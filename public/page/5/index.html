<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="OrionPotter" />










<meta property="og:type" content="website">
<meta property="og:title" content="Orion Potter&#39;s 个人博客">
<meta property="og:url" content="https://blog.orionpotter.space/page/5/index.html">
<meta property="og:site_name" content="Orion Potter&#39;s 个人博客">
<meta property="og:locale">
<meta property="article:author" content="Orion Potter">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.orionpotter.space/page/5/"/>





  <title>Orion Potter's 个人博客</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Orion Potter's 个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-folder"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/PostgreSQL.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/PostgreSQL.html" itemprop="url">PostgreSQL 学习</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><ul>
<li>make &gt;&#x3D; 3.8.0</li>
<li>推荐gcc最新版</li>
<li>bzip、bzip2、tar、readline、readline-devel、zlib-devel</li>
<li>Perl</li>
</ul>
<h2 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h2><pre class="line-numbers language-uri" data-language="uri"><code class="language-uri"><span class="token path">https</span> ://www.postgresql.org/download/ <span class="token fragment"><span class="token fragment-delimiter">#</span></span> 下载名为postgresql-10.21.tar.gz  解压
<span class="token path">gunzip</span> postgresql-10.21.tar.gz
<span class="token path">tar</span> xf postgresql-10.21.tar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/postgresql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="创建data、log目录"><a href="#创建data、log目录" class="headerlink" title="创建data、log目录"></a>创建data、log目录</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/local/postgresql
<span class="token function">mkdir</span> /usr/local/postgresql/data
<span class="token function">mkdir</span> /usr/local/postgresql/log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/profile
<span class="token comment"># 添加</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PGHOME</span><span class="token operator">=</span>/usr/local/postgresql
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PGDATA</span><span class="token operator">=</span>/usr/local/postgresql/data
<span class="token comment"># 保存后生效</span>
<span class="token builtin class-name">source</span> /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="增加用户-postgres-并赋权"><a href="#增加用户-postgres-并赋权" class="headerlink" title="增加用户 postgres 并赋权"></a>增加用户 postgres 并赋权</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">useradd</span> postgres
<span class="token function">chown</span> <span class="token parameter variable">-R</span> postgres:root /usr/local/postgresql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> postgres
/usr/local/postgresql/bin/initdb <span class="token parameter variable">-D</span> /usr/local/postgresql/data/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /usr/local/postgresql/data/postgresql.conf
<span class="token comment"># 修改</span>
listen_addresses <span class="token operator">=</span> <span class="token string">'*'</span>
port <span class="token operator">=</span> <span class="token number">5432</span>

<span class="token function">vim</span> /usr/local/postgresql/data/pg_hba.conf
<span class="token comment"># 添加一行</span>
<span class="token function">host</span>    all             all             <span class="token number">0.0</span>.0.0/0               trust<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pg_ctl start <span class="token parameter variable">-l</span> /usr/local/postgresql/log/pg_server.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="登录默认数据库"><a href="#登录默认数据库" class="headerlink" title="登录默认数据库"></a>登录默认数据库</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/local/postgresql/bin/psql postgres<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="为默认用户设置密码"><a href="#为默认用户设置密码" class="headerlink" title="为默认用户设置密码"></a>为默认用户设置密码</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">postgres</span><span class="token operator">=</span><span class="token comment"># sudo -u postgres psql postgres</span>
postgres-<span class="token comment">#  \password postgres</span>
Enter new password: 
Enter it again: <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="基础教程"><a href="#基础教程" class="headerlink" title="基础教程"></a>基础教程</h1><h2 id="Querying-Data"><a href="#Querying-Data" class="headerlink" title="Querying Data"></a>Querying Data</h2><h2 id="Filtering-Data"><a href="#Filtering-Data" class="headerlink" title="Filtering Data"></a>Filtering Data</h2><h2 id="Joining-Multiple-Tables"><a href="#Joining-Multiple-Tables" class="headerlink" title="Joining Multiple Tables"></a>Joining Multiple Tables</h2><h2 id="Grouping-Data"><a href="#Grouping-Data" class="headerlink" title="Grouping Data"></a>Grouping Data</h2><h2 id="Set-Operations"><a href="#Set-Operations" class="headerlink" title="Set Operations"></a>Set Operations</h2><h2 id="Grouping-sets-Cube-and-Rollup"><a href="#Grouping-sets-Cube-and-Rollup" class="headerlink" title="Grouping sets, Cube, and Rollup"></a>Grouping sets, Cube, and Rollup</h2><h2 id="Subquery"><a href="#Subquery" class="headerlink" title="Subquery"></a>Subquery</h2><h2 id="Common-Table-Expressions"><a href="#Common-Table-Expressions" class="headerlink" title="Common Table Expressions"></a>Common Table Expressions</h2><h2 id="Modifying-Data"><a href="#Modifying-Data" class="headerlink" title="Modifying Data"></a>Modifying Data</h2><h2 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h2><h2 id="Import-amp-Export-Data"><a href="#Import-amp-Export-Data" class="headerlink" title="Import &amp; Export Data"></a>Import &amp; Export Data</h2><h2 id="Managing-Tables"><a href="#Managing-Tables" class="headerlink" title="Managing Tables"></a>Managing Tables</h2><h2 id="Understanding-PostgreSQL-Constraints"><a href="#Understanding-PostgreSQL-Constraints" class="headerlink" title="Understanding PostgreSQL Constraints"></a>Understanding PostgreSQL Constraints</h2><h2 id="PostgreSQL-Data-Types-in-Depth"><a href="#PostgreSQL-Data-Types-in-Depth" class="headerlink" title="PostgreSQL Data Types in Depth"></a>PostgreSQL Data Types in Depth</h2><h2 id="Conditional-Expressions-amp-Operators"><a href="#Conditional-Expressions-amp-Operators" class="headerlink" title="Conditional Expressions &amp; Operators"></a>Conditional Expressions &amp; Operators</h2><h2 id="PostgreSQL-Utilities"><a href="#PostgreSQL-Utilities" class="headerlink" title="PostgreSQL Utilities"></a>PostgreSQL Utilities</h2><h2 id="PostgreSQL-Recipes"><a href="#PostgreSQL-Recipes" class="headerlink" title="PostgreSQL Recipes"></a>PostgreSQL Recipes</h2><h1 id="高级教程"><a href="#高级教程" class="headerlink" title="高级教程"></a>高级教程</h1><h2 id="PL-x2F-pgSQL"><a href="#PL-x2F-pgSQL" class="headerlink" title="PL&#x2F;pgSQL"></a>PL&#x2F;pgSQL</h2><h2 id="Triggers"><a href="#Triggers" class="headerlink" title="Triggers"></a>Triggers</h2><h2 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h2><h2 id="Indexes"><a href="#Indexes" class="headerlink" title="Indexes"></a>Indexes</h2><h2 id="Administration"><a href="#Administration" class="headerlink" title="Administration"></a>Administration</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/RESTful%20API%E8%AE%BE%E8%AE%A1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/RESTful%20API%E8%AE%BE%E8%AE%A1.html" itemprop="url">RESTful API设计</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是RESTful-API"><a href="#什么是RESTful-API" class="headerlink" title="什么是RESTful API"></a>什么是RESTful API</h1><p>REST（Representational State Transfer）是基于HTTP协议的架构风格，通过一组约束条件和原则来设计和实现网络服务,RESTful API是遵循这些原则并以REST架构风格实现的Web服务接口。</p>
<h1 id="REST架构的核心原则"><a href="#REST架构的核心原则" class="headerlink" title="REST架构的核心原则"></a>REST架构的核心原则</h1><h2 id="资源（Resources）"><a href="#资源（Resources）" class="headerlink" title="资源（Resources）"></a>资源（Resources）</h2><p>资源应该是名词，通常是实体，例如用户（User）、订单（Order）、产品（Product）等,避免在URI中使用动词。</p>
<h2 id="无状态（Stateless）"><a href="#无状态（Stateless）" class="headerlink" title="无状态（Stateless）"></a>无状态（Stateless）</h2><p>每个请求从客户端到服务器都必须包含理解请求所需的全部信息，服务器不应存储客户端的状态。</p>
<h2 id="分层架构"><a href="#分层架构" class="headerlink" title="分层架构"></a>分层架构</h2><p>REST架构鼓励分层设计，客户端不需要了解服务端的实现细节，通过中间层来处理缓存、安全等问题。</p>
<h2 id="可缓存性"><a href="#可缓存性" class="headerlink" title="可缓存性"></a>可缓存性</h2><p>服务端响应应明确指明其是否可被缓存，提高系统性能。</p>
<h1 id="RESTful-API设计的关键要素"><a href="#RESTful-API设计的关键要素" class="headerlink" title="RESTful API设计的关键要素"></a>RESTful API设计的关键要素</h1><h2 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h2><ul>
<li><strong>GET</strong>: 获取资源</li>
<li><strong>POST</strong>: 创建新资源</li>
<li><strong>PUT</strong>: 更新现有资源</li>
<li><strong>DELETE</strong>: 删除资源</li>
<li><strong>PATCH</strong>: 部分更新资源</li>
</ul>
<h2 id="URL结构"><a href="#URL结构" class="headerlink" title="URL结构"></a>URL结构</h2><ul>
<li>使用名词而非动词</li>
<li>保持简单的层级结构</li>
<li>使用复数形式表示集合</li>
</ul>
<p>例如：<code>/users</code>、<code>/users/123</code>、<code>/users/123/orders</code></p>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><ul>
<li><strong>200 OK</strong>: 请求成功</li>
<li><strong>201 Created</strong>: 资源创建成功</li>
<li><strong>400 Bad Request</strong>: 客户端错误</li>
<li><strong>404 Not Found</strong>: 资源不存在</li>
<li><strong>500 Internal Server Error</strong>: 服务器错误</li>
</ul>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>在URL中包含版本信息，如：<code>/api/v1/users</code></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="使用名词而非动词"><a href="#使用名词而非动词" class="headerlink" title="使用名词而非动词"></a>使用名词而非动词</h2><ul>
<li><strong>不推荐</strong>: <code>/getUsers</code></li>
<li><strong>推荐</strong>: <code>/users</code></li>
</ul>
<h2 id="保持简单的层级结构"><a href="#保持简单的层级结构" class="headerlink" title="保持简单的层级结构"></a>保持简单的层级结构</h2><p>避免过多的层级，建议不超过2-3级，例如：<code>/users/123/orders/456</code></p>
<h2 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h2><p>返回有意义的错误消息和适当的状态码，以帮助客户端理解问题。</p>
<h2 id="分页和过滤"><a href="#分页和过滤" class="headerlink" title="分页和过滤"></a>分页和过滤</h2><p>使用查询参数进行分页和过滤，例如：<code>/users?page=2&amp;limit=20</code></p>
<h2 id="安全性考虑"><a href="#安全性考虑" class="headerlink" title="安全性考虑"></a>安全性考虑</h2><ul>
<li>使用HTTPS</li>
<li>实施身份验证和授权</li>
<li>限制请求速率</li>
</ul>
<h2 id="实际案例分析"><a href="#实际案例分析" class="headerlink" title="实际案例分析"></a>实际案例分析</h2><p>考虑一个简单的博客API：</p>
<ul>
<li><code>GET /posts</code>: 获取所有文章</li>
<li><code>POST /posts</code>: 创建新文章</li>
<li><code>GET /posts/&#123;id&#125;</code>: 获取特定文章</li>
<li><code>PUT /posts/&#123;id&#125;</code>: 更新特定文章</li>
<li><code>DELETE /posts/&#123;id&#125;</code>: 删除特定文章</li>
<li><code>GET /posts/&#123;id&#125;/comments</code>: 获取特定文章的评论</li>
</ul>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol>
<li><strong>在URL中使用动词</strong>：应使用名词表示资源。</li>
<li><strong>忽视HTTP方法的语义</strong>：确保使用正确的HTTP方法处理请求。</li>
<li><strong>返回不一致的数据结构</strong>：保持API响应的一致性。</li>
<li><strong>忽视安全性</strong>：始终考虑API的安全性。</li>
<li><strong>过度嵌套URL结构</strong>：保持URL结构的简单性。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/Mybatis%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/Mybatis%E5%AE%9E%E8%B7%B5.html" itemprop="url">mybatis实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/orm/" itemprop="url" rel="index">
                    <span itemprop="name">orm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是mybatis"><a href="#什么是mybatis" class="headerlink" title="什么是mybatis"></a>什么是mybatis</h1><blockquote>
<p>MyBatis是一个持久层框架，支持自定义SQL、存储过程以及高级映射。它减少了JDBC设置参数和获取结果集的代码工作，通过XML或注解将Java的原始类型、接口、POJO映射到数据库记录中。</p>
</blockquote>
<h2 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h2><ol>
<li><p>SqlSessionFactory：创建SqlSession的工厂。</p>
</li>
<li><p>SqlSession：提供了与数据库交互的主要接口，管理数据库连接、事务处理。</p>
</li>
<li><p>Mapper：Mapper接口定义了数据库操作方法，通过绑定注解或者XML进行映射SQL，执行数据库操作方法时，动态代理对象拦截后调用executor执行对应的SQL。</p>
</li>
<li><p>Configruation：MyBatis的全局配置类，包含所有配置信息，包括数据源、事务管理、映射器、插件等。</p>
</li>
<li><p>Executor：负责执行具体的SQL操作，并处理结果集的映射。</p>
</li>
</ol>
<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><h2 id="安装Mybatis"><a href="#安装Mybatis" class="headerlink" title="安装Mybatis"></a>安装Mybatis</h2><p>项目采用Maven构建，只需要在<code>pom.xml</code>中导入MyBatis、Mysql连接依赖，项目以Mysql数据库为例进行实践。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- MyBatis --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- MySQL Connector --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>8.0.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h2><p>MyBatis 的核心是 <code>SqlSessionFactory</code>，它负责创建和管理 <code>SqlSession</code> 对象。要获得 <code>SqlSessionFactory</code> 实例，可以使用 <code>SqlSessionFactoryBuilder</code>。<code>SqlSessionFactoryBuilder</code> 能够通过读取 XML 配置文件（如 <code>mybatis-config.xml</code>）或者通过编程方式配置的 <code>Configuration</code> 对象来构建 <code>SqlSessionFactory</code> 实例。</p>
<h3 id="基于xml构建"><a href="#基于xml构建" class="headerlink" title="基于xml构建"></a>基于xml构建</h3><p>基于mybatis配置文件mybatis-config.xml构建SqlSessionFactory,需要读取类路径下的资源配置文件(src&#x2F;main&#x2F;resources&#x2F;mybatis-config.xml)，mybatis提供了一个Resources工具类，可以更加简单读取。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>
<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>mybatis配置文件示例：</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- mybatis-config.xml --></span>
<span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">configuration</span>
        <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Config 3.0//EN"</span>
        <span class="token string">"https://mybatis.org/dtd/mybatis-3-config.dtd"</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;driver&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;url&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;username&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;password&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="基于Configruation构建"><a href="#基于Configruation构建" class="headerlink" title="基于Configruation构建"></a>基于Configruation构建</h3><p>基于自定义的mybatis全局配置类构建SqlSessionFactory，可以配置数据源、自定义连接池等相关配置信息。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 自定义配置 HikariCP 连接池</span>
<span class="token class-name">HikariConfig</span> hikariConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hikariConfig<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hikariConfig<span class="token punctuation">.</span><span class="token function">setJdbcUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hikariConfig<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hikariConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">(</span>hikariConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTransactionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Environment</span> environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Environment</span><span class="token punctuation">(</span><span class="token string">"development"</span><span class="token punctuation">,</span> transactionFactory<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="构建SqlSession"><a href="#构建SqlSession" class="headerlink" title="构建SqlSession"></a>构建SqlSession</h2><p>通过SqlSessionFactory创建SqlSession进行管理数据库连接和管理事务,采用以下代码示例创建SqlSession无需手动关闭连接。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token comment">//todo 业务代码</span>
    <span class="token comment">// 提交事务</span>
    sqlSession<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 捕获异常，回滚事务</span>
    sqlSession<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//处理异常</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>构建SqlSessionFactory有三种方式：</p>
<ol>
<li>纯读取mybatis-config.xml</li>
<li>纯读取Configuration</li>
<li>两种混合使用构建[由于Java注解的限制，一些复杂的sql不好实现，实际采用的是，配置文件+配置类+映射文件+注解的方式使用]</li>
</ol>
</blockquote>
<p>SqlSessionFactory创建SqlSession实例6种方法：</p>
<ul>
<li><strong>事务处理</strong>：如何实现自动提交或者手动提交？</li>
<li><strong>数据库连接</strong>：如何使用其他自定义的数据源？</li>
<li><strong>语句执行</strong>：如何复用PreparedStatement执行语句或批量更新语句（包括插入语句和删除语句）？</li>
</ul>
<p>基于以上需求，有下列已重载的多个 openSession() 方法供使用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span>
<span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span>
<span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">)</span>
<span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">)</span>
<span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span>
<span class="token class-name">SqlSession</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>默认的 openSession() 方法没有参数：</p>
<ul>
<li>事务作用域将会开启（也就是不自动提交，如果未调用 <code>commit</code> 方法，<code>SqlSession</code> 关闭时 MyBatis 会自动回滚事务。）。</li>
<li>将由当前环境配置的 DataSource 实例中获取 Connection 对象。</li>
<li>事务隔离级别将会使用驱动或数据源的默认设置。</li>
<li>预处理语句不会被复用，也不会批量处理更新。</li>
</ul>
<p><code>ExecutorType</code> 这个枚举类型定义了三个值:</p>
<ul>
<li><code>ExecutorType.SIMPLE</code>：为每个语句的执行创建一个新的预处理语句。</li>
<li><code>ExecutorType.REUSE</code>：该类型的执行器会复用预处理语句。</li>
<li><code>ExecutorType.BATCH</code>：该类型的执行器会批量执行所有更新语句，如果 SELECT 在多个更新中间执行，将在必要时将多条更新语句分隔开来，以方便理解。</li>
</ul>
<p><strong>立即批量更新方法</strong></p>
<p>当你将 <code>ExecutorType</code> 设置为 <code>ExecutorType.BATCH</code> 时，可以使用这个方法清除（执行）缓存在 JDBC 驱动类中的批量更新语句。</p>
<pre class="line-numbers language-none"><code class="language-none">if (count % batchSize &#x3D;&#x3D; 0) &#123;
     sqlSession.flushStatements(); &#x2F;&#x2F; 手动刷新缓存中的 SQL 语句
     sqlSession.clearCache(); &#x2F;&#x2F; 清空缓存，防止内存溢出
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="作用域和生命周期"><a href="#作用域和生命周期" class="headerlink" title="作用域和生命周期"></a>作用域和生命周期</h2><h3 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h3><p>创建完SqlSessionFactory就可以放弃了，属于方法作用域</p>
<h3 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h3><p>创建完了就一直存在，每次使用都拿去创建SqlSession对象，作用域是应用作用域，应该使用单例模式或者静态单例模式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBatisSessionFactory</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 加载 MyBatis 配置文件</span>
        <span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">MyBatisSessionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 构建 SqlSessionFactory</span>
        sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 私有构造方法，防止外部实例化</span>
    <span class="token keyword">private</span> <span class="token class-name">MyBatisSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 获取 SqlSessionFactory 的静态方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> sqlSessionFactory<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><p>每个现成都有自己的sqlSession,SqlSession不是线程安全的，不能被共享，作用域是方法作用域，每次操作完就自动关闭。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// todo</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><p>映射器是用来绑定映射语句的接口，映射器的实例是从SqlSession中获取的，使用完即可关闭，作用域是方法作用域。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">BlogMapper</span> mapper <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">BlogMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// todo</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><h2 id="mybatis配置文件结构"><a href="#mybatis配置文件结构" class="headerlink" title="mybatis配置文件结构"></a>mybatis配置文件结构</h2><p>mybatis的配置文档的顶层结构如下</p>
<ul>
<li>configuration（配置）<ul>
<li>properties（属性）</li>
<li>settings（设置）</li>
<li>typeAliases（类型别名）</li>
<li>typeHandlers（类型处理器）</li>
<li>objectFactory（对象工厂）</li>
<li>plugins（插件）</li>
<li>environments（环境配置）<ul>
<li>environment（环境变量）<ul>
<li>transactionManager（事务管理器）</li>
<li>dataSource（数据源）</li>
</ul>
</li>
</ul>
</li>
<li>databaseIdProvider（数据库厂商标识）</li>
<li>mappers（映射器）</li>
</ul>
</li>
</ul>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>属性可以采用外部的配置文件，如jdbc.properties，将外部的配置文件引入后，可以在整个mybatis-config.xml配置文件中引用，也可以在构建<code>sqlSessionFactory</code>的时候传入自定义的配置的properties</p>
<h3 id="加载外部配置文件"><a href="#加载外部配置文件" class="headerlink" title="加载外部配置文件"></a>加载外部配置文件</h3><p><strong>外部配置文件jdbc.properties</strong></p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">driver</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token key attr-name">url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mybatis_tutorial?serverTimezone=Asia/Shanghai</span>
<span class="token key attr-name">username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>mybatis-config.xml引用属性</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;driver&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;url&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;username&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;password&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构建SqlSessionFactor加载属性"><a href="#构建SqlSessionFactor加载属性" class="headerlink" title="构建SqlSessionFactor加载属性"></a>构建SqlSessionFactor加载属性</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>
<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//自定义配置properties</span>
<span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span> <span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://localhost:3306/mybatis_tutorial?serverTimezone=Asia/Shanghai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="属性优先级"><a href="#属性优先级" class="headerlink" title="属性优先级"></a>属性优先级</h3><p>构建SqlSessionFactory传入的属性 &gt; 加载外部配置文件的属性 &gt; 在mybatis-config.xml中properties元素体内指定的属性</p>
<h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- 启用或禁用二级缓存 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用延迟加载 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazyLoadingEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用激进的延迟加载 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aggressiveLazyLoading<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用多结果集支持 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipleResultSetsEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 使用列标签代替列名 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useColumnLabel<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用 JDBC 生成的键 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useGeneratedKeys<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 自动映射行为，PARTIAL 表示部分映射 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>autoMappingBehavior<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PARTIAL<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 未知列的自动映射行为，WARNING 表示警告 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>autoMappingUnknownColumnBehavior<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WARNING<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 默认的执行器类型，SIMPLE 表示简单执行器 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultExecutorType<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SIMPLE<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 默认的语句超时时间（秒） --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultStatementTimeout<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>25<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 默认的获取大小 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultFetchSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用安全的 RowBounds --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>safeRowBoundsEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用安全的结果处理器 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>safeResultHandlerEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用下划线转驼峰命名法 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapUnderscoreToCamelCase<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 本地缓存范围，SESSION 表示会话级别缓存 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localCacheScope<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SESSION<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 为 NULL 值指定的 JDBC 类型 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcTypeForNull<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OTHER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 延迟加载触发的方法 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazyLoadTriggerMethods<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>equals,clone,hashCode,toString<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 默认的脚本语言驱动 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultScriptingLanguage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.ibatis.scripting.xmltags.XMLLanguageDriver<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 默认的枚举类型处理器 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultEnumTypeHandler<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.ibatis.type.EnumTypeHandler<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用在设置 NULL 值时调用 setter 方法 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>callSettersOnNulls<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用返回空行的实例 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>returnInstanceForEmptyRow<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 日志前缀 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logPrefix<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleLogPreFix_<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 日志实现，SLF4J、LOG4J、LOG4J2、JDK_LOGGING、COMMONS_LOGGING、STDOUT_LOGGING、NO_LOGGING --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logImpl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SLF4J<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 代理工厂，CGLIB 或 JAVASSIST --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>proxyFactory<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CGLIB<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 自定义 VFS 实现 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vfsImpl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.example.YourselfVfsImpl<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 启用或禁用使用实际的参数名称 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>useActualParamName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  
  <span class="token comment">&lt;!-- 配置工厂类 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>configurationFactory<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.example.ConfigurationFactory<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><p>类型别名可以给一个java类型设置一个缩写名字，他仅适用于xml配置，主要降低全限定类名的书写。</p>
<h3 id="配置文件方式"><a href="#配置文件方式" class="headerlink" title="配置文件方式"></a>配置文件方式</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAliases</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Author<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Author<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Blog<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Blog<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Comment<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Comment<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Post<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Post<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Section<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Section<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAlias</span> <span class="token attr-name">alias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Tag<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog.Tag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeAliases</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="注解方式"><a href="#注解方式" class="headerlink" title="注解方式"></a>注解方式</h3><p>typeAlias指定一个包的时候，默认会采用bean的名字首字母小写</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeAliases</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>domain.blog<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeAliases</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Alias</span><span class="token punctuation">(</span><span class="token string">"Author"</span><span class="token punctuation">)</span><span class="token comment">//不加注解默认是author,加了注解以后就是Author</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Author</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="类型处理器"><a href="#类型处理器" class="headerlink" title="类型处理器"></a>类型处理器</h2><p>MyBatis在设置预处理语句（PreparedStatement）中的参数或从结果集中取出一个值时，都会用类型处理器将获取到的值以合适的方式转换成 Java 类型，LocalDateTime与数据库中DateTime相互对应，mybatis会自动处理，但是有一些，例如：pojo是list,mysql中是varchar()这就要需要设置自定义类型处理来处理了。</p>
<h3 id="配置类型处理器"><a href="#配置类型处理器" class="headerlink" title="配置类型处理器"></a>配置类型处理器</h3><p>实现 <code>org.apache.ibatis.type.TypeHandler</code> 接口或继承一个很便利的类 <code>org.apache.ibatis.type.BaseTypeHandler</code>，将它映射到一个 JDBC 类型。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringListTypeHandler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseTypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNonNullParameter</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">JdbcType</span> jdbcType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token class-name">String</span> columnName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> columnValue <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> columnValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>columnValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> columnIndex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> columnValue <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> columnValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>columnValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">CallableStatement</span> cs<span class="token punctuation">,</span> <span class="token keyword">int</span> columnIndex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> columnValue <span class="token operator">=</span> cs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> columnValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>columnValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="注册到Mybatis"><a href="#注册到Mybatis" class="headerlink" title="注册到Mybatis"></a>注册到Mybatis</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- mybatis-config.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeHandlers</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeHandler</span> <span class="token attr-name">handler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.handler.StringListTypeHandler<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.util.List<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>typeHandlers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="编写映射文件配置"><a href="#编写映射文件配置" class="headerlink" title="编写映射文件配置"></a>编写映射文件配置</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- BlogMapper.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.BlogMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BlogResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Blog<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        ……
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tags<span class="token punctuation">"</span></span> <span class="token attr-name">typeHandler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.handler.StringListTypeHandler<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>categories<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>categories<span class="token punctuation">"</span></span> <span class="token attr-name">typeHandler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.handler.StringListTypeHandler<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        ……
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectBlog<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BlogResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        select * from Blog where id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="对象工厂"><a href="#对象工厂" class="headerlink" title="对象工厂"></a>对象工厂</h2><blockquote>
<p>在 MyBatis 中，对象工厂（ObjectFactory）负责实例化所有映射的对象。它主要用于创建从数据库返回的结果对象。</p>
</blockquote>
<h3 id="默认对象工厂"><a href="#默认对象工厂" class="headerlink" title="默认对象工厂"></a>默认对象工厂</h3><p>默认情况下，MyBatis 使用 <code>DefaultObjectFactory</code> 来创建结果对象。这对于大多数情况已经足够了。</p>
<h3 id="自定义对象工厂"><a href="#自定义对象工厂" class="headerlink" title="自定义对象工厂"></a>自定义对象工厂</h3><p>通过实现 <code>ObjectFactory</code> 接口来自定义对象工厂。假设我们有一个 <code>User</code> 类，我们希望在创建 <code>User</code> 对象时自动设置一个默认的状态字段。</p>
<p><strong>1. User类</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectFactoryUser</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2. 自定义对象工厂，给ObjectFactoryUser设置默认的状态为 “active”。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomObjectFactory</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultObjectFactory</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">T</span> instance <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> constructorArgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">T</span> instance <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> constructorArgTypes<span class="token punctuation">,</span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">T</span> instance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"active"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3. 配置自定义对象工厂</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- mybatis-config.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- 其他配置 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>objectFactory</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.CustomObjectFactory<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当 <code>ObjectFactoryUser</code> 对象通过MyBatis查询创建时，自定义的对象工厂会自动将<code>status</code> 字段设置为 “active”。输出结果应显示用户的状态为 “active”。</p>
<p><strong>作用：</strong></p>
<ol>
<li><p><strong>创建结果对象</strong>：当 MyBatis 从数据库返回结果集时，使用对象工厂创建结果对象实例。</p>
</li>
<li><p><strong>对象初始化</strong>：可以在对象创建时进行一些自定义的初始化工作，比如依赖注入、默认值设置等。</p>
</li>
<li><p><strong>构造函数选择</strong>：可以选择使用特定的构造函数来创建对象，满足特殊的对象创建需求。</p>
</li>
</ol>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><h3 id="开发步骤"><a href="#开发步骤" class="headerlink" title="开发步骤"></a>开发步骤</h3><ol>
<li><strong>实现 Interceptor 接口</strong>：创建一个类实现 MyBatis 提供的 <code>Interceptor</code> 接口。</li>
<li><strong>注入插件</strong>：在 MyBatis 配置文件中注入插件。</li>
<li><strong>配置插件</strong>：在插件类中配置需要拦截的方法和自定义逻辑。</li>
</ol>
<h3 id="插件原理"><a href="#插件原理" class="headerlink" title="插件原理"></a>插件原理</h3><p>MyBatis 插件通过拦截器机制，在执行 SQL 语句的四个主要方法前后进行拦截：</p>
<ul>
<li><code>Executor</code>：执行增删改查操作的方法。</li>
<li><code>ParameterHandler</code>：处理参数的方法。</li>
<li><code>ResultSetHandler</code>：处理结果集的方法。</li>
<li><code>StatementHandler</code>：处理 SQL 语句的方法。</li>
</ul>
<p>通过拦截这些方法，可以在执行 SQL 语句前后进行自定义操作。</p>
<h3 id="插件示例"><a href="#插件示例" class="headerlink" title="插件示例"></a>插件示例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"prepare"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlExecutionTimeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SqlExecutionTimeInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行被拦截的方法</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SQL execution took "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建目标对象的代理</span>
        <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 读取插件配置的属性</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>注入插件</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.plugin.SqlExecutionTimeInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="插件配置说明"><a href="#插件配置说明" class="headerlink" title="插件配置说明"></a>插件配置说明</h3><ul>
<li><code>@Intercepts</code> 注解：用于定义插件要拦截的方法。</li>
<li><code>@Signature</code> 注解：用于指定要拦截的类、方法和参数类型。</li>
<li><code>intercept</code> 方法：插件的核心逻辑，拦截目标方法并执行自定义操作。</li>
<li><code>plugin</code> 方法：用于创建插件的代理对象。</li>
<li><code>setProperties</code> 方法：用于设置插件的属性。</li>
</ul>
<h3 id="插件开发原理"><a href="#插件开发原理" class="headerlink" title="插件开发原理"></a>插件开发原理</h3><ul>
<li><strong>拦截器机制</strong>：MyBatis 插件通过拦截器机制，在执行 SQL 语句的四个主要方法前后进行拦截。通过 <code>@Intercepts</code> 和 <code>@Signature</code> 注解，可以指定要拦截的类、方法和参数类型。</li>
<li><strong>代理模式</strong>：MyBatis 插件使用代理模式，通过 <code>Plugin.wrap</code> 方法创建目标对象的代理对象。在代理对象中，可以在执行目标方法前后进行自定义操作。</li>
<li><strong>反射机制</strong>：在 <code>intercept</code> 方法中，可以通过反射机制获取目标对象和方法参数，从而实现自定义操作。</li>
</ul>
<h3 id="分页插件"><a href="#分页插件" class="headerlink" title="分页插件"></a>分页插件</h3><p><strong>1. 导入分页插件依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- PageHelper 依赖 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2. 注入插件</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!-- 配置 PageHelper 插件 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.github.pagehelper.PageInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token comment">&lt;!-- 指定数据库方言，这里设置为 MySQL --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>helperDialect<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment">&lt;!-- 启用分页参数合理化 --></span>
            <span class="token comment">&lt;!-- 当页码参数小于 1 时，会自动调整为 1 --></span>
            <span class="token comment">&lt;!-- 当页码大于最大页数时，会自动调整为最大页数 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reasonable<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment">&lt;!-- 支持从方法参数中获取分页参数 --></span>
            <span class="token comment">&lt;!-- 允许在 Mapper 接口的方法参数中直接传递分页参数 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>supportMethodsArguments<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment">&lt;!-- 配置额外的分页参数 --></span>
            <span class="token comment">&lt;!-- 使用 countSql 作为统计总记录数的 SQL 语句 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>params<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count=countSql<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3. 测试分页插件</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">FoodMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">FoodMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 查询第一页，每页 2 条记录</span>
            <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">></span></span> foods <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectAllFood</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">></span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>foods<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 输出食物信息</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">></span></span> foodList <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            foodList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 输出分页信息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前页: "</span> <span class="token operator">+</span> pageInfo<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"每页的记录数: "</span> <span class="token operator">+</span> pageInfo<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总记录数: "</span> <span class="token operator">+</span> pageInfo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总页数: "</span> <span class="token operator">+</span> pageInfo<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>生产过程中可能会涉及多个环境，如开发环境、测试环境、生产环境</p>
<h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 定义多个环境 --></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
       <span class="token comment">&lt;!-- 开发环境 --></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.cj.jdbc.Driver<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/dev_db<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dev_user<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dev_password<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
       <span class="token comment">&lt;!-- 测试环境 --></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.cj.jdbc.Driver<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/test_db<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_user<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test_password<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
       <span class="token comment">&lt;!-- 生产环境 --></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>production<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.cj.jdbc.Driver<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/prod_db<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prod_user<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prod_password<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="按需使用环境"><a href="#按需使用环境" class="headerlink" title="按需使用环境"></a>按需使用环境</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">"mybatis-config.xml"</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span><span class="token string">"&#123;environment id&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactory<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="事务管理器"><a href="#事务管理器" class="headerlink" title="事务管理器"></a>事务管理器</h2><p> MyBatis 中有两种类型的事务管理器（也就是 type&#x3D;”[JDBC|MANAGED]”）</p>
<ul>
<li><p>JDBC – 这个配置直接使用了 JDBC 的提交和回滚功能，它依赖从数据源获得的连接来管理事务作用域。默认情况下，为了与某些驱动程序兼容，它在关闭连接时启用自动提交。然而，对于某些驱动程序来说，启用自动提交不仅是不必要的，而且是一个代价高昂的操作。因此，从 3.5.10 版本开始，你可以通过将 “skipSetAutoCommitOnClose” 属性设置为 “true” 来跳过这个步骤。例如：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;transactionManager type&#x3D;&quot;JDBC&quot;&gt;
  &lt;property name&#x3D;&quot;skipSetAutoCommitOnClose&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;
&lt;&#x2F;transactionManager&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>MANAGED – 这个配置几乎没做什么。它从不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。 默认情况下它会关闭连接。然而一些容器并不希望连接被关闭，因此需要将 closeConnection 属性设置为 false 来阻止默认的关闭行为。例如:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;transactionManager type&#x3D;&quot;MANAGED&quot;&gt;
  &lt;property name&#x3D;&quot;closeConnection&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;
&lt;&#x2F;transactionManager&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p><strong>提示</strong> Spring + MyBatis，则没有必要配置事务管理器，因为 Spring 模块会使用自带的管理器来覆盖前面的配置。</p>
<h2 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h2><p>三种内建的数据源类型（也就是 type&#x3D;”[UNPOOLED|POOLED|JNDI]”）：</p>
<p><strong>UNPOOLED</strong>– 这个数据源的实现会每次请求时打开和关闭连接。</p>
<p><strong>POOLED</strong>– 这种数据源的实现利用“池”的概念将 JDBC 连接对象组织起来，避免了创建新的连接实例时所必需的初始化和认证时间。默认使用</p>
<p><strong>JNDI</strong> – 这个数据源实现是为了能在如 EJB 或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个 JNDI 上下文的数据源引用。</p>
<h3 id="添加自定义数据源HikariCP"><a href="#添加自定义数据源HikariCP" class="headerlink" title="添加自定义数据源HikariCP"></a>添加自定义数据源HikariCP</h3><p><strong>1. 导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- HikariCP --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.zaxxer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>HikariCP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2. 创建自定义的 HikariCP 数据源工厂</strong></p>
<p>在 MyBatis 中使用 HikariCP 作为数据源时，创建自定义的 HikariCP 数据源工厂是为了满足 MyBatis 的数据源配置要求。MyBatis 期望的数据源配置类需要实现 <code>DataSourceFactory</code> 接口，而 HikariCP 本身并不直接实现这个接口。因此，我们需要创建一个自定义的工厂类来适配 HikariCP 数据源。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HikariCPDataSourceFactory</span> <span class="token keyword">implements</span> <span class="token class-name">DataSourceFactory</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HikariConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"driverClassName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setJdbcUrl</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"jdbcUrl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3. 配置 MyBatis 使用自定义的数据源工厂</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.factory.HikariCPDataSourceFactory<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;driver&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcUrl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;url&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;username&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;password&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="数据库厂商"><a href="#数据库厂商" class="headerlink" title="数据库厂商"></a>数据库厂商</h2><p>MyBatis 可以根据不同的数据库厂商执行不同的语句，这种多厂商的支持是基于映射语句中的 <code>databaseId</code> 属性。 MyBatis 会加载带有匹配当前数据库 <code>databaseId</code> 属性和所有不带 <code>databaseId</code> 属性的语句。 如果同时找到带有 <code>databaseId</code> 和不带 <code>databaseId</code> 的相同语句，则后者会被舍弃。 为支持多厂商特性，只要像下面这样在 mybatis-config.xml 文件中加入 <code>databaseIdProvider</code> 即可：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;databaseIdProvider type&#x3D;&quot;DB_VENDOR&quot; &#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>databaseIdProvider 对应的 DB_VENDOR 实现会将 databaseId 设置为 <code>DatabaseMetaData#getDatabaseProductName()</code> 返回的字符串。 由于通常情况下这些字符串都非常长，而且相同产品的不同版本会返回不同的值，你可能想通过设置属性别名来使其变短：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;databaseIdProvider type&#x3D;&quot;DB_VENDOR&quot;&gt;
  &lt;property name&#x3D;&quot;SQL Server&quot; value&#x3D;&quot;sqlserver&quot;&#x2F;&gt;
  &lt;property name&#x3D;&quot;DB2&quot; value&#x3D;&quot;db2&quot;&#x2F;&gt;
  &lt;property name&#x3D;&quot;Oracle&quot; value&#x3D;&quot;oracle&quot; &#x2F;&gt;
&lt;&#x2F;databaseIdProvider&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在提供了属性别名时，databaseIdProvider 的 DB_VENDOR 实现会将 databaseId 设置为数据库产品名与属性中的名称第一个相匹配的值，如果没有匹配的属性，将会设置为 “null”。 在这个例子中，如果 <code>getDatabaseProductName()</code> 返回“Oracle (DataDirect)”，databaseId 将被设置为“oracle”。</p>
<p>你可以通过实现接口 <code>org.apache.ibatis.mapping.DatabaseIdProvider</code> 并在 mybatis-config.xml 中注册来构建自己的 DatabaseIdProvider：</p>
<pre class="line-numbers language-none"><code class="language-none">public interface DatabaseIdProvider &#123;
  default void setProperties(Properties p) &#123; &#x2F;&#x2F; 从 3.5.2 开始，该方法为默认方法
    &#x2F;&#x2F; 空实现
  &#125;
  String getDatabaseId(DataSource dataSource) throws SQLException;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h2><p>四种映射器方式，可以找到对应配置的映射文件</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 使用相对于类路径的资源引用 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/BlogMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/UserMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/OrderMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/BookMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/AnimalMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper/FoodMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 使用映射器接口实现类的完全限定类名 --></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.BlogMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.OrderMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.BookMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.AnimalMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.FoodMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 将包内的映射器接口全部注册为映射器 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="XML-映射器"><a href="#XML-映射器" class="headerlink" title="XML 映射器"></a>XML 映射器</h1><p>SQL 映射文件只有很少的几个顶级元素（按照应被定义的顺序列出）：</p>
<ul>
<li><code>cache</code> – 该命名空间的缓存配置。</li>
<li><code>cache-ref</code> – 引用其它命名空间的缓存配置。</li>
<li><code>resultMap</code> – 描述如何从数据库结果集中加载对象，是最复杂也是最强大的元素。</li>
<li><code>sql</code> – 可被其它语句引用的可重用语句块。</li>
<li><code>insert</code> – 映射插入语句。</li>
<li><code>update</code> – 映射更新语句。</li>
<li><code>delete</code> – 映射删除语句。</li>
<li><code>select</code> – 映射查询语句。</li>
</ul>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectBlog<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BlogResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        select * from Blog where id = #&#123;id&#125;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- 常见参数含义 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectBlog<span class="token punctuation">"</span></span>              <span class="token attr-name">&lt;!--</span> <span class="token attr-name">SQL</span> <span class="token attr-name">语句的唯一标识符，用于在</span> <span class="token attr-name">MyBatis</span> <span class="token attr-name">中引用这个语句</span> <span class="token attr-name">--</span><span class="token punctuation">></span></span>
  parameterType="int"            <span class="token comment">&lt;!-- 输入参数的类型，这里是 int 类型 --></span>
  resultType="hashmap"           <span class="token comment">&lt;!-- 结果集的类型，这里是 HashMap --></span>
  resultMap="BlogResultMap"    <span class="token comment">&lt;!-- 结果映射的 ID，用于复杂的结果集映射 --></span>
  flushCache="false"             <span class="token comment">&lt;!-- 是否在执行该语句时刷新缓存，默认值为 false --></span>
  useCache="true"                <span class="token comment">&lt;!-- 是否启用二级缓存，默认值为 true --></span>
  timeout="10"                   <span class="token comment">&lt;!-- SQL 语句的超时时间，单位为秒 --></span>
  fetchSize="256"                <span class="token comment">&lt;!-- 提示驱动程序每次批量返回的行数 --></span>
  statementType="PREPARED"       <span class="token comment">&lt;!-- SQL 语句的类型，可以是 STATEMENT、PREPARED 或 CALLABLE --></span>
  resultSetType="FORWARD_ONLY">  <span class="token comment">&lt;!-- 结果集的类型，可以是 FORWARD_ONLY、SCROLL_SENSITIVE 或 SCROLL_INSENSITIVE --></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="insert-update-和-delete"><a href="#insert-update-和-delete" class="headerlink" title="insert, update 和 delete"></a>insert, update 和 delete</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>insertAuthor<span class="token punctuation">"</span></span>              <span class="token attr-name">&lt;!--</span> <span class="token attr-name">SQL</span> <span class="token attr-name">语句的唯一标识符，用于在</span> <span class="token attr-name">MyBatis</span> <span class="token attr-name">中引用这个语句</span> <span class="token attr-name">--</span><span class="token punctuation">></span></span>
  parameterType="domain.blog.Author"  <span class="token comment">&lt;!-- 输入参数的类型，这里是 domain.blog.Author 类 --></span>
  flushCache="true"              <span class="token comment">&lt;!-- 是否在执行该语句时刷新缓存，默认值为 true --></span>
  statementType="PREPARED"       <span class="token comment">&lt;!-- SQL 语句的类型，可以是 STATEMENT、PREPARED 或 CALLABLE，默认值为 PREPARED --></span>
  keyProperty=""                 <span class="token comment">&lt;!-- （可选）指定生成的主键将被设置到的属性名 --></span>
  keyColumn=""                   <span class="token comment">&lt;!-- （可选）指定数据库中生成的主键列名 --></span>
  useGeneratedKeys=""            <span class="token comment">&lt;!-- （可选）是否使用 JDBC 的 getGeneratedKeys 方法获取主键，默认值为 false --></span>
  timeout="20">                  <span class="token comment">&lt;!-- SQL 语句的超时时间，单位为秒，默认值取决于数据库驱动程序 --></span>
    <span class="token comment">&lt;!-- SQL 插入语句 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updateAuthor<span class="token punctuation">"</span></span>              <span class="token attr-name">&lt;!--</span> <span class="token attr-name">SQL</span> <span class="token attr-name">语句的唯一标识符，用于在</span> <span class="token attr-name">MyBatis</span> <span class="token attr-name">中引用这个语句</span> <span class="token attr-name">--</span><span class="token punctuation">></span></span>
  parameterType="domain.blog.Author"  <span class="token comment">&lt;!-- 输入参数的类型，这里是 domain.blog.Author 类 --></span>
  flushCache="true"              <span class="token comment">&lt;!-- 是否在执行该语句时刷新缓存，默认值为 true --></span>
  statementType="PREPARED"       <span class="token comment">&lt;!-- SQL 语句的类型，可以是 STATEMENT、PREPARED 或 CALLABLE，默认值为 PREPARED --></span>
  timeout="20">                  <span class="token comment">&lt;!-- SQL 语句的超时时间，单位为秒，默认值取决于数据库驱动程序 --></span>
    <span class="token comment">&lt;!-- SQL 更新语句 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span>
  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>deleteAuthor<span class="token punctuation">"</span></span>              <span class="token attr-name">&lt;!--</span> <span class="token attr-name">SQL</span> <span class="token attr-name">语句的唯一标识符，用于在</span> <span class="token attr-name">MyBatis</span> <span class="token attr-name">中引用这个语句</span> <span class="token attr-name">--</span><span class="token punctuation">></span></span>
  parameterType="domain.blog.Author"  <span class="token comment">&lt;!-- 输入参数的类型，这里是 domain.blog.Author 类 --></span>
  flushCache="true"              <span class="token comment">&lt;!-- 是否在执行该语句时刷新缓存，默认值为 true --></span>
  statementType="PREPARED"       <span class="token comment">&lt;!-- SQL 语句的类型，可以是 STATEMENT、PREPARED 或 CALLABLE，默认值为 PREPARED --></span>
  timeout="20">                  <span class="token comment">&lt;!-- SQL 语句的超时时间，单位为秒，默认值取决于数据库驱动程序 --></span>
    <span class="token comment">&lt;!-- SQL 删除语句 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><p>定义可重用的 SQL 代码片段，以便在其它语句中使用</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sql</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userColumns<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> $&#123;alias&#125;.id,$&#123;alias&#125;.username,$&#123;alias&#125;.password <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sql</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUsers<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  select
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userColumns<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alias<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>,
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userColumns<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alias<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>
  from some_table t1
    cross join some_table t2
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>对于大多数简单的使用场景，都不需要使用复杂的参数</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUsers<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  select id, username, password
  from users
  where id = #&#123;id&#125;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> JDBC 要求，如果一个列允许使用 null 值，并且会使用值为 null 的参数，就必须要指定 JDBC 类型（jdbcType)。</p>
<h2 id="字符串替换"><a href="#字符串替换" class="headerlink" title="字符串替换"></a>字符串替换</h2><p>默认情况下，使用 <code>#&#123;&#125;</code> 参数语法时，MyBatis 会创建 <code>PreparedStatement</code> 参数占位符，并通过占位符安全地设置参数（就像使用 ? 一样）。</p>
<p>有时你就是想直接在 SQL 语句中直接插入一个不转义的字符串。 比如 ORDER BY 子句，这时候你可以</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- MyBatis 就不会修改或转义该字符串了,用这种方式接受用户的输入，并用作语句参数是不安全的，会导致潜在的 SQL 注入攻击</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> $&#123;columnName&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="结果映射"><a href="#结果映射" class="headerlink" title="结果映射"></a>结果映射</h2><h3 id="resultType"><a href="#resultType" class="headerlink" title="resultType"></a>resultType</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUsers<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.someapp.model.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  select id, username, hashedPassword
  from some_table
  where id = #&#123;id&#125;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>someapp<span class="token punctuation">.</span>model</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> hashedPassword<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="resultMap"><a href="#resultMap" class="headerlink" title="resultMap"></a>resultMap</h3><p>解决数据库列名和实体类属性名不一致。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_id<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hashed_password<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUsers<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  select user_id, user_name, hashed_password
  from some_table
  where id = #&#123;id&#125;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="association"><a href="#association" class="headerlink" title="association"></a>association</h3><p><code>association</code>用于处理一对一的关系。它通常用于映射一个对象内部的另一个对象。</p>
<p><strong>示例</strong></p>
<p>我们有两个表：<code>User</code> 和 <code>Address</code>，其中每个用户都有一个地址。</p>
<p><strong>表结构</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">User</span> <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    address_id <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Address <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    street <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    city <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>实体类：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> street<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>mybatis映射文件</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Address<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>street<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>street<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>city<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>city<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUser<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT u.id, u.name, a.id AS address_id, a.street, a.city
        FROM User u
        LEFT JOIN Address a ON u.address_id = a.id
        WHERE u.id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>property</strong>：Java 对象中的属性名。</li>
<li><strong>javaType</strong>：关联的 Java 类型。</li>
<li><strong>column</strong>：数据库中的列名。</li>
<li><strong>id</strong> 和 <strong>result</strong>：分别用于映射主键和普通字段。</li>
</ul>
<h3 id="collection"><a href="#collection" class="headerlink" title="collection"></a>collection</h3><p>用于处理一对多的关系。它通常用于映射一个对象内部的集合。</p>
<p><strong>示例</strong></p>
<p>假设我们有两个表：<code>Order</code> 和 <code>OrderItem</code>，其中每个订单都有多个订单项。</p>
<p><strong>表结构</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>Order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> OrderItem <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    product_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    quantity <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>实体类</strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">></span></span> orderItems<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderItem</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> orderId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>MyBatis 映射文件</strong>：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.OrderMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OrderResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Order<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userId<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orderItems<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.OrderItem<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orderId<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>productName<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product_name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>quantity<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>quantity<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectOrder<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OrderResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT o.id, o.user_id, i.id AS item_id, i.order_id, i.product_name, i.quantity
        FROM `Order` o
        LEFT JOIN OrderItem i ON o.id = i.order_id
        WHERE o.id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>property</strong>：Java 对象中的集合属性名。</li>
<li><strong>ofType</strong>：集合中元素的 Java 类型。</li>
<li><strong>column</strong>：数据库中的列名。</li>
<li><strong>id</strong> 和 <strong>result</strong>：分别用于映射主键和普通字段。</li>
</ul>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>在 MyBatis 中，除了使用 <code>&lt;result&gt;</code> 元素将查询结果映射到 Java 对象的属性外，还可以使用构造函数来进行映射。</p>
<p><strong>示例</strong></p>
<p>我们有一个 <code>Book</code> 类，它只有一个带参数的构造函数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> author<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> price<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>数据库表结构</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> books <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    author <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    price <span class="token keyword">DOUBLE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Mybatis映射文件</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.BookMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BookResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>idArg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Integer<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Double<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectById<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BookResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        select id,title,author,price from books where id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Mapper接口</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BookMapper</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Books</span> <span class="token function">selectById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>使用 <code>&lt;constructor&gt;</code> 元素来定义构造函数参数的映射。</li>
<li><code>&lt;idArg&gt;</code> 用于映射主键参数，<code>&lt;arg&gt;</code> 用于映射其他参数。</li>
</ul>
<h3 id="鉴别器"><a href="#鉴别器" class="headerlink" title="鉴别器"></a>鉴别器</h3><p>鉴别器（Discriminator）用于处理多态结果映射，即根据某个列的值动态地选择不同的结果映射。这在处理继承关系或需要根据某个列的值映射到不同的类时非常有用。</p>
<p><strong>示例</strong></p>
<p>假设我们有一个 <code>Animal</code> 表，其中包含不同类型的动物（如猫和狗）。我们希望根据 <code>type</code> 列的值将结果映射到不同的类（<code>Cat</code> 或 <code>Dog</code>）。</p>
<p><strong>表结构</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> animals <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">type</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    breed <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    color <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>实体类</strong></p>
<p>我们有一个基类 <code>Animal</code>，以及两个子类 <code>Cat</code> 和 <code>Dog</code>。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> breed<span class="token punctuation">;</span>
    <span class="token class-name">String</span> color<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">String</span> breed<span class="token punctuation">,</span><span class="token class-name">String</span> color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>breed <span class="token operator">=</span> breed<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> breed<span class="token punctuation">;</span>
    <span class="token class-name">String</span> color<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">String</span> breed<span class="token punctuation">,</span><span class="token class-name">String</span> color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>breed <span class="token operator">=</span> breed<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Mapper接口</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AnimalMapper</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Animal</span><span class="token punctuation">></span></span> <span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>Mapper映射文件</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.AnimalMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AnimalResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Animal<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>discriminator</span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>String<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>type<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cat<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Cat<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>color<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dog<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Dog<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>color<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>breed<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>discriminator</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AnimalResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        select * from animals
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>使用 <code>&lt;discriminator&gt;</code> 元素来定义鉴别器。</li>
<li><code>javaType</code> 属性指定鉴别器列的 Java 类型。</li>
<li><code>column</code> 属性指定用于鉴别的列名。</li>
<li><code>&lt;case&gt;</code> 元素用于定义不同值对应的结果映射。</li>
</ul>
<h2 id="自动映射"><a href="#自动映射" class="headerlink" title="自动映射"></a>自动映射</h2><p>简单的场景下，MyBatis 可以为你自动映射查询结果，MyBatis会获取结果中返回的列名并在 Java 类中查找相同名字的属性（忽略大小写），但如果遇到复杂的场景，你需要构建一个结果映射，一般java遵循驼峰命名，数据库遵循_分割单词，为了让这两种自动映射需要在配置文件中开启驼峰命名。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- mybatis-config.xml --></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapUnderscoreToCamelCase<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>有三种自动映射等级：</p>
<ul>
<li><code>NONE</code> - 禁用自动映射。仅对手动映射的属性进行映射。</li>
<li><code>PARTIAL</code> - 对除在内部定义了嵌套结果映射（也就是连接的属性）以外的属性进行映射</li>
<li><code>FULL</code> - 自动映射所有属性。</li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>MyBatis 提供了两种类型的缓存机制：一级缓存（本地缓存）和二级缓存。一级缓存是默认启用的，而二级缓存需要进行额外的配置。</p>
<h3 id="一级缓存（本地缓存）"><a href="#一级缓存（本地缓存）" class="headerlink" title="一级缓存（本地缓存）"></a>一级缓存（本地缓存）</h3><p>一级缓存是 SqlSession 级别的缓存，它在同一个 SqlSession 中有效。MyBatis 默认启用一级缓存。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCacheLevel1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactoryByXml</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第一次查询，结果会被缓存</span>
            <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 第二次查询，MyBatis 会从SqlSession缓存中获取结果，而不是再次查询数据库</span>
            <span class="token class-name">User</span> user2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h3><p>二级缓存是 Mapper 映射级别的缓存，它在多个 SqlSession 之间共享。</p>
<h4 id="mybatis-config-xml"><a href="#mybatis-config-xml" class="headerlink" title="mybatis-config.xml"></a>mybatis-config.xml</h4><p>要启用二级缓存，需要进行以下配置：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置Mapper文件"><a href="#配置Mapper文件" class="headerlink" title="配置Mapper文件"></a>配置Mapper文件</h4><p>在 Mapper XML 文件中启用二级缓存：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span><span class="token punctuation">/></span></span>  <span class="token comment">&lt;!-- 开启2级缓存 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Address<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address_id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>street<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>street<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>city<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>city<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUser<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT u.id, u.name, a.id AS address_id, a.street, a.city
        FROM User u
        LEFT JOIN Address a ON u.address_id = a.id
        WHERE u.id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="实体类实现-Serializable-接口"><a href="#实体类实现-Serializable-接口" class="headerlink" title="实体类实现 Serializable 接口"></a>实体类实现 Serializable 接口</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置缓存策略"><a href="#配置缓存策略" class="headerlink" title="配置缓存策略"></a>配置缓存策略</h4><p>通过 <code>&lt;cache&gt;</code> 元素配置缓存策略，例如设置缓存大小、刷新间隔等</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span>
    <span class="token attr-name">eviction</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LRU<span class="token punctuation">"</span></span>
    <span class="token attr-name">flushInterval</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span>
    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>512<span class="token punctuation">"</span></span>
    <span class="token attr-name">readOnly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>eviction</strong>：缓存回收策略，默认值是 LRU（最近最少使用）。</li>
<li><strong>flushInterval</strong>：刷新间隔，单位是毫秒。</li>
<li><strong>size</strong>：缓存大小，表示可以缓存的对象数目。</li>
<li><strong>readOnly</strong>：只读属性，默认值是 <code>false</code>。</li>
</ul>
<h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCacheLevel2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第一次查询，结果会被缓存</span>
            <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第二次查询，从缓存中查找数据</span>
            <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="动态-SQL"><a href="#动态-SQL" class="headerlink" title="动态 SQL"></a>动态 SQL</h1><p>MyBatis 动态 SQL 是 MyBatis 提供的一种强大功能，用于在运行时动态生成 SQL 语句。动态 SQL 语句可以根据不同的条件生成不同的 SQL 语句，从而提高 SQL 的灵活性和可维护性。</p>
<ul>
<li>if</li>
<li>choose (when, otherwise)</li>
<li>trim (where, set)</li>
<li>foreach</li>
</ul>
<h2 id="lt-if-gt-标签"><a href="#lt-if-gt-标签" class="headerlink" title="&lt;if&gt; 标签"></a><code>&lt;if&gt;</code> 标签</h2><p>根据用户的名字和id动态查询用户</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUserByIdAndName<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT u.id, u.name, a.id AS address_id, a.street, a.city
        FROM User u
        LEFT JOIN Address a ON u.address_id = a.id
        WHERE 1 = 1
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id != null<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
            and u.id = #&#123;id&#125;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name != null<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
            and u.name = #&#123;name&#125;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testIfLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactoryByXml</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUserByIdAndName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"John Doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">User</span> user2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUserByIdAndName</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="lt-choose-gt-、-lt-when-gt-和-lt-otherwise-gt-标签"><a href="#lt-choose-gt-、-lt-when-gt-和-lt-otherwise-gt-标签" class="headerlink" title="&lt;choose&gt;、&lt;when&gt; 和 &lt;otherwise&gt; 标签"></a><code>&lt;choose&gt;</code>、<code>&lt;when&gt;</code> 和 <code>&lt;otherwise&gt;</code> 标签</h2><p><code>&lt;choose&gt;</code> 标签用于实现类似于 Java 中的 <code>switch</code> 语句的功能，<code>&lt;when&gt;</code> 和 <code>&lt;otherwise&gt;</code> 标签用于定义条件分支。根据不通条件查询用户</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectUserByIdOrName<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT u.id, u.name, a.id AS address_id, a.street, a.city
        FROM User u
        LEFT JOIN Address a ON u.address_id = a.id
        WHERE 1 = 1
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>choose</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                and u.id = #&#123;id&#125;
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                and u.name = #&#123;name&#125;
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>otherwise</span><span class="token punctuation">></span></span>
                and 1 = 0
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>otherwise</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>choose</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChoiceLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactoryByXml</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">UserMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">User</span> user1 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUserByIdOrName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"John Doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">User</span> user2 <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectUserByIdOrName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2 <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="lt-trim-gt-、-lt-where-gt-和-lt-set-gt-标签"><a href="#lt-trim-gt-、-lt-where-gt-和-lt-set-gt-标签" class="headerlink" title="&lt;trim&gt;、&lt;where&gt; 和 &lt;set&gt; 标签"></a><code>&lt;trim&gt;</code>、<code>&lt;where&gt;</code> 和 <code>&lt;set&gt;</code> 标签</h2><ul>
<li><code>&lt;trim&gt;</code> 标签用于去除多余的前缀或后缀。</li>
<li><code>&lt;where&gt;</code> 标签用于自动处理 <code>WHERE</code> 子句中的条件。</li>
<li><code>&lt;set&gt;</code> 标签用于自动处理 <code>UPDATE</code> 语句中的 <code>SET</code> 子句。</li>
</ul>
<p>有一个 <code>Food</code> 表，希望根据不同的条件动态查询和更新食物信息。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectFood<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Food<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT id, name, category, price, available
        FROM foods
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefixOverrides</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AND | OR<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name != null and name != ''<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                     OR AND name = #&#123;name&#125;  <span class="token comment">&lt;!-- OR AND trim前缀标签会去除掉 --></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>category != null and category != ''<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    AND category = #&#123;category&#125;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price != null and price != ''<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    AND price = #&#123;price&#125;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>available != null and available != ''<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    AND available = #&#123;available&#125;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>

    <span class="token comment">&lt;!-- 动态更新食物信息 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updateFood<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        UPDATE foods
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    name = #&#123;name&#125;,
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>category != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    category = #&#123;category&#125;,
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    price = #&#123;price&#125;,
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>available != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    available = #&#123;available&#125;,, <span class="token comment">&lt;!-- ,, trim后缀标签会去除掉 --></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">></span></span>
        WHERE id = #&#123;id&#125;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><code>&lt;trim&gt;</code> 标签用于去除多余的前缀或后缀。</li>
<li><code>&lt;where&gt;</code> 标签自动处理 <code>WHERE</code> 子句中的条件。如果没有任何条件，它会去掉多余的 <code>WHERE</code> 关键字。</li>
<li><code>&lt;set&gt;</code> 标签用于自动处理 <code>UPDATE</code> 语句中的 <code>SET</code> 子句。</li>
</ol>
<h2 id="lt-foreach-gt-标签"><a href="#lt-foreach-gt-标签" class="headerlink" title="&lt;foreach&gt; 标签"></a><code>&lt;foreach&gt;</code> 标签</h2><p><code>&lt;foreach&gt;</code> 标签用于遍历集合，并生成相应的 SQL 片段。例如查询指定集合id的食物。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectFoodListById<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.tutorial.mybatis.pojo.Food<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT id, name, category, price, available
        FROM foods
        where id in 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>listId<span class="token punctuation">"</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(<span class="token punctuation">"</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            #&#123;id&#125;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>collection&#x3D;”list”：指定要遍历的集合是 <code>list</code>。使用@param注解指定</li>
<li>item&#x3D;”id”：指定集合中每个元素的变量名为 <code>id</code>。</li>
<li>index&#x3D;”index”：指定集合中每个元素的索引变量名为 <code>index</code>（可选）。</li>
<li>open&#x3D;”(“：指定生成的 SQL 片段的开头部分为 <code>(</code>。</li>
<li>close&#x3D;”)”：指定生成的 SQL 片段的结尾部分为 <code>)</code>。</li>
<li>separator&#x3D;”,”：指定生成的 SQL 片段中每个元素之间的分隔符为 <code>,</code>。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testForeachLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BuildSqlSessionFactoryByXml</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuildSqlSessionFactoryByXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">FoodMapper</span> mapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">FoodMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">></span></span> apple <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">selectFoodListById</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            apple<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="SQL语句构建器"><a href="#SQL语句构建器" class="headerlink" title="SQL语句构建器"></a>SQL语句构建器</h1><p>Java 程序员面对的最痛苦的事情之一就是在 Java 代码中嵌入 SQL 语句。这通常是因为需要动态生成 SQL 语句，不然我们可以将它们放到外部文件或者存储过程中。如你所见，MyBatis 在 XML 映射中具备强大的 SQL 动态生成能力。但有时，我们还是需要在 Java 代码里构建 SQL 语句。此时，MyBatis 有另外一个特性可以帮到你，让你从处理典型问题中解放出来，比如加号、引号、换行、格式化问题、嵌入条件的逗号管理及 AND 连接。确实，在 Java 代码中动态生成 SQL 代码真的就是一场噩梦。例如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT P.ID, P.USERNAME, P.PASSWORD, P.FULL_NAME, "</span>
<span class="token string">"P.LAST_NAME,P.CREATED_ON, P.UPDATED_ON "</span> <span class="token operator">+</span>
<span class="token string">"FROM PERSON P, ACCOUNT A "</span> <span class="token operator">+</span>
<span class="token string">"INNER JOIN DEPARTMENT D on D.ID = P.DEPARTMENT_ID "</span> <span class="token operator">+</span>
<span class="token string">"INNER JOIN COMPANY C on D.COMPANY_ID = C.ID "</span> <span class="token operator">+</span>
<span class="token string">"WHERE (P.ID = A.ID AND P.FIRST_NAME like ?) "</span> <span class="token operator">+</span>
<span class="token string">"OR (P.LAST_NAME like ?) "</span> <span class="token operator">+</span>
<span class="token string">"GROUP BY P.ID "</span> <span class="token operator">+</span>
<span class="token string">"HAVING (P.LAST_NAME like ?) "</span> <span class="token operator">+</span>
<span class="token string">"OR (P.FIRST_NAME like ?) "</span> <span class="token operator">+</span>
<span class="token string">"ORDER BY P.ID, P.FULL_NAME"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>MyBatis 3 提供了方便的工具类来帮助解决此问题。借助 SQL 类，我们只需要简单地创建一个实例，并调用它的方法即可生成 SQL 语句。让我们来用 SQL 类重写上面的例子：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">selectPersonSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
    <span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">"P.ID, P.USERNAME, P.PASSWORD, P.FULL_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME, P.CREATED_ON, P.UPDATED_ON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">"PERSON P"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">"ACCOUNT A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INNER_JOIN</span><span class="token punctuation">(</span><span class="token string">"DEPARTMENT D on D.ID = P.DEPARTMENT_ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INNER_JOIN</span><span class="token punctuation">(</span><span class="token string">"COMPANY C on D.COMPANY_ID = C.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.ID = A.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.FIRST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GROUP_BY</span><span class="token punctuation">(</span><span class="token string">"P.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAVING</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAVING</span><span class="token punctuation">(</span><span class="token string">"P.FIRST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ORDER_BY</span><span class="token punctuation">(</span><span class="token string">"P.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ORDER_BY</span><span class="token punctuation">(</span><span class="token string">"P.FULL_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><h2 id="日志架构"><a href="#日志架构" class="headerlink" title="日志架构"></a>日志架构</h2><p>Mybatis内置了slf4j日志门面，我们采用slf4j+logback的架构</p>
<h2 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h2><pre class="line-numbers language-pom.xml" data-language="pom.xml"><code class="language-pom.xml">&lt;!-- pom.xml --&gt;
&lt;!-- SLF4J API --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;&#x2F;artifactId&gt;
    &lt;version&gt;1.7.30&lt;&#x2F;version&gt;
&lt;&#x2F;dependency&gt;
&lt;!-- Logback Classic --&gt;
&lt;dependency&gt;
     &lt;groupId&gt;ch.qos.logback&lt;&#x2F;groupId&gt;
     &lt;artifactId&gt;logback-classic&lt;&#x2F;artifactId&gt;
     &lt;version&gt;1.2.3&lt;&#x2F;version&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="开启配置"><a href="#开启配置" class="headerlink" title="开启配置"></a>开启配置</h2><pre class="line-numbers language-mybatis.xml" data-language="mybatis.xml"><code class="language-mybatis.xml">&lt;!-- mybatis.xml 开启日志配置 --&gt;
&lt;settings&gt;
	&lt;setting name&#x3D;&quot;logImpl&quot; value&#x3D;&quot;SLF4J&quot;&#x2F;&gt;
&lt;&#x2F;settings&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><pre class="line-numbers language-logback.xml" data-language="logback.xml"><code class="language-logback.xml">&lt;!-- src&#x2F;main&#x2F;resources&#x2F;logback.xml 控制台日志--&gt;
&lt;configuration&gt;
    &lt;!-- Console Appender --&gt;
    &lt;appender name&#x3D;&quot;STDOUT&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss&#125; %-5level %logger&#123;36&#125; - %msg%n&lt;&#x2F;pattern&gt;
        &lt;&#x2F;encoder&gt;
    &lt;&#x2F;appender&gt;
    
    &lt;!-- Root Logger --&gt;
    &lt;root level&#x3D;&quot;debug&quot;&gt;
        &lt;appender-ref ref&#x3D;&quot;STDOUT&quot; &#x2F;&gt;
    &lt;&#x2F;root&gt;
    &lt;!-- MyBatis Logger --&gt;
    &lt;logger name&#x3D;&quot;com.tutorial.mybatis&quot; level&#x3D;&quot;debug&quot; &#x2F;&gt;
&lt;&#x2F;configuration&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/Software%20cracking.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/Software%20cracking.html" itemprop="url">软件破解</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Typro破解"><a href="#Typro破解" class="headerlink" title="Typro破解"></a>Typro破解</h1><blockquote>
<p>亲测几个版本都有效，主要破解方式为修改注册表，不要给typro检测注册表修改的权限就可以了</p>
</blockquote>
<p>1.通过win+r,输入regedit打开注册表</p>
<img src="https://telegraph-image-2ni.pages.dev/file/6ac2175e435ab73248b76.png" style="zoom:50%;">

<p>2.根据图上的路径，找到Typro</p>
<img src="https://telegraph-image-2ni.pages.dev/file/68fce7738c28d8017a590.png" style="zoom:33%;">

<p>3.在注册表编辑器中，双击修改IDate的值,将其改为一个未来日期。比如2099-01-01。这样就可以试用Typora到2099-01-01。</p>
<img src="https://telegraph-image-2ni.pages.dev/file/c8c93f58d4cabd60e3eed.png" style="zoom:50%;">

<p>4.修改管理员的访问权限，typro就不会检测到修改过注册表了</p>
<img src="https://telegraph-image-2ni.pages.dev/file/2c9493624aaf44e0908c4.png" style="zoom:33%;">

<p>5.执行完第四步后，点击应用和确认，直接就可以打开typro了</p>
<h1 id="Navicat破解"><a href="#Navicat破解" class="headerlink" title="Navicat破解"></a>Navicat破解</h1><blockquote>
<p>无限试用bat脚本</p>
</blockquote>
<pre class="line-numbers language-bat" data-language="bat"><code class="language-bat">@echo off

echo Delete HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPremium\Registration[version and language]
for &#x2F;f %%i in (&#39;&quot;REG QUERY &quot;HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPremium&quot; &#x2F;s | findstr &#x2F;L Registration&quot;&#39;) do (
    reg delete %%i &#x2F;va &#x2F;f
)
echo.

echo Delete Info folder under HKEY_CURRENT_USER\Software\Classes\CLSID
for &#x2F;f %%i in (&#39;&quot;REG QUERY &quot;HKEY_CURRENT_USER\Software\Classes\CLSID&quot; &#x2F;s | findstr &#x2F;E Info&quot;&#39;) do (
    reg delete %%i &#x2F;va &#x2F;f
)
echo.

echo Finish

pause<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/Redis%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/Redis%E5%AE%9E%E8%B7%B5.html" itemprop="url">Redis实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><h2 id="Redis介绍"><a href="#Redis介绍" class="headerlink" title="Redis介绍"></a>Redis介绍</h2><blockquote>
<p>Redis（Remote Dictionary Server）是一个开源的内存数据结构存储系统，广泛用于缓存、消息队列、实时分析等场景。它支持多种数据结构，如字符串、哈希、列表、集合、有序集合、位图、HyperLogLog、地理空间和流。</p>
</blockquote>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li><strong>高性能</strong>：Redis将数据存储在内存中，读写速度非常快，适合高并发场景。</li>
<li><strong>丰富的数据结构</strong>：支持多种数据结构，能够满足各种复杂的数据操作需求。</li>
<li><strong>持久化</strong>：支持RDB和AOF两种持久化方式，保证数据的可靠性。</li>
<li><strong>高可用性</strong>：支持主从复制、哨兵模式和集群模式，能够实现高可用性和数据冗余。</li>
<li><strong>简单易用</strong>：提供了丰富的命令和客户端库，开发者可以方便地进行操作。</li>
</ol>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol>
<li><strong>内存消耗大</strong>：由于数据存储在内存中，内存消耗较大，存储大量数据时成本较高。</li>
<li><strong>持久化性能影响</strong>：虽然支持持久化，但在高并发写入场景下，持久化操作可能会影响性能。</li>
<li><strong>单线程模型</strong>：Redis 的单线程模型虽然简化了设计，但在某些多核 CPU 场景下可能无法充分利用硬件资源。</li>
<li><strong>数据一致性</strong>：在主从复制和集群模式下，可能会有短暂的数据不一致问题。</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="官方snapd商店安装"><a href="#官方snapd商店安装" class="headerlink" title="官方snapd商店安装"></a>官方snapd商店安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> epel-release <span class="token parameter variable">-y</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> snapd <span class="token parameter variable">-y</span> 
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> snapd.socket 
<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /var/lib/snapd/snap /snap
<span class="token function">sudo</span> snap <span class="token function">install</span> redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="官方源码安装-推荐"><a href="#官方源码安装-推荐" class="headerlink" title="官方源码安装[推荐]"></a>官方源码安装[推荐]</h3><p>1.安装阿里源</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CentOS 7</span>
<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
<span class="token comment"># 安装编译器</span>
yum <span class="token function">install</span> gcc-c++ <span class="token parameter variable">-y</span>
<span class="token comment"># 下载源码</span>
<span class="token function">wget</span> https://download.redis.io/redis-stable.tar.gz
<span class="token comment"># 编译redis</span>
<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> redis-stable.tar.gz
<span class="token builtin class-name">cd</span> redis-stable
<span class="token function">make</span>
<span class="token comment"># 安装生成的可执行文件</span>
<span class="token function">make</span> <span class="token function">install</span>
<span class="token comment"># 启动redis</span>
redis-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><p><strong>SET 命令</strong></p>
<blockquote>
<p>将指定的键设置为指定的值。如果键已经存在，则覆盖旧值。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
SET key value
<span class="token comment"># 示例</span>
SET mykey <span class="token string">"Hello, Redis!"</span>
<span class="token comment"># EX seconds：设置键的过期时间（秒）</span>
SET mykey <span class="token string">"Hello, Redis!"</span> EX <span class="token number">10</span>
<span class="token comment"># PX milliseconds：设置键的过期时间（毫秒）</span>
SET mykey <span class="token string">"Hello, Redis!"</span> PX <span class="token number">10000</span>
<span class="token comment"># NX：仅在键不存在时设置键的值</span>
SET mykey <span class="token string">"Hello, Redis!"</span> NX
<span class="token comment"># XX：仅在键已经存在时设置键的值</span>
SET mykey <span class="token string">"Hello, Redis!"</span> XX<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>GET 命令</strong></p>
<blockquote>
<p>获取指定键的值。如果键不存在，返回nil</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
GET key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>DEL 命令</strong></p>
<blockquote>
<p>删除指定的键。如果键不存在，忽略该命令。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
DEL key
DEL key1 key2 key3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>EXPIRE 命令</strong></p>
<blockquote>
<p>设置键的过期时间（秒）。当键过期时，它会被自动删除。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
EXPIRE key seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>KEYS 命令</strong></p>
<blockquote>
<p>查找所有符合给定模式的键。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
KEYS pattern
<span class="token comment"># 示例</span>
KEYS *
KEYS user:*
KEYS *name*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>EXISTS 命令</strong></p>
<blockquote>
<p>检查一个或多个键是否存在。返回存在的键的数量。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
EXISTS key
EXISTS key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>TTL 命令</strong></p>
<blockquote>
<p>获取键的剩余生存时间（秒）。如果键不存在或没有设置过期时间，返回 <code>-1</code>。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
TTL key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>INCR 命令</strong></p>
<blockquote>
<p>将键的值加1。如果键不存在，则将键的值初始化为0，然后执行加1操作。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
INCR key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>DECR 命令</strong></p>
<blockquote>
<p>将键的值减1。如果键不存在，则将键的值初始化为0，然后执行减1操作。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
DECR key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="数据结构操作命令"><a href="#数据结构操作命令" class="headerlink" title="数据结构操作命令"></a>数据结构操作命令</h2><h3 id="String（字符串）"><a href="#String（字符串）" class="headerlink" title="String（字符串）"></a>String（字符串）</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>字符串是Redis中最简单的类型，可以存储任何形式的字符串值，包括数字、字节数组等。字符串值最多可以达到512MB。</p>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>缓存</strong>：网页内容缓存，提高访问速度。</li>
<li><strong>计数器</strong>：记录网站访问次数。</li>
<li><strong>会话管理</strong>：存储用户会话信息。</li>
<li><strong>简单的键值存储</strong>：存储用户信息。</li>
</ul>
<h4 id="常用命令及参数"><a href="#常用命令及参数" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>SET key value</code>：设置指定key的值。</li>
<li><code>GET key</code>：获取指定key的值。</li>
<li><code>INCR key</code>：将指定key的值加1。</li>
</ul>
<h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisStringExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 缓存网页内容</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"page:home"</span><span class="token punctuation">,</span> <span class="token string">"&lt;html>...&lt;/html>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计数器</span>
        jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">"page_views"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> pageViews <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"page_views"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Page views: "</span> <span class="token operator">+</span> pageViews<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：1</span>
        <span class="token comment">// 会话管理</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"session:user123"</span><span class="token punctuation">,</span> <span class="token string">"session_data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 简单的键值存储</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user:1001:username"</span><span class="token punctuation">,</span> <span class="token string">"john_doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user:1001:username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：john_doe</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Hash（哈希）"><a href="#Hash（哈希）" class="headerlink" title="Hash（哈希）"></a>Hash（哈希）</h3><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>哈希是一个键值对集合，特别适用于存储对象。哈希可以高效地存储和访问对象的多个字段。</p>
<h4 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>存储对象</strong>：例如用户信息。</li>
<li><strong>配置项</strong>：存储应用程序配置。</li>
</ul>
<h4 id="常用命令及参数-1"><a href="#常用命令及参数-1" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>HSET key field value</code>：设置哈希表中指定字段的值。</li>
<li><code>HGET key field</code>：获取哈希表中指定字段的值。</li>
<li><code>HGETALL key</code>：获取哈希表中所有字段的值。</li>
</ul>
<h4 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisHashExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存储用户信息</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"user:1000"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"user:1000"</span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">,</span> <span class="token string">"alice@example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取用户信息</span>
        <span class="token class-name">String</span> userName <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"user:1000"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userEmail <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"user:1000"</span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：Alice</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：alice@example.com</span>
        <span class="token comment">// 存储配置项</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"theme"</span><span class="token punctuation">,</span> <span class="token string">"dark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token string">"1.2.3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取配置项</span>
        <span class="token class-name">String</span> theme <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"theme"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> version <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Theme: "</span> <span class="token operator">+</span> theme<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：dark</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Version: "</span> <span class="token operator">+</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：1.2.3</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="List（列表）"><a href="#List（列表）" class="headerlink" title="List（列表）"></a>List（列表）</h3><h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><p>列表是一个链表，可以从两端进行高效操作。适用于需要按顺序访问元素的场景。</p>
<h4 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>消息队列</strong>：实现简单的消息队列系统。</li>
<li><strong>任务列表</strong>：存储待处理的任务。</li>
<li><strong>最新消息</strong>：存储按时间顺序的消息。</li>
</ul>
<h4 id="常用命令及参数-2"><a href="#常用命令及参数-2" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>LPUSH key value</code>：将一个值插入到列表头部。</li>
<li><code>RPUSH key value</code>：将一个值插入到列表尾部。</li>
<li><code>RPOP key</code>：移除并返回列表的最后一个元素。</li>
<li><code>LRANGE key start stop</code>：获取列表在指定范围内的元素。</li>
</ul>
<h4 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisListExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实现消息队列</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"message_queue"</span><span class="token punctuation">,</span> <span class="token string">"message1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"message_queue"</span><span class="token punctuation">,</span> <span class="token string">"message2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从队列中取出消息</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">rpop</span><span class="token punctuation">(</span><span class="token string">"message_queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Message: "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：message1</span>
        <span class="token comment">// 存储待处理的任务</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"task_list"</span><span class="token punctuation">,</span> <span class="token string">"task1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"task_list"</span><span class="token punctuation">,</span> <span class="token string">"task2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取待处理的任务</span>
        <span class="token class-name">String</span> task <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">rpop</span><span class="token punctuation">(</span><span class="token string">"task_list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Task: "</span> <span class="token operator">+</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：task1</span>
        <span class="token comment">// 存储最新消息</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"news_feed"</span><span class="token punctuation">,</span> <span class="token string">"news1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"news_feed"</span><span class="token punctuation">,</span> <span class="token string">"news2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取最新消息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> newsFeed <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">"news_feed"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> news <span class="token operator">:</span> newsFeed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"News: "</span> <span class="token operator">+</span> news<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：news2, news1</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h3><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><p>集合是无序的唯一元素集合，提供高效的成员检查和去重功能。</p>
<h4 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>标签</strong>：存储用户的兴趣标签。</li>
<li><strong>唯一性检查</strong>：检查某个元素是否存在。</li>
<li><strong>共同好友</strong>：找出共同好友。</li>
<li><strong>去重</strong>：去除重复数据。</li>
</ul>
<h4 id="常用命令及参数-3"><a href="#常用命令及参数-3" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>SADD key member</code>：向集合添加一个或多个成员。</li>
<li><code>SISMEMBER key member</code>：判断成员是否是集合的成员。</li>
<li><code>SMEMBERS key</code>：返回集合中的所有成员。</li>
</ul>
<h4 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSetExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存储用户的兴趣标签</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"user:1000:tags"</span><span class="token punctuation">,</span> <span class="token string">"music"</span><span class="token punctuation">,</span> <span class="token string">"sports"</span><span class="token punctuation">,</span> <span class="token string">"travel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查标签是否存在</span>
        <span class="token keyword">boolean</span> isTagExist <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">sismember</span><span class="token punctuation">(</span><span class="token string">"user:1000:tags"</span><span class="token punctuation">,</span> <span class="token string">"music"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Is tag 'music' exist: "</span> <span class="token operator">+</span> isTagExist<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：true</span>
        <span class="token comment">// 获取所有标签</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tags <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">smembers</span><span class="token punctuation">(</span><span class="token string">"user:1000:tags"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> tag <span class="token operator">:</span> tags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Tag: "</span> <span class="token operator">+</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：music, sports, travel</span>
        <span class="token comment">// 存储用户1和用户2的朋友列表</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"user:1:friends"</span><span class="token punctuation">,</span> <span class="token string">"user2"</span><span class="token punctuation">,</span> <span class="token string">"user3"</span><span class="token punctuation">,</span> <span class="token string">"user4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"user:2:friends"</span><span class="token punctuation">,</span> <span class="token string">"user3"</span><span class="token punctuation">,</span> <span class="token string">"user4"</span><span class="token punctuation">,</span> <span class="token string">"user5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 找出共同好友</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> commonFriends <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">sinter</span><span class="token punctuation">(</span><span class="token string">"user:1:friends"</span><span class="token punctuation">,</span> <span class="token string">"user:2:friends"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> friend <span class="token operator">:</span> commonFriends<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Common friend: "</span> <span class="token operator">+</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：user3, user4</span>
        <span class="token comment">// 去除重复数据</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"duplicates"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> uniqueElements <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">smembers</span><span class="token punctuation">(</span><span class="token string">"duplicates"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element <span class="token operator">:</span> uniqueElements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unique element: "</span> <span class="token operator">+</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：1, 2, 3, 4</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Sorted-Set（有序集合）"><a href="#Sorted-Set（有序集合）" class="headerlink" title="Sorted Set（有序集合）"></a>Sorted Set（有序集合）</h3><h4 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h4><p>有序集合是带有分数的集合，集合中的元素是有序的。适用于需要按权重排序的场景。</p>
<h4 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>排行榜</strong>：实现游戏的排行榜。</li>
<li><strong>延迟队列</strong>：存储带有时间戳的任务。</li>
<li><strong>按评分排序</strong>：存储商品列表。</li>
</ul>
<h4 id="常用命令及参数-4"><a href="#常用命令及参数-4" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>ZADD key score member</code>：向有序集合添加一个成员，或者更新已存在成员的分数。</li>
<li><code>ZREM key member</code>：移除有序集合中的一个成员。</li>
<li><code>ZRANGE key start stop [WITHSCORES]</code>：</li>
</ul>
<h4 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSortedSetExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 		<span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实现游戏的排行榜</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取排行榜</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">></span></span> leaderboard <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrevrangeWithScores</span><span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple</span> tuple <span class="token operator">:</span> leaderboard<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：Bob: 200.0, Alice: 100.0</span>
        <span class="token comment">// 存储带有时间戳的任务</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"task_queue"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"task1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"task_queue"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"task2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取任务列表</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tasks <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrange</span><span class="token punctuation">(</span><span class="token string">"task_queue"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> task <span class="token operator">:</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Task: "</span> <span class="token operator">+</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：task1, task2</span>
        <span class="token comment">// 存储按评分排序的商品列表</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">,</span> <span class="token number">9.8</span><span class="token punctuation">,</span> <span class="token string">"ProductA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">,</span> <span class="token number">8.6</span><span class="token punctuation">,</span> <span class="token string">"ProductB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取商品列表</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">></span></span> products <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrangeWithScores</span><span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple</span> product <span class="token operator">:</span> products<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：ProductB: 8.6, ProductA: 9.8</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Bitmap（位图）"><a href="#Bitmap（位图）" class="headerlink" title="Bitmap（位图）"></a>Bitmap（位图）</h3><h4 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h4><p>位图是对字符串类型的进一步扩展，提供按位操作，适用于大规模数据的快速统计。</p>
<h4 id="应用场景-5"><a href="#应用场景-5" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>用户签到</strong>：记录用户每天的签到情况。</li>
<li><strong>统计</strong>：统计某个时间段内的活跃用户。</li>
<li><strong>布隆过滤器</strong>：用于快速判断某个元素是否存在。</li>
</ul>
<h4 id="常用命令及参数-5"><a href="#常用命令及参数-5" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>SETBIT key offset value</code>：对key指定偏移量上的位进行设置。</li>
<li><code>GETBIT key offset</code>：对key指定偏移量上的位进行获取。</li>
<li><code>BITCOUNT key [start end]</code>：统计字符串被设置为1的bit数。</li>
</ul>
<h4 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisBitmapExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录用户签到</span>
        jedis<span class="token punctuation">.</span><span class="token function">setbit</span><span class="token punctuation">(</span><span class="token string">"user:1000:checkin"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">setbit</span><span class="token punctuation">(</span><span class="token string">"user:1000:checkin"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查用户是否签到</span>
        <span class="token keyword">boolean</span> isCheckedInDay1 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">getbit</span><span class="token punctuation">(</span><span class="token string">"user:1000:checkin"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isCheckedInDay2 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">getbit</span><span class="token punctuation">(</span><span class="token string">"user:1000:checkin"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Day 1 check-in: "</span> <span class="token operator">+</span> isCheckedInDay1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：true</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Day 2 check-in: "</span> <span class="token operator">+</span> isCheckedInDay2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：true</span>
        <span class="token comment">// 统计签到次数</span>
        <span class="token keyword">long</span> checkinCount <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">bitcount</span><span class="token punctuation">(</span><span class="token string">"user:1000:checkin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Check-in count: "</span> <span class="token operator">+</span> checkinCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：2</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h3><h4 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h4><p>HyperLogLog是基数估计算法，可以在低内存消耗下进行大规模基数统计，适用于去重统计。</p>
<h4 id="应用场景-6"><a href="#应用场景-6" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>基数统计</strong>：统计网站的独立访问用户数（UV）。</li>
</ul>
<h4 id="常用命令及参数-6"><a href="#常用命令及参数-6" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>PFADD key element [element ...]</code>：将元素添加到HyperLogLog中。</li>
<li><code>PFCOUNT key</code>：返回HyperLogLog的基数估算值。</li>
</ul>
<h4 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisHyperLogLogExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加独立访问用户</span>
        jedis<span class="token punctuation">.</span><span class="token function">pfadd</span><span class="token punctuation">(</span><span class="token string">"unique_visitors"</span><span class="token punctuation">,</span> <span class="token string">"user1"</span><span class="token punctuation">,</span> <span class="token string">"user2"</span><span class="token punctuation">,</span> <span class="token string">"user3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取独立访问用户数</span>
        <span class="token keyword">long</span> uvCount <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pfcount</span><span class="token punctuation">(</span><span class="token string">"unique_visitors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unique visitors: "</span> <span class="token operator">+</span> uvCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：3</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Geo（地理空间）"><a href="#Geo（地理空间）" class="headerlink" title="Geo（地理空间）"></a>Geo（地理空间）</h3><h4 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h4><p>地理空间类型允许存储地理位置数据，并提供半径查询功能，适用于地理位置存储与查询。</p>
<h4 id="应用场景-7"><a href="#应用场景-7" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>存储地理位置</strong>：存储用户或商家的地理位置。</li>
<li><strong>查询附近的用户或商家</strong>：实现“附近的人”或“附近的商家”功能。</li>
</ul>
<h4 id="常用命令及参数-7"><a href="#常用命令及参数-7" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>GEOADD key longitude latitude member</code>：将地理空间位置（纬度、经度、名称）添加到指定的key中。</li>
<li><code>GEORADIUS key longitude latitude radius unit</code>：以给定的经纬度为中心，返回指定半径范围内的地理位置。</li>
</ul>
<h4 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisGeoExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加地理位置</span>
        jedis<span class="token punctuation">.</span><span class="token function">geoadd</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">13.361389</span><span class="token punctuation">,</span> <span class="token number">38.115556</span><span class="token punctuation">,</span> <span class="token string">"Palermo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">geoadd</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">15.087269</span><span class="token punctuation">,</span> <span class="token number">37.502669</span><span class="token punctuation">,</span> <span class="token string">"Catania"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询附近位置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> nearby <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">georadius</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"km"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> location <span class="token operator">:</span> nearby<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Nearby location: "</span> <span class="token operator">+</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：Catania, Palermo</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Stream（流）"><a href="#Stream（流）" class="headerlink" title="Stream（流）"></a>Stream（流）</h3><h4 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h4><p>流是一种日志结构数据类型，可以添加和读取数据项，适用于实时数据流处理。</p>
<h4 id="应用场景-8"><a href="#应用场景-8" class="headerlink" title="应用场景"></a>应用场景</h4><ul>
<li><strong>实时数据流处理</strong>：处理传感器数据。</li>
<li><strong>日志收集</strong>：收集和处理日志数据。</li>
<li><strong>消息队列</strong>：实现复杂的消息队列系统。</li>
</ul>
<h4 id="常用命令及参数-8"><a href="#常用命令及参数-8" class="headerlink" title="常用命令及参数"></a>常用命令及参数</h4><ul>
<li><code>XADD key ID field value [field value ...]</code>：向流中添加一个消息。</li>
<li><code>XRANGE key start end [COUNT count]</code>：返回指定区间内的流消息。</li>
</ul>
<h4 id="示例代码-8"><a href="#示例代码-8" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisStreamExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 连接到Redis</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加消息到流</span>
        jedis<span class="token punctuation">.</span><span class="token function">xadd</span><span class="token punctuation">(</span><span class="token string">"mystream"</span><span class="token punctuation">,</span> <span class="token class-name">StreamEntryID</span><span class="token punctuation">.</span><span class="token constant">NEW_ENTRY</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"sensor_id"</span><span class="token punctuation">,</span> <span class="token string">"sensor1"</span><span class="token punctuation">,</span> <span class="token string">"temperature"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 读取消息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEntry</span><span class="token punctuation">></span></span> messages <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">xrange</span><span class="token punctuation">(</span><span class="token string">"mystream"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEntry</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 输出：[&#123;sensor_id=sensor1, temperature=20&#125;]</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><blockquote>
<p>Redis 提供了事务机制，可以将一组命令打包成一个原子操作。事务中的所有命令都会按顺序执行，确保数据的一致性。Redis 的事务机制主要通过以下命令实现：<code>MULTI</code>、<code>EXEC</code>、<code>DISCARD</code> 和 <code>WATCH</code>。</p>
</blockquote>
<h3 id="MULTI-命令"><a href="#MULTI-命令" class="headerlink" title="MULTI 命令"></a>MULTI 命令</h3><blockquote>
<p>标记一个事务的开始。事务中的所有命令会被放入一个队列，等待执行。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例</span>
MULTI
SET key1 <span class="token string">"value1"</span>
SET key2 <span class="token string">"value2"</span>
EXEC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="EXEC-命令"><a href="#EXEC-命令" class="headerlink" title="EXEC 命令"></a>EXEC 命令</h3><blockquote>
<p>执行所有在事务中排队的命令。所有命令会按顺序执行，并且是原子操作。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例</span>
MULTI
SET key1 <span class="token string">"value1"</span>
SET key2 <span class="token string">"value2"</span>
EXEC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="DISCARD-命令"><a href="#DISCARD-命令" class="headerlink" title="DISCARD 命令"></a>DISCARD 命令</h3><blockquote>
<p>取消事务，放弃所有在事务中排队的命令。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例</span>
MULTI
SET key1 <span class="token string">"value1"</span>
SET key2 <span class="token string">"value2"</span>
DISCARD<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="WATCH-命令"><a href="#WATCH-命令" class="headerlink" title="WATCH 命令"></a>WATCH 命令</h3><blockquote>
<p>监视一个或多个键，如果在事务执行之前这些键被修改，事务将被中止。<code>WATCH</code> 命令用于实现乐观锁。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
WATCH key1 key2
MULTI
SET key1 <span class="token string">"value1"</span>
SET key2 <span class="token string">"value2"</span>
EXEC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>Redis 的事务不是严格意义的原子性且不支持回滚。如果事务中的某个命令执行失败，其他命令仍会继续执行。</li>
<li><code>WATCH</code> 命令用于实现乐观锁，可以监视一个或多个键。如果在事务执行之前这些键被修改，事务将被中止。</li>
<li>Redis 事务中的命令会被放入一个队列，等待 <code>EXEC</code> 命令执行。事务中的命令不会立即执行，而是等到 <code>EXEC</code> 命令执行时才会执行。</li>
</ul>
<h3 id="事务失败场景"><a href="#事务失败场景" class="headerlink" title="事务失败场景"></a>事务失败场景</h3><ul>
<li>命令语法错误： 如果在事务队列中的某个命令存在语法错误，整个事务会被标记为失败，但正确的命令仍会执行。确保语法正确。</li>
<li>WATCH监视的键被修改： 如果在事务执行之前，WATCH 监视的键被其他客户端修改，事务将被中止。实现重试机制。</li>
<li>内存不足：如果 Redis 实例内存不足，事务中的某些命令可能会因为内存分配失败而无法执行。配置内存限制和淘汰策略来管理内存使用。</li>
<li>网络错误：网络问题可能导致客户端与 Redis 服务器的连接中断，从而导致事务失败。实现重试机制。</li>
</ul>
<p><strong>重试机制示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   redisTemplate<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   redisTemplate<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"new_value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 事务成功</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="LUA脚本"><a href="#LUA脚本" class="headerlink" title="LUA脚本"></a>LUA脚本</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>Lua 是一种轻量级的脚本语言，Redis支持在服务器端执行Lua 脚本。通过Lua脚本，可以将多个 Redis 命令组合成一个原子操作，从而保证操作的原子性和一致性。</p>
<h3 id="EVAL-命令"><a href="#EVAL-命令" class="headerlink" title="EVAL 命令"></a>EVAL 命令</h3><blockquote>
<p>EVAL命令用于执行 Lua 脚本</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
<span class="token comment"># script 要执行的 Lua 脚本</span>
<span class="token comment"># numkeys 脚本中使用的键的数量</span>
<span class="token comment"># key 传递给脚本的键</span>
<span class="token comment"># arg 传递给脚本的参数</span>
EVAL script numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> arg <span class="token punctuation">[</span>arg <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token comment"># 示例 将mykey设置为Hello, Redis!</span>
EVAL <span class="token string">"return redis.call('SET', KEYS[1], ARGV[1])"</span> <span class="token number">1</span> mykey <span class="token string">"Hello, Redis!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="EVALSHA-命令"><a href="#EVALSHA-命令" class="headerlink" title="EVALSHA 命令"></a>EVALSHA 命令</h3><blockquote>
<p>EVALSHA命令用于执行已经缓存的 Lua 脚本。EVALSHA通过脚本的SHA1校验和来执行脚本，从而避免每次都传递脚本内容。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
<span class="token comment"># sha1 脚本的 SHA1 校验和</span>
EVALSHA sha1 numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> arg <span class="token punctuation">[</span>arg <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token comment"># 示例</span>
-- 先使用 EVAL 命令执行脚本
EVAL <span class="token string">"return redis.call('SET', KEYS[1], ARGV[1])"</span> <span class="token number">1</span> mykey <span class="token string">"Hello, Redis!"</span>

-- 获取脚本的 SHA1 校验和
SCRIPT LOAD <span class="token string">"return redis.call('SET', KEYS[1], ARGV[1])"</span>

-- 使用 EVALSHA 命令执行脚本
EVALSHA <span class="token operator">&lt;</span>sha<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token number">1</span> mykey <span class="token string">"Hello, Redis!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="为什么LUA能保证原子性"><a href="#为什么LUA能保证原子性" class="headerlink" title="为什么LUA能保证原子性"></a>为什么LUA能保证原子性</h3><ol>
<li>单线程执行：redis是一个单线程的服务，核心命令都是单线程的，同一时间只能处理一个命令。</li>
<li>脚本作为一个整体执行：使用 <code>EVAL</code> 或 <code>EVALSHA</code> 命令执行 Lua 脚本时，Redis 会将整个脚本作为一个原子操作执行。</li>
<li>脚本执行的原子性： Redis在执行Lua脚本时不会中断脚本的执行。</li>
</ol>
<h3 id="LUA应用场景"><a href="#LUA应用场景" class="headerlink" title="LUA应用场景"></a>LUA应用场景</h3><ol>
<li><strong>脚本缓存</strong>：使用 <code>SCRIPT LOAD</code> 命令将脚本加载到 Redis 服务器，并使用 <code>EVALSHA</code> 命令执行缓存的脚本，减少网络传输和解析脚本的开销。</li>
<li><strong>错误处理</strong>：在 Lua 脚本中添加错误处理逻辑，确保脚本执行过程中出现错误时能够正确处理。</li>
<li><strong>性能优化</strong>：尽量将复杂的逻辑放在 Lua 脚本中执行，减少客户端与 Redis 服务器之间的网络往返次数，提高性能。</li>
</ol>
<h1 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h1><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><blockquote>
<p>Redis 提供了两种主要的持久化机制：RDB（Redis Database）快照和 AOF（Append Only File）日志</p>
</blockquote>
<h3 id="RDB-快照"><a href="#RDB-快照" class="headerlink" title="RDB 快照"></a>RDB 快照</h3><p>工作原理：RDB 持久化通过创建内存中数据的快照并将其保存到磁盘上来实现。Redis 会在指定的时间间隔内生成 RDB 文件，包含某一时刻的数据快照。</p>
<h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ol>
<li><strong>生成的文件较小</strong>：RDB 文件是压缩的二进制文件，体积较小，适合备份和传输。</li>
<li><strong>恢复速度快</strong>：RDB 文件是一个完整的数据快照，恢复速度较快。</li>
<li><strong>对性能影响小</strong>：RDB 持久化在指定的时间间隔内进行，不会频繁写磁盘，对 Redis 性能影响较小。</li>
</ol>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li><strong>数据丢失风险</strong>：由于 RDB 持久化是定期进行的，可能会丢失最近一次快照后的数据。</li>
<li><strong>生成快照时消耗资源</strong>：生成 RDB 快照时会消耗一定的 CPU 和内存资源，可能会影响 Redis 的性能。</li>
</ol>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>可以在 Redis 配置文件（<code>redis.conf</code>）中配置 RDB 持久化。常用的配置选项包括：</p>
<ul>
<li>save：配置生成 RDB 快照的时间间隔和条件。</li>
<li>dbfilename：指定 RDB 文件的名称。</li>
<li>dir：指定 RDB 文件的存储目录。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 在 900 秒内有 1 次写操作时生成快照</span>
<span class="token comment"># 在 300 秒内有 10 次写操作时生成快照</span>
<span class="token comment"># 在 60 秒内有 10000 次写操作时生成快照</span>
save 900 1
save 300 10
save 60 10000

<span class="token comment"># RDB 文件名</span>
dbfilename dump.rdb

<span class="token comment"># RDB 文件存储目录</span>
dir /var/lib/redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="手动生成和恢复-RDB-快照"><a href="#手动生成和恢复-RDB-快照" class="headerlink" title="手动生成和恢复 RDB 快照"></a>手动生成和恢复 RDB 快照</h4><ul>
<li><strong>生成快照</strong>：可以使用 <code>BGSAVE</code> 命令手动生成 RDB 快照。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">BGSAVE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><strong>恢复快照</strong>：将 RDB 文件放置在 Redis 配置文件中指定的目录下，然后重启 Redis 服务器即可恢复数据。</li>
</ul>
<h3 id="AOF-日志"><a href="#AOF-日志" class="headerlink" title="AOF 日志"></a>AOF 日志</h3><p>工作原理：AOF 持久化通过将每次写操作记录到日志文件中来实现。Redis 会将所有写操作追加到 AOF 文件中，并定期将文件同步到磁盘。</p>
<h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ol>
<li><strong>数据恢复更完整</strong>：AOF 文件记录了每次写操作，数据恢复时丢失的可能性较小。</li>
<li><strong>可读性强</strong>：AOF 文件是纯文本文件，包含 Redis 命令，便于调试和分析。</li>
</ol>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li><strong>文件较大</strong>：AOF 文件会随着写操作的增加而变大，可能需要定期重写文件以控制文件大小。</li>
<li><strong>对性能影响较大</strong>：由于每次写操作都会记录到 AOF 文件中，频繁的写操作可能会影响 Redis 的性能。</li>
</ol>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>可以在 Redis 配置文件（<code>redis.conf</code>）中配置 AOF 持久化。常用的配置选项包括：</p>
<ul>
<li>appendonly：启用 AOF 持久化。</li>
<li>appendfilename：指定 AOF 文件的名称。</li>
<li>appendfsync：配置 AOF 文件的同步策略。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 启用 AOF 持久化</span>
appendonly yes

<span class="token comment"># AOF 文件名</span>
appendfilename "appendonly.aof"

<span class="token comment"># AOF 文件同步策略</span>
<span class="token comment"># always：每次写操作后立即同步</span>
<span class="token comment"># everysec：每秒同步一次（默认）</span>
<span class="token comment"># no：由操作系统决定何时同步</span>
appendfsync everysec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AOF重写"><a href="#AOF重写" class="headerlink" title="AOF重写"></a>AOF重写</h4><p>由于 AOF 文件会随着写操作的增加而变大，Redis 提供了 AOF 重写机制，通过创建一个新的 AOF 文件来压缩旧的 AOF 文件。</p>
<ul>
<li><strong>自动重写</strong>：可以在配置文件中配置自动重写的条件。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 当 AOF 文件大小是上次重写后的两倍时触发重写</span>
auto-aof-rewrite-percentage 100
<span class="token comment"># AOF 文件最小大小（字节），达到此大小才会触发重写</span>
auto-aof-rewrite-min-size 64mb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>手动重写</strong>：可以使用 <code>BGREWRITEAOF</code> 命令手动触发 AOF 重写。</li>
</ul>
<h3 id="持久化策略选择"><a href="#持久化策略选择" class="headerlink" title="持久化策略选择"></a>持久化策略选择</h3><ol>
<li><strong>仅使用 RDB</strong>：适用于不太关心数据丢失的场景，例如缓存。RDB 持久化对性能影响较小，但可能会丢失最近一次快照后的数据。</li>
<li><strong>仅使用 AOF</strong>：适用于需要尽量减少数据丢失的场景。AOF 持久化可以记录每次写操作，但对性能影响较大。</li>
<li><strong>同时使用 RDB 和 AOF</strong>：适用于需要兼顾数据完整性和性能的场景。可以同时启用 RDB 和 AOF 持久化，RDB 提供快速恢复，AOF 提供更高的数据完整性。</li>
</ol>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 同时使用 RDB 和 AOF的配置</span>
<span class="token comment"># RDB 配置</span>
save 900 1
save 300 10
save 60 10000
dbfilename dump.rdb
dir /var/lib/redis

<span class="token comment"># AOF 配置</span>
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h2><blockquote>
<p>Redis 提供了强大的复制机制，使得数据可以在多个 Redis 实例之间进行复制，从而实现数据的高可用性和负载均衡。</p>
</blockquote>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>主从复制就是一个主节点将数据复制到一个或多个从节点上，主节点处理写操作，从节点处理读操作，这样可以提高读性能，并在主节点故障时提供数据冗余。</p>
<h3 id="复制过程"><a href="#复制过程" class="headerlink" title="复制过程"></a>复制过程</h3><ol>
<li><strong>全量复制</strong>：当从节点第一次连接到主节点时，会进行全量复制。主节点会将当前内存中的数据快照发送给从节点，从节点接收到快照后进行数据加载。</li>
<li><strong>增量复制</strong>：在全量复制完成后，主节点会将新的写操作命令发送给从节点，从节点执行这些命令以保持数据同步。</li>
</ol>
<h3 id="配置主从复制"><a href="#配置主从复制" class="headerlink" title="配置主从复制"></a>配置主从复制</h3><h4 id="配置主节点"><a href="#配置主节点" class="headerlink" title="配置主节点"></a>配置主节点</h4><p>主节点无需进行特殊配置，只需启动 Redis 实例即可。</p>
<h4 id="配置从节点"><a href="#配置从节点" class="headerlink" title="配置从节点"></a>配置从节点</h4><p>从节点需要配置连接到主节点。可以在 Redis 配置文件（<code>redis.conf</code>）中添加以下配置：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 指定主节点的 IP 地址和端口</span>
replicaof &lt;master-ip> &lt;master-port>
<span class="token comment"># 示例</span>
replicaof 192.168.1.100 6379
<span class="token comment"># Redis 实例启动后，通过命令行配置从节点</span>
redis-cli REPLICAOF 192.168.1.100 6379<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="取消从节点"><a href="#取消从节点" class="headerlink" title="取消从节点"></a>取消从节点</h4><p>如果需要将从节点转换为独立的主节点，可以使用以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli REPLICAOF NO ONE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="管理主从复制"><a href="#管理主从复制" class="headerlink" title="管理主从复制"></a>管理主从复制</h3><h4 id="查看复制状态"><a href="#查看复制状态" class="headerlink" title="查看复制状态"></a>查看复制状态</h4><p>可以使用 <code>INFO replication</code> 命令查看复制状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli INFO replication
<span class="token comment"># 结果</span>
<span class="token comment"># Replication</span>
role:master
connected_slaves:1
slave0:ip<span class="token operator">=</span><span class="token number">192.168</span>.1.101,port<span class="token operator">=</span><span class="token number">6379</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">1234567</span>,lag<span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="复制延迟"><a href="#复制延迟" class="headerlink" title="复制延迟"></a>复制延迟</h4><p>主从复制是异步进行的，主节点不会等待从节点完成复制就返回客户端，所以从节点总会有一定程度的数据延迟，可以使用 <code>REPLCONF</code> 命令配置从节点的复制延迟，以减少主节点的负载，帮助Redis系统在主节点故障时,快速恢复数据,提高系统的可用性和可靠性。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli REPLCONF ack <span class="token number">1000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="复制断开和重连"><a href="#复制断开和重连" class="headerlink" title="复制断开和重连"></a>复制断开和重连</h4><p>当从节点与主节点的连接断开时，从节点会自动尝试重新连接主节点。在重连期间，从节点会继续处理读请求，但数据可能不是最新的。</p>
<h3 id="高级配置选项"><a href="#高级配置选项" class="headerlink" title="高级配置选项"></a>高级配置选项</h3><h4 id="repl-diskless-sync"><a href="#repl-diskless-sync" class="headerlink" title="repl-diskless-sync"></a><code>repl-diskless-sync</code></h4><p>配置是否使用无盘复制,主节点和从节点初次建立连接的时候，从节点发送sync请求全量复制，配置无盘复制后，主节点会直接将内存中数据传输给从节点，而不是生成RDB快照，将RDB快照发送给从节点，主节点不生成和传输RDB文件，减轻了主节点的磁盘IO。</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">repl-diskless-sync yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="repl-diskless-sync-delay"><a href="#repl-diskless-sync-delay" class="headerlink" title="repl-diskless-sync-delay"></a><code>repl-diskless-sync-delay</code></h4><p>配置无盘复制的延迟时间，以等待更多从节点连接：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">repl-diskless-sync-delay 5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="min-replicas-to-write-和-min-replicas-max-lag"><a href="#min-replicas-to-write-和-min-replicas-max-lag" class="headerlink" title="min-replicas-to-write 和 min-replicas-max-lag"></a><code>min-replicas-to-write</code> 和 <code>min-replicas-max-lag</code></h4><p>配置最少从节点数量和最大复制延迟，以确保数据的高可用性：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">min-replicas-to-write 1
min-replicas-max-lag 10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="主从复制的优缺点"><a href="#主从复制的优缺点" class="headerlink" title="主从复制的优缺点"></a>主从复制的优缺点</h3><h4 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h4><ol>
<li><strong>提高读性能</strong>：从节点可以分担读请求，提高系统的读性能。</li>
<li><strong>数据冗余</strong>：从节点提供数据备份，在主节点故障时可以切换到从节点，确保数据的高可用性。</li>
</ol>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li><strong>数据一致性</strong>：主从复制是异步的，可能会有短暂的数据不一致。</li>
<li><strong>写性能影响</strong>：主节点需要将写操作发送给所有从节点，可能会影响写性能。</li>
<li><strong>手动切换</strong>：主节点发生故障，需要手动切换从节点为主节点。</li>
</ol>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p><strong>延迟（Latency）</strong></p>
<ul>
<li><strong>问题</strong>：主从节点之间的网络延迟会导致从节点的数据滞后于主节点，影响数据一致性。</li>
<li><strong>解决</strong>：通过优化网络条件，减少延迟，使用低延迟网络硬件。此外，可以使用 Redis 的 <code>min-slaves-to-write</code> 和 <code>min-slaves-max-lag</code> 配置项，确保主节点在写入数据时有足够数量的从节点保持低延迟。</li>
</ul>
<p><strong>复制风暴（Replication Storm）</strong></p>
<ul>
<li><strong>问题</strong>：主节点重启或故障恢复时，从节点可能同时请求全量复制，造成网络和主节点负载过高。</li>
<li><strong>解决</strong>：通过配置 <code>repl-backlog-size</code> 和 <code>repl-backlog-ttl</code> 增加复制积压缓冲区（backlog），以便在主节点恢复后进行增量复制，而非全量复制。</li>
</ul>
<h2 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h2><blockquote>
<p>Redis Sentinel 是 Redis 提供的一种高可用性解决方案，用于监控、自动故障转移和通知管理员。通过 Sentinel，可以实现 Redis 集群的自动化管理，确保系统的高可用性。</p>
</blockquote>
<h3 id="Redis-Sentinel-的主要功能"><a href="#Redis-Sentinel-的主要功能" class="headerlink" title="Redis Sentinel 的主要功能"></a>Redis Sentinel 的主要功能</h3><ol>
<li><strong>监控</strong>：持续监控主节点和从节点的运行状态。</li>
<li><strong>通知</strong>：在检测到故障时，向管理员发送通知。</li>
<li><strong>自动故障转移</strong>：当主节点发生故障时，自动将一个从节点提升为新的主节点。</li>
<li><strong>配置提供者</strong>：客户端可以通过 Sentinel 获取当前的主节点地址。</li>
</ol>
<h3 id="Sentinel-的配置"><a href="#Sentinel-的配置" class="headerlink" title="Sentinel 的配置"></a>Sentinel 的配置</h3><h4 id="Sentinel-配置文件"><a href="#Sentinel-配置文件" class="headerlink" title="Sentinel 配置文件"></a>Sentinel 配置文件</h4><p>Sentinel 使用独立的配置文件，通常命名为 <code>sentinel.conf</code>。以下是一个基本的 Sentinel 配置文件示例：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># Sentinel 实例的端口</span>
port 26379

<span class="token comment"># 监控的主节点，格式为：sentinel monitor &lt;master-name> &lt;master-ip> &lt;master-port> &lt;quorum></span>
<span class="token comment"># &lt;quorum> 是达成一致所需的 Sentinel 数量</span>
sentinel monitor mymaster 192.168.1.100 6379 2

<span class="token comment"># 指定 Sentinel 与主节点通信的密码（如果主节点启用了密码保护）</span>
<span class="token comment"># sentinel auth-pass &lt;master-name> &lt;password></span>
<span class="token comment"># sentinel auth-pass mymaster mypassword</span>

<span class="token comment"># 指定 Sentinel 判断主节点失效的时间（毫秒）</span>
sentinel down-after-milliseconds mymaster 5000

<span class="token comment"># 指定故障转移的超时时间（毫秒）</span>
sentinel failover-timeout mymaster 60000

<span class="token comment"># 指定在故障转移过程中，最多可以有多少个从节点同时对新的主节点进行同步</span>
sentinel parallel-syncs mymaster 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="启动-Sentinel"><a href="#启动-Sentinel" class="headerlink" title="启动 Sentinel"></a>启动 Sentinel</h4><p>可以使用以下命令启动 Sentinel：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-sentinel /path/to/sentinel.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="原理-x2F-算法-x2F-选举过程-x2F-故障转移过程"><a href="#原理-x2F-算法-x2F-选举过程-x2F-故障转移过程" class="headerlink" title="原理&#x2F;算法&#x2F;选举过程&#x2F;故障转移过程"></a>原理&#x2F;算法&#x2F;选举过程&#x2F;故障转移过程</h3><ol>
<li><strong>检测故障</strong>：Sentinel 实例通过 PING 命令检测主节点的状态。如果主节点在指定时间内没有响应，Sentinel 会将其标记为 SDOWN。</li>
<li><strong>确认故障</strong>：如果多个 Sentinel 实例（达到 quorum 数量）都认为主节点下线，Sentinel 会将其标记为 ODOWN，并发起故障转移。</li>
<li><strong>选举新的主节点</strong>：Sentinel 会从从节点中选举一个作为新的主节点。选举过程基于从节点的优先级、复制偏移量等因素。</li>
<li><strong>重新配置从节点</strong>：其他从节点更新其复制目标，开始从新的主节点复制数据。</li>
<li><strong>通知客户端</strong>：Sentinel 会向客户端提供新的主节点地址，以便客户端重新连接。</li>
</ol>
<h3 id="Sentinel-的高级配置"><a href="#Sentinel-的高级配置" class="headerlink" title="Sentinel 的高级配置"></a>Sentinel 的高级配置</h3><h4 id="客户端重定向"><a href="#客户端重定向" class="headerlink" title="客户端重定向"></a>客户端重定向</h4><p>可以配置客户端在连接到 Sentinel 时自动获取主节点地址：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># Sentinel 提供的主节点地址</span>
sentinel announce-ip 192.168.1.101
sentinel announce-port 26379<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="安全配置"><a href="#安全配置" class="headerlink" title="安全配置"></a>安全配置</h4><p>可以配置 Sentinel 与 Redis 实例之间的认证信息：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># Sentinel 与主节点通信的密码</span>
sentinel auth-pass mymaster mypassword

<span class="token comment"># Sentinel 与从节点通信的密码</span>
sentinel replica-announce-auth-pass mypassword<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="日志和监控"><a href="#日志和监控" class="headerlink" title="日志和监控"></a>日志和监控</h4><p>可以配置 Sentinel 的日志和监控选项：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 日志文件</span>
logfile "/var/log/redis/sentinel.log"

<span class="token comment"># 日志级别</span>
loglevel notice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="示例配置"><a href="#示例配置" class="headerlink" title="示例配置"></a>示例配置</h3><p>以下是一个完整的 Sentinel 配置示例：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">port 26379
sentinel monitor mymaster 192.168.1.100 6379 2
sentinel auth-pass mymaster mypassword
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
logfile "/var/log/redis/sentinel.log"
loglevel notice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="启动多个-Sentinel-实例"><a href="#启动多个-Sentinel-实例" class="headerlink" title="启动多个 Sentinel 实例"></a>启动多个 Sentinel 实例</h3><p>为了实现高可用性，通常需要启动多个 Sentinel 实例。可以在不同的服务器上启动 Sentinel，并使用相同的配置文件。</p>
<h3 id="常见问题-1"><a href="#常见问题-1" class="headerlink" title="常见问题"></a>常见问题</h3><ul>
<li><strong>脑裂</strong>：哨兵错误地判断主节点已宕机，触发主从切换，导致脑裂。</li>
<li><strong>哨兵自身问题</strong>：哨兵自身出现故障，导致无法正常工作。Sentinel 集群中如果有一个 Sentinel 节点出现故障，其他 Sentinel 节点仍然可以继续监控主节点和执行故障转移。</li>
</ul>
<p><strong>解决方法</strong></p>
<ul>
<li><p><strong>降低网络延迟</strong>：降低主从节点和哨兵节点之间的网络延迟，可以减少网络问题导致的故障。</p>
</li>
<li><p><strong>合理配置哨兵</strong>：合理配置哨兵的参数，例如min-nodes-to-promote参数和down-after-movement-seconds参数，可以降低哨兵误判主节点宕机的概率。</p>
</li>
<li><p><strong>使用多个哨兵节点</strong>：使用多个哨兵节点可以提高哨兵系统的可用性，即使一个哨兵节点出现故障，其他哨兵节点仍然可以工作。</p>
</li>
</ul>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><blockquote>
<p>Redis 集群（Redis Cluster）是一种分布式的 Redis 部署方式，旨在实现数据的分片和高可用性。通过 Redis 集群，可以将数据分布在多个节点上，从而提高系统的扩展性和容错能力。</p>
</blockquote>
<img src="https://telegraph-image-2ni.pages.dev/file/b72d32e756849d1c331b4.jpg" style="zoom:70%;">

<h3 id="Redis-集群的架构"><a href="#Redis-集群的架构" class="headerlink" title="Redis 集群的架构"></a>Redis 集群的架构</h3><p><strong>Redis集群</strong>是一种<strong>去中心化</strong>的架构，由多个节点组成，每个节点都存储部分数据，并且可以处理读写请求，集群中的节点相互之间平等，没有主从之分，数据在集群中的各个节点之间进行分片（sharding），每个节点负责存储一部分数据。</p>
<h4 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h4><p>Redis 集群将数据分片存储在多个节点上，数据分片通过哈希槽（hash slot）来实现，共有 16384 个哈希槽，哈希槽会平均分配到每个服务器上，每个键通过 CRC16 校验和计算得到一个哈希值，然后对 16384 取模，确定该键属于哪个哈希槽，每个节点负责一定范围的哈希槽。</p>
<h4 id="高可用性"><a href="#高可用性" class="headerlink" title="高可用性"></a>高可用性</h4><p>在Redis集群模式下，主节点的选举主要是通过Redis集群Gossip协议本身实现的，不依赖于哨兵机制，集群模式使用了一种基于投票的选举算法来进行故障转移和新主节点的选举。</p>
<h3 id="选举算法"><a href="#选举算法" class="headerlink" title="选举算法"></a>选举算法</h3><p>Redis集群模式的选举算法可以总结为以下几点：</p>
<ol>
<li><strong>故障检测</strong>：集群节点通过Gossip协议相互通信，定期发送PING消息并接收PONG消息，如果一个节点未能在一定时间内接收到另一个节点的PONG消息，它会将其标记为下线。</li>
<li><strong>故障确认</strong>：如果超过半数的主节点都认为某个主节点下线，那么这个主节点会被标记为确实下线（fail）。</li>
<li><strong>投票选举</strong>：在一个主节点被确认下线后，从节点会参与投票以选举一个新的主节点，投票过程中，每个从节点向其他主节点发送投票请求。</li>
<li><strong>投票决策</strong>：每个主节点在接收到投票请求后，会根据自身的判断决定是否同意这个投票请求，如果超过半数的主节点同意某个从节点成为新的主节点，那么这个从节点将被提升为新的主节点。</li>
<li><strong>故障转移</strong>：新选出的主节点开始承担主节点的角色，其他从节点更新其复制目标。</li>
</ol>
<h3 id="Redis-集群的配置"><a href="#Redis-集群的配置" class="headerlink" title="Redis 集群的配置"></a>Redis 集群的配置</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>每个 Redis 实例都需要一个独立的配置文件。以下是一个基本的 Redis 集群配置文件示例：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># Redis 集群模式</span>
cluster-enabled yes

<span class="token comment"># 集群配置文件</span>
cluster-config-file nodes.conf

<span class="token comment"># 集群节点的超时时间（毫秒）</span>
cluster-node-timeout 5000

<span class="token comment"># 集群端口（默认端口 + 10000）</span>
port 6379
cluster-announce-port 6379
cluster-announce-bus-port 16379

<span class="token comment"># 其他常规配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将上述配置文件保存为 <code>redis.conf</code>，并复制到每个节点上。</p>
<h4 id="启动-Redis-实例"><a href="#启动-Redis-实例" class="headerlink" title="启动 Redis 实例"></a>启动 Redis 实例</h4><p>在每个节点上启动 Redis 实例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-server /path/to/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h4><p>使用 <code>redis-cli</code> 工具创建集群。假设有 6 个节点，IP 地址和端口如下：</p>
<ul>
<li>192.168.1.1:6379</li>
<li>192.168.1.2:6379</li>
<li>192.168.1.3:6379</li>
<li>192.168.1.4:6379</li>
<li>192.168.1.5:6379</li>
<li>192.168.1.6:6379</li>
</ul>
<p>在任意一个节点上执行以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> create <span class="token number">192.168</span>.1.1:6379 <span class="token number">192.168</span>.1.2:6379 <span class="token number">192.168</span>.1.3:6379 <span class="token number">192.168</span>.1.4:6379 <span class="token number">192.168</span>.1.5:6379 <span class="token number">192.168</span>.1.6:6379 --cluster-replicas <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>--cluster-replicas 1</code> 表示为每个主节点分配一个从节点。执行该命令后，Redis 会提示确认，输入 <code>yes</code> 以继续。</p>
<h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><p>可以使用以下命令查看集群状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.1.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="管理-Redis-集群"><a href="#管理-Redis-集群" class="headerlink" title="管理 Redis 集群"></a>管理 Redis 集群</h3><h4 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token operator">&lt;</span>new-node-ip<span class="token operator">></span>:<span class="token operator">&lt;</span>new-node-port<span class="token operator">></span> <span class="token operator">&lt;</span>existing-node-ip<span class="token operator">></span>:<span class="token operator">&lt;</span>existing-node-port<span class="token operator">></span>
<span class="token comment">#example</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">192.168</span>.1.7:6379 <span class="token number">192.168</span>.1.1:6379<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> del-node <span class="token operator">&lt;</span>existing-node-ip<span class="token operator">></span>:<span class="token operator">&lt;</span>existing-node-port<span class="token operator">></span> <span class="token operator">&lt;</span>node-id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>要获取 <code>node-id</code>，可以使用 <code>cluster nodes</code> 命令查看。</p>
<h4 id="重新分片"><a href="#重新分片" class="headerlink" title="重新分片"></a>重新分片</h4><p>当集群中的节点数量发生变化时，需要重新分配哈希槽。可以使用以下命令进行重新分片：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token operator">&lt;</span>existing-node-ip<span class="token operator">></span>:<span class="token operator">&lt;</span>existing-node-port<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Redis 会提示输入要移动的哈希槽数量、源节点和目标节点。</p>
<h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><p>当主节点发生故障时，从节点会自动提升为主节点。如果需要手动进行故障转移，可以使用以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> failover <span class="token operator">&lt;</span>existing-node-ip<span class="token operator">></span>:<span class="token operator">&lt;</span>existing-node-port<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Redis-集群的优缺点"><a href="#Redis-集群的优缺点" class="headerlink" title="Redis 集群的优缺点"></a>Redis 集群的优缺点</h3><h4 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h4><ol>
<li><strong>高可用性</strong>：通过主从复制和故障转移，实现高可用性。</li>
<li><strong>扩展性</strong>：通过数据分片，可以水平扩展 Redis 集群，处理更大的数据量和更高的吞吐量。</li>
<li><strong>负载均衡</strong>：读写请求可以分布在多个节点上，实现负载均衡。</li>
</ol>
<h4 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li><strong>管理复杂性</strong>：配置和管理 Redis 集群比单节点 Redis 更复杂。</li>
<li><strong>数据一致性</strong>：由于 Redis 集群是异步复制，可能会有短暂的数据不一致。</li>
<li><strong>客户端支持</strong>：需要使用支持 Redis 集群的客户端库。</li>
</ol>
<h3 id="常见问题-2"><a href="#常见问题-2" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="数据不一致"><a href="#数据不一致" class="headerlink" title="数据不一致"></a>数据不一致</h4><p>集群模式下，如果一个节点发生故障，可能会导致数据不一致的问题。例如，数据的写操作可能在某些节点上成功，而在其他节点上失败。</p>
<p><strong>原因</strong></p>
<p>数据不一致的原因通常是由于网络分区或节点故障。Redis 集群采用的是异步复制机制，从节点可能未及时同步主节点的数据。</p>
<p><strong>解决方法</strong></p>
<ul>
<li><strong>使用同步复制</strong>：配置Redis集群使用 <code>wait</code> 命令来确保写操作在返回之前至少传播到一定数量的从节点。</li>
<li><strong>增加复制因子</strong>：通过增加从节点的数量来提高数据的可用性和一致性。</li>
<li><strong>监控和报警</strong>：使用监控工具实时监控集群状态，及时发现并处理数据不一致问题。</li>
</ul>
<h4 id="数据迁移问题"><a href="#数据迁移问题" class="headerlink" title="数据迁移问题"></a>数据迁移问题</h4><p>在集群扩展或缩减时，数据需要在节点之间迁移，可能会导致性能下降或数据丢失。</p>
<p><strong>原因</strong></p>
<p>数据迁移过程需要大量的网络传输和计算资源，可能会影响集群的性能，如果在迁移过程中发生故障，可能导致数据丢失。</p>
<p><strong>解决方法</strong></p>
<ul>
<li><strong>平滑数据迁移</strong>：使用 Redis 提供的 <code>resharding</code> 工具进行平滑的数据迁移，确保在迁移过程中集群的可用性。</li>
<li><strong>监控迁移过程</strong>：实时监控数据迁移过程，及时处理可能出现的问题。</li>
<li><strong>数据备份</strong>：在进行数据迁移之前，进行全面的数据备份，确保在出现问题时可以进行数据恢复。</li>
</ul>
<h4 id="写扩散问题"><a href="#写扩散问题" class="headerlink" title="写扩散问题"></a>写扩散问题</h4><p>在高并发写入的场景下，集群可能会遇到写扩散（write amplification）问题，导致写入性能下降。</p>
<p><strong>原因</strong></p>
<p>写扩散是由于 Redis 集群在写入数据时，需要在多个节点之间进行同步和复制，从而导致额外的写操作和网络开销。</p>
<p><strong>解决方法</strong></p>
<ul>
<li><strong>优化写操作</strong>：减少不必要的写操作，尽量合并写请求。</li>
<li><strong>配置合理的复制策略</strong>：调整 Redis 集群的复制策略，减少写扩散带来的开销。</li>
<li><strong>负载均衡</strong>：通过负载均衡器分散写请求，减少单个节点的负载。</li>
</ul>
<h4 id="节点故障和恢复"><a href="#节点故障和恢复" class="headerlink" title="节点故障和恢复"></a>节点故障和恢复</h4><p>节点故障会导致数据不可用，影响集群的整体可用性。</p>
<p><strong>原因</strong></p>
<p>节点故障可能由硬件故障、软件错误或网络问题引起。集群在失去一个节点后，可能需要时间进行故障转移和数据恢复。</p>
<p><strong>解决方法</strong></p>
<ul>
<li><strong>冗余配置</strong>：配置多个从节点，确保在主节点故障时能够及时进行故障转移。</li>
<li><strong>自动故障转移</strong>：使用 Redis 集群的自动故障转移机制，确保在节点故障时能够自动切换到可用节点。</li>
<li><strong>定期备份</strong>：定期进行数据备份，确保在节点故障时能够进行数据恢复。</li>
</ul>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><h2 id="客户端调优"><a href="#客户端调优" class="headerlink" title="客户端调优"></a>客户端调优</h2><ol>
<li><p><strong>连接管理</strong></p>
<ul>
<li><strong>连接池</strong>：使用连接池来管理与 Redis 的连接，避免频繁的连接和断开操作，提高性能。</li>
<li><strong>长连接</strong>：使用长连接而不是短连接，减少建立连接的开销。</li>
</ul>
</li>
<li><p><strong>请求优化</strong></p>
<ul>
<li><strong>批量操作</strong>：尽可能地使用批量操作，如 <code>MGET</code>、<code>MSET</code> 等，以减少网络往返次数。</li>
<li><strong>管道化（Pipelining）</strong>：使用管道技术，将多个命令打包成一个请求，减少网络延迟。</li>
<li><strong>LUA</strong>：将多个命令打包成lua脚本，使用lua脚本执行命令</li>
</ul>
</li>
<li><p><strong>数据序列化</strong></p>
<ul>
<li><strong>高效序列化</strong>：选择高效的数据序列化方式（如 MessagePack）以减少数据传输量和序列化&#x2F;反序列化的开销。</li>
<li><strong>压缩</strong>：对于较大的数据，可以考虑在客户端压缩数据后再传输，减少网络带宽的使用。</li>
</ul>
</li>
<li><p><strong>请求模式</strong></p>
<ul>
<li><strong>合理设置超时</strong>：设置合理的连接超时和请求超时，避免长时间等待未响应的请求。</li>
<li><strong>减少阻塞操作</strong>：尽量避免使用阻塞操作，影响客户端的响应时间，尽量避免使用可能导致阻塞的命令，如 <code>KEYS</code> 和 <code>FLUSHALL</code>。</li>
</ul>
</li>
<li><p><strong>客户端并发</strong></p>
<ul>
<li><strong>分布式锁</strong>：在高并发场景下，使用 Redis 的分布式锁来保证数据一致性。</li>
<li><strong>异步操作</strong>：使用异步的 Redis 客户端库，以提高请求处理的并发性和响应速度。</li>
</ul>
</li>
</ol>
<h2 id="服务端调优"><a href="#服务端调优" class="headerlink" title="服务端调优"></a>服务端调优</h2><ol>
<li><strong>内存优化</strong><ul>
<li><strong>maxmemory</strong>：设置Redis实例的最大内存使用量，当内存使用达到限制时，Redis 会根据内存淘汰策略释放内存。</li>
<li><strong>内存分配器</strong>：选择合适的内存分配器，如 jemalloc，能更有效地管理内存。</li>
<li><strong>压缩内存</strong>：通过配置文件启用内存压缩，以节省内存。</li>
<li><strong>对象共享</strong>：多个键可以共享相同的值对象，减少内存使用，提高内存利用率</li>
<li><strong>内存淘汰策略</strong>：达到内存限制时，可以通过内存淘汰策略释放内存<ul>
<li><strong>noeviction</strong>：不淘汰任何数据，返回错误。</li>
<li><strong>allkeys-lru</strong>：使用 LRU 算法淘汰所有键。</li>
<li><strong>volatile-lru</strong>：使用 LRU 算法淘汰设置了过期时间的键。</li>
<li><strong>allkeys-random</strong>：随机淘汰所有键。</li>
<li><strong>volatile-random</strong>：随机淘汰设置了过期时间的键。</li>
<li><strong>volatile-ttl</strong>：淘汰剩余生存时间（TTL）最短的键。</li>
</ul>
</li>
</ul>
</li>
<li><strong>持久化</strong><ul>
<li><strong>优化 RDB 持久化</strong>：设置合理的快照频率和条件，避免过于频繁或过于稀疏的快照。</li>
<li><strong>AOF 持久化优化</strong>：选择适当的 AOF 持久化策略（如 <code>appendfsync everysec</code>），在性能和数据安全之间找到平衡。</li>
</ul>
</li>
<li><strong>数据结构优化</strong><ul>
<li><strong>合适的数据结构</strong>：根据使用场景选择合适的数据结构，如字符串、列表、集合、哈希等。</li>
<li><strong>减少内存占用</strong>：使用压缩列表、整数集合的特殊编码等方式，减少内存占用。</li>
</ul>
</li>
<li><strong>集群和高可用</strong><ul>
<li><strong>分片（Sharding）</strong>：将数据分布在多个 Redis 实例上，避免单个实例的性能瓶颈。</li>
<li><strong>Redis Cluster</strong>：使用 Redis Cluster 实现分布式部署，提高扩展性和高可用性。</li>
<li><strong>Sentinel</strong>：使用 Sentinel 实现主从切换和高可用，保证系统的稳定性。</li>
</ul>
</li>
</ol>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 启用压缩列表</span>
list-max-ziplist-entries 512
list-max-ziplist-value 64
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

<span class="token comment"># 启用整数集合</span>
set-max-intset-entries 512

<span class="token comment"># 启用对象共享</span>
maxmemory-sharing 1

<span class="token comment"># 配置内存淘汰策略</span>
maxmemory-policy allkeys-lru

<span class="token comment"># 启用内存压缩</span>
maxmemory-compression 1

<span class="token comment"># 配置最大内存使用量</span>
maxmemory 2gb

<span class="token comment"># 内存配置</span>
maxmemory 2gb
maxmemory-policy allkeys-lru

<span class="token comment"># 持久化配置</span>
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

<span class="token comment"># 网络配置</span>
maxclients 10000
tcp-keepalive 300<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="缓存策略"><a href="#缓存策略" class="headerlink" title="缓存策略"></a>缓存策略</h3><p>Redis 提供了多种缓存淘汰策略，用于在内存达到限制时自动删除一些数据，以确保系统的稳定运行。</p>
<ol>
<li><strong>noeviction</strong>：当内存达到限制时，不淘汰任何数据，直接返回错误。</li>
<li><strong>allkeys-lru</strong>：使用 LRU（Least Recently Used）算法淘汰所有键，优先淘汰最近最少使用的键。</li>
<li><strong>volatile-lru</strong>：使用 LRU 算法淘汰设置了过期时间的键。</li>
<li><strong>allkeys-random</strong>：随机淘汰所有键。</li>
<li><strong>volatile-random</strong>：随机淘汰设置了过期时间的键。</li>
<li><strong>volatile-ttl</strong>：淘汰剩余生存时间（TTL）最短的键。</li>
<li><strong>allkeys-lfu</strong>：使用 LFU（Least Frequently Used）算法淘汰所有键，优先淘汰使用频率最低的键。</li>
<li><strong>volatile-lfu</strong>：使用 LFU 算法淘汰设置了过期时间的键。</li>
</ol>
<h3 id="监控和调试"><a href="#监控和调试" class="headerlink" title="监控和调试"></a>监控和调试</h3><ol>
<li><strong>INFO memory</strong>：获取内存使用情况的详细信息。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli INFO memory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li><strong>MEMORY STATS</strong>：获取内存使用的统计信息。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli MEMORY STATS<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li><strong>MEMORY USAGE</strong>：获取指定键的内存使用情况。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli MEMORY USAGE <span class="token operator">&lt;</span>key<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h1 id="安全与监控"><a href="#安全与监控" class="headerlink" title="安全与监控"></a>安全与监控</h1><h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><p><strong>身份验证</strong></p>
<p>Redis 支持通过密码进行身份验证，以防止未经授权的访问。</p>
<p><strong>配置身份验证</strong></p>
<p>可以在 Redis 配置文件（<code>redis.conf</code>）中设置密码：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 设置 Redis 密码</span>
requirepass yourpassword<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>动态设置密码</strong></p>
<p>也可以在 Redis 实例运行时，通过命令行设置密码：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli CONFIG SET requirepass yourpassword<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>客户端身份验证</strong></p>
<p>客户端连接到 Redis 服务器后，需要进行身份验证：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 客户端</span>
redis-cli <span class="token parameter variable">-a</span> yourpassword
<span class="token comment"># 第三方客户端</span>
Jedis jedis <span class="token operator">=</span> new Jedis<span class="token punctuation">(</span><span class="token string">"localhost"</span>, <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis.auth<span class="token punctuation">(</span><span class="token string">"yourpassword"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><h3 id="自带的监控命令"><a href="#自带的监控命令" class="headerlink" title="自带的监控命令"></a>自带的监控命令</h3><ol>
<li><strong>INFO 命令</strong>：获取 Redis 实例的详细信息，包括内存使用、连接数、命中率等。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli INFO<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li><strong>MONITOR 命令</strong>：实时监控 Redis 实例的所有命令执行情况。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli MONITOR<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li><strong>SLOWLOG 命令</strong>：查看慢查询日志，帮助识别性能瓶颈。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli SLOWLOG GET<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="第三方监控工具"><a href="#第三方监控工具" class="headerlink" title="第三方监控工具"></a>第三方监控工具</h3><ol>
<li>Prometheus：开源的监控系统，适用于收集和存储 Redis 的监控数据。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./redis_exporter <span class="token parameter variable">--redis.addr</span><span class="token operator">=</span>redis://localhost:6379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>Grafana：开源的可视化工具，适用于展示和分析 Redis 的监控数据。</li>
</ol>
<h1 id="实践应用"><a href="#实践应用" class="headerlink" title="实践应用"></a>实践应用</h1><h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><h3 id="什么是分布式锁"><a href="#什么是分布式锁" class="headerlink" title="什么是分布式锁"></a>什么是分布式锁</h3><p>分布式锁是一种在分布式系统中控制对共享资源访问的机制。它确保在同一时间只有一个进程或线程可以访问某个资源，从而避免数据不一致或竞争条件的发生。</p>
<h3 id="应用场景-9"><a href="#应用场景-9" class="headerlink" title="应用场景"></a>应用场景</h3><ol>
<li><strong>分布式系统中的资源竞争</strong>：多个服务实例需要访问同一个资源，例如数据库记录或文件。</li>
<li><strong>任务调度</strong>：确保同一任务在同一时间只有一个实例在执行。</li>
<li><strong>限流</strong>：控制并发访问的数量，防止系统过载。</li>
<li><strong>分布式事务</strong>：在分布式环境中实现事务的一致性。</li>
</ol>
<h3 id="实现方式及优缺点"><a href="#实现方式及优缺点" class="headerlink" title="实现方式及优缺点"></a>实现方式及优缺点</h3><ol>
<li><strong>基于数据库的分布式锁</strong><ul>
<li><strong>优点</strong>：实现简单，适用于已有数据库的系统。</li>
<li><strong>缺点</strong>：性能较低，数据库成为瓶颈，可靠性依赖于数据库。</li>
</ul>
</li>
<li><strong>基于Redis的分布式锁</strong><ul>
<li><strong>优点</strong>：性能高，Redis的高可用性和持久化机制可以提高锁的可靠性。</li>
<li><strong>缺点</strong>：需要额外的Redis服务，可能存在锁失效问题。</li>
</ul>
</li>
<li><strong>基于Zookeeper的分布式锁</strong><ul>
<li><strong>优点</strong>：强一致性和高可靠性，适用于需要严格一致性的场景。</li>
<li><strong>缺点</strong>：实现复杂，性能相对较低，需要额外的Zookeeper服务。</li>
</ul>
</li>
</ol>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>以Redis分布式锁为例，其实现原理如下：</p>
<ol>
<li><strong>获取锁</strong>：使用<code>SETNX</code>命令（SET if Not eXists）在Redis中创建一个键，如果键不存在则创建并返回成功，否则返回失败。</li>
<li><strong>设置过期时间</strong>：使用<code>EXPIRE</code>命令为键设置过期时间，防止死锁。</li>
<li><strong>释放锁</strong>：使用<code>DEL</code>命令删除键，释放锁。</li>
</ol>
<h3 id="应用示例"><a href="#应用示例" class="headerlink" title="应用示例"></a>应用示例</h3><p>假设我们有一个电商系统，多个服务实例需要同时更新库存。为了避免超卖问题，我们需要使用分布式锁来确保同一时间只有一个实例可以更新库存。</p>
<h4 id="基于Redis的分布式锁实现"><a href="#基于Redis的分布式锁实现" class="headerlink" title="基于Redis的分布式锁实现"></a>基于Redis的分布式锁实现</h4><p>在生产环境中，我们可以使用Redisson库来简化Redis分布式锁的实现。Redisson是一个高效的Redis客户端，提供了许多高级功能，包括分布式锁。</p>
<p><strong>代码实现</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisDistributedLock</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">acquireLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> lockKey<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> lockValue <span class="token operator">=</span> <span class="token function">generateLockValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用线程ID和时间戳生成唯一标识</span>

        <span class="token comment">// 如果键不存在，设置键的值并返回true；如果键已经存在，则返回false</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> lockValue<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> lockValue<span class="token punctuation">;</span> <span class="token comment">// 返回锁的唯一标识</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> lockKey<span class="token punctuation">,</span> <span class="token class-name">String</span> lockValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> currentValue <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateLockValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h2><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><ol>
<li><strong>使用 Redis 的 Sorted Set</strong>：利用 Redis 的 Sorted Set 数据结构来存储队列中的元素，元素的优先级作为分数。</li>
<li><strong>使用 Lua 脚本</strong>：并发环境中，单个redis的命令是原子性，但是多个命令组合才能实现优先级队列功能（ZRANGE、ZREM），多个命令组合无法保证原子性，Lua脚本在Redis中是原子执行的。即使有多个客户端同时执行 Lua 脚本，Redis 也会保证脚本在执行期间不会被其他命令打断，通过Lua脚本来保证操作的原子性，避免并发问题。</li>
</ol>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><ol>
<li><strong>入队</strong>：将元素添加到 Sorted Set 中，优先级作为分数。</li>
<li><strong>出队</strong>：从 Sorted Set 中移除并返回分数最小的元素（优先级最高）。</li>
</ol>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>需要两个 Lua 脚本，一个用于入队，一个用于出队。</p>
<h4 id="入队脚本（enqueue-lua）"><a href="#入队脚本（enqueue-lua）" class="headerlink" title="入队脚本（enqueue.lua）"></a>入队脚本（enqueue.lua）</h4><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- enqueue.lua</span>
<span class="token comment">-- 参数：KEYS[1] - 队列名</span>
<span class="token comment">-- 参数：ARGV[1] - 元素</span>
<span class="token comment">-- 参数：ARGV[2] - 优先级</span>

redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ZADD'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="出队脚本（dequeue-lua）"><a href="#出队脚本（dequeue-lua）" class="headerlink" title="出队脚本（dequeue.lua）"></a>出队脚本（dequeue.lua）</h4><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- dequeue.lua</span>
<span class="token comment">-- 参数：KEYS[1] - 队列名</span>

<span class="token keyword">local</span> result <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ZRANGE'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ZREM'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="RedisPriorityQueueService-java"><a href="#RedisPriorityQueueService-java" class="headerlink" title="RedisPriorityQueueService.java"></a>RedisPriorityQueueService.java</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisPriorityQueueService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> enqueueScript<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dequeueScript<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisPriorityQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>enqueueScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>enqueueScript<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"scripts/enqueue.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>enqueueScript<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>dequeueScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dequeueScript<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceScriptSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"scripts/dequeue.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dequeueScript<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//入队</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token class-name">String</span> queueName<span class="token punctuation">,</span> <span class="token class-name">String</span> element<span class="token punctuation">,</span> <span class="token keyword">double</span> priority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>enqueueScript<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>queueName<span class="token punctuation">)</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//出队</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token class-name">String</span> queueName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>dequeueScript<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>queueName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="计数器和限流"><a href="#计数器和限流" class="headerlink" title="计数器和限流"></a>计数器和限流</h2><h3 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h3><p>计数器是一种常见的应用场景，用于统计某个事件的发生次数，例如访问次数、点赞次数等。在分布式系统中，可以使用 Redis 来实现高效的分布式计数器。</p>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><strong>递增计数</strong>：使用 Redis 的 <code>INCR</code> 命令对指定键的值进行递增操作。</li>
<li><strong>获取计数</strong>：使用 Redis 的 <code>GET</code> 命令获取指定键的值。</li>
</ol>
<h3 id="应用示例-1"><a href="#应用示例-1" class="headerlink" title="应用示例"></a>应用示例</h3><p>有一个网站，需要统计每个页面的访问次数。我们可以使用 Redis 来实现分布式计数器。</p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCounterService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 递增计数器
     * @param key 计数器的键
     * @return 递增后的值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">incrementCounter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取计数器的值
     * @param key 计数器的键
     * @return 计数器的值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><p>限流是一种常见的应用场景，用于控制并发访问的数量，防止系统过载。在分布式系统中，可以使用 Redis 来实现高效的分布式限流。</p>
<h3 id="实现原理-2"><a href="#实现原理-2" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><strong>令牌桶算法</strong>：使用 Redis 的 <code>INCR</code> 和 <code>EXPIRE</code> 命令实现令牌桶算法。每次请求到来时，检查令牌桶中的令牌数量，如果令牌数量足够，则允许请求，否则拒绝请求。</li>
<li><strong>滑动窗口算法</strong>：使用 Redis 的 <code>ZADD</code> 和 <code>ZREMRANGEBYSCORE</code> 命令实现滑动窗口算法。每次请求到来时，记录请求的时间戳，并删除过期的请求记录。</li>
</ol>
<h3 id="应用示例-2"><a href="#应用示例-2" class="headerlink" title="应用示例"></a>应用示例</h3><p>我们有一个 API 接口，需要限制每分钟的访问次数不超过100次。我们可以使用Redis来实现分布式限流。</p>
<h4 id="基于令牌桶算法的限流实现"><a href="#基于令牌桶算法的限流实现" class="headerlink" title="基于令牌桶算法的限流实现"></a>基于令牌桶算法的限流实现</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisRateLimiterService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 检查是否允许请求
     * @param key 限流的键
     * @param limit 每分钟的请求限制
     * @return 是否允许请求
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAllowed</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> currentMinute <span class="token operator">=</span> currentTimeMillis <span class="token operator">/</span> <span class="token number">60000</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> currentMinute<span class="token punctuation">;</span>

        <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> count <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="基于滑动窗口算法的限流实现"><a href="#基于滑动窗口算法的限流实现" class="headerlink" title="基于滑动窗口算法的限流实现"></a>基于滑动窗口算法的限流实现</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSlidingWindowRateLimiterService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 检查是否允许请求
     * @param key 限流的键
     * @param limit 每分钟的请求限制
     * @return 是否允许请求
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAllowed</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">":requests"</span><span class="token punctuation">;</span>

        <span class="token comment">// 删除一分钟前的请求记录</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeRangeByScore</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> currentTimeMillis <span class="token operator">-</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录当前请求</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">,</span> currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取当前时间窗口内的请求数量</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zCard</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> count <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="地理位置服务"><a href="#地理位置服务" class="headerlink" title="地理位置服务"></a>地理位置服务</h2><h3 id="什么是地理位置服务"><a href="#什么是地理位置服务" class="headerlink" title="什么是地理位置服务"></a>什么是地理位置服务</h3><p>地理位置服务是一种基于地理空间数据的服务，允许存储和查询地理位置数据。Redis 提供了内置的地理空间数据结构，可以高效地存储和查询地理位置数据。</p>
<h3 id="应用场景-10"><a href="#应用场景-10" class="headerlink" title="应用场景"></a>应用场景</h3><ol>
<li><strong>查找附近的地点</strong>：例如查找附近的餐馆、加油站等。</li>
<li><strong>用户位置跟踪</strong>：实时跟踪用户位置，提供基于位置的服务。</li>
<li><strong>地理围栏</strong>：检测用户是否进入或离开特定的地理区域。</li>
</ol>
<h3 id="实现方式及优缺点-1"><a href="#实现方式及优缺点-1" class="headerlink" title="实现方式及优缺点"></a>实现方式及优缺点</h3><ol>
<li>基于数据库的地理位置服务<ul>
<li><strong>优点</strong>：实现简单，适用于已有数据库的系统。</li>
<li><strong>缺点</strong>：性能较低，数据库成为瓶颈，查询效率较低。</li>
</ul>
</li>
<li>基于Redis的地理位置服务<ul>
<li><strong>优点</strong>：性能高，Redis 的内置地理空间数据结构可以高效存储和查询地理位置数据。</li>
<li><strong>缺点</strong>：需要额外的 Redis 服务。</li>
</ul>
</li>
</ol>
<h3 id="实现原理-3"><a href="#实现原理-3" class="headerlink" title="实现原理"></a>实现原理</h3><p>Redis 提供了以下几个命令用于地理位置服务：</p>
<ol>
<li><strong>GEOADD</strong>：将地理位置添加到指定的键中。</li>
<li><strong>GEODIST</strong>：计算两个地理位置之间的距离。</li>
<li><strong>GEORADIUS</strong>：查找指定范围内的地理位置。</li>
<li><strong>GEOHASH</strong>：获取地理位置的 Geohash 值。</li>
</ol>
<h3 id="应用示例-3"><a href="#应用示例-3" class="headerlink" title="应用示例"></a>应用示例</h3><p>有一个应用，需要存储多个地点的地理位置，并提供查找附近地点的功能。我们可以使用 Redis 来实现地理位置服务。</p>
<h4 id="基于Redis的地理位置服务实现"><a href="#基于Redis的地理位置服务实现" class="headerlink" title="基于Redis的地理位置服务实现"></a>基于Redis的地理位置服务实现</h4><p>生产环境中，我们可以使用RedisTemplate来简化Redis地理位置服务的实现。</p>
<p><strong>代码实现</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisGeoService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 添加地理位置
     * @param key 键
     * @param longitude 经度
     * @param latitude 纬度
     * @param member 地点名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addGeoLocation</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">double</span> longitude<span class="token punctuation">,</span> <span class="token keyword">double</span> latitude<span class="token punctuation">,</span> <span class="token class-name">String</span> member<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span><span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 计算两个地点之间的距离
     * @param key 键
     * @param member1 地点1
     * @param member2 地点2
     * @param metric 距离单位
     * @return 距离
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Distance</span> <span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> member1<span class="token punctuation">,</span> <span class="token class-name">String</span> member2<span class="token punctuation">,</span> <span class="token class-name">Metric</span> metric<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> member1<span class="token punctuation">,</span> member2<span class="token punctuation">,</span> metric<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 查找指定范围内的地点
     * @param key 键
     * @param longitude 经度
     * @param latitude 纬度
     * @param radius 范围
     * @param metric 距离单位
     * @return 附近的地点
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getNearbyLocations</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">double</span> longitude<span class="token punctuation">,</span> <span class="token keyword">double</span> latitude<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">,</span> <span class="token class-name">Metric</span> metric<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Circle</span> within <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span>radius<span class="token punctuation">,</span> metric<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">radius</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> within<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取地理位置的 Geohash 值
     * @param key 键
     * @param members 地点名称
     * @return Geohash 值
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getGeoHash</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> members<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><p>以下是一些使用地理位置服务的示例：</p>
<h4 id="添加地理位置"><a href="#添加地理位置" class="headerlink" title="添加地理位置"></a>添加地理位置</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisGeoService</span> redisGeoService<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    redisGeoService<span class="token punctuation">.</span><span class="token function">addGeoLocation</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">13.361389</span><span class="token punctuation">,</span> <span class="token number">38.115556</span><span class="token punctuation">,</span> <span class="token string">"Palermo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisGeoService<span class="token punctuation">.</span><span class="token function">addGeoLocation</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">15.087269</span><span class="token punctuation">,</span> <span class="token number">37.502669</span><span class="token punctuation">,</span> <span class="token string">"Catania"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="计算两个地点之间的距离"><a href="#计算两个地点之间的距离" class="headerlink" title="计算两个地点之间的距离"></a>计算两个地点之间的距离</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisGeoService</span> redisGeoService<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">calculateDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Distance</span> distance <span class="token operator">=</span> redisGeoService<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token string">"Palermo"</span><span class="token punctuation">,</span> <span class="token string">"Catania"</span><span class="token punctuation">,</span> <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Distance: "</span> <span class="token operator">+</span> distance<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" km"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="查找指定范围内的地点"><a href="#查找指定范围内的地点" class="headerlink" title="查找指定范围内的地点"></a>查找指定范围内的地点</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisGeoService</span> redisGeoService<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findNearbyLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> results <span class="token operator">=</span> redisGeoService<span class="token punctuation">.</span><span class="token function">getNearbyLocations</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token number">15.0</span><span class="token punctuation">,</span> <span class="token number">37.5</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GeoResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">:</span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Location: "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", Distance: "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" km"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="获取地理位置的-Geohash-值"><a href="#获取地理位置的-Geohash-值" class="headerlink" title="获取地理位置的 Geohash 值"></a>获取地理位置的 Geohash 值</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisGeoService</span> redisGeoService<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getGeoHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> geoHashes <span class="token operator">=</span> redisGeoService<span class="token punctuation">.</span><span class="token function">getGeoHash</span><span class="token punctuation">(</span><span class="token string">"locations"</span><span class="token punctuation">,</span> <span class="token string">"Palermo"</span><span class="token punctuation">,</span> <span class="token string">"Catania"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> geoHash <span class="token operator">:</span> geoHashes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Geohash: "</span> <span class="token operator">+</span> geoHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>






          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/SpringBoot%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/SpringBoot%E5%AE%9E%E8%B7%B5.html" itemprop="url">SpringBoot实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><h2 id="SringBoot介绍"><a href="#SringBoot介绍" class="headerlink" title="SringBoot介绍"></a>SringBoot介绍</h2><p>Spring Boot是一个用于创建独立、生产级Spring应用程序的框架。它简化了Spring应用程序的开发，通过提供一系列开箱即用的配置和功能，使开发者能够快速上手并专注于业务逻辑。</p>
<p>主要特点：</p>
<ul>
<li><strong>简化Spring开发</strong>：提供更快、更广泛的入门体验。</li>
<li><strong>默认配置</strong>：提供开箱即用的配置，同时允许灵活定制。</li>
<li><strong>嵌入式服务器</strong>：支持内置服务器（如Tomcat、Jetty），无需外部部署。</li>
<li><strong>非功能性特性</strong>：内置支持安全性、度量、健康检查和外部化配置等常见需求。</li>
<li><strong>无代码生成</strong>：无需代码生成或XML配置（除非需要生成原生镜像）。</li>
</ul>
<p>Spring Boot应用程序可以通过<code>java -jar</code>命令或传统的WAR包方式启动，非常适合快速开发和部署Java应用程序。</p>
<h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><p>Spring Boot 2.4.8 需要 Java 8 或更高版本，并且可以兼容到 Java 16，包括 Java 16。还需要 Spring Framework 5.3.8 或以上版本。</p>
<p><strong>构建工具版本要求</strong></p>
<table>
<thead>
<tr>
<th>构建工具</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Maven</td>
<td>3.3+</td>
</tr>
<tr>
<td>Gradle</td>
<td>6.x</td>
</tr>
</tbody></table>
<h3 id="Servlet-容器"><a href="#Servlet-容器" class="headerlink" title="Servlet 容器"></a>Servlet 容器</h3><p>Spring Boot 支持以下嵌入式 Servlet 容器</p>
<table>
<thead>
<tr>
<th align="left">Servlet 容器</th>
<th align="left">Servlet 版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Tomcat 10.0</td>
<td align="left">5.0</td>
</tr>
<tr>
<td align="left">Jetty 11.0</td>
<td align="left">5.1</td>
</tr>
<tr>
<td align="left">Undertow 2.2 (Jakarta EE 9 variant)</td>
<td align="left">5.0</td>
</tr>
</tbody></table>
<p><strong>默认配置的容器是 Tomcat</strong></p>
<p><strong>原因：</strong></p>
<ol>
<li><strong>广泛使用</strong>：Tomcat 是最常用的 Servlet 容器之一，具有广泛的社区支持和成熟的生态系统。</li>
<li><strong>稳定性和性能</strong>：Tomcat 在性能和稳定性方面表现出色，适用于大多数应用场景。</li>
<li><strong>Spring Boot 的历史原因</strong>：Spring Boot 从一开始就默认使用 Tomcat，许多开发者已经习惯了这种配置。</li>
</ol>
<p><strong>修改为 Jetty或者Undertow,先排除Tomcat依赖，再添加对应依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- Exclude Tomcat --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    
    <span class="token comment">&lt;!-- Include Jetty --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-jetty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- Include Undertow --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-undertow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="GraalVM-原生镜像"><a href="#GraalVM-原生镜像" class="headerlink" title="GraalVM 原生镜像"></a>GraalVM 原生镜像</h3><blockquote>
<p><strong>GraalVM 是一个多语言虚拟机，支持多种编程语言和运行时环境。GraalVM 原生镜像（Native Image）是 GraalVM 提供的一项功能，可以将 Java 应用程序编译成独立的本地可执行文件。这种本地可执行文件不依赖于 JVM，可以在没有 Java 运行时环境的情况下运行。</strong></p>
</blockquote>
<p>Spring Boot应用程序可以通过使用 GraalVM 22.3 或以上版本 <a target="_blank" rel="noopener" href="https://springdoc.cn/spring-boot/native-image.html#native-image.introducing-graalvm-native-images">转换为原生镜像</a>。</p>
<p>镜像可以通过 <a target="_blank" rel="noopener" href="https://github.com/graalvm/native-build-tools">本地构建工具</a> Gradle&#x2F;Maven插件或GraalVM提供的 <code>native-image</code> 工具来创建。你也可以使用 <a target="_blank" rel="noopener" href="https://github.com/paketo-buildpacks/native-image">native-image Paketo buildpack</a> 来创建原生镜像。</p>
<p>支持以下版本。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GraalVM Community</td>
<td align="left">22.3</td>
</tr>
<tr>
<td align="left">Native Build Tools</td>
<td align="left">0.9.23</td>
</tr>
</tbody></table>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p><strong>安装方式：</strong>Maven安装</p>
<p><strong>软件版本：</strong></p>
<ul>
<li>jdk 1.8</li>
<li>maven 3.3.X+</li>
</ul>
<h3 id="Maven创建项目"><a href="#Maven创建项目" class="headerlink" title="Maven创建项目"></a>Maven创建项目</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>myproject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>

    <span class="token comment">&lt;!-- 将在此添加其他行... --></span>

    <span class="token comment">&lt;!-- ((只有当你使用 milestone 或 snapshot 版本时，你才需要这个。)) --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>spring-snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>spring-milestones<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepositories</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>spring-snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>spring-milestones<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepositories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="添加依赖到classpath"><a href="#添加依赖到classpath" class="headerlink" title="添加依赖到classpath"></a>添加依赖到classpath</h3><p>Spring Boot提供了一些<code>starter</code>，不同的<code>starter</code>提供不同的功能，添加<code>starter</code>可以快速的把一套功能所需要jar添加到你的classpath。例如添加web依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>spring-boot-starter-web包含的依赖项详情如下：</p>
<ol>
<li><strong>spring-boot-starter</strong>：<ul>
<li><code>org.springframework.boot:spring-boot-starter</code></li>
<li>包含 Spring Boot 的核心功能和自动配置支持。</li>
</ul>
</li>
<li><strong>spring-boot-starter-json</strong>：<ul>
<li><code>org.springframework.boot:spring-boot-starter-json</code></li>
<li>包含 Jackson 依赖，用于处理 JSON 数据。</li>
</ul>
</li>
<li><strong>spring-boot-starter-tomcat</strong>：<ul>
<li><code>org.springframework.boot:spring-boot-starter-tomcat</code></li>
<li>包含嵌入式 Tomcat 容器。</li>
</ul>
</li>
<li><strong>spring-web</strong>：<ul>
<li><code>org.springframework:spring-web</code></li>
<li>提供 Spring MVC 框架的核心功能。</li>
</ul>
</li>
<li><strong>spring-webmvc</strong>：<ul>
<li><code>org.springframework:spring-webmvc</code></li>
<li>提供 Spring MVC 框架的 Web 层功能。</li>
</ul>
</li>
<li><strong>hibernate-validator</strong>：<ul>
<li><code>org.hibernate.validator:hibernate-validator</code></li>
<li>提供 Java Bean 验证功能。</li>
</ul>
</li>
<li><strong>spring-boot-starter-logging</strong>：<ul>
<li><code>org.springframework.boot:spring-boot-starter-logging</code></li>
<li>包含 SLF4J 和 Logback，用于日志记录。</li>
</ul>
</li>
</ol>
<p><strong>可以运行以下命令查看依赖树,包含哪些依赖</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mvn dependency:tree <span class="token parameter variable">-Dincludes</span><span class="token operator">=</span>org.springframework.boot:spring-boot-starter-web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><p>Maven默认会从<code>src/main/java</code> 编译源代码，因此我们创建一个<code>src/main/java/MyApplication.java</code> 的文件，包含以下代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RestController</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"hello,world"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MainApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="RestController-和-RequestMapping-注解"><a href="#RestController-和-RequestMapping-注解" class="headerlink" title="@RestController 和 @RequestMapping 注解"></a>@RestController 和 @RequestMapping 注解</h4><ul>
<li><code>@RestController =@Controller +@ResponseBody</code>将返回的结果字符串直接响应给客户端</li>
<li><code>@RequestMapping</code>提供了routing路由信息，告诉所有请求都被映射到home()</li>
</ul>
<h4 id="SpringBootApplication-注解"><a href="#SpringBootApplication-注解" class="headerlink" title="@SpringBootApplication 注解"></a>@SpringBootApplication 注解</h4><p><code>@SpringBootApplication</code>&#x3D;<code>@SpringBootConfiguration</code>+<code>@EnableAutoConfiguration</code>+<code>@ComponentScan</code></p>
<p><code>@EnableAutoConfiguration</code>实现了自动配置，告诉Spring Boot根据你添加的<code>starter</code>依赖项 “猜测” 你想如何配置Spring</p>
<h4 id="main-方法"><a href="#main-方法" class="headerlink" title="main 方法"></a>main 方法</h4><p>main方法通过调用 <code>run</code> 方法，把应用委托给Spring Boot的 <code>SpringApplication</code> 类。 <code>SpringApplication</code> 引导我们的应用程序启动Spring，而Spring又会启动自动配置的Tomcat网络服务器。 我们需要将 <code>启动类得类名.class</code> 作为参数传递给 <code>run</code> 方法，以告诉 <code>SpringApplication</code> 哪个是主要的Spring组件。 <code>args</code> 数组也被传入，这是命令行参数。</p>
<h3 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h3><p>命令行输入<code>mvn spring-boot:run</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ mvn spring-boot:run

  <span class="token builtin class-name">.</span>   ____          _            __ _ _
 /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
 <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
  '  <span class="token operator">|</span>____<span class="token operator">|</span> .__<span class="token operator">|</span>_<span class="token operator">|</span> <span class="token operator">|</span>_<span class="token operator">|</span>_<span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">\</span>__, <span class="token operator">|</span> / / / /
 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>_<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">|</span>___/<span class="token operator">=</span>/_/_/_/
 :: Spring Boot ::  <span class="token punctuation">(</span>v2.4.8-SNAPSHOT<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token punctuation">(</span>log output here<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>. <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> Started MyApplication <span class="token keyword">in</span> <span class="token number">0.906</span> seconds <span class="token punctuation">(</span>process running <span class="token keyword">for</span> <span class="token number">6.514</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打开你的浏览器，访问 <code>localhost:8080</code> ，看到以下输出。</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">Hello World!<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="创建一个可执行-Jar"><a href="#创建一个可执行-Jar" class="headerlink" title="创建一个可执行 Jar"></a>创建一个可执行 Jar</h3><p>打包为一个独立可执行jar包，它完全可以运行在生产环境中。 可执行的jar文件（有时被称为 “fat jar”）是包含你的编译类以及你的代码运行所需的所有jar依赖项的压缩包。springboot采取了直接嵌套jar,为了创建一个可执行的jar，我们需要在 <code>pom.xml</code> 中添加 <code>spring-boot-maven-plugin</code> 插件。在 <code>pom.xml</code> 的 <code>dependencies</code> 节点下面插入以下几行。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="使用Spring-Boot进行开发"><a href="#使用Spring-Boot进行开发" class="headerlink" title="使用Spring Boot进行开发"></a>使用Spring Boot进行开发</h1><h2 id="starter"><a href="#starter" class="headerlink" title="starter"></a>starter</h2><p>Starter 是一组开箱即用的依赖，简化了项目配置。例如，使用 <code>spring-boot-starter-data-jpa</code> 轻松集成 Spring 和 JPA。</p>
<p><strong>关于Starter的命名</strong></p>
<p>官方 Starter 命名为 <code>spring-boot-starter-*</code>，第三方 Starter 应以项目名称开头，如 <code>thirdpartyproject-spring-boot-starter</code>。</p>
<h2 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h2><p>避免使用 “default package”，使用反转域名（如 <code>com.example.project</code>）作为包名，以防止 Spring Boot 应用程序扫描项目中所有 JAR 包里的所有类，增加不必要的开销和潜在问题。</p>
<h2 id="启动类的位置"><a href="#启动类的位置" class="headerlink" title="启动类的位置"></a>启动类的位置</h2><p>建议将启动类放在根包中,项目结构如下，高于其他类，确保 <code>@SpringBootApplication</code> 默认扫描子包中的所有组件。如果不使用 <code>@SpringBootApplication</code>，可以用 <code>@EnableAutoConfiguration</code> 和 <code>@ComponentScan</code> 代替。</p>
<p><strong>项目结构</strong></p>
<pre class="line-numbers language-none"><code class="language-none">com
 +- example
     +- myapplication
         +- MyApplication.java
         |
         +- customer
         |   +- Customer.java
         |   +- CustomerController.java
         |   +- CustomerService.java
         |   +- CustomerRepository.java
         |
         +- order
             +- Order.java
             +- OrderController.java
             +- OrderService.java
             +- OrderRepository.java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Configuration-类"><a href="#Configuration-类" class="headerlink" title="Configuration 类"></a>Configuration 类</h2><blockquote>
<p>Spring Boot倾向于使用Java代码进行配置，建议通过 <code>@Configuration</code>类而非 XML 配置。启动类通常作为主要的<code>@SpringBootConfiguration</code> 类(相当于<code>@Configuration</code>)。</p>
</blockquote>
<h3 id="导入Configuration-类"><a href="#导入Configuration-类" class="headerlink" title="导入Configuration 类"></a>导入Configuration 类</h3><p> <code>@Import</code> 注解可以用来导入额外的配置类。 </p>
<p> <code>@ComponentScan</code> 指定扫描路径，来自动扫描加载所有Spring组件，包括 <code>@Configuration</code> 类。</p>
<h3 id="导入XML配置文件"><a href="#导入XML配置文件" class="headerlink" title="导入XML配置文件"></a>导入XML配置文件</h3><p><code>@ImportResource</code> 注解来加载XML配置文件，将xml配置文件中的bean映射成配置类中bean。</p>
<h2 id="自动装配（配置）"><a href="#自动装配（配置）" class="headerlink" title="自动装配（配置）"></a>自动装配（配置）</h2><blockquote>
<p>Spring Boot的自动装配机制旨在简化配置过程，通过自动检测和配置应用程序所需的组件和服务。</p>
</blockquote>
<h3 id="自动配置的工作原理"><a href="#自动配置的工作原理" class="headerlink" title="自动配置的工作原理"></a>自动配置的工作原理</h3><ol>
<li><strong>依赖检测</strong>：Spring Boot 会根据你项目中的依赖自动检测所需的配置。例如，如果你添加了 HSQLDB 依赖，Spring Boot 会检测到这一点。</li>
<li><strong>默认配置</strong>：如果你没有手动配置某些 Bean（例如 <code>DataSource</code>），Spring Boot 会提供默认配置。例如，在检测到 HSQLDB 依赖且没有手动配置 <code>DataSource</code> 的情况下，Spring Boot 会自动配置一个内存数据库。</li>
</ol>
<h3 id="启用自动配置"><a href="#启用自动配置" class="headerlink" title="启用自动配置"></a>启用自动配置</h3><p>要启用自动配置功能，你需要在你的配置类上添加 <code>@EnableAutoConfiguration</code> 或 <code>@SpringBootApplication</code> 注解。</p>
<ul>
<li><code>@EnableAutoConfiguration</code>：启用 Spring Boot 的自动配置机制。</li>
<li><code>@SpringBootApplication</code>：这是一个组合注解，包含了 <code>@EnableAutoConfiguration</code>、<code>@ComponentScan</code> 和 <code>@SpringBootConfiguration</code>，通常用于 Spring Boot 应用的主类。</li>
</ul>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><h4 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h4><p>假设你有一个简单的 Spring Boot 应用，并且添加了 HSQLDB 依赖。</p>
<p><strong>pom.xml</strong>：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.hsqldb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hsqldb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Application.java</strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>@SpringBootApplication</code> 注解启用了自动配置功能。因为你添加了 HSQLDB 依赖，并且没有手动配置 <code>DataSource</code>，Spring Boot 会自动配置一个内存数据库。</p>
<h4 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h4><p>如果你想手动配置 <code>DataSource</code>，可以在配置类中定义一个 <code>DataSource</code> Bean。</p>
<p><strong>DataSourceConfig.java</strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DriverManagerDataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/mydb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Spring Boot 的自动配置机制会检测到你已经手动配置了 <code>DataSource</code>，因此不会再自动配置内存数据库。</p>
<h3 id="如何禁用指定类进行自动装配"><a href="#如何禁用指定类进行自动装配" class="headerlink" title="如何禁用指定类进行自动装配"></a>如何禁用指定类进行自动装配</h3><p>如果你想禁用掉项目中某些自动装配类，可以在 <code>@SpringBootApplication</code> 注解的 <code>exclude</code> 属性中指定，如下例所示。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="依赖注入Bean"><a href="#依赖注入Bean" class="headerlink" title="依赖注入Bean"></a>依赖注入Bean</h2><p>springBoot推荐使用构造函数注入和 <code>@ComponentScan</code> 注解扫描 Bean。如果启动类在顶级包中，<code>@ComponentScan</code> 可省略参数。<code>@SpringBootApplication</code> 已包含 <code>@ComponentScan</code>。以下示例展示了 <code>@Service</code> Bean 使用构造器注入 <code>RiskAssessor</code> Bean。</p>
<p><strong>示例代码：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAccountService</span> <span class="token keyword">implements</span> <span class="token class-name">AccountService</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RiskAssessor</span> riskAssessor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyAccountService</span><span class="token punctuation">(</span><span class="token class-name">RiskAssessor</span> riskAssessor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>riskAssessor <span class="token operator">=</span> riskAssessor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果一个Bean有多个构造函数，你需要用 <code>@Autowired</code> 注解来告诉Spring该用哪个构造函数进行注入。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAccountService</span> <span class="token keyword">implements</span> <span class="token class-name">AccountService</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RiskAssessor</span> riskAssessor<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PrintStream</span> out<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">MyAccountService</span><span class="token punctuation">(</span><span class="token class-name">RiskAssessor</span> riskAssessor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>riskAssessor <span class="token operator">=</span> riskAssessor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>out <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyAccountService</span><span class="token punctuation">(</span><span class="token class-name">RiskAssessor</span> riskAssessor<span class="token punctuation">,</span> <span class="token class-name">PrintStream</span> out<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>riskAssessor <span class="token operator">=</span> riskAssessor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>out <span class="token operator">=</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SpringBootApplication-注解介绍"><a href="#SpringBootApplication-注解介绍" class="headerlink" title="@SpringBootApplication 注解介绍"></a>@SpringBootApplication 注解介绍</h2><p>SpringBoot的开发者希望应用程序可以进行自动装配、自动组件扫描、允许导入额外的配置类，因此采用了<code>@SpringBootApplication</code> 注解就可以用来启用这三个功能</p>
<ul>
<li><code>@EnableAutoConfiguration</code>：启用Spring Boot的自动配置机制。</li>
<li><code>@ComponentScan</code>：对应用程序所在的包启用 <code>@Component</code> 扫描</li>
<li><code>@SpringBootConfiguration</code>：允许在Context中注册额外的Bean或导入额外的配置类</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Same as @SpringBootConfiguration @EnableAutoConfiguration @ComponentScan</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h1><h2 id="SpringApplication"><a href="#SpringApplication" class="headerlink" title="SpringApplication"></a>SpringApplication</h2><blockquote>
<p>通过调用SpringApplication类的run静态方法，启动springboot应用程序</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="启用失败"><a href="#启用失败" class="headerlink" title="启用失败"></a>启用失败</h3><p>如果应用程序启动失败，日志里面异常信息不够，可以通过debug模式启动，来显示完整的报告，更好的了解报错原因。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">java</span> <span class="token parameter variable">-jar</span> myproject-0.0.1-SNAPSHOT.jar <span class="token parameter variable">--debug</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="懒初始化（Lazy-Initialization）"><a href="#懒初始化（Lazy-Initialization）" class="headerlink" title="懒初始化（Lazy Initialization）"></a>懒初始化（Lazy Initialization）</h3><p>懒加载就是应用程序启动的时候不会创建所有Bean，只有在需要这个Bean的时候才会创建这个Bean。</p>
<p><strong>创建懒加载的方式</strong></p>
<ol>
<li>使用 <code>SpringApplicationBuilder</code> 的 <code>lazyInitialization</code> 方法</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">lazyInitialization</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>使用 <code>SpringApplication</code> 的 <code>setLazyInitialization</code> 方法</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">setLazyInitialization</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>使用 <code>spring.main.lazy-initialization</code> 属性</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">lazy-initialization</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>如果你想禁用某些Bean的懒初始化，同时对应用程序的其他部分使用懒初始化，你可以使用 <code>@Lazy(false)</code> 注解将其<code>Lazy</code> 属性显式地设置为 false。</p>
</blockquote>
<h3 id="自定义-Banner"><a href="#自定义-Banner" class="headerlink" title="自定义 Banner"></a>自定义 Banner</h3><p>启动时打印的Banner可以通过在 classpath 中添加 <code>banner.txt</code> 文件或通过将 <code>spring.banner.location</code> 属性设置为该文件的位置来自定义。 如果该文件的编码不是UTF-8，你可以通过 <code>spring.banner.charset</code> 属性设置其字符编码。</p>
<h3 id="自定义SpringApplication"><a href="#自定义SpringApplication" class="headerlink" title="自定义SpringApplication"></a>自定义SpringApplication</h3><p>如果需要修改springBoot的默认值，可以进行自定义，如关闭banner</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MpApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span> springApplication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">MpApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        springApplication<span class="token punctuation">.</span><span class="token function">setBannerMode</span><span class="token punctuation">(</span><span class="token class-name">Banner<span class="token punctuation">.</span>Mode</span><span class="token punctuation">.</span><span class="token constant">OFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        springApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Builder-API"><a href="#Builder-API" class="headerlink" title="Builder API"></a>Builder API</h3><p><code>SpringApplicationBuilder</code> 允许你链式调用多个方法，包括调用 <code>parent</code> 和 <code>child</code> 方法，创建一个层次结构，如下例所示。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span><span class="token class-name">Parent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">child</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bannerMode</span><span class="token punctuation">(</span><span class="token class-name">Banner<span class="token punctuation">.</span>Mode</span><span class="token punctuation">.</span><span class="token constant">OFF</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Application-事件和监听器"><a href="#Application-事件和监听器" class="headerlink" title="Application 事件和监听器"></a>Application 事件和监听器</h3><p>在 Spring Boot 应用程序中，除了常见的 Spring 框架事件（如 <code>ContextRefreshedEvent</code>）之外，<code>SpringApplication</code> 还会发布一些额外的应用事件。这些事件可以帮助开发者在应用程序的不同启动阶段执行特定的逻辑。</p>
<p><strong>1.事件发布顺序</strong></p>
<p>以下是 <code>SpringApplication</code> 发布的事件按顺序列出：</p>
<ol>
<li><strong>ApplicationStartingEvent</strong>：<ul>
<li><strong>时机</strong>：应用程序启动时，最早发布的事件。</li>
<li><strong>作用</strong>：在任何处理之前（除了注册监听器和初始化器），发布此事件。</li>
</ul>
</li>
<li><strong>ApplicationEnvironmentPreparedEvent</strong>：<ul>
<li><strong>时机</strong>：在上下文创建之前，当 <code>Environment</code> 已知时发布。</li>
<li><strong>作用</strong>：表示 <code>Environment</code> 已准备好，但上下文还未创建。</li>
</ul>
</li>
<li><strong>ApplicationContextInitializedEvent</strong>：<ul>
<li><strong>时机</strong>：<code>ApplicationContext</code> 已准备好并且 <code>ApplicationContextInitializers</code> 被调用，但在任何 Bean 定义被加载之前发布。</li>
<li><strong>作用</strong>：表示上下文已初始化，但还未加载 Bean 定义。</li>
</ul>
</li>
<li><strong>ApplicationPreparedEvent</strong>：<ul>
<li><strong>时机</strong>：在刷新开始前但在 Bean 定义加载后发布。</li>
<li><strong>作用</strong>：表示 Bean 定义已加载，但上下文还未刷新。</li>
</ul>
</li>
<li><strong>ApplicationStartedEvent</strong>：<ul>
<li><strong>时机</strong>：上下文被刷新之后，但在任何应用程序和命令行运行程序被调用之前发布。</li>
<li><strong>作用</strong>：表示应用程序已启动，但还未运行任何 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code>。</li>
</ul>
</li>
<li>**AvailabilityChangeEvent (LivenessState.CORRECT)**：<ul>
<li><strong>时机</strong>：紧接着 <code>ApplicationStartedEvent</code> 发布。</li>
<li><strong>作用</strong>：表明应用程序被认为是存活的（Liveness）。</li>
</ul>
</li>
<li><strong>ApplicationReadyEvent</strong>：<ul>
<li><strong>时机</strong>：在所有 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 被调用后发布。</li>
<li><strong>作用</strong>：表示应用程序已准备好，可以接受请求。</li>
</ul>
</li>
<li>**AvailabilityChangeEvent (ReadinessState.ACCEPTING_TRAFFIC)**：<ul>
<li><strong>时机</strong>：紧接着 <code>ApplicationReadyEvent</code> 发布。</li>
<li><strong>作用</strong>：表明应用程序已准备好为请求提供服务（Readiness）。</li>
</ul>
</li>
<li><strong>ApplicationFailedEvent</strong>：<ul>
<li><strong>时机</strong>：启动时出现异常时发布。</li>
<li><strong>作用</strong>：表示应用程序启动失败。</li>
</ul>
</li>
</ol>
<p>2.<strong>注册监听器</strong></p>
<p>有些事件是在 <code>ApplicationContext</code> 被创建之前触发的，所以你不能以 <code>@Bean</code> 的形式注册监听器。你可以通过以下方式注册监听器：</p>
<ol>
<li><strong>通过 <code>SpringApplication.addListeners(…)</code> 方法</strong>：</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">addListeners</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyApplicationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li><strong>通过 <code>SpringApplicationBuilder.listeners(…)</code> 方法</strong>：</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyApplicationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="WEB-环境（Environment）"><a href="#WEB-环境（Environment）" class="headerlink" title="WEB 环境（Environment）"></a>WEB 环境（Environment）</h3><p><code>SpringApplication</code> 会试图帮你创建正确类型的 <code>ApplicationContext</code>，具体 <code>WebApplicationType</code> 的算法如下。</p>
<ul>
<li>如果Spring MVC存在，就会使用 <code>AnnotationConfigServletWebServerApplicationContext</code>。</li>
<li>如果Spring MVC不存在而Spring WebFlux存在，则使用 <code>AnnotationConfigReactiveWebServerApplicationContext</code>。</li>
<li>否则，将使用 <code>AnnotationConfigApplicationContext</code>。</li>
</ul>
<h3 id="访问应用参数"><a href="#访问应用参数" class="headerlink" title="访问应用参数"></a>访问应用参数</h3><p>传递给 <code>SpringApplication.run(..)</code> 的命令行参数,通过 <code>ApplicationArguments</code> 接口，访问原始的 <code>String[]</code> 参数以及经过解析的 <code>option</code> 和 <code>non-option</code> 参数。</p>
<h3 id="使用-ApplicationRunner-或-CommandLineRunner"><a href="#使用-ApplicationRunner-或-CommandLineRunner" class="headerlink" title="使用 ApplicationRunner 或 CommandLineRunner"></a>使用 ApplicationRunner 或 CommandLineRunner</h3><p><code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 是 Spring Boot 提供的两个接口，用于在 Spring Boot 应用程序启动完成后执行特定的代码。这两个接口的主要作用是在应用程序启动并初始化所有 Spring 容器和 beans 之后，执行一些自定义逻辑。它们提供了在应用程序初始化完成后立即执行代码的机制，适用于各种初始化任务、资源加载、数据检查等场景。</p>
<p><strong>1.ApplicationRunner</strong></p>
<p><code>ApplicationRunner</code> 接口的 <code>run</code> 方法接受一个 <code>ApplicationArguments</code> 对象，该对象包含传递给应用程序的参数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplicationRunner</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApplicationRunner is running with args: "</span> <span class="token operator">+</span> args<span class="token punctuation">.</span><span class="token function">getOptionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.CommandLineRunner</strong></p>
<p><code>CommandLineRunner</code> 接口的 <code>run</code> 方法接受一个 <code>String</code> 数组，该数组包含传递给应用程序的原始命令行参数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandLineRunner</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CommandLineRunner is running with args: "</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.主要区别</strong></p>
<ul>
<li><strong>参数类型</strong>：<ul>
<li><code>ApplicationRunner</code> 接受 <code>ApplicationArguments</code> 对象，提供了对传递给应用程序的参数的更丰富的访问方式。</li>
<li><code>CommandLineRunner</code> 接受一个 <code>String</code> 数组，包含传递给应用程序的原始命令行参数。</li>
</ul>
</li>
<li><strong>使用场景</strong>：<ul>
<li><code>ApplicationRunner</code> 更适合需要解析和处理复杂参数的场景。</li>
<li><code>CommandLineRunner</code> 更适合处理简单的命令行参数。</li>
</ul>
</li>
</ul>
<h3 id="SpringBoot程序退出机制"><a href="#SpringBoot程序退出机制" class="headerlink" title="SpringBoot程序退出机制"></a>SpringBoot程序退出机制</h3><p><strong>1.JVM Shutdown Hook</strong></p>
<p>每个 <code>SpringApplication</code> 都会向 JVM 注册一个 shutdown hook，以确保在 JVM 退出时优雅地关闭 <code>ApplicationContext</code>。这意味着在应用程序退出时，Spring 会自动调用所有标准的生命周期回调，例如实现了 <code>DisposableBean</code> 接口的 bean 或带有 <code>@PreDestroy</code> 注解的方法。</p>
<p><strong>2.ExitCodeGenerator 接口</strong></p>
<p>如果你希望在应用程序退出时返回特定的退出代码，可以实现 <code>org.springframework.boot.ExitCodeGenerator</code> 接口。这个接口只有一个方法 <code>getExitCode()</code>，返回一个整数作为退出代码。</p>
<h3 id="开启管理功能"><a href="#开启管理功能" class="headerlink" title="开启管理功能"></a>开启管理功能</h3><p>设置 <code>spring.application.admin.enabled</code> 属性为true，启用应用程序的管理相关功能，它会在 <code>MBeanServer</code> 平台上暴露了 <code>SpringApplicationAdminMXBean</code>，<strong>打开 JMX 客户端</strong>，<strong>连接到应用程序</strong>。</p>
<h3 id="SpringBoot启动流程分析"><a href="#SpringBoot启动流程分析" class="headerlink" title="SpringBoot启动流程分析"></a>SpringBoot启动流程分析</h3><p>在 Spring Boot 应用程序启动期间，<code>SpringApplication</code> 和 <code>ApplicationContext</code> 会执行许多与应用程序生命周期相关的任务，包括 Bean 的生命周期管理和事件处理。为了更好地了解和分析应用程序的启动过程，Spring 框架提供了 <code>ApplicationStartup</code> 接口，通过 <code>StartupStep</code> 对象来跟踪应用程序的启动顺序。</p>
<h2 id="外部化的配置"><a href="#外部化的配置" class="headerlink" title="外部化的配置"></a>外部化的配置</h2><p>在不同的环境中使用相同的应用程序代码,可以通过多种外部配置源（如properties、YAML、环境变量、命令行参数）来实现。Spring Boot 使用一个特定的 <code>PropertySource</code> 顺序来加载配置，这样后面的配置源可以覆盖前面的配置源。</p>
<p>properties文件 &gt; YAML文件 &gt; 环境变量 &gt; 命令行参数  </p>
<blockquote>
<p>properties文件和YAML文件，按顺序加载，JAR包内的先执行，JAR 包外的文件优先于 JAR 包内的文件。</p>
</blockquote>
<p><strong>配置数据文件的加载顺序</strong></p>
<ol>
<li><strong>在 JAR 包内的 <code>application.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包内的特定 Profile 的 <code>application-&#123;profile&#125;.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包外的 <code>application.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包外的特定 Profile 的 <code>application-&#123;profile&#125;.properties</code> 和 YAML 文件</strong>。</li>
</ol>
<h3 id="通过命令行参数获取属性"><a href="#通过命令行参数获取属性" class="headerlink" title="通过命令行参数获取属性"></a>通过命令行参数获取属性</h3><ul>
<li><strong>通过 <code>@Value</code> 注解</strong>：直接注入属性值。</li>
<li><strong>通过 <code>Environment</code> 接口</strong>：使用 <code>Environment</code> 获取属性值。</li>
<li><strong>通过 <code>@ConfigurationProperties</code> 注解</strong>：将属性绑定到一个 POJO 类中。</li>
<li><strong>通过 <code>ApplicationArguments</code> 接口</strong>：获取原始的命令行参数。</li>
</ul>
<h3 id="通过Json获取属性"><a href="#通过Json获取属性" class="headerlink" title="通过Json获取属性"></a>通过Json获取属性</h3><p>环境变量和系统属性往往有限制，这意味着有些属性名称不能使用。 为了帮助解决这个问题，Spring Boot允许你将一个属性块编码为一个单一的JSON结构。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">SPRING_APPLICATION_JSON</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span> <span class="token function">java</span> <span class="token parameter variable">-jar</span> myapp.jar
$ <span class="token function">java</span> <span class="token parameter variable">-Dspring.application.json</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span> <span class="token parameter variable">-jar</span> myapp.jar
$ <span class="token function">java</span> <span class="token parameter variable">-jar</span> myapp.jar <span class="token parameter variable">--spring.application.json</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="通过Application-Properties获取属性"><a href="#通过Application-Properties获取属性" class="headerlink" title="通过Application Properties获取属性"></a>通过Application Properties获取属性</h3><p>Spring Boot会自动从以下位置找到并加载 <code>application.properties</code> 和 <code>application.yaml</code> 文件。</p>
<h4 id="加载顺序"><a href="#加载顺序" class="headerlink" title="加载顺序"></a>加载顺序</h4><p>加载顺序如下，最后的会覆盖前面的</p>
<ol>
<li><strong>当前目录的 <code>/config</code> 子目录</strong>：<ul>
<li><code>file:./config/</code></li>
</ul>
</li>
<li><strong>当前目录</strong>：<ul>
<li><code>file:./</code></li>
</ul>
</li>
<li><strong>类路径的 <code>/config</code> 包</strong>：<ul>
<li><code>classpath:/config/</code></li>
</ul>
</li>
<li><strong>类路径的根目录</strong>：<ul>
<li><code>classpath:/</code></li>
</ul>
</li>
</ol>
<p>示例说明</p>
<p>假设你有以下配置文件内容：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#./config/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8081</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_config</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#./application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8082</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/config/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8083</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_config</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8084</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>最终结果</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8084</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="特定文件"><a href="#特定文件" class="headerlink" title="特定文件"></a>特定文件</h4><p>Spring Boot可以使用 <code>application-&#123;profile&#125;</code> 的命名惯例加载profile特定的文件。</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#application.profile</span>
<span class="token key attr-name">spring.profiles.active</span><span class="token punctuation">=</span><span class="token value attr-value">prod</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#application-prod.profile</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h4><p><code>@ConfigurationProperties</code> 注解用于将外部化配置（如 <code>application.properties</code> 或 <code>application.yml</code> 文件中的属性）绑定到一个 POJO 类中。通过 <code>@ConfigurationProperties</code> 注解，你可以将一组相关的属性集中到一个类中，便于管理和使用。</p>
<ol>
<li><strong>定义配置属性类</strong>：创建一个 POJO 类，并使用 <code>@ConfigurationProperties</code> 注解指定属性前缀。</li>
<li><strong>启用配置属性</strong>：在启动类中使用 <code>@EnableConfigurationProperties</code> 注解启用配置属性绑定。</li>
<li><strong>在其他组件中使用配置属性类</strong>：通过依赖注入将配置属性类注入到需要使用的组件中。</li>
</ol>
<h3 id="通过环境变量获取参数"><a href="#通过环境变量获取参数" class="headerlink" title="通过环境变量获取参数"></a>通过环境变量获取参数</h3><p>在 Unix&#x2F;Linux&#x2F;MacOS 中，你可以使用 <code>export</code> 命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SERVER_PORT</span><span class="token operator">=</span><span class="token number">8085</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SPRING_DATASOURCE_URL</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/mydb_env<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>通过Environment接口获取变量</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Environment</span> env<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> serverPort <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> datasourceUrl <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.datasource.url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server Port: "</span> <span class="token operator">+</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Datasource URL: "</span> <span class="token operator">+</span> datasourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h1><p>在 Spring Boot 中，实现国际化（i18n）可以让应用程序支持多种语言和区域设置。以下是如何在 Spring Boot 应用程序中使用国际化的详细步骤：</p>
<h2 id="配置国际化资源文件"><a href="#配置国际化资源文件" class="headerlink" title="配置国际化资源文件"></a>配置国际化资源文件</h2><p>首先，你需要创建包含不同语言的资源文件。通常，这些文件位于 <code>src/main/resources</code> 目录下，并且以 <code>.properties</code> 文件的形式存在。</p>
<ul>
<li><code>messages.properties</code>（默认语言）</li>
</ul>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">greeting</span><span class="token punctuation">=</span><span class="token value attr-value">Hello</span>
<span class="token key attr-name">farewell</span><span class="token punctuation">=</span><span class="token value attr-value">Goodbye</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><code>messages_fr.properties</code>（法语）</li>
</ul>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">greeting</span><span class="token punctuation">=</span><span class="token value attr-value">Bonjour</span>
<span class="token key attr-name">farewell</span><span class="token punctuation">=</span><span class="token value attr-value">Au revoir</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><code>messages_es.properties</code>（西班牙语）</li>
</ul>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">greeting</span><span class="token punctuation">=</span><span class="token value attr-value">Hola</span>
<span class="token key attr-name">farewell</span><span class="token punctuation">=</span><span class="token value attr-value">Adiós</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="配置-MessageSource-Bean"><a href="#配置-MessageSource-Bean" class="headerlink" title="配置 MessageSource Bean"></a>配置 <code>MessageSource</code> Bean</h2><p>在你的 Spring Boot 应用程序配置类中，配置 <code>MessageSource</code> Bean 以加载国际化资源文件。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternationalizationConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageSource</span> <span class="token function">messageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReloadableResourceBundleMessageSource</span> messageSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReloadableResourceBundleMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageSource<span class="token punctuation">.</span><span class="token function">setBasename</span><span class="token punctuation">(</span><span class="token string">"classpath:messages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageSource<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> messageSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">LocaleResolver</span> <span class="token function">localeResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CookieLocaleResolver</span> localeResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CookieLocaleResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localeResolver<span class="token punctuation">.</span><span class="token function">setDefaultLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">US</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> localeResolver<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">LocaleChangeInterceptor</span> <span class="token function">localeChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LocaleChangeInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interceptor<span class="token punctuation">.</span><span class="token function">setParamName</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">localeChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用国际化资源"><a href="#使用国际化资源" class="headerlink" title="使用国际化资源"></a>使用国际化资源</h2><p>在你的控制器或服务中，你可以通过 <code>MessageSource</code> Bean 来获取国际化消息。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/greeting"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"lang"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> lang<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Locale</span> locale <span class="token operator">=</span> lang <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Locale</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> messageSource<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"greeting"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="切换语言"><a href="#切换语言" class="headerlink" title="切换语言"></a>切换语言</h2><p>你可以通过在 URL 中添加语言参数来切换语言。例如：</p>
<ul>
<li><code>http://localhost:8080/greeting?lang=fr</code> 将返回 “Bonjour”</li>
<li><code>http://localhost:8080/greeting?lang=es</code> 将返回 “Hola”</li>
<li><code>http://localhost:8080/greeting</code> 将返回 “Hello”（默认语言）</li>
</ul>
<h2 id="使用-RequestHeader-注解自动检测语言"><a href="#使用-RequestHeader-注解自动检测语言" class="headerlink" title="使用 @RequestHeader 注解自动检测语言"></a>使用 <code>@RequestHeader</code> 注解自动检测语言</h2><p>你还可以使用 <code>@RequestHeader</code> 注解自动检测请求中的 <code>Accept-Language</code> 头来设置语言。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreetingController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/greeting"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Accept-Language"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> messageSource<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"greeting"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> locale <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> locale <span class="token operator">:</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Json"><a href="#Json" class="headerlink" title="Json"></a>Json</h1><p>Spring Boot提供了与三个JSON库的集成,Jackson是首选和默认的库。</p>
<ul>
<li>Gson</li>
<li>Jackson</li>
<li>JSON-B</li>
</ul>
<p>Jackson 是一个用于处理 JSON 数据的流行库，广泛应用于 Java 应用程序中。它可以轻松地将 Java 对象转换为 JSON 格式（序列化），以及将 JSON 数据转换为 Java 对象（反序列化）。在 Spring Boot 中，Jackson 通常用于处理 RESTful API 的请求和响应。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="序列化（将-Java-对象转换为-JSON）"><a href="#序列化（将-Java-对象转换为-JSON）" class="headerlink" title="序列化（将 Java 对象转换为 JSON）"></a>序列化（将 Java 对象转换为 JSON）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建一个示例对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"John Doe"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将对象转换为 JSON 字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="反序列化（将-JSON-转换为-Java-对象）"><a href="#反序列化（将-JSON-转换为-Java-对象）" class="headerlink" title="反序列化（将 JSON 转换为 Java 对象）"></a>反序列化（将 JSON 转换为 Java 对象）</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// JSON 字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token string">"&#123;\"name\":\"John Doe\",\"age\":30&#125;"</span><span class="token punctuation">;</span>

        <span class="token comment">// 将 JSON 字符串转换为对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SpringBoot中使用-Jackson"><a href="#SpringBoot中使用-Jackson" class="headerlink" title="SpringBoot中使用 Jackson"></a>SpringBoot中使用 Jackson</h2><p>在 Spring Boot 中，Jackson 通常用于处理 RESTful API 的请求和响应。Spring Boot 默认使用 Jackson 作为 JSON 处理库。</p>
<h3 id="创建Rest控制器"><a href="#创建Rest控制器" class="headerlink" title="创建Rest控制器"></a>创建Rest控制器</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"John Doe"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="发送请求并查看响应"><a href="#发送请求并查看响应" class="headerlink" title="发送请求并查看响应"></a>发送请求并查看响应</h3><p>启动应用程序后，访问 <code>http://localhost:8080/api/user</code>，你将看到以下 JSON 响应：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
    <span class="token property">"age"</span><span class="token operator">:</span> <span class="token number">30</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="自定义-Jackson-配置"><a href="#自定义-Jackson-配置" class="headerlink" title="自定义 Jackson 配置"></a>自定义 Jackson 配置</h2><p>在 Spring Boot 配置类中定义 <code>ObjectMapper</code> Bean 来自定义 Jackson 的配置。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">INDENT_OUTPUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启用缩进输出</span>
        <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Jackson注解"><a href="#Jackson注解" class="headerlink" title="Jackson注解"></a>Jackson注解</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@JsonPropertyOrder</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 指定 JSON 属性的顺序</span>
<span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">"full_name"</span><span class="token punctuation">)</span> <span class="token comment">// 自定义 JSON 属性名</span>
<span class="token annotation punctuation">@JsonIgnore</span> <span class="token comment">// 忽略这个属性,使其不被序列化或反序列化</span>
<span class="token annotation punctuation">@JsonInclude</span> 注解可以指定只包含非空属性    
<span class="token annotation punctuation">@JsonSerialize</span> 、<span class="token annotation punctuation">@JsonDeserialize</span> <span class="token comment">//注解可以自定义序列化和反序列化的逻辑。    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Executor和TaskScheduler"><a href="#Executor和TaskScheduler" class="headerlink" title="Executor和TaskScheduler"></a>Executor<code>和</code>TaskScheduler</h1><p><code>Executor</code> 和 <code>TaskScheduler</code> 在Spring Boot中的主要作用就是执行异步任务和定时任务。</p>
<h2 id="异步任务执行-Executor"><a href="#异步任务执行-Executor" class="headerlink" title="异步任务执行 (Executor)"></a>异步任务执行 (<code>Executor</code>)</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>异步任务允许你在后台执行一些耗时的操作，而不会阻塞主线程。这对于提高应用程序的性能和响应速度非常有用。常见的异步任务包括：</p>
<ul>
<li>发送电子邮件</li>
<li>处理文件上传</li>
<li>调用远程服务</li>
<li>数据处理和计算</li>
</ul>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>使用 <code>@EnableAsync</code> 注解来启用异步任务执行，并使用 <code>@Async</code> 注解来标记需要异步执行的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AsyncApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Async</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Executing async task..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 模拟耗时操作</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Async task completed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="定时任务执行-TaskScheduler"><a href="#定时任务执行-TaskScheduler" class="headerlink" title="定时任务执行 (TaskScheduler)"></a>定时任务执行 (<code>TaskScheduler</code>)</h2><h3 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h3><p>定时任务允许你在指定的时间间隔或特定的时间点执行某些操作。这对于执行周期性任务非常有用。常见的定时任务包括：</p>
<ul>
<li>数据备份</li>
<li>日志清理</li>
<li>定期报告生成</li>
<li>定时发送通知</li>
</ul>
<h3 id="如何使用-1"><a href="#如何使用-1" class="headerlink" title="如何使用"></a>如何使用</h3><p>使用 <code>@EnableScheduling</code> 注解来启用定时任务执行，并使用 <code>@Scheduled</code> 注解来标记需要定时执行的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SchedulingApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SchedulingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedRate <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Executing scheduled task..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="配置和优化"><a href="#配置和优化" class="headerlink" title="配置和优化"></a>配置和优化</h2><p>通过配置文件或自定义配置类来优化 <code>Executor</code> 和 <code>TaskScheduler</code> 的性能，以满足特定的需求。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">spring:
  task:
    execution:
      pool:
        max-size: 16
        queue-capacity: 100
        keep-alive: "10s"
    scheduling:
      thread-name-prefix: "scheduling-"
      pool:
        size: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"taskExecutor"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"Async-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskScheduler</span> <span class="token function">taskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThreadPoolTaskScheduler</span> scheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">setPoolSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"Scheduling-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> scheduler<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>Spring Boot提供了强大的测试支持，可以帮助你编写和运行各种类型的测试，包括单元测试、集成测试和端到端测试。</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>单元测试是测试代码的最小单位，通常是一个方法或一个类。Spring Boot提供了JUnit和Mockito等工具来编写单元测试。</p>
<h3 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAddition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用Mockito进行单元测试"><a href="#使用Mockito进行单元测试" class="headerlink" title="使用Mockito进行单元测试"></a>使用Mockito进行单元测试</h2><p>Mockito是一个流行的Java库，用于创建和配置模拟对象。它非常适合用来测试依赖于其他类或服务的类。</p>
<h3 id="服务类"><a href="#服务类" class="headerlink" title="服务类"></a>服务类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="测试类-1"><a href="#测试类-1" class="headerlink" title="测试类"></a>测试类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> <span class="token class-name">MyService</span> myService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@InjectMocks</span>
    <span class="token keyword">private</span> <span class="token class-name">MyServiceTest</span> myServiceTest<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyServiceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MockitoAnnotations</span><span class="token punctuation">.</span><span class="token function">openMocks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGreet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">when</span><span class="token punctuation">(</span>myService<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> myService<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h2><p>集成测试用于测试应用程序的不同部分如何协同工作。Spring Boot提供了 <code>@SpringBootTest</code> 注解来方便地进行集成测试。</p>
<h3 id="控制器类"><a href="#控制器类" class="headerlink" title="控制器类"></a>控制器类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, World"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="测试类-2"><a href="#测试类-2" class="headerlink" title="测试类"></a>测试类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span><span class="token constant">RANDOM_PORT</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyControllerTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TestRestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用MockMvc进行Web层测试"><a href="#使用MockMvc进行Web层测试" class="headerlink" title="使用MockMvc进行Web层测试"></a>使用MockMvc进行Web层测试</h2><p>MockMvc是Spring提供的一个工具，用于测试Spring MVC控制器，而不需要启动整个服务器。</p>
<h3 id="控制器类-1"><a href="#控制器类-1" class="headerlink" title="控制器类"></a>控制器类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, World"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="测试类-3"><a href="#测试类-3" class="headerlink" title="测试类"></a>测试类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@WebMvcTest</span><span class="token punctuation">(</span><span class="token class-name">MyController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyControllerTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MockMvc</span> mockMvc<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        mockMvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andExpect</span><span class="token punctuation">(</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">andExpect</span><span class="token punctuation">(</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><p>SpringBoot支持Web开发，目前有两大框架，Servlet web Application、Reactive Web两种框架</p>
<h2 id="Servlet-Web-Application"><a href="#Servlet-Web-Application" class="headerlink" title="Servlet Web Application"></a>Servlet Web Application</h2><p>构建基于Servlet的Web应用，可以利用Spring Boot对Spring MVC或Jersey的自动配置，常用的是MVC模式。</p>
<h3 id="Spring-web-Mvc框架"><a href="#Spring-web-Mvc框架" class="headerlink" title="Spring web Mvc框架"></a>Spring web Mvc框架</h3><h4 id="两种编程风格"><a href="#两种编程风格" class="headerlink" title="两种编程风格"></a>两种编程风格</h4><ul>
<li><p>基于注解编程风格</p>
</li>
<li><p>基于函数式编程的风格</p>
</li>
</ul>
<h4 id="SpringBoot中的Spring-Mvc自动配置"><a href="#SpringBoot中的Spring-Mvc自动配置" class="headerlink" title="SpringBoot中的Spring Mvc自动配置"></a>SpringBoot中的Spring Mvc自动配置</h4><ol>
<li><strong>视图解析器</strong>：<ul>
<li>包含 <code>ContentNegotiatingViewResolver</code> 和 <code>BeanNameViewResolver</code> Bean，用于视图解析。</li>
</ul>
</li>
<li><strong>静态资源支持</strong>：<ul>
<li>提供对静态资源（如CSS、JavaScript、图像）的服务支持，包括对WebJars的支持。</li>
</ul>
</li>
<li><strong>类型转换和格式化</strong>：<ul>
<li>自动注册 <code>Converter</code>、<code>GenericConverter</code> 和 <code>Formatter</code> Bean，用于类型转换和格式化。</li>
<li>支持 <code>HttpMessageConverters</code>，用于将请求和响应转换为对象。</li>
</ul>
</li>
<li><strong>消息代码解析器</strong>：<ul>
<li>自动注册 <code>MessageCodesResolver</code>，用于国际化和本地化消息的解析。</li>
</ul>
</li>
<li><strong>静态首页</strong>：<ul>
<li>支持静态的 <code>index.html</code> 作为应用程序的首页。</li>
</ul>
</li>
<li><strong>数据绑定初始化</strong>：<ul>
<li>自动使用 <code>ConfigurableWebBindingInitializer</code> Bean，用于初始化数据绑定。</li>
</ul>
</li>
</ol>
<h4 id="定制Spring-MVC"><a href="#定制Spring-MVC" class="headerlink" title="定制Spring MVC"></a>定制Spring MVC</h4><p>如果你需要在保留Spring Boot自动配置的基础上进行更多的MVC定制，可以使用以下方法：</p>
<ol>
<li>使用 <code>WebMvcConfigurer</code></li>
</ol>
<ul>
<li>添加一个不含 <code>@EnableWebMvc</code> 注解的 <code>@Configuration</code> 类，实现 <code>WebMvcConfigurer</code> 接口。</li>
<li>适用于添加拦截器、格式化器、视图控制器等。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFormatters</span><span class="token punctuation">(</span><span class="token class-name">FormatterRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addFormatter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>使用 <code>WebMvcRegistrations</code></li>
</ol>
<ul>
<li>声明一个 <code>WebMvcRegistrations</code> 类型的Bean，用于提供 <code>RequestMappingHandlerMapping</code>、<code>RequestMappingHandlerAdapter</code> 或 <code>ExceptionHandlerExceptionResolver</code> 的自定义实例。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebMvcRegistrations</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcRegistrations</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestMappingHandlerMapping</span> <span class="token function">getRequestMappingHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyRequestMappingHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestMappingHandlerAdapter</span> <span class="token function">getRequestMappingHandlerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyRequestMappingHandlerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ExceptionHandlerExceptionResolver</span> <span class="token function">getExceptionHandlerExceptionResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyExceptionHandlerExceptionResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>完全控制Spring MVC</li>
</ol>
<ul>
<li>添加自己的 <code>@Configuration</code> 并使用 <code>@EnableWebMvc</code> 注解，完全接管Spring MVC的配置。</li>
<li>适用于需要完全自定义Spring MVC行为的场景。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebMvc</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 完全自定义Spring MVC配置</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="HTTP消息转换器（HttpMessageConverter）"><a href="#HTTP消息转换器（HttpMessageConverter）" class="headerlink" title="HTTP消息转换器（HttpMessageConverter）"></a>HTTP消息转换器（HttpMessageConverter）</h4><p><code>HttpMessageConverter</code> 是 Spring MVC 中用于将 HTTP 请求和响应的内容转换为 Java 对象和反之的接口。它在处理 RESTful Web 服务时非常有用，特别是当你需要将请求体转换为 Java 对象，或者将 Java 对象转换为响应体时。</p>
<p><strong>1.主要用途</strong></p>
<ol>
<li><strong>请求体到Java对象的转换</strong>：<ul>
<li>将客户端发送的 JSON、XML 或其他格式的数据转换为 Java 对象。</li>
<li>例如，将一个 JSON 请求体转换为一个 Java 对象，以便在控制器方法中使用。</li>
</ul>
</li>
<li><strong>Java对象到响应体的转换</strong>：<ul>
<li>将控制器方法返回的 Java 对象转换为 JSON、XML 或其他格式的数据，以便发送给客户端。</li>
<li>例如，将一个 Java 对象转换为 JSON 响应体，发送给客户端。</li>
</ul>
</li>
</ol>
<p><strong>2.默认行为</strong></p>
<p>Spring Boot 提供了一些开箱即用的合理默认值。默认情况下，Spring Boot 会自动配置以下 <code>HttpMessageConverter</code>：</p>
<ul>
<li><strong>JSON 转换</strong>：使用 Jackson 库将 Java 对象转换为 JSON 格式，或将 JSON 格式的数据转换为 Java 对象。</li>
<li><strong>XML 转换</strong>：如果 Jackson XML 扩展可用，使用 Jackson XML 扩展进行 XML 转换；否则，使用 JAXB 进行 XML 转换。</li>
<li><strong>字符串转换</strong>：默认情况下，字符串是以 UTF-8 编码的。</li>
</ul>
<p><strong>3.自定义</strong> <code>HttpMessageConverter</code></p>
<p>如果你需要添加或定制 <code>HttpMessageConverter</code>，可以通过配置类来实现。你可以添加新的转换器，或者覆盖默认的转换器。</p>
<p><strong>pom.xml</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>自定义转换器配置</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyHttpMessageConvertersConfiguration</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">HttpMessageConverters</span> <span class="token function">customConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> converters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 添加一个自定义的字符串转换器</span>
        <span class="token class-name">StringHttpMessageConverter</span> stringConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringHttpMessageConverter</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stringConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 添加一个自定义的 JSON 转换器</span>
        <span class="token class-name">MappingJackson2HttpMessageConverter</span> jsonConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappingJackson2HttpMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jsonConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpMessageConverters</span><span class="token punctuation">(</span>converters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>/api/hello</code> 端点将返回一个字符串，<code>/api/json</code> 端点将返回一个 JSON 对象,自定义的 <code>HttpMessageConverter</code> 将处理这些。</p>
<h4 id="CORS-跨域的支持"><a href="#CORS-跨域的支持" class="headerlink" title="CORS 跨域的支持"></a>CORS 跨域的支持</h4><p>跨源资源共享（CORS，Cross-Origin Resource Sharing）是一种W3C规范，允许服务器定义哪些跨域请求是被允许的。这对于现代Web应用程序来说非常重要，因为它允许客户端（如浏览器）从不同的域名请求资源，而不会受到同源策略的限制。</p>
<p>从Spring 4.2版本开始，Spring MVC 支持CORS。Spring Boot 提供了两种配置CORS的方法：</p>
<p><strong>1.局部CORS配置</strong></p>
<p>你可以在控制器类或方法上使用 <code>@CrossOrigin</code> 注解来配置CORS。例如</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@CrossOrigin</span><span class="token punctuation">(</span>origins <span class="token operator">=</span> <span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/api/data"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.全局CORS配置</strong></p>
<p>为整个应用程序配置CORS，可以通过实现 <code>WebMvcConfigurer</code> 接口并重写 <code>addCorsMappings</code> 方法来实现全局CORS配置。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCorsConfiguration</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token function">corsConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCorsMappings</span><span class="token punctuation">(</span><span class="token class-name">CorsRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 允许跨域访问的路径</span>
                registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token string">"/api/**"</span><span class="token punctuation">)</span>
                        <span class="token comment">// 允许的源</span>
                        <span class="token punctuation">.</span><span class="token function">allowedOrigins</span><span class="token punctuation">(</span><span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
                        <span class="token comment">// 允许的方法</span>
                        <span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">)</span>
                        <span class="token comment">// 允许的请求头</span>
                        <span class="token punctuation">.</span><span class="token function">allowedHeaders</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>
                        <span class="token comment">// 是否允许发送Cookie</span>
                        <span class="token punctuation">.</span><span class="token function">allowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token comment">// 预检请求的缓存时间（秒）</span>
                        <span class="token punctuation">.</span><span class="token function">maxAge</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.CORS应用场景</strong></p>
<ul>
<li>前后端分离</li>
<li>微服务</li>
<li>第三方API调用</li>
</ul>
<h3 id="JAX-RS-和-Jersey"><a href="#JAX-RS-和-Jersey" class="headerlink" title="JAX-RS 和 Jersey"></a>JAX-RS 和 Jersey</h3><ul>
<li><strong>JAX-RS</strong>：Java API for RESTful Web Services，是一个标准的 API，用于创建 RESTful Web 服务。它提供了一组注解和接口，简化了 RESTful 服务的开发。</li>
<li><strong>Jersey</strong>：JAX-RS 的参考实现，提供了完整的 JAX-RS 功能，并扩展了许多额外的特性和功能，帮助开发者更高效地构建 RESTful 服务。</li>
</ul>
<h3 id="嵌入式Servlet容器支持"><a href="#嵌入式Servlet容器支持" class="headerlink" title="嵌入式Servlet容器支持"></a>嵌入式Servlet容器支持</h3><p>对于Servlet应用，Spring Boot包括对嵌入式 <a target="_blank" rel="noopener" href="https://tomcat.apache.org/">Tomcat</a>、 <a target="_blank" rel="noopener" href="https://www.eclipse.org/jetty/">Jetty</a> 和 <a target="_blank" rel="noopener" href="https://github.com/undertow-io/undertow">Undertow</a> 服务器的支持。默认情况下，嵌入式服务器监听 <code>8080</code> 端口的HTTP请求。</p>
<h2 id="优雅停机"><a href="#优雅停机" class="headerlink" title="优雅停机"></a>优雅停机</h2><p>在生产环境中，应用程序的优雅停机（Graceful Shutdown）是一个非常重要的功能。它确保应用程序在停止或重启时能够完成正在进行的请求处理，并且正确地释放资源，从而避免数据丢失和服务中断。Spring Boot 提供了对优雅停机的支持，使得开发者可以更轻松地实现这一功能。</p>
<h3 id="优雅停机的作用"><a href="#优雅停机的作用" class="headerlink" title="优雅停机的作用"></a>优雅停机的作用</h3><ol>
<li><strong>完成正在进行的请求</strong>：确保正在处理的请求能够在应用程序停止前完成，避免请求被中断。</li>
<li><strong>释放资源</strong>：正确地关闭数据库连接、文件句柄、线程池等资源，避免资源泄漏。</li>
<li><strong>避免数据丢失</strong>：确保数据处理操作（如事务、文件写入）能够在应用程序停止前完成，避免数据丢失。</li>
<li><strong>提高系统稳定性</strong>：在应用程序停止或重启时，减少对系统其他部分的影响，提高系统的整体稳定性。</li>
</ol>
<h3 id="Spring-Boot-的优雅停机配置"><a href="#Spring-Boot-的优雅停机配置" class="headerlink" title="Spring Boot 的优雅停机配置"></a>Spring Boot 的优雅停机配置</h3><p>从 Spring Boot 2.3 开始，Spring Boot 提供了对优雅停机的内置支持。你可以通过配置文件来启用和配置优雅停机功能。</p>
<h4 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h4><p>在 <code>application.properties</code> 或 <code>application.yml</code> 文件中配置优雅停机。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">server:
#启用优雅停机功能。
  shutdown: graceful

spring:
  lifecycle:
#设置每个停机阶段的超时时间为30秒。
    timeout-per-shutdown-phase: 30s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="优雅停机的实现"><a href="#优雅停机的实现" class="headerlink" title="优雅停机的实现"></a>优雅停机的实现</h3><p>Spring Boot 的优雅停机机制主要通过以下几个步骤实现：</p>
<ol>
<li><strong>接收停机信号</strong>：当应用程序接收到停机信号（如 <code>SIGTERM</code>）时，Spring Boot 会开始优雅停机过程。</li>
<li><strong>停止接受新请求</strong>：应用程序会停止接受新的请求，但会继续处理已经接收的请求。</li>
<li><strong>完成正在进行的请求</strong>：应用程序会等待正在进行的请求处理完成，直到达到配置的超时时间。</li>
<li><strong>释放资源</strong>：应用程序会正确地关闭数据库连接、文件句柄、线程池等资源。</li>
<li><strong>停止应用程序</strong>：在所有请求处理完成并释放资源后，应用程序会停止。</li>
</ol>
<blockquote>
<p><strong>使用Tomcat的优雅关机需要Tomcat 9.0.33或更高版本。</strong></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/SpringBoot%E7%90%86%E8%AE%BA.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/SpringBoot%E7%90%86%E8%AE%BA.html" itemprop="url">SpringBoot理论</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="什么是SpringBoot"><a href="#什么是SpringBoot" class="headerlink" title="什么是SpringBoot"></a>什么是SpringBoot</h2><p>Spring Boot是一个用于创建独立、生产级Spring应用程序的框架。它简化了Spring应用程序的开发，通过提供一系列开箱即用的配置和功能，使开发者能够快速上手并专注于业务逻辑。</p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li><strong>自动配置</strong>：根据项目中的依赖自动配置Spring应用。</li>
<li><strong>独立运行</strong>：可以打包成可执行的JAR或WAR文件，直接运行。</li>
<li><strong>内嵌服务器</strong>：默认提供内嵌的Tomcat、Jetty和Undertow服务器。</li>
<li><strong>简化的Maven配置</strong>：通过提供的“starter”依赖，简化Maven配置。</li>
<li><strong>生产级监控和管理</strong>：内置健康检查、监控和管理功能。</li>
<li><strong>无代码生成</strong>：没有代码生成，不需要配置文件生成，直接使用Java代码配置。</li>
</ul>
<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><blockquote>
<p>Spring Boot倾向于使用Java代码进行配置，建议通过 <code>@Configuration</code>类而非 XML 配置。启动类通常作为主要的<code>@SpringBootConfiguration</code> 类(相当于<code>@Configuration</code>)。</p>
</blockquote>
<h3 id="导入Configuration-类"><a href="#导入Configuration-类" class="headerlink" title="导入Configuration 类"></a>导入Configuration 类</h3><p> <code>@Import</code> 注解可以用来导入额外的配置类。 </p>
<p> <code>@ComponentScan</code> 指定扫描路径，来自动扫描加载所有Spring组件，包括 <code>@Configuration</code> 类。</p>
<h3 id="导入XML配置文件"><a href="#导入XML配置文件" class="headerlink" title="导入XML配置文件"></a>导入XML配置文件</h3><p><code>@ImportResource</code> 注解来加载XML配置文件，将xml配置文件中的bean映射成配置类中bean。</p>
<h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><blockquote>
<p>Spring Boot的自动装配机制旨在简化配置过程，通过自动检测和配置应用程序所需的组件和服务。</p>
</blockquote>
<h3 id="自动配置的工作原理"><a href="#自动配置的工作原理" class="headerlink" title="自动配置的工作原理"></a>自动配置的工作原理</h3><ol>
<li><strong>依赖检测</strong>：Spring Boot 会根据你项目中的依赖自动检测所需的配置。例如，如果你添加了 HSQLDB 依赖，Spring Boot 会检测到这一点。</li>
<li><strong>默认配置</strong>：如果你没有手动配置某些 Bean（例如 <code>DataSource</code>），Spring Boot 会提供默认配置。例如，在检测到 HSQLDB 依赖且没有手动配置 <code>DataSource</code> 的情况下，Spring Boot 会自动配置一个内存数据库。</li>
</ol>
<h3 id="启用自动配置"><a href="#启用自动配置" class="headerlink" title="启用自动配置"></a>启用自动配置</h3><p>要启用自动配置功能，你需要在你的配置类上添加 <code>@EnableAutoConfiguration</code> 或 <code>@SpringBootApplication</code> 注解。</p>
<ul>
<li><code>@EnableAutoConfiguration</code>：启用 Spring Boot 的自动配置机制。</li>
<li><code>@SpringBootApplication</code>：这是一个组合注解，包含了 <code>@EnableAutoConfiguration</code>、<code>@ComponentScan</code> 和 <code>@SpringBootConfiguration</code>，通常用于 Spring Boot 应用的主类。</li>
</ul>
<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p>Spring Boot Actuator提供了一组用于监控和管理Spring Boot应用的端点，包括健康检查、审计、度量和环境信息等。可以通过<code>/actuator</code>访问这些端点，并通过配置文件进行自定义和安全设置。</p>
<h2 id="Starter"><a href="#Starter" class="headerlink" title="Starter"></a>Starter</h2><p>Starter 是一组开箱即用的依赖，简化了项目配置。例如，使用 <code>spring-boot-starter-data-jpa</code> 轻松集成 Spring 和 JPA。</p>
<h2 id="嵌入式Servlet容器有哪些"><a href="#嵌入式Servlet容器有哪些" class="headerlink" title="嵌入式Servlet容器有哪些"></a>嵌入式Servlet容器有哪些</h2><table>
<thead>
<tr>
<th align="left">Servlet 容器</th>
<th align="left">Servlet 版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Tomcat 10.0</td>
<td align="left">5.0</td>
</tr>
<tr>
<td align="left">Jetty 11.0</td>
<td align="left">5.1</td>
</tr>
<tr>
<td align="left">Undertow 2.2 (Jakarta EE 9 variant)</td>
<td align="left">5.0</td>
</tr>
</tbody></table>
<p><strong>默认配置的容器是 Tomcat</strong></p>
<p><strong>原因：</strong></p>
<ol>
<li><strong>广泛使用</strong>：Tomcat 是最常用的 Servlet 容器之一，具有广泛的社区支持和成熟的生态系统。</li>
<li><strong>稳定性和性能</strong>：Tomcat 在性能和稳定性方面表现出色，适用于大多数应用场景。</li>
<li><strong>Spring Boot 的历史原因</strong>：Spring Boot 从一开始就默认使用 Tomcat，许多开发者已经习惯了这种配置。</li>
</ol>
<h2 id="原生镜像"><a href="#原生镜像" class="headerlink" title="原生镜像"></a>原生镜像</h2><blockquote>
<p>raalVM 是一个多语言虚拟机，支持多种编程语言和运行时环境。GraalVM 原生镜像（Native Image）是 GraalVM 提供的一项功能，可以将 Java 应用程序编译成独立的本地可执行文件。这种本地可执行文件不依赖于 JVM，可以在没有 Java 运行时环境的情况下运行。**</p>
</blockquote>
<p>Spring Boot应用程序可以通过使用 GraalVM 22.3 或以上版本 <a target="_blank" rel="noopener" href="https://springdoc.cn/spring-boot/native-image.html#native-image.introducing-graalvm-native-images">转换为原生镜像</a>。</p>
<p>镜像可以通过 <a target="_blank" rel="noopener" href="https://github.com/graalvm/native-build-tools">本地构建工具</a> Gradle&#x2F;Maven插件或GraalVM提供的 <code>native-image</code> 工具来创建。你也可以使用 <a target="_blank" rel="noopener" href="https://github.com/paketo-buildpacks/native-image">native-image Paketo buildpack</a> 来创建原生镜像。</p>
<p>支持以下版本。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GraalVM Community</td>
<td align="left">22.3</td>
</tr>
<tr>
<td align="left">Native Build Tools</td>
<td align="left">0.9.23</td>
</tr>
</tbody></table>
<h1 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h1><h2 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h2><p>懒加载就是应用程序启动的时候不会创建所有Bean，只有在需要这个Bean的时候才会创建这个Bean。</p>
<p><strong>创建懒加载的方式</strong></p>
<ol>
<li>使用 <code>SpringApplicationBuilder</code> 的 <code>lazyInitialization</code> 方法</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">lazyInitialization</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>使用 <code>SpringApplication</code> 的 <code>setLazyInitialization</code> 方法</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">setLazyInitialization</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>使用 <code>spring.main.lazy-initialization</code> 属性</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">lazy-initialization</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>如果你想禁用某些Bean的懒初始化，同时对应用程序的其他部分使用懒初始化，你可以使用 <code>@Lazy(false)</code> 注解将其<code>Lazy</code> 属性显式地设置为 false。</p>
</blockquote>
<h2 id="springBoot的初始化自定义逻辑"><a href="#springBoot的初始化自定义逻辑" class="headerlink" title="springBoot的初始化自定义逻辑"></a>springBoot的初始化自定义逻辑</h2><p><code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 是 Spring Boot 提供的两个接口，用于在 Spring Boot 应用程序启动完成后执行特定的代码。这两个接口的主要作用是在应用程序启动并初始化所有 Spring 容器和 beans 之后，执行一些自定义逻辑。它们提供了在应用程序初始化完成后立即执行代码的机制，适用于各种初始化任务、资源加载、数据检查等场景。</p>
<p><strong>1.ApplicationRunner</strong></p>
<p><code>ApplicationRunner</code> 接口的 <code>run</code> 方法接受一个 <code>ApplicationArguments</code> 对象，该对象包含传递给应用程序的参数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplicationRunner</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApplicationRunner is running with args: "</span> <span class="token operator">+</span> args<span class="token punctuation">.</span><span class="token function">getOptionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.CommandLineRunner</strong></p>
<p><code>CommandLineRunner</code> 接口的 <code>run</code> 方法接受一个 <code>String</code> 数组，该数组包含传递给应用程序的原始命令行参数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandLineRunner</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CommandLineRunner is running with args: "</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.主要区别</strong></p>
<ul>
<li><strong>参数类型</strong>：<ul>
<li><code>ApplicationRunner</code> 接受 <code>ApplicationArguments</code> 对象，提供了对传递给应用程序的参数的更丰富的访问方式。</li>
<li><code>CommandLineRunner</code> 接受一个 <code>String</code> 数组，包含传递给应用程序的原始命令行参数。</li>
</ul>
</li>
<li><strong>使用场景</strong>：<ul>
<li><code>ApplicationRunner</code> 更适合需要解析和处理复杂参数的场景。</li>
<li><code>CommandLineRunner</code> 更适合处理简单的命令行参数。</li>
</ul>
</li>
</ul>
<h2 id="外部配置"><a href="#外部配置" class="headerlink" title="外部配置"></a>外部配置</h2><p>在不同的环境中使用相同的应用程序代码,可以通过多种外部配置源（如properties、YAML、环境变量、命令行参数）来实现。Spring Boot 使用一个特定的 <code>PropertySource</code> 顺序来加载配置，这样后面的配置源可以覆盖前面的配置源。</p>
<p>properties文件 &gt; YAML文件 &gt; 环境变量 &gt; 命令行参数  </p>
<blockquote>
<p>properties文件和YAML文件，按顺序加载，JAR包内的先执行，JAR 包外的文件优先于 JAR 包内的文件。</p>
</blockquote>
<p><strong>配置数据文件的加载顺序</strong></p>
<ol>
<li><strong>在 JAR 包内的 <code>application.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包内的特定 Profile 的 <code>application-&#123;profile&#125;.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包外的 <code>application.properties</code> 和 YAML 文件</strong>。</li>
<li><strong>在 JAR 包外的特定 Profile 的 <code>application-&#123;profile&#125;.properties</code> 和 YAML 文件</strong>。</li>
</ol>
<h3 id="通过命令行参数获取属性"><a href="#通过命令行参数获取属性" class="headerlink" title="通过命令行参数获取属性"></a>通过命令行参数获取属性</h3><ul>
<li><strong>通过 <code>@Value</code> 注解</strong>：直接注入属性值。</li>
<li><strong>通过 <code>Environment</code> 接口</strong>：使用 <code>Environment</code> 获取属性值。</li>
<li><strong>通过 <code>@ConfigurationProperties</code> 注解</strong>：将属性绑定到一个 POJO 类中。</li>
<li><strong>通过 <code>ApplicationArguments</code> 接口</strong>：获取原始的命令行参数。</li>
</ul>
<h3 id="通过Json获取属性"><a href="#通过Json获取属性" class="headerlink" title="通过Json获取属性"></a>通过Json获取属性</h3><p>环境变量和系统属性往往有限制，这意味着有些属性名称不能使用。 为了帮助解决这个问题，Spring Boot允许你将一个属性块编码为一个单一的JSON结构。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">SPRING_APPLICATION_JSON</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span> <span class="token function">java</span> <span class="token parameter variable">-jar</span> myapp.jar
$ <span class="token function">java</span> <span class="token parameter variable">-Dspring.application.json</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span> <span class="token parameter variable">-jar</span> myapp.jar
$ <span class="token function">java</span> <span class="token parameter variable">-jar</span> myapp.jar <span class="token parameter variable">--spring.application.json</span><span class="token operator">=</span><span class="token string">'&#123;"my":&#123;"name":"test"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="通过Application-Properties获取属性"><a href="#通过Application-Properties获取属性" class="headerlink" title="通过Application Properties获取属性"></a>通过Application Properties获取属性</h3><p>Spring Boot会自动从以下位置找到并加载 <code>application.properties</code> 和 <code>application.yaml</code> 文件。</p>
<h4 id="加载顺序"><a href="#加载顺序" class="headerlink" title="加载顺序"></a>加载顺序</h4><p>加载顺序如下，最后的会覆盖前面的</p>
<ol>
<li><strong>当前目录的 <code>/config</code> 子目录</strong>：<ul>
<li><code>file:./config/</code></li>
</ul>
</li>
<li><strong>当前目录</strong>：<ul>
<li><code>file:./</code></li>
</ul>
</li>
<li><strong>类路径的 <code>/config</code> 包</strong>：<ul>
<li><code>classpath:/config/</code></li>
</ul>
</li>
<li><strong>类路径的根目录</strong>：<ul>
<li><code>classpath:/</code></li>
</ul>
</li>
</ol>
<p>示例说明</p>
<p>假设你有以下配置文件内容：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#./config/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8081</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_config</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#./application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8082</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/config/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8083</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_config</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8084</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>最终结果</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#src/main/resources/application.properties</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8084</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/mydb_classpath_root</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="特定文件"><a href="#特定文件" class="headerlink" title="特定文件"></a>特定文件</h4><p>Spring Boot可以使用 <code>application-&#123;profile&#125;</code> 的命名惯例加载profile特定的文件。</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#application.profile</span>
<span class="token key attr-name">spring.profiles.active</span><span class="token punctuation">=</span><span class="token value attr-value">prod</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#application-prod.profile</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h4><p><code>@ConfigurationProperties</code> 注解用于将外部化配置（如 <code>application.properties</code> 或 <code>application.yml</code> 文件中的属性）绑定到一个 POJO 类中。通过 <code>@ConfigurationProperties</code> 注解，你可以将一组相关的属性集中到一个类中，便于管理和使用。</p>
<ol>
<li><strong>定义配置属性类</strong>：创建一个 POJO 类，并使用 <code>@ConfigurationProperties</code> 注解指定属性前缀。</li>
<li><strong>启用配置属性</strong>：在启动类中使用 <code>@EnableConfigurationProperties</code> 注解启用配置属性绑定。</li>
<li><strong>在其他组件中使用配置属性类</strong>：通过依赖注入将配置属性类注入到需要使用的组件中。</li>
</ol>
<h3 id="通过环境变量获取参数"><a href="#通过环境变量获取参数" class="headerlink" title="通过环境变量获取参数"></a>通过环境变量获取参数</h3><p>在 Unix&#x2F;Linux&#x2F;MacOS 中，你可以使用 <code>export</code> 命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SERVER_PORT</span><span class="token operator">=</span><span class="token number">8085</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SPRING_DATASOURCE_URL</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/mydb_env<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>通过Environment接口获取变量</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Environment</span> env<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> serverPort <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> datasourceUrl <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.datasource.url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server Port: "</span> <span class="token operator">+</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Datasource URL: "</span> <span class="token operator">+</span> datasourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="多环境支持"><a href="#多环境支持" class="headerlink" title="多环境支持"></a>多环境支持</h2><p>通过在<code>application.properties</code>文件中配置不同环境的配置文件，例如：</p>
<ul>
<li><code>application-dev.properties</code>：开发环境配置。</li>
<li><code>application-prod.properties</code>：生产环境配置。<br>然后在启动时通过<code>--spring.profiles.active=dev</code>或<code>application.yml</code>中的<code>spring.profiles.active=dev</code>指定激活的配置文件。</li>
</ul>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>在 Spring Boot 应用程序中，除了常见的 Spring 框架事件（如 <code>ContextRefreshedEvent</code>）之外，<code>SpringApplication</code> 还会发布一些额外的应用事件。这些事件可以帮助开发者在应用程序的不同启动阶段执行特定的逻辑。</p>
<p><strong>1.事件发布顺序</strong></p>
<p>以下是 <code>SpringApplication</code> 发布的事件按顺序列出：</p>
<ol>
<li><strong>ApplicationStartingEvent</strong>：<ul>
<li><strong>时机</strong>：应用程序启动时，最早发布的事件。</li>
<li><strong>作用</strong>：在任何处理之前（除了注册监听器和初始化器），发布此事件。</li>
</ul>
</li>
<li><strong>ApplicationEnvironmentPreparedEvent</strong>：<ul>
<li><strong>时机</strong>：在上下文创建之前，当 <code>Environment</code> 已知时发布。</li>
<li><strong>作用</strong>：表示 <code>Environment</code> 已准备好，但上下文还未创建。</li>
</ul>
</li>
<li><strong>ApplicationContextInitializedEvent</strong>：<ul>
<li><strong>时机</strong>：<code>ApplicationContext</code> 已准备好并且 <code>ApplicationContextInitializers</code> 被调用，但在任何 Bean 定义被加载之前发布。</li>
<li><strong>作用</strong>：表示上下文已初始化，但还未加载 Bean 定义。</li>
</ul>
</li>
<li><strong>ApplicationPreparedEvent</strong>：<ul>
<li><strong>时机</strong>：在刷新开始前但在 Bean 定义加载后发布。</li>
<li><strong>作用</strong>：表示 Bean 定义已加载，但上下文还未刷新。</li>
</ul>
</li>
<li><strong>ApplicationStartedEvent</strong>：<ul>
<li><strong>时机</strong>：上下文被刷新之后，但在任何应用程序和命令行运行程序被调用之前发布。</li>
<li><strong>作用</strong>：表示应用程序已启动，但还未运行任何 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code>。</li>
</ul>
</li>
<li>**AvailabilityChangeEvent (LivenessState.CORRECT)**：<ul>
<li><strong>时机</strong>：紧接着 <code>ApplicationStartedEvent</code> 发布。</li>
<li><strong>作用</strong>：表明应用程序被认为是存活的（Liveness）。</li>
</ul>
</li>
<li><strong>ApplicationReadyEvent</strong>：<ul>
<li><strong>时机</strong>：在所有 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 被调用后发布。</li>
<li><strong>作用</strong>：表示应用程序已准备好，可以接受请求。</li>
</ul>
</li>
<li>**AvailabilityChangeEvent (ReadinessState.ACCEPTING_TRAFFIC)**：<ul>
<li><strong>时机</strong>：紧接着 <code>ApplicationReadyEvent</code> 发布。</li>
<li><strong>作用</strong>：表明应用程序已准备好为请求提供服务（Readiness）。</li>
</ul>
</li>
<li><strong>ApplicationFailedEvent</strong>：<ul>
<li><strong>时机</strong>：启动时出现异常时发布。</li>
<li><strong>作用</strong>：表示应用程序启动失败。</li>
</ul>
</li>
</ol>
<p>2.<strong>注册监听器</strong></p>
<p>有些事件是在 <code>ApplicationContext</code> 被创建之前触发的，所以你不能以 <code>@Bean</code> 的形式注册监听器。你可以通过以下方式注册监听器：</p>
<ol>
<li><strong>通过 <code>SpringApplication.addListeners(…)</code> 方法</strong>：</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">addListeners</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyApplicationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li><strong>通过 <code>SpringApplicationBuilder.listeners(…)</code> 方法</strong>：</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyApplicationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><p>Spring Boot提供了与三个JSON库的集成,Jackson是首选和默认的库。</p>
<ul>
<li>Gson</li>
<li>Jackson</li>
<li>JSON-B</li>
</ul>
<p>Jackson 是一个用于处理 JSON 数据的流行库，广泛应用于 Java 应用程序中。它可以轻松地将 Java 对象转换为 JSON 格式（序列化），以及将 JSON 数据转换为 Java 对象（反序列化）。在 Spring Boot 中，Jackson 通常用于处理 RESTful API 的请求和响应。</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><h4 id="序列化（将-Java-对象转换为-JSON）"><a href="#序列化（将-Java-对象转换为-JSON）" class="headerlink" title="序列化（将 Java 对象转换为 JSON）"></a>序列化（将 Java 对象转换为 JSON）</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建一个示例对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"John Doe"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将对象转换为 JSON 字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="反序列化（将-JSON-转换为-Java-对象）"><a href="#反序列化（将-JSON-转换为-Java-对象）" class="headerlink" title="反序列化（将 JSON 转换为 Java 对象）"></a>反序列化（将 JSON 转换为 Java 对象）</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonExample</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// JSON 字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token string">"&#123;\"name\":\"John Doe\",\"age\":30&#125;"</span><span class="token punctuation">;</span>

        <span class="token comment">// 将 JSON 字符串转换为对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="SpringBoot中使用-Jackson"><a href="#SpringBoot中使用-Jackson" class="headerlink" title="SpringBoot中使用 Jackson"></a>SpringBoot中使用 Jackson</h3><p>在 Spring Boot 中，Jackson 通常用于处理 RESTful API 的请求和响应。Spring Boot 默认使用 Jackson 作为 JSON 处理库。</p>
<h4 id="创建Rest控制器"><a href="#创建Rest控制器" class="headerlink" title="创建Rest控制器"></a>创建Rest控制器</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"John Doe"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="发送请求并查看响应"><a href="#发送请求并查看响应" class="headerlink" title="发送请求并查看响应"></a>发送请求并查看响应</h4><p>启动应用程序后，访问 <code>http://localhost:8080/api/user</code>，你将看到以下 JSON 响应：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
    <span class="token property">"age"</span><span class="token operator">:</span> <span class="token number">30</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="自定义-Jackson-配置"><a href="#自定义-Jackson-配置" class="headerlink" title="自定义 Jackson 配置"></a>自定义 Jackson 配置</h3><p>在 Spring Boot 配置类中定义 <code>ObjectMapper</code> Bean 来自定义 Jackson 的配置。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JacksonConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">INDENT_OUTPUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启用缩进输出</span>
        <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Jackson注解"><a href="#Jackson注解" class="headerlink" title="Jackson注解"></a>Jackson注解</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@JsonPropertyOrder</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"name"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 指定 JSON 属性的顺序</span>
<span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">"full_name"</span><span class="token punctuation">)</span> <span class="token comment">// 自定义 JSON 属性名</span>
<span class="token annotation punctuation">@JsonIgnore</span> <span class="token comment">// 忽略这个属性,使其不被序列化或反序列化</span>
<span class="token annotation punctuation">@JsonInclude</span> 注解可以指定只包含非空属性    
<span class="token annotation punctuation">@JsonSerialize</span> 、<span class="token annotation punctuation">@JsonDeserialize</span> <span class="token comment">//注解可以自定义序列化和反序列化的逻辑。    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>什么是Spring Boot DevTools？</p>
<p>Spring Boot DevTools是一个开发工具包，旨在提高开发效率。它提供了自动重启、实时加载属性文件、调试等功能。当类路径上的文件发生变化时，DevTools会自动重新启动应用。</p>
<p>安全</p>
<p>Spring Boot可以集成Spring Security实现安全管理。只需添加<code>spring-boot-starter-security</code>依赖，并通过配置类或配置文件进行安全配置。例如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        http
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/public/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="异步任务执行-Executor"><a href="#异步任务执行-Executor" class="headerlink" title="异步任务执行 (Executor)"></a>异步任务执行 (<code>Executor</code>)</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>异步任务允许你在后台执行一些耗时的操作，而不会阻塞主线程。这对于提高应用程序的性能和响应速度非常有用。常见的异步任务包括：</p>
<ul>
<li>发送电子邮件</li>
<li>处理文件上传</li>
<li>调用远程服务</li>
<li>数据处理和计算</li>
</ul>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>使用 <code>@EnableAsync</code> 注解来启用异步任务执行，并使用 <code>@Async</code> 注解来标记需要异步执行的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AsyncApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Async</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeAsyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Executing async task..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 模拟耗时操作</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Async task completed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="定时任务执行-TaskScheduler"><a href="#定时任务执行-TaskScheduler" class="headerlink" title="定时任务执行 (TaskScheduler)"></a>定时任务执行 (<code>TaskScheduler</code>)</h2><h3 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h3><p>定时任务允许你在指定的时间间隔或特定的时间点执行某些操作。这对于执行周期性任务非常有用。常见的定时任务包括：</p>
<ul>
<li>数据备份</li>
<li>日志清理</li>
<li>定期报告生成</li>
<li>定时发送通知</li>
</ul>
<h3 id="如何使用-1"><a href="#如何使用-1" class="headerlink" title="如何使用"></a>如何使用</h3><p>使用 <code>@EnableScheduling</code> 注解来启用定时任务执行，并使用 <code>@Scheduled</code> 注解来标记需要定时执行的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SchedulingApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SchedulingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedRate <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Executing scheduled task..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="配置和优化"><a href="#配置和优化" class="headerlink" title="配置和优化"></a>配置和优化</h2><p>通过配置文件或自定义配置类来优化 <code>Executor</code> 和 <code>TaskScheduler</code> 的性能，以满足特定的需求。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">spring:
  task:
    execution:
      pool:
        max-size: 16
        queue-capacity: 100
        keep-alive: "10s"
    scheduling:
      thread-name-prefix: "scheduling-"
      pool:
        size: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"taskExecutor"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"Async-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskScheduler</span> <span class="token function">taskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThreadPoolTaskScheduler</span> scheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">setPoolSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduler<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"Scheduling-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> scheduler<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>Spring Boot提供了<code>spring-boot-starter-test</code>，集成了JUnit、Spring Test、AssertJ和Mockito等常用测试框架。可以通过<code>@SpringBootTest</code>注解进行集成测试。例如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceTests</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyService</span> myService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testServiceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">assertNotNull</span><span class="token punctuation">(</span>myService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以通过<code>@MockBean</code>注解创建Mock对象，并注入到Spring应用上下文中。例如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyControllerTests</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@MockBean</span>
    <span class="token keyword">private</span> <span class="token class-name">MyService</span> myService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MockMvc</span> mockMvc<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testControllerMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token function">given</span><span class="token punctuation">(</span>myService<span class="token punctuation">.</span><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">willReturn</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mockMvc<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/someEndpoint"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">andExpect</span><span class="token punctuation">(</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">andExpect</span><span class="token punctuation">(</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="优雅停机"><a href="#优雅停机" class="headerlink" title="优雅停机"></a>优雅停机</h2><p>在生产环境中，应用程序的优雅停机（Graceful Shutdown）是一个非常重要的功能。它确保应用程序在停止或重启时能够完成正在进行的请求处理，并且正确地释放资源，从而避免数据丢失和服务中断。Spring Boot 提供了对优雅停机的支持，使得开发者可以更轻松地实现这一功能。</p>
<h3 id="优雅停机的作用"><a href="#优雅停机的作用" class="headerlink" title="优雅停机的作用"></a>优雅停机的作用</h3><ol>
<li><strong>完成正在进行的请求</strong>：确保正在处理的请求能够在应用程序停止前完成，避免请求被中断。</li>
<li><strong>释放资源</strong>：正确地关闭数据库连接、文件句柄、线程池等资源，避免资源泄漏。</li>
<li><strong>避免数据丢失</strong>：确保数据处理操作（如事务、文件写入）能够在应用程序停止前完成，避免数据丢失。</li>
<li><strong>提高系统稳定性</strong>：在应用程序停止或重启时，减少对系统其他部分的影响，提高系统的整体稳定性。</li>
</ol>
<h3 id="Spring-Boot-的优雅停机配置"><a href="#Spring-Boot-的优雅停机配置" class="headerlink" title="Spring Boot 的优雅停机配置"></a>Spring Boot 的优雅停机配置</h3><p>从 Spring Boot 2.3 开始，Spring Boot 提供了对优雅停机的内置支持。你可以通过配置文件来启用和配置优雅停机功能。</p>
<h4 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h4><p>在 <code>application.properties</code> 或 <code>application.yml</code> 文件中配置优雅停机。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">server:
#启用优雅停机功能。
  shutdown: graceful

spring:
  lifecycle:
#设置每个停机阶段的超时时间为30秒。
    timeout-per-shutdown-phase: 30s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="优雅停机的实现"><a href="#优雅停机的实现" class="headerlink" title="优雅停机的实现"></a>优雅停机的实现</h3><p>Spring Boot 的优雅停机机制主要通过以下几个步骤实现：</p>
<ol>
<li><strong>接收停机信号</strong>：当应用程序接收到停机信号（如 <code>SIGTERM</code>）时，Spring Boot 会开始优雅停机过程。</li>
<li><strong>停止接受新请求</strong>：应用程序会停止接受新的请求，但会继续处理已经接收的请求。</li>
<li><strong>完成正在进行的请求</strong>：应用程序会等待正在进行的请求处理完成，直到达到配置的超时时间。</li>
<li><strong>释放资源</strong>：应用程序会正确地关闭数据库连接、文件句柄、线程池等资源。</li>
<li><strong>停止应用程序</strong>：在所有请求处理完成并释放资源后，应用程序会停止。</li>
</ol>
<blockquote>
<p><strong>使用Tomcat的优雅关机需要Tomcat 9.0.33或更高版本。</strong></p>
</blockquote>
<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><ul>
<li><strong>@SpringBootApplication</strong>：用于标注主类，集成了<code>@Configuration</code>、<code>@EnableAutoConfiguration</code>和<code>@ComponentScan</code>。</li>
<li><strong>@Configuration</strong>：用于定义配置类，等同于XML配置文件。</li>
<li><strong>@EnableAutoConfiguration</strong>：启用自动配置。</li>
<li><strong>@ComponentScan</strong>：自动扫描并注册组件。</li>
<li><strong>@RestController</strong>：用于创建RESTful Web服务的控制器。</li>
<li><strong>@RequestMapping</strong>：用于映射HTTP请求到处理方法。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/API%E7%BD%91%E5%85%B3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/API%E7%BD%91%E5%85%B3.html" itemprop="url">API网关</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是API网关"><a href="#什么是API网关" class="headerlink" title="什么是API网关"></a>什么是API网关</h1><blockquote>
<p>API 网关是一个管理、处理和路由API调用到后端服务的系统。作为微服务架构中的关键组件，API网关为客户端（如移动设备、Web应用程序、第三方服务等）提供了一个统一的入口点，并将请求路由到适当的微服务上。此外，它还可以提供额外的跨服务功能，包括请求聚合、协议转换、请求和响应转换等。</p>
</blockquote>
<h2 id="API的功能"><a href="#API的功能" class="headerlink" title="API的功能"></a>API的功能</h2><h3 id="请求路由"><a href="#请求路由" class="headerlink" title="请求路由"></a>请求路由</h3><p>API网关将接收到的请求转发到正确的服务。例如，它可以基于URL路径或请求参数将请求路由到特定的微服务。</p>
<h3 id="API聚合"><a href="#API聚合" class="headerlink" title="API聚合"></a>API聚合</h3><p>API网关可以将多个API请求聚合为一个请求，减少客户端需要做的调用次数，以便提升性能和用户体验。</p>
<h3 id="身份验证和授权"><a href="#身份验证和授权" class="headerlink" title="身份验证和授权"></a>身份验证和授权</h3><p>它可以在请求到达后端服务之前进行用户身份验证和授权检查，提供安全层，确保只有验证过的用户可以访问敏感信息。</p>
<h3 id="限流和服务降级"><a href="#限流和服务降级" class="headerlink" title="限流和服务降级"></a>限流和服务降级</h3><p>网关可以限制对后端服务的请求频率，帮助防范DDoS攻击，并在系统负载过高时实施服务降级策略。</p>
<h3 id="跨应用程序消息传递"><a href="#跨应用程序消息传递" class="headerlink" title="跨应用程序消息传递"></a>跨应用程序消息传递</h3><p>API网关支持不同类型的跨应用程序通讯协议，如HTTP, WebSocket等。</p>
<h3 id="监控和日志记录"><a href="#监控和日志记录" class="headerlink" title="监控和日志记录"></a>监控和日志记录</h3><p>为了诊断和调试问题，API网关可以对通过它的流量进行监控，并记录日志。</p>
<h3 id="响应转换"><a href="#响应转换" class="headerlink" title="响应转换"></a>响应转换</h3><p>它可以修改微服务的响应，以符合客户端的需要，例如把JSON转换为XML。</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>API网关可以在多个实例之间分配流量，和负载均衡器的工作相似，以提高性能和可靠性。</p>
<h2 id="API网关的原理"><a href="#API网关的原理" class="headerlink" title="API网关的原理"></a>API网关的原理</h2><ol>
<li><p>接收请求：API网关的第一步是接收从客户端发来的API请求。</p>
</li>
<li><p>预处理和验证：在路由请求之前，API网关需要进行一些预处理工作，比如用户认证（确定请求是否来自一个有效的用户）、鉴权（确定用户是否有权访问请求的资源）、请求校验（确定请求是否合法，是否包含全部必要的参数）等。另外，它也可能需要进行一些消息转换或协议转换的工作。</p>
</li>
<li><p>路由请求：API网关将经过校验之后的有效请求路由到正确的后端服务或微服务，比如根据URL或者请求的参数来决定将请求路由到哪一个服务。</p>
</li>
<li><p>请求聚合：对于需要多个微服务共同配合来完成的请求，API网关可以将这些请求聚合，而后一次性返回给客户端。这样可以减少客户端需要发出的请求数，从而提升性能和用户体验。</p>
</li>
<li><p>响应返回：当后端服务处理完请求后，会将响应返回给API网关，网关之后再将这些响应返回给客户端。在这个过程中，API网关可能还会进行一些后处理，比如进行数据格式转换，或者添加一些特殊的HTTP头等。</p>
</li>
<li><p>日志和监控：在整个过程中，API网关会持续记录日志，同时进行性能监控和错误跟踪。这些信息对于系统的维护和故障排查产生重大价值。</p>
</li>
</ol>
<h2 id="API网关的优点"><a href="#API网关的优点" class="headerlink" title="API网关的优点"></a>API网关的优点</h2><ol>
<li><strong>抽象化：</strong>API 网关为外部消费者访问一组微服务提供了一个统一的入口点，对底层实施细节进行抽象化，同时允许微服务独立演进。</li>
<li><strong>安全性：</strong>API 网关可以处理身份验证、授权和速率限制等安全任务，从而提高底层微服务的安全性。</li>
<li><strong>性能：</strong>API 网关可以缓存响应并执行请求&#x2F;响应转换，提高系统的整体性能。</li>
<li><strong>开发人员体验：</strong>API 网关提供分析、归档和测试工具，使开发人员可以更容易建立和维护基于微服务的应用程序。</li>
<li><strong>消费者体验：</strong>API 网关可以让消费者更容易发现和使用微服务提供的 API，改善整体易用性和用户体验。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/ClickHouse.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/ClickHouse.html" itemprop="url">Clickhouse</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-01-24T00:00:00+08:00">
                2024-01-24
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h1><h2 id="什么是ClickHouse？"><a href="#什么是ClickHouse？" class="headerlink" title="什么是ClickHouse？"></a>什么是ClickHouse？</h2><p>ClickHouse是一个用于联机分析(OLAP【online analytical processing】)的列式数据库管理系统(DBMS)</p>
<h3 id="什么是列式数据库？"><a href="#什么是列式数据库？" class="headerlink" title="什么是列式数据库？"></a>什么是列式数据库？</h3><p>列式数据库是先将一列中的数据值连在一起存储起来，然后再存储下一列的数据，并以此类推的数据库。列阵式数据库完全为分析数据而存在，采用密集贮存数据的方式，不考虑少量数据的更新问题，是大数据环境下，针对仓储式数据存储而产生的数据库。</p>
<h3 id="列式数据库的优点"><a href="#列式数据库的优点" class="headerlink" title="列式数据库的优点"></a>列式数据库的优点</h3><p>自动索引：由于将列作为存储形式，每一列本身就可以作为索引，所以不需要多余的数据结构来为此列创建额外索引。</p>
<p>利于数据压缩：由于大多数列数据基数是重复的，因此在列的存储上其实不需要巨大的数据量。其次相同的列数据属性一致，这为数据结构的优化和压缩提供了便利，并且对于数字列可以采取更有效率的算法进行压缩储存。</p>
<p>延迟物化：列式数据库具有特殊的执行引擎，在数据运算的过程中一般无需解压，而是以指针替代运算，直到最后输出完整的数据。这种方式能够有效削减对CPU的耗损，并减少对其内存与网络传输消耗，最终降低储存所需的空间。</p>
<h3 id="列式数据库与行式数据库的区别"><a href="#列式数据库与行式数据库的区别" class="headerlink" title="列式数据库与行式数据库的区别"></a>列式数据库与行式数据库的区别</h3><h4 id="存储数据方式不同"><a href="#存储数据方式不同" class="headerlink" title="存储数据方式不同"></a>存储数据方式不同</h4><p>行式数据库是以行为单位进行数据存储。将一整行的数据在物理位置连续堆叠，再进行连接存储。列式数据库是先将一列中的数据值连在一起存储起来，然后再存储下一列的数据，它的每一列都是相同的属性。</p>
<h4 id="查询方式不同"><a href="#查询方式不同" class="headerlink" title="查询方式不同"></a>查询方式不同</h4><p>行式数据库在查询数据时，会对数据的每一行进行扫描，从而得到我们需要的数据。即使我们只需要其中某一行的数据，也需要对其余的数据进行全面检索。列式数据库仅对我们需要的列进行查询即可，避免建立过多冗杂的索引内容，有效减少了数据量。尤其是在面对海量数据的时候，查询速度快于行式数据库。</p>
<h4 id="应用场景不同"><a href="#应用场景不同" class="headerlink" title="应用场景不同"></a>应用场景不同</h4><p>行式数据库主要应用于传统的业务场景中，比如联机事务处理。列式数据库由于具有查询速度方面的优势，可适用于大数据分析、联机分析处理。</p>
<h3 id="LAP场景的关键特征"><a href="#LAP场景的关键特征" class="headerlink" title="LAP场景的关键特征"></a>LAP场景的关键特征</h3><ul>
<li>绝大多数是读请求</li>
<li>数据以相当大的批次(&gt; 1000行)更新，而不是单行更新;或者根本没有更新。</li>
<li>已添加到数据库的数据不能修改。</li>
<li>对于读取，从数据库中提取相当多的行，但只提取列的一小部分。</li>
<li>宽表，即每个表包含着大量的列</li>
<li>查询相对较少(通常每台服务器每秒查询数百次或更少)</li>
<li>对于简单查询，允许延迟大约50毫秒</li>
<li>列中的数据相对较小：数字和短字符串(例如，每个URL 60个字节)</li>
<li>处理单个查询时需要高吞吐量(每台服务器每秒可达数十亿行)</li>
<li>事务不是必须的</li>
<li>对数据一致性要求低</li>
<li>每个查询有一个大表。除了他以外，其他的都很小。</li>
<li>查询结果明显小于源数据。换句话说，数据经过过滤或聚合，因此结果适合于单个服务器的RAM中</li>
</ul>
<h3 id="列式数据库更适合OLAP场景的原因"><a href="#列式数据库更适合OLAP场景的原因" class="headerlink" title="列式数据库更适合OLAP场景的原因"></a>列式数据库更适合OLAP场景的原因</h3><h4 id="输入-x2F-输出"><a href="#输入-x2F-输出" class="headerlink" title="输入&#x2F;输出"></a>输入&#x2F;输出</h4><ol>
<li>针对分析类查询，通常只需要读取表的一小部分列。在列式数据库中你可以只读取你需要的数据。例如，如果只需要读取100列中的5列，这将帮助你最少减少20倍的I&#x2F;O消耗。</li>
<li>由于数据总是打包成批量读取的，所以压缩是非常容易的。同时数据按列分别存储这也更容易压缩。这进一步降低了I&#x2F;O的体积。</li>
<li>由于I&#x2F;O的降低，这将帮助更多的数据被系统缓存。</li>
</ol>
<p>例如，查询«统计每个广告平台的记录数量»需要读取«广告平台ID»这一列，它在未压缩的情况下需要1个字节进行存储。如果大部分流量不是来自广告平台，那么这一列至少可以以十倍的压缩率被压缩。当采用快速压缩算法，它的解压速度最少在十亿字节(未压缩数据)每秒。换句话说，这个查询可以在单个服务器上以每秒大约几十亿行的速度进行处理。这实际上是当前实现的速度。</p>
<h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>由于执行一个查询需要处理大量的行，因此在整个向量上执行所有操作将比在每一行上执行所有操作更加高效。同时这将有助于实现一个几乎没有调用成本的查询引擎。如果你不这样做，使用任何一个机械硬盘，查询引擎都不可避免的停止CPU进行等待。所以，在数据按列存储并且按列执行是很有意义的。</p>
<p>有两种方法可以做到这一点：</p>
<ol>
<li>向量引擎：所有的操作都是为向量而不是为单个值编写的。这意味着多个操作之间的不再需要频繁的调用，并且调用的成本基本可以忽略不计。操作代码包含一个优化的内部循环。</li>
<li>代码生成：生成一段代码，包含查询中的所有操作。</li>
</ol>
<p>这是不应该在一个通用数据库中实现的，因为这在运行简单查询时是没有意义的。但是也有例外，例如，MemSQL使用代码生成来减少处理SQL查询的延迟(只是为了比较，分析型数据库通常需要优化的是吞吐而不是延迟)。</p>
<p>请注意，为了提高CPU效率，查询语言必须是声明型的(SQL或MDX)， 或者至少一个向量(J，K)。 查询应该只包含隐式循环，允许进行优化。</p>
<h2 id="二、ClickHouse特性"><a href="#二、ClickHouse特性" class="headerlink" title="二、ClickHouse特性"></a>二、ClickHouse特性</h2><h3 id="真正的列式数据库管理系统"><a href="#真正的列式数据库管理系统" class="headerlink" title="真正的列式数据库管理系统"></a>真正的列式数据库管理系统</h3><p>在一个真正的列式数据库管理系统中，除了数据本身外不应该存在其他额外的数据。这意味着为了避免在值旁边存储它们的长度«number»，你必须支持固定长度数值类型。例如，10亿个UInt8类型的数据在未压缩的情况下大约消耗1GB左右的空间，如果不是这样的话，这将对CPU的使用产生强烈影响。即使是在未压缩的情况下，紧凑的存储数据也是非常重要的，因为解压缩的速度主要取决于未压缩数据的大小。</p>
<p>这是非常值得注意的，因为在一些其他系统中也可以将不同的列分别进行存储，但由于对其他场景进行的优化，使其无法有效的处理分析查询。例如： HBase，BigTable，Cassandra，HyperTable。在这些系统中，你可以得到每秒数十万的吞吐能力，但是无法得到每秒几亿行的吞吐能力。</p>
<p>需要说明的是，ClickHouse不单单是一个数据库， 它是一个数据库管理系统。因为它允许在运行时创建表和数据库、加载数据和运行查询，而无需重新配置或重启服务。</p>
<h3 id="数据压缩"><a href="#数据压缩" class="headerlink" title="数据压缩"></a>数据压缩</h3><p>在一些列式数据库管理系统中(例如：InfiniDB CE 和 MonetDB) 并没有使用数据压缩。但是, 若想达到比较优异的性能，数据压缩确实起到了至关重要的作用。</p>
<p>除了在磁盘空间和CPU消耗之间进行不同权衡的高效通用压缩编解码器之外，ClickHouse还提供针对特定类型数据的专用编解码器，这使得ClickHouse能够与更小的数据库(如时间序列数据库)竞争并超越它们。</p>
<h3 id="数据的磁盘存储"><a href="#数据的磁盘存储" class="headerlink" title="数据的磁盘存储"></a>数据的磁盘存储</h3><p>许多的列式数据库(如 SAP HANA, Google PowerDrill)只能在内存中工作，这种方式会造成比实际更多的设备预算。</p>
<p>ClickHouse被设计用于工作在传统磁盘上的系统，它提供每GB更低的存储成本，但如果可以使用SSD和内存，它也会合理的利用这些资源。</p>
<h3 id="多核心并行处理"><a href="#多核心并行处理" class="headerlink" title="多核心并行处理"></a>多核心并行处理</h3><p>ClickHouse会使用服务器上一切可用的资源，从而以最自然的方式并行处理大型查询。</p>
<h3 id="多服务器分布式处理"><a href="#多服务器分布式处理" class="headerlink" title="多服务器分布式处理"></a>多服务器分布式处理</h3><p>上面提到的列式数据库管理系统中，几乎没有一个支持分布式的查询处理。 在ClickHouse中，数据可以保存在不同的shard上，每一个shard都由一组用于容错的replica组成，查询可以并行地在所有shard上进行处理。这些对用户来说是透明的</p>
<h3 id="支持SQL"><a href="#支持SQL" class="headerlink" title="支持SQL"></a>支持SQL</h3><p>ClickHouse支持一种基于SQL的声明式查询语言，它在许多情况下与ANSI SQL标准相同。</p>
<p>支持的查询GROUP BY, ORDER BY, FROM, JOIN, IN以及非相关子查询。</p>
<p>相关(依赖性)子查询和窗口函数暂不受支持，但将来会被实现。</p>
<h3 id="向量引擎"><a href="#向量引擎" class="headerlink" title="向量引擎"></a>向量引擎</h3><p>为了高效的使用CPU，数据不仅仅按列存储，同时还按向量(列的一部分)进行处理，这样可以更加高效地使用CPU。</p>
<h3 id="实时的数据更新"><a href="#实时的数据更新" class="headerlink" title="实时的数据更新"></a>实时的数据更新</h3><p>ClickHouse支持在表中定义主键。为了使查询能够快速在主键中进行范围查找，数据总是以增量的方式有序的存储在MergeTree中。因此，数据可以持续不断地高效的写入到表中，并且写入的过程中不会存在任何加锁的行为。</p>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>按照主键对数据进行排序，这将帮助ClickHouse在几十毫秒以内完成对数据特定值或范围的查找。</p>
<h3 id="适合在线查询"><a href="#适合在线查询" class="headerlink" title="适合在线查询"></a>适合在线查询</h3><p>在线查询意味着在没有对数据做任何预处理的情况下以极低的延迟处理查询并将结果加载到用户的页面中。</p>
<h3 id="支持近似计算"><a href="#支持近似计算" class="headerlink" title="支持近似计算"></a>支持近似计算</h3><p>ClickHouse提供各种各样在允许牺牲数据精度的情况下对查询进行加速的方法：</p>
<ol>
<li>用于近似计算的各类聚合函数，如：distinct values, medians, quantiles</li>
<li>基于数据的部分样本进行近似查询。这时，仅会从磁盘检索少部分比例的数据。</li>
<li>不使用全部的聚合条件，通过随机选择有限个数据聚合条件进行聚合。这在数据聚合条件满足某些分布条件下，在提供相当准确的聚合结果的同时降低了计算资源的使用。</li>
</ol>
<h3 id="自适应连接算法"><a href="#自适应连接算法" class="headerlink" title="自适应连接算法"></a>自适应连接算法</h3><p>ClickHouse支持自定义JOIN多个表，它更倾向于散列连接算法，如果有多个大表，则使用合并-连接算法</p>
<h3 id="支持数据复制和数据完整性"><a href="#支持数据复制和数据完整性" class="headerlink" title="支持数据复制和数据完整性"></a>支持数据复制和数据完整性</h3><p>ClickHouse使用异步的多主复制技术。当数据被写入任何一个可用副本后，系统会在后台将数据分发给其他副本，以保证系统在不同副本上保持相同的数据。在大多数情况下ClickHouse能在故障后自动恢复，在一些少数的复杂情况下需要手动恢复。</p>
<h3 id="角色的访问控制"><a href="#角色的访问控制" class="headerlink" title="角色的访问控制"></a>角色的访问控制</h3><p>ClickHouse使用SQL查询实现用户帐户管理，并允许角色的访问控制，类似于ANSI SQL标准和流行的关系数据库管理系统。</p>
<p>15.限制</p>
<ol>
<li>没有完整的事务支持。</li>
<li>缺少高频率，低延迟的修改或删除已存在数据的能力。仅能用于批量删除或修改数据，但这符合 GDPR。</li>
<li>稀疏索引使得ClickHouse不适合通过其键检索单行的点查询。</li>
</ol>
<h2 id="clickHouse性能"><a href="#clickHouse性能" class="headerlink" title="clickHouse性能"></a>clickHouse性能</h2><h3 id="单个大查询的吞吐量"><a href="#单个大查询的吞吐量" class="headerlink" title="单个大查询的吞吐量"></a>单个大查询的吞吐量</h3><p>吞吐量可以使用每秒处理的行数或每秒处理的字节数来衡量。如果数据被放置在page cache中，则一个不太复杂的查询在单个服务器上大约能够以2-10GB／s（未压缩）的速度进行处理（对于简单的查询，速度可以达到30GB／s）。如果数据没有在page cache中的话，那么速度将取决于你的磁盘系统和数据的压缩率。例如，如果一个磁盘允许以400MB／s的速度读取数据，并且数据压缩率是3，则数据的处理速度为1.2GB&#x2F;s。这意味着，如果你是在提取一个10字节的列，那么它的处理速度大约是1-2亿行每秒。</p>
<p>对于分布式处理，处理速度几乎是线性扩展的，但这受限于聚合或排序的结果不是那么大的情况下。</p>
<h3 id="处理短查询的延迟时间"><a href="#处理短查询的延迟时间" class="headerlink" title="处理短查询的延迟时间"></a>处理短查询的延迟时间</h3><p>如果一个查询使用主键并且没有太多行(几十万)进行处理，并且没有查询太多的列，那么在数据被page cache缓存的情况下，它的延迟应该小于50毫秒(在最佳的情况下应该小于10毫秒)。 否则，延迟取决于数据的查找次数。如果你当前使用的是HDD，在数据没有加载的情况下，查询所需要的延迟可以通过以下公式计算得知： 查找时间（10 ms） * 查询的列的数量 * 查询的数据块的数量。</p>
<h3 id="处理大量短查询的吞吐量"><a href="#处理大量短查询的吞吐量" class="headerlink" title="处理大量短查询的吞吐量"></a>处理大量短查询的吞吐量</h3><p>在相同的情况下，ClickHouse可以在单个服务器上每秒处理数百个查询（在最佳的情况下最多可以处理数千个）。但是由于这不适用于分析型场景。因此我们建议每秒最多查询100次。</p>
<h3 id="数据的写入性能"><a href="#数据的写入性能" class="headerlink" title="数据的写入性能"></a>数据的写入性能</h3><p>我们建议每次写入不少于1000行的批量写入，或每秒不超过一个写入请求。当使用tab-separated格式将一份数据写入到MergeTree表中时，写入速度大约为50到200MB&#x2F;s。如果您写入的数据每行为1Kb，那么写入的速度为50，000到200，000行每秒。如果您的行更小，那么写入速度将更高。为了提高写入性能，您可以使用多个INSERT进行并行写入，这将带来线性的性能提升。</p>
<h2 id="clickHouse单机安装"><a href="#clickHouse单机安装" class="headerlink" title="clickHouse单机安装"></a>clickHouse单机安装</h2><h3 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h3><p>ClickHouse可以在任何具有x86_64，AArch64或PowerPC64LE CPU架构的Linux，FreeBSD或Mac OS X上运行。</p>
<p>官方预构建的二进制文件通常针对x86_64进行编译，并利用<code>SSE 4.2</code>指令集，因此，除非另有说明，支持它的CPU使用将成为额外的系统需求。下面是检查当前CPU是否支持SSE 4.2的命令:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token parameter variable">-q</span> sse4_2 /proc/cpuinfo <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"SSE 4.2 supported"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"SSE 4.2 not supported"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="RPM安装CK服务端"><a href="#RPM安装CK服务端" class="headerlink" title="RPM安装CK服务端"></a>RPM安装CK服务端</h3><h4 id="设置RPM-repository"><a href="#设置RPM-repository" class="headerlink" title="设置RPM repository"></a>设置RPM repository</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils
<span class="token function">sudo</span> yum-config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="安装ClickHouse-server和client"><a href="#安装ClickHouse-server和client" class="headerlink" title="安装ClickHouse server和client"></a>安装ClickHouse server和client</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> clickhouse-server clickhouse-client<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="修改配置文件，允许通过IPV4访问"><a href="#修改配置文件，允许通过IPV4访问" class="headerlink" title="修改配置文件，允许通过IPV4访问"></a>修改配置文件，允许通过IPV4访问</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置文件位置</span>
<span class="token builtin class-name">cd</span> /etc/clickhouse-server/
- config.d 配置文件夹，主配置文件自动加载.xml结尾的配置文件
- config.xml 主配置文件
- users.d 管理用户配置文件夹，主配置文件自动加载.xml结尾的配置文件
- users.xml 用户配置文件，主配置文件自动加载
<span class="token comment">#备份原始配置文件</span>
<span class="token function">cp</span>  /etc/clickhouse-server/config.xml  /etc/clickhouse-server/config.xml.bak
<span class="token comment">#修改配置文件里面允许IPV4访问，约212行，取消注释</span>
<span class="token operator">&lt;</span>listen_host<span class="token operator">></span><span class="token number">0.0</span>.0.<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/listen_host<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="开启ClickHouse-server"><a href="#开启ClickHouse-server" class="headerlink" title="开启ClickHouse server"></a>开启ClickHouse server</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> clickhouse-server
<span class="token function">sudo</span> systemctl start clickhouse-server
<span class="token function">sudo</span> systemctl status clickhouse-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="测试是否安装成功"><a href="#测试是否安装成功" class="headerlink" title="测试是否安装成功"></a>测试是否安装成功</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#已经安装了客户端，直接使用客户端访问即可</span>
clickhouse-client 
<span class="token comment">#此时登录进来，即可使用sql语法，默认用户为default，无密码</span>
<span class="token comment">#如果在配置文件中配置了密码，请指定密码登录</span>
clickhouse-client <span class="token parameter variable">--password</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="clickhouse集群搭建"><a href="#clickhouse集群搭建" class="headerlink" title="clickhouse集群搭建"></a>clickhouse集群搭建</h2><blockquote>
<p>集群架构三台clickhouse-server和三台clickhouse-keeper</p>
<p>搭建流程：</p>
<ol>
<li>在群集的所有机器上安装ClickHouse服务端</li>
<li>在配置文件中设置集群配置及Kepper配置</li>
<li>在<strong>每个</strong>实例上创建本地表</li>
<li>创建一个分布式表</li>
</ol>
</blockquote>
<h3 id="集群节点信息"><a href="#集群节点信息" class="headerlink" title="集群节点信息"></a>集群节点信息</h3><h4 id="server和kepper所在服务器信息"><a href="#server和kepper所在服务器信息" class="headerlink" title="server和kepper所在服务器信息"></a>server和kepper所在服务器信息</h4><table>
<thead>
<tr>
<th>名称</th>
<th>hosts</th>
<th>ip</th>
<th>clickhouse-server</th>
<th>clickhouse-keeper</th>
</tr>
</thead>
<tbody><tr>
<td>节点1</td>
<td>slave1</td>
<td>192.168.67.111</td>
<td>192.168.67.111</td>
<td>192.168.67.111</td>
</tr>
<tr>
<td>节点2</td>
<td>slave2</td>
<td>192.168.67.112</td>
<td>192.168.67.112</td>
<td>192.168.67.112</td>
</tr>
<tr>
<td>节点3</td>
<td>slave3</td>
<td>192.168.67.113</td>
<td>192.168.67.113</td>
<td>192.168.67.113</td>
</tr>
</tbody></table>
<h4 id="hosts配置"><a href="#hosts配置" class="headerlink" title="hosts配置"></a>hosts配置</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"192.168.67.111  slave1"</span> <span class="token operator">>></span>/etc/hosts
<span class="token builtin class-name">echo</span> <span class="token string">"192.168.67.112  slave2"</span> <span class="token operator">>></span>/etc/hosts
<span class="token builtin class-name">echo</span> <span class="token string">"192.168.67.113  slave3"</span> <span class="token operator">>></span>/etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="安装ClickHouse-Server"><a href="#安装ClickHouse-Server" class="headerlink" title="安装ClickHouse-Server"></a>安装ClickHouse-Server</h3><blockquote>
<p>按照单机版安装即可，需要打开IPV4访问</p>
</blockquote>
<h3 id="安装ClickHouse-Keeper"><a href="#安装ClickHouse-Keeper" class="headerlink" title="安装ClickHouse-Keeper"></a>安装ClickHouse-Keeper</h3><blockquote>
<p>新版本clickhouse-server中自带clickhouse-keeper,无需单独安装</p>
</blockquote>
<h3 id="配置ClickHouse-Keeper配置文件"><a href="#配置ClickHouse-Keeper配置文件" class="headerlink" title="配置ClickHouse-Keeper配置文件"></a>配置ClickHouse-Keeper配置文件</h3><blockquote>
<p>1.在集群的每个节点创建配置文件：vim &#x2F;etc&#x2F;clickhouse-server&#x2F;config.d&#x2F;metrika.xml</p>
<p>2.添加如下配置，其中<server_id>1</server_id>代表唯一的服务器ID, ClickHouse Keeper 集群的每个节点都必须有一个唯一的编号(1, 2, 3, ……)</p>
<p>3.执行<code>chown -R clickhouse:cliclhouse /var/lib/clickhouse/</code>和<code>chown -R clickhouse:cliclhouse /var/lib/clickhouse/</code> 授权给clickhouse用户和用户组</p>
<p>4.ClickHouse Keeper被绑定到ClickHouse服务器包中，只需添加配置’ <keeper_server> ‘，并像往常一样启动ClickHouse服务器。</keeper_server></p>
</blockquote>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keeper_server</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tcp_port</span><span class="token punctuation">></span></span>9181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tcp_port</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server_id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server_id</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_storage_path</span><span class="token punctuation">></span></span>/var/lib/clickhouse/coordination/log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_storage_path</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshot_storage_path</span><span class="token punctuation">></span></span>/var/lib/clickhouse/coordination/snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshot_storage_path</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>coordination_settings</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>operation_timeout_ms</span><span class="token punctuation">></span></span>10000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>operation_timeout_ms</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session_timeout_ms</span><span class="token punctuation">></span></span>30000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session_timeout_ms</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>raft_logs_level</span><span class="token punctuation">></span></span>warning<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>raft_logs_level</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>coordination_settings</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>raft_configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>raft_configuration</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keeper_server</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>tcp_port</code> — 客户端连接的端口(默认是<code>2181</code>和ZooKeeper保持一致).</li>
<li><code>tcp_port_secure</code> — client 和 keeper-server之间的SSL连接的安全端口.</li>
<li><code>server_id</code> — 唯一的服务器ID, ClickHouse Keeper 集群的每个参与组件都必须有一个唯一的编号(1, 2, 3, 等等).</li>
<li><code>log_storage_path</code> — 协调日志的路径, 最好存放在不繁忙的机器上 (和ZooKeeper一样).</li>
<li><code>snapshot_storage_path</code> — 协调快照的路径.</li>
</ul>
<p>每个<code>&lt;server&gt;</code>的主要参数是:</p>
<ul>
<li><code>id</code> — 仲裁中的服务器标识符。</li>
<li><code>hostname</code> — 放置该服务器的主机名。</li>
<li><code>port</code> — 服务器监听连接的端口。</li>
</ul>
<h3 id="配置ClickHouse-Server配置文件"><a href="#配置ClickHouse-Server配置文件" class="headerlink" title="配置ClickHouse-Server配置文件"></a>配置ClickHouse-Server配置文件</h3><blockquote>
<p>1.在集群的每个节点创建配置文件：vim &#x2F;etc&#x2F;clickhouse-server&#x2F;config.d&#x2F;metrika.xml</p>
<p>2.添加如下配置，按照集群模式三个分片，一个副本进行配置,分片是指包含部分数据的服务器，要读取所有的数据，必须访问所有的分片。副本是指存储分片备份数据的服务器，要读取所有的数据，访问任意副本上的数据即可。</p>
<p>3.常见的集群模式</p>
<ul>
<li>单分片多副本模式</li>
<li>多分片单副本模式</li>
<li>多分片多副本模式</li>
</ul>
</blockquote>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote_servers</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>perftest_3shards_1replicas</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>perftest_3shards_1replicas</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote_servers</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="宏配置"><a href="#宏配置" class="headerlink" title="宏配置"></a>宏配置</h3><blockquote>
<p>区分每台ClickHouse节点的宏配置，macros中标签<shard>代表当前节点的分片号，标签<replica>代表当前节点的副本号，这两个名称可以随意取，后期在创建副本表时可以动态读取这两个宏变量。注意：每台ClickHouse节点需要配置不同名称。</replica></shard></p>
</blockquote>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>7.附完整的配置文件</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote_servers</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>perftest_3shards_1replicas</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">></span></span>slave3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>8000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>perftest_3shards_1replicas</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote_servers</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--zookeeper集群的连接信息--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keeper_server</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tcp_port</span><span class="token punctuation">></span></span>9181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tcp_port</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server_id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server_id</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_storage_path</span><span class="token punctuation">></span></span>/var/lib/clickhouse/coordination/log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_storage_path</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshot_storage_path</span><span class="token punctuation">></span></span>/var/lib/clickhouse/coordination/snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshot_storage_path</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>coordination_settings</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>operation_timeout_ms</span><span class="token punctuation">></span></span>10000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>operation_timeout_ms</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session_timeout_ms</span><span class="token punctuation">></span></span>30000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session_timeout_ms</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>raft_logs_level</span><span class="token punctuation">></span></span>warning<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>raft_logs_level</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>coordination_settings</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>raft_configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hostname</span><span class="token punctuation">></span></span>slave3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hostname</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>9444<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>raft_configuration</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keeper_server</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--定义宏变量，后面需要用--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">></span></span>slave1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--不限制访问来源ip地址--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networks</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span><span class="token punctuation">></span></span>::/0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networks</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--数据压缩方式，默认为lz4--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_compression</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size</span><span class="token punctuation">></span></span>10000000000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size</span><span class="token punctuation">></span></span>
                                             
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size_ratio</span><span class="token punctuation">></span></span>0.01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size_ratio</span><span class="token punctuation">></span></span>                                                                                                                                       
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>method</span><span class="token punctuation">></span></span>lz4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>method</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_compression</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="启动并查看"><a href="#启动并查看" class="headerlink" title="启动并查看"></a>启动并查看</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#start</span>
systemct start clickhouse-server
<span class="token comment">#login clickServer,此处我更改了config.xml的server的tcp_port</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span>
<span class="token comment">#execute sql</span>
<span class="token keyword">select</span> * from system.clusters<span class="token punctuation">;</span>
<span class="token comment">#如果显示cluster信息则集群搭建成功</span>
<span class="token operator">&lt;</span>internal_replication<span class="token operator">></span>true<span class="token operator">&lt;</span>/internal_replication<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="验证Keeper是否搭建成功"><a href="#验证Keeper是否搭建成功" class="headerlink" title="验证Keeper是否搭建成功"></a>验证Keeper是否搭建成功</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> ruok <span class="token operator">|</span> <span class="token function">nc</span> localhost <span class="token number">9181</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>ruok</code>: 测试服务器运行时是否处于无错误状态。如果服务器正在运行，它将用imok响应。否则它将完全不响应。“imok”的响应并不一定表明服务器已加入仲裁，只是表明服务器进程处于活动状态并绑定到指定的客户端端口。使用“stat”获取状态wrt仲裁和客户端连接信息的详细信息。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">imok<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>mntr</code>: 输出可用于监视集群运行状况的变量列表。</li>
<li><code>stat</code>: 列出服务器和连接客户机的简要详细信息。</li>
</ul>
<h3 id="创建本地表和分布式表"><a href="#创建本地表和分布式表" class="headerlink" title="创建本地表和分布式表"></a>创建本地表和分布式表</h3><h4 id="本地表和分布式表区别"><a href="#本地表和分布式表区别" class="headerlink" title="本地表和分布式表区别"></a>本地表和分布式表区别</h4><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">说明</th>
<th align="left">区别</th>
</tr>
</thead>
<tbody><tr>
<td align="left">本地表（Local Table）</td>
<td align="left">数据只会存储在当前写入的节点上，不会被分散到多台服务器上。</td>
<td align="left">本地表的写入和查询，受限于单台服务器的存储、计算资源，不具备横向拓展能力。</td>
</tr>
<tr>
<td align="left">分布式表（Distributed Table）</td>
<td align="left">本地表的集合，它将多个本地表抽象为一张统一的表，对外提供写入、查询功能。当写入分布式表时，数据会被自动分发到集合中的各个本地表中；当查询分布式表时，集合中的各个本地表都会被分别查询，并且把最终结果汇总后返回。</td>
<td align="left">分布式表的写入和查询，可以利用多台服务器的存储、计算资源，具有较好的横向拓展能力。</td>
</tr>
</tbody></table>
<h4 id="下载表数据"><a href="#下载表数据" class="headerlink" title="下载表数据"></a>下载表数据</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz <span class="token operator">|</span> unxz <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>nproc<span class="token variable">`</span></span> <span class="token operator">></span> hits_v1.tsv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--query</span> <span class="token string">"CREATE DATABASE IF NOT EXISTS tutorial"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tutorial<span class="token punctuation">.</span>hits_v1_local <span class="token keyword">on</span> cluster perftest_3shards_1replicas
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>WatchID<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>JavaEnable<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Title<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>GoodEvent<span class="token punctuation">`</span></span> Int16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>EventTime<span class="token punctuation">`</span></span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>EventDate<span class="token punctuation">`</span></span> <span class="token keyword">Date</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>CounterID<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ClientIP<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ClientIP6<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RegionID<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UserID<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>CounterClass<span class="token punctuation">`</span></span> Int8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OS<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UserAgent<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>URL<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Referer<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>URLDomain<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RefererDomain<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Refresh<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsRobot<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RefererCategories<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt16<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>URLCategories<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt16<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>URLRegions<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RefererRegions<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ResolutionWidth<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ResolutionHeight<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ResolutionDepth<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FlashMajor<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FlashMinor<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FlashMinor2<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>NetMajor<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>NetMinor<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UserAgentMajor<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UserAgentMinor<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>CookieEnable<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>JavascriptEnable<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsMobile<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>MobilePhone<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>MobilePhoneModel<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Params<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IPNetworkID<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>TraficSourceID<span class="token punctuation">`</span></span> Int8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SearchEngineID<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SearchPhrase<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>AdvEngineID<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsArtifical<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>WindowClientWidth<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>WindowClientHeight<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ClientTimeZone<span class="token punctuation">`</span></span> Int16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ClientEventTime<span class="token punctuation">`</span></span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SilverlightVersion1<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SilverlightVersion2<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SilverlightVersion3<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SilverlightVersion4<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>PageCharset<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>CodeVersion<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsLink<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsDownload<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsNotBounce<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FUniqID<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>HID<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsOldCounter<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsEvent<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IsParameter<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>DontCountHits<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>WithHash<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>HitColor<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTCEventTime<span class="token punctuation">`</span></span> <span class="token keyword">DateTime</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Age<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Sex<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Income<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Interests<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>Robotness<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>GeneralInterests<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt16<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RemoteIP<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RemoteIP6<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>WindowName<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OpenerName<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>HistoryLength<span class="token punctuation">`</span></span> Int16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>BrowserLanguage<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>BrowserCountry<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SocialNetwork<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SocialAction<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>HTTPError<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SendTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>DNSTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ConnectTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ResponseStartTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ResponseEndTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FetchTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RedirectTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>DOMInteractiveTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>DOMContentLoadedTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>DOMCompleteTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>LoadEventStartTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>LoadEventEndTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>NSToDOMContentLoadedTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FirstPaintTiming<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RedirectCount<span class="token punctuation">`</span></span> Int8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SocialSourceNetworkID<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>SocialSourcePage<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ParamPrice<span class="token punctuation">`</span></span> Int64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ParamOrderID<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ParamCurrency<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ParamCurrencyID<span class="token punctuation">`</span></span> UInt16<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>GoalsReached<span class="token punctuation">`</span></span> Array<span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OpenstatServiceName<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OpenstatCampaignID<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OpenstatAdID<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>OpenstatSourceID<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTMSource<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTMMedium<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTMCampaign<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTMContent<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>UTMTerm<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>FromTag<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>HasGCLID<span class="token punctuation">`</span></span> UInt8<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RefererHash<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>URLHash<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>CLID<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>YCLID<span class="token punctuation">`</span></span> UInt64<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ShareService<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ShareURL<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ShareTitle<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ParsedParams<span class="token punctuation">`</span></span> Nested<span class="token punctuation">(</span>
        Key1 String<span class="token punctuation">,</span>
        Key2 String<span class="token punctuation">,</span>
        Key3 String<span class="token punctuation">,</span>
        Key4 String<span class="token punctuation">,</span>
        Key5 String<span class="token punctuation">,</span>
        ValueDouble Float64<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>IslandID<span class="token punctuation">`</span></span> FixedString<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RequestNum<span class="token punctuation">`</span></span> UInt32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>RequestTry<span class="token punctuation">`</span></span> UInt8
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> toYYYYMM<span class="token punctuation">(</span>EventDate<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>CounterID<span class="token punctuation">,</span> EventDate<span class="token punctuation">,</span> intHash32<span class="token punctuation">(</span>UserID<span class="token punctuation">)</span><span class="token punctuation">)</span>
SAMPLE <span class="token keyword">BY</span> intHash32<span class="token punctuation">(</span>UserID<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--query</span> <span class="token string">"INSERT INTO tutorial.hits_v1 FORMAT TSV"</span> <span class="token parameter variable">--format_csv_delimiter</span><span class="token operator">=</span><span class="token string">'|'</span> <span class="token parameter variable">--max_insert_block_size</span><span class="token operator">=</span><span class="token number">100000</span> <span class="token operator">&lt;</span> hits_v1.tsv
<span class="token parameter variable">--format_csv_delimiter</span>
clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--query</span> <span class="token string">"INSERT INTO tutorial.hits_v1 FORMAT TSV"</span> <span class="token parameter variable">--format_csv_delimiter</span><span class="token operator">=</span><span class="token string">'|'</span> <span class="token parameter variable">--max_insert_block_size</span><span class="token operator">=</span><span class="token number">100000</span> <span class="token operator">&lt;</span> hits_v1.tsv
<span class="token parameter variable">--format_csv_delimiter</span>


clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--query</span> <span class="token string">"INSERT INTO tutorial.ods_sa FORMAT CSV"</span> <span class="token parameter variable">--format_csv_delimiter</span><span class="token operator">=</span><span class="token string">'|'</span>  <span class="token parameter variable">--max_insert_block_size</span><span class="token operator">=</span><span class="token number">100000</span> <span class="token operator">&lt;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="创建本地表"><a href="#创建本地表" class="headerlink" title="创建本地表"></a>创建本地表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#根据tutorial.hits的建表语句创建一个集权表只是表名不一致，其他节点也会看到该表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tutorial<span class="token punctuation">.</span>hits_local <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">on</span> cluster perftest_3shards_1replicas <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="创建分布式表"><a href="#创建分布式表" class="headerlink" title="创建分布式表"></a>创建分布式表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tutorial<span class="token punctuation">.</span>hits_all <span class="token keyword">on</span> cluster perftest_3shards_1replicas <span class="token keyword">AS</span> tutorial<span class="token punctuation">.</span>hits_v1_local
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">Distributed</span><span class="token punctuation">(</span>perftest_3shards_1replicas<span class="token punctuation">,</span> tutorial<span class="token punctuation">,</span> hits_v1_local<span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="分布式表插入数据"><a href="#分布式表插入数据" class="headerlink" title="分布式表插入数据"></a>分布式表插入数据</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tutorial<span class="token punctuation">.</span>hits_all <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tutorial<span class="token punctuation">.</span>hits_v1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><blockquote>
<p>另外两台节点能够看到本地表和分布式表说明集群部署并同步成功</p>
</blockquote>
<h4 id="其他表概念"><a href="#其他表概念" class="headerlink" title="其他表概念"></a>其他表概念</h4><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">说明</th>
<th align="left">区别</th>
</tr>
</thead>
<tbody><tr>
<td align="left">单机表（Non-Replicated Table）</td>
<td align="left">数据只会存储在当前服务器上，不会被复制到其他服务器，即只有一个副本。</td>
<td align="left">单机表在异常情况下无法保证服务高可用。</td>
</tr>
<tr>
<td align="left">复制表（Replicated Table）</td>
<td align="left">数据会被自动复制到多台服务器上，形成多个副本。</td>
<td align="left">复制表在至少有一个正常副本的情况下，能够对外提供服务。</td>
</tr>
</tbody></table>
<h2 id="六、接口"><a href="#六、接口" class="headerlink" title="六、接口"></a>六、接口</h2><h3 id="命令行客户端"><a href="#命令行客户端" class="headerlink" title="命令行客户端"></a>命令行客户端</h3><p>ClickHouse提供了一个原生命令行客户端<code>clickhouse-client</code>客户端支持命令行</p>
<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><p>客户端可以在交互和非交互(批处理)模式下使用。要使用批处理模式，请指定<code>query</code>参数，或将数据发送到<code>stdin</code>(它会验证<code>stdin</code>是否是终端)，或两者同时进行。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#插入数据</span>
<span class="token function">cat</span> file.csv <span class="token operator">|</span> clickhouse-client <span class="token parameter variable">--database</span><span class="token operator">=</span>test <span class="token parameter variable">--query</span><span class="token operator">=</span><span class="token string">"INSERT INTO test FORMAT CSV"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在批量模式中，默认的数据格式是<code>TabSeparated</code>分隔的。您可以根据查询来灵活设置FORMAT格式。</p>
<p>默认情况下，在批量模式中只能执行单个查询。为了从一个Script中执行多个查询，可以使用<code>--multiquery</code>参数。</p>
<h4 id="查询参数"><a href="#查询参数" class="headerlink" title="查询参数"></a>查询参数</h4><p>您可以创建带有参数的查询，并将值从客户端传递给服务器。这允许避免在客户端使用特定的动态值格式化查询。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ clickhouse-client <span class="token parameter variable">--param_parName</span><span class="token operator">=</span><span class="token string">"[1, 2]"</span>  <span class="token parameter variable">-q</span> <span class="token string">"SELECT * FROM table WHERE a = &#123;parName:Array(UInt16)&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>查询语法</strong></p>
<p>像平常一样格式化一个查询，然后把你想要从app参数传递到查询的值用大括号格式化，格式如下:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">&#123;<span class="token operator">&lt;</span>name<span class="token operator">></span>:<span class="token operator">&lt;</span><span class="token keyword">data</span> <span class="token keyword">type</span><span class="token operator">></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>name</code> — 占位符标识符。在控制台客户端，使用<code>--param_&lt;name&gt; = value</code>来指定</li>
<li><code>data type</code> — 数据类型参数值。例如，一个数据结构<code>(integer, (&#39;string&#39;, integer))</code>拥有<code>Tuple(UInt8, Tuple(String, UInt8))</code>数据类型(你也可以用另一个integer类型)。</li>
</ul>
<p><strong>示例</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ clickhouse-client <span class="token parameter variable">--param_tuple_in_tuple</span><span class="token operator">=</span><span class="token string">"(10, ('dt', 10))"</span> <span class="token parameter variable">-q</span> <span class="token string">"SELECT * FROM table WHERE val = &#123;tuple_in_tuple:Tuple(UInt8, Tuple(String, UInt8))&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><h4 id="通过命令行"><a href="#通过命令行" class="headerlink" title="通过命令行"></a>通过命令行</h4><p>命令行参数会覆盖默认值和配置文件的配置。</p>
<ul>
<li><code>--host, -h</code> -– 服务端的host名称, 默认是<code>localhost</code>。您可以选择使用host名称或者IPv4或IPv6地址。</li>
<li><code>--port</code> – 连接的端口，默认值：9000。注意HTTP接口以及TCP原生接口使用的是不同端口。</li>
<li><code>--user, -u</code> – 用户名。 默认值：<code>default</code>。</li>
<li><code>--password</code> – 密码。 默认值：空字符串。</li>
<li><code>--query, -q</code> – 使用非交互模式查询。</li>
<li><code>--database, -d</code> – 默认当前操作的数据库. 默认值：服务端默认的配置（默认是<code>default</code>）。</li>
<li><code>--multiline, -m</code> – 如果指定，允许多行语句查询（Enter仅代表换行，不代表查询语句完结）。</li>
<li><code>--multiquery, -n</code> – 如果指定, 允许处理用<code>;</code>号分隔的多个查询，只在非交互模式下生效。</li>
<li><code>--format, -f</code> – 使用指定的默认格式输出结果。</li>
<li><code>--vertical, -E</code> – 如果指定，默认情况下使用垂直格式输出结果。这与<code>–format=Vertical</code>相同。在这种格式中，每个值都在单独的行上打印，这种方式对显示宽表很有帮助。</li>
<li><code>--time, -t</code> – 如果指定，非交互模式下会打印查询执行的时间到<code>stderr</code>中。</li>
<li><code>--stacktrace</code> – 如果指定，如果出现异常，会打印堆栈跟踪信息。</li>
<li><code>--config-file</code> – 配置文件的名称。</li>
<li><code>--secure</code> – 如果指定，将通过安全连接连接到服务器。</li>
<li><code>--history_file</code> — 存放命令历史的文件的路径。</li>
<li><code>--param_&lt;name&gt;</code> — 查询参数配置查询参数</li>
</ul>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置文件的配置会覆盖默认值</p>
<p><code>clickhouse-client</code>使用以下第一个配置文件：</p>
<ul>
<li>通过<code>--config-file</code>参数指定。</li>
<li><code>./clickhouse-client.xml</code></li>
<li><code>~/.clickhouse-client/config.xml</code></li>
<li><code>/etc/clickhouse-client/config.xml</code></li>
</ul>
<p><strong>配置文件示例</strong>:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>config</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>username<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span>password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>secure</span><span class="token punctuation">></span></span>False<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>secure</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="JDBC驱动"><a href="#JDBC驱动" class="headerlink" title="JDBC驱动"></a>JDBC驱动</h3><h4 id="2-1官方驱动"><a href="#2-1官方驱动" class="headerlink" title="2.1官方驱动"></a>2.1官方驱动</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ru.yandex.clickhouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>clickhouse-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>&#123;version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="第三方驱动"><a href="#第三方驱动" class="headerlink" title="第三方驱动"></a>第三方驱动</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.housepower<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>clickhouse-native-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>&#123;version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>两者间的主要区别如下：</p>
<p>a.驱动类加载路径不同，分别为 ru.yandex.clickhouse.ClickHouseDriver和 com.github.housepower.jdbc.ClickHouseDriver<br>b.默认连接端口不同，分别为 8123 和 9000<br>C.连接协议不同，官方驱动使用 HTTP 协议，而三方驱动使用 TCP 协议</p>
<h4 id="mybatis-plus整合ClickHouse"><a href="#mybatis-plus整合ClickHouse" class="headerlink" title="mybatis-plus整合ClickHouse"></a>mybatis-plus整合ClickHouse</h4><p><strong>建表示例：</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> tb_stat <span class="token punctuation">(</span> id String<span class="token punctuation">,</span> region String<span class="token punctuation">,</span> <span class="token keyword">group</span> String<span class="token punctuation">,</span> yesterday <span class="token keyword">INT</span><span class="token punctuation">,</span> today <span class="token keyword">INT</span><span class="token punctuation">,</span> stat_date <span class="token keyword">DateTime</span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> SummingMergeTree <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span> toYYYYMM <span class="token punctuation">(</span> stat_date <span class="token punctuation">)</span><span class="token punctuation">,</span> region <span class="token punctuation">)</span>  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span> toStartOfHour <span class="token punctuation">(</span> stat_date <span class="token punctuation">)</span><span class="token punctuation">,</span> region<span class="token punctuation">,</span> <span class="token keyword">group</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:56:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:21:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:20:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:13:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:44:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'6'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:22:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'333'</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:11:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'333'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:55:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_stat <span class="token keyword">VALUES</span><span class="token punctuation">(</span> <span class="token string">'9'</span><span class="token punctuation">,</span><span class="token string">'1232364'</span><span class="token punctuation">,</span> <span class="token string">'333'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'2021-07-09 12:34:00'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>依赖相关：</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>ru.yandex.clickhouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>clickhouse-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
       <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
       <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.baomidou/mybatis-plus-boot-starter --></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

       
       <span class="token comment">&lt;!--Spring Boot 测试--></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="配置SpringBoot配置文件"><a href="#配置SpringBoot配置文件" class="headerlink" title="配置SpringBoot配置文件"></a>配置SpringBoot配置文件</h5><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">server:
  port: 8080
spring:
#clickhouse配置
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driverClassName: ru.yandex.clickhouse.ClickHouseDirver
    click:
      url: jdbc:clickhouse://192.168.67.111:8123/tutorial
      username: default
      password:
      initialSize: 10
      maxActive: 100
      minIdle: 10
      maxWait: 6000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="配置DruidConfig"><a href="#配置DruidConfig" class="headerlink" title="配置DruidConfig"></a>配置DruidConfig</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.click"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">druidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Mapper配置"><a href="#Mapper配置" class="headerlink" title="Mapper配置"></a>Mapper配置</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StatMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stat</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="Entity配置"><a href="#Entity配置" class="headerlink" title="Entity配置"></a>Entity配置</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tb_stat"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stat</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> group<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> yesterday<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> today<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>locale<span class="token operator">=</span><span class="token string">"zh"</span><span class="token punctuation">,</span> timezone<span class="token operator">=</span><span class="token string">"GMT+8"</span><span class="token punctuation">,</span> pattern<span class="token operator">=</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> statDate<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppArgTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StatMapper</span> statMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testClickHouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Integer</span> integer <span class="token operator">=</span> statMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><blockquote>
<p>clickhouse 数据库的语法有一些不同,删除和修改的SQL要自己在xml文件内写。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- clickHouse语法</span>
<span class="token comment">-- 删除语法</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tb_stat <span class="token keyword">delete</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token string">'10'</span><span class="token punctuation">;</span>
<span class="token comment">-- 修改语法</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> tb_stat <span class="token keyword">update</span> today<span class="token operator">=</span><span class="token number">222</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token string">'4'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="输入输出格式"><a href="#输入输出格式" class="headerlink" title="输入输出格式"></a>输入输出格式</h3><p>ClickHouse可以接受输入和输出各种格式的数据，如TSV(TabSeparated)、CSV、CSVWhithNames、JSON、XML等。</p>
<h4 id="TabSeparated"><a href="#TabSeparated" class="headerlink" title="TabSeparated"></a>TabSeparated</h4><p>在TabSeparated分隔格式中，数据按行写入。每行包含由制表符分隔的值，每个值后跟一个制表符，除了行中最后一个值，最后的值后面是一个换行符。在任何地方都采用严格的Unix换行(\n)。最后一行结束后必须再插入一个换行符。值以文本格式编写，不包含引号，并使用转义的特殊字符，这种格式也被称为<code>TSV</code>。</p>
<p><code>TabSeparated</code>格式便于其他的程序和脚本处理数据。默认情况下，HTTP接口和命令行客户端的批处理模式中会使用这个格式。这种格式还允许在不同dbms之间传输数据。例如，您可以从MySQL获取转储并将其上传到ClickHouse，反之亦然。</p>
<h4 id="数据格式化"><a href="#数据格式化" class="headerlink" title="数据格式化"></a>数据格式化</h4><p>整数是用十进制形式写的。数字可以在开头包含一个额外的<code>+</code>字符(解析时忽略该符号，格式化时不记录该符号)。非负数不能包含负号。在读取时，允许将空字符串解析为零，或者(对于有符号类型)将’-‘(仅有减号的字符串)解析为零。不符合相应数据类型的数字可能被解析为数值，而不会出现错误消息。</p>
<p>浮点数以十进制形式书写。用<code>.</code>作为小数点的符号。支持指数符号，如<code>inf</code>、<code>+inf</code>、<code>-inf</code>和<code>nan</code>。小数点前或后可以不出现数字(如123.或.123)。 在格式化期间，浮点数精度可能会丢失。 在解析期间，并不严格要求读取与机器可以表示的最接近的数值。</p>
<p>日期以<code>YYYY-MM-DD</code>格式编写，并以相同的格式解析，但允许使用任何字符作为分隔符。 日期和时间以<code>YYYY-MM-DD hh:mm:ss</code>的格式书写，并以相同的格式解析，但允许使用任何字符作为分隔符。 时区采用客户端或服务器端时区(取决于谁对数据进行格式化)。对于带有时间的日期，没有是哦用夏时制时间。因此，如果导出的数据采用了夏时制，则实际入库的时间不一定与预期的时间对应，解析将根据解析动作发起方选择时间。 在读取操作期间，不正确的日期和具有时间的日期可以自然溢出(如2021-01-32)或设置成空日期和时间，而不会出现错误消息。</p>
<p>有个例外情况，时间解析也支持Unix时间戳(如果它恰好由10个十进制数字组成)。其结果与时区无关。格式<code>YYYY-MM-DD hh:mm:ss</code>和<code>NNNNNNNNNN</code>这两种格式会自动转换。</p>
<p>字符串输出时，特殊字符会自动转义。以下转义序列用于输出:<code>\b</code>, <code>\f</code>, <code>\r</code>, <code>\n</code>, <code>\t</code>, <code>\0</code>, <code>\&#39;</code>, <code>\\</code>。解析还支持<code>\a</code>、<code>\v</code>和<code>\xHH</code>(HH代表十六进制编码)和<code>\c</code>，其中<code>c</code>是任何字符(这些序列被转换为<code>c</code>)。因此，读取数据时，换行符可以写成<code>\n</code>或<code>\</code>。</p>
<p>NULL将输出为<code>\N</code>。</p>
<p>Nested结构的每个元素都表示为数组。</p>
<h2 id="引擎"><a href="#引擎" class="headerlink" title="引擎"></a>引擎</h2><h3 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h3><p>数据库引擎允许您处理数据表。默认情况下，ClickHouse使用Atomic数据库引擎。它提供了可配置的table engines和SQL dialect。</p>
<p>ClickHouse以下数据库引擎：</p>
<ul>
<li>MySQL</li>
<li>Lazy</li>
<li>Atomic</li>
<li>PostgreSQL</li>
<li>MaterializedPostgreSQL</li>
<li>Replicated</li>
<li>SQLite</li>
</ul>
<h4 id="mysql引擎"><a href="#mysql引擎" class="headerlink" title="mysql引擎"></a>mysql引擎</h4><p>MySQL引擎用于将远程的MySQL服务器中的表映射到ClickHouse中，并允许您对表进行<code>INSERT</code>和<code>SELECT</code>查询，以方便您在ClickHouse与MySQL之间进行数据交<code>MySQL</code>数据库引擎会将对其的查询转换为MySQL语法并发送到MySQL服务器中，因此您可以执行诸如<code>SHOW TABLES</code>或<code>SHOW CREATE TABLE</code>之类的操作。但不支持以下操作：</p>
<ul>
<li><code>RENAME</code></li>
<li><code>CREATE TABLE</code></li>
<li><code>ALTER</code></li>
</ul>
<h5 id="创建mysql引擎的数据库"><a href="#创建mysql引擎的数据库" class="headerlink" title="创建mysql引擎的数据库"></a>创建mysql引擎的数据库</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> db_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MySQL<span class="token punctuation">(</span><span class="token string">'host:port'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'database'</span> <span class="token operator">|</span> <span class="token keyword">database</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>引擎参数</strong></p>
<ul>
<li><code>host:port</code> — MySQL服务地址</li>
<li><code>database</code> — MySQL数据库名称</li>
<li><code>user</code> — MySQL用户名</li>
<li><code>password</code> — MySQL用户密码</li>
</ul>
<h5 id="mysql数据库示例"><a href="#mysql数据库示例" class="headerlink" title="mysql数据库示例"></a>mysql数据库示例</h5><p><strong>1.创建数据库为test库，创建数据库表为mysql_table</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">USE</span> test<span class="token punctuation">;</span>
<span class="token keyword">Database</span> changed

mysql<span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>mysql_table<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token operator">-</span><span class="token operator">></span>   <span class="token identifier"><span class="token punctuation">`</span>int_id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span>   <span class="token identifier"><span class="token punctuation">`</span>float<span class="token punctuation">`</span></span> <span class="token keyword">FLOAT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>int_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">09</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> mysql_table <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>int_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>float<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysql_table<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+-----+</span>
<span class="token operator">|</span> int_id <span class="token operator">|</span> <span class="token keyword">value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----+</span>
<span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.clickhouse中按照mysql引擎创建数据库</strong></p>
<blockquote>
<p>与MySQL服务器交换数据,在clockhouse创建数据库mysql_db</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> mysql_db <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MySQL<span class="token punctuation">(</span><span class="token string">'localhost:3306'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'my_user'</span><span class="token punctuation">,</span> <span class="token string">'user_password'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>3.在clickhouse里面查看数据库</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">┌─name─────┐
│ <span class="token keyword">default</span>  │
│ mysql_db │
│ system   │
└──────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>4.在clickhouse查看数据库表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span> <span class="token keyword">FROM</span> mysql_db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">┌─name─────────┐
│  mysql_table │
└──────────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>5.在clickhouse执行插入语句</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mysql_db<span class="token punctuation">.</span>mysql_table <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>6.在clickhouse执行查询</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">┌─int_id─┬─<span class="token keyword">value</span>─┐
│      <span class="token number">1</span> │     <span class="token number">2</span> │
│      <span class="token number">3</span> │     <span class="token number">4</span> │
└────────┴───────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="索引-1"><a href="#索引-1" class="headerlink" title="索引"></a>索引</h3><ul>
<li>联合主键</li>
<li>联合排序键</li>
</ul>
<blockquote>
<ul>
<li>如果我们只指定了排序键，那么主键将隐式定义为排序键。</li>
<li>为了提高内存效率，我们显式地指定了一个主键，只包含查询过滤的列。基于主键的主索引被完全加载到主内存中。</li>
<li>为了上下文的一致性和最大的压缩比例，我们单独定义了排序键，排序键包含当前表所有的列（和压缩算法有关，一般排序之后又更好的压缩率）。</li>
<li>如果同时指定了主键和排序键，则主键必须是排序键的前缀。</li>
</ul>
</blockquote>
<h3 id="表引擎"><a href="#表引擎" class="headerlink" title="表引擎"></a>表引擎</h3><p>表引擎（即表的类型）决定了：</p>
<ul>
<li>数据的存储方式和位置，写到哪里以及从哪里读取数据</li>
<li>支持哪些查询以及如何支持。</li>
<li>并发数据访问。</li>
<li>索引的使用（如果存在）。</li>
<li>是否可以执行多线程请求。</li>
<li>数据复制参数。</li>
</ul>
<h4 id="引擎分类"><a href="#引擎分类" class="headerlink" title="引擎分类"></a>引擎分类</h4><ul>
<li>MergeTree:适用于高负载任务的最通用和功能最强大的表引擎</li>
<li>日志:具有最小功能的轻量级引擎。当您需要快速写入许多小表（最多约100万行）并在以后整体读取它们时，该类型的引擎是最有效的。</li>
<li>集成的表引擎:用于与其他的数据存储与处理系统集成的引擎。</li>
<li>special:用于其他特定功能的引擎</li>
</ul>
<h4 id="MergeTree引擎"><a href="#MergeTree引擎" class="headerlink" title="MergeTree引擎"></a>MergeTree引擎</h4><blockquote>
<p>MergeTree引擎的共同特点是可以快速插入数据并进行后续的后台数据处理。MergeTree系列引擎支持<strong>数据复制</strong>（使用Replicated* 的引擎版本），分区和一些其他引擎不支持的其他功能。</p>
</blockquote>
<h5 id="VersionedCollapsingMergeTree"><a href="#VersionedCollapsingMergeTree" class="headerlink" title="VersionedCollapsingMergeTree"></a>VersionedCollapsingMergeTree</h5><p>特点：</p>
<ul>
<li>允许快速写入不断变化的对象状态。</li>
<li>删除后台中的旧对象状态。 这显著降低了存储体积。</li>
</ul>
<blockquote>
<p>引擎继承自 MergeTree并将折叠行的逻辑添加到合并数据部分的算法中。 <code>VersionedCollapsingMergeTree</code> 用于相同的目的,折叠树但使用不同的折叠算法，允许以多个线程的任何顺序插入数据。 特别是<code>Version</code> 列有助于正确折叠行，即使它们以错误的顺序插入。 相比之下, <code>CollapsingMergeTree</code> 只允许严格连续插入。</p>
</blockquote>
<p>引擎参数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">VersionedCollapsingMergeTree<span class="token punctuation">(</span>sign<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p><code>sign</code> — 指定行类型的列名: <code>1</code> 是一个 “state” 行, <code>-1</code> 是一个 “cancel” 行</p>
<p>列数据类型应为 <code>Int8</code>.</p>
</li>
<li><p><code>version</code> — 指定对象状态版本的列名。</p>
<p>列数据类型应为 <code>UInt*</code>.</p>
</li>
</ul>
<h5 id="GraphiteMergeTree"><a href="#GraphiteMergeTree" class="headerlink" title="GraphiteMergeTree"></a>GraphiteMergeTree</h5><blockquote>
<p>该引擎用来对 <a target="_blank" rel="noopener" href="http://graphite.readthedocs.io/en/latest/index.html">Graphite</a>数据进行瘦身及汇总。对于想使用CH来存储Graphite数据的开发者来说可能有用。</p>
</blockquote>
<h5 id="AggregatingMergeTree"><a href="#AggregatingMergeTree" class="headerlink" title="AggregatingMergeTree"></a>AggregatingMergeTree</h5><blockquote>
<p>该引擎继承自MergeTree，并改变了数据片段的合并逻辑。 ClickHouse 会将一个数据片段内所有具有相同主键（准确的说是 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree">排序键</a>）的行替换成一行，这一行会存储一系列聚合函数的状态。可以使用 <code>AggregatingMergeTree</code> 表来做增量数据的聚合统计，包括物化视图的数据聚合。</p>
</blockquote>
<h5 id="CollapsingMergeTree"><a href="#CollapsingMergeTree" class="headerlink" title="CollapsingMergeTree"></a>CollapsingMergeTree</h5><blockquote>
<p>该引擎继承于 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree">MergeTree</a>，并在数据块合并算法中添加了折叠行的逻辑。<code>CollapsingMergeTree</code> 会异步的删除（折叠）这些除了特定列 <code>Sign</code> 有 <code>1</code> 和 <code>-1</code> 的值以外，其余所有字段的值都相等的成对的行。没有成对的行会被保留。因此，该引擎可以显著的降低存储量并提高 <code>SELECT</code> 查询效率。</p>
</blockquote>
<p>引擎参数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">CollapsingMergeTree<span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="自定义分区键"><a href="#自定义分区键" class="headerlink" title="自定义分区键"></a>自定义分区键</h5><blockquote>
<p>MergeTree 系列的表（包括可复制表）可以使用分区。基于 MergeTree 表的物化视图也支持分区。</p>
<p>分区是在一个表中通过指定的规则划分而成的逻辑数据集。可以按任意标准进行分区，如按月，按日或按事件类型。为了减少需要操作的数据，每个分区都是分开存储的。访问数据时，ClickHouse 尽量使用这些分区的最小子集。</p>
<p>分区是在建表时通过 <code>PARTITION BY expr</code> 子句指定的。分区键可以是表中列的任意表达式。例如，指定按月分区，表达式为 <code>toYYYYMM(date_column)</code>：</p>
</blockquote>
<h5 id="MergeTree"><a href="#MergeTree" class="headerlink" title="MergeTree"></a>MergeTree</h5><blockquote>
<p>clickhouse 中最强大的表引擎当属 <code>MergeTree</code> （合并树）引擎及该系列（<code>*MergeTree</code>）中的其他引擎。</p>
<p><code>MergeTree</code> 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式一个接着一个的快速写入，数据片段在后台按照一定的规则进行合并。相比在插入时不断修改（重写）已存储的数据，这种策略会高效很多。</p>
<p>主要特点:</p>
<ul>
<li>存储的数据按主键排序。能够创建一个小型的稀疏索引来加快数据检索。</li>
<li>如果指定了分区键的话，可以使用分区。在相同数据集和相同结果集的情况下 ClickHouse 中某些带分区的操作会比普通操作更快。查询中指定了分区键时 ClickHouse 会自动截取分区数据。这也有效增加了查询性能。</li>
<li>支持数据副本。<code>ReplicatedMergeTree</code> 系列的表提供了数据副本功能。</li>
<li>支持数据采样。可以给表设置一个采样方法。</li>
</ul>
</blockquote>
<p><strong>建表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
<span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span> <span class="token punctuation">[</span>TTL expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span> <span class="token punctuation">[</span>TTL expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">INDEX</span> index_name1 expr1 <span class="token keyword">TYPE</span> type1<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> GRANULARITY value1<span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> index_name2 expr2 <span class="token keyword">TYPE</span> type2<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> GRANULARITY value2
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> expr
<span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> expr<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> expr<span class="token punctuation">]</span>
<span class="token punctuation">[</span>SAMPLE <span class="token keyword">BY</span> expr<span class="token punctuation">]</span>
<span class="token punctuation">[</span>TTL expr <span class="token punctuation">[</span><span class="token keyword">DELETE</span><span class="token operator">|</span><span class="token keyword">TO</span> <span class="token keyword">DISK</span> <span class="token string">'xxx'</span><span class="token operator">|</span><span class="token keyword">TO</span> VOLUME <span class="token string">'xxx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>SETTINGS name<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>ENGINE</code> - 引擎名和参数。<code>ENGINE = MergeTree()</code>. <code>MergeTree</code> 引擎没有参数。</p>
</li>
<li><p><code>ORDER BY</code> — 排序键。可以是一组列的元组或任意的表达式。 例如: <code>ORDER BY (CounterID, EventDate)</code>,如果没有使用 <code>PRIMARY KEY</code> 显式指定的主键，ClickHouse 会使用排序键作为主键。如果不需要排序，可以使用 <code>ORDER BY tuple()</code>. 参考 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#selecting-the-primary-key">选择主键</a></p>
</li>
<li><p><code>PARTITION BY</code> — <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/custom-partitioning-key">分区键</a> ，可选项。大多数情况下，不需要分使用区键。即使需要使用，也不需要使用比月更细粒度的分区键。分区不会加快查询（这与 ORDER BY 表达式不同）。永远也别使用过细粒度的分区键。不要使用客户端指定分区标识符或分区字段名称来对数据进行分区（而是将分区字段标识或名称作为 ORDER BY 表达式的第一列来指定分区）。要按月分区，可以使用表达式 <code>toYYYYMM(date_column)</code>，这里的 <code>date_column</code>是一个Date类型的列。分区名的格式会是<code>&quot;YYYYMM&quot;</code>。</p>
</li>
<li><p><code>PRIMARY KEY</code> - 如果要 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#choosing-a-primary-key-that-differs-from-the-sorting-key">选择与排序键不同的主键</a>，在这里指定，可选项。默认情况下主键跟排序键（由 <code>ORDER BY</code> 子句指定）相同。大部分情况下不需要再专门指定一个 <code>PRIMARY KEY</code> 子句。</p>
</li>
<li><p><code>SAMPLE BY</code> - 用于抽样的表达式，可选项。如果要用抽样表达式，主键中必须包含这个表达式。例如： <code>SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID))</code> 。</p>
</li>
<li><p><code>TTL</code> - 指定行存储的持续时间并定义数据片段在硬盘和卷上的移动逻辑的规则列表，可选项。表达式中必须存在至少一个 <code>Date</code> 或 <code>DateTime</code> 类型的列，比如：</p>
<p><code>TTL date + INTERVAl 1 DAY</code></p>
</li>
</ul>
<p>TTL测试建表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">//创建5分钟后删除行的表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table_with_where
<span class="token punctuation">(</span>
    d <span class="token keyword">DateTime</span><span class="token punctuation">,</span>
    a <span class="token keyword">Int</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> toYYYYMM<span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> d
TTL d <span class="token operator">+</span> <span class="token keyword">INTERVAL</span> <span class="token number">5</span> <span class="token keyword">MINUTE</span><span class="token punctuation">;</span>
<span class="token comment">//插入多条数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> table_with_where <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table_with_where<span class="token punctuation">;</span>
┌───────────────────d─┬─a─┐
│ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">16</span>:<span class="token number">20</span>:<span class="token number">42</span> │ <span class="token number">1</span> │
│ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">16</span>:<span class="token number">21</span>:<span class="token number">04</span> │ <span class="token number">2</span> │
│ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">16</span>:<span class="token number">21</span>:<span class="token number">07</span> │ <span class="token number">3</span> │
│ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">16</span>:<span class="token number">21</span>:<span class="token number">09</span> │ <span class="token number">4</span> │
│ <span class="token number">2023</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">16</span>:<span class="token number">21</span>:<span class="token number">14</span> │ <span class="token number">5</span> │
└─────────────────────┴───┘
<span class="token comment">//5分钟后数据自动删除</span>
<span class="token comment">//设置一个过期时间</span>
<span class="token keyword">SECOND</span>
<span class="token keyword">MINUTE</span>
<span class="token keyword">HOUR</span>
<span class="token keyword">DAY</span>
WEEK
<span class="token keyword">YEAR</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="ReplacingMergeTree"><a href="#ReplacingMergeTree" class="headerlink" title="ReplacingMergeTree"></a>ReplacingMergeTree</h5><blockquote>
<p>该引擎和MergeTree的不同之处在于它会删除排序键值相同的重复项。数据的去重只会在数据合并期间进行。合并会在后台一个不确定的时间进行，因此你无法预先作出计划。有一些数据可能仍未被处理。尽管你可以调用 <code>OPTIMIZE</code> 语句发起计划外的合并，但请不要依靠它，因为 <code>OPTIMIZE</code> 语句会引发对数据的大量读写。<code>ReplacingMergeTree</code> 适用于在后台清除重复的数据以节省空间，但是它不保证没有重复的数据出现。</p>
</blockquote>
<p><strong>建表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ENGINE</span> <span class="token operator">=</span> ReplacingMergeTree<span class="token punctuation">(</span><span class="token punctuation">[</span>ver<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p><code>ver</code> — 版本列。类型为 <code>UInt*</code>, <code>Date</code> 或 <code>DateTime</code>。可选参数。</p>
<p>在数据合并的时候，<code>ReplacingMergeTree</code> 从所有具有相同排序键的行中选择一行留下：</p>
<ul>
<li>如果 <code>ver</code> 列未指定，保留最后一条。</li>
<li>如果 <code>ver</code> 列已指定，保留 <code>ver</code> 值最大的版本。</li>
</ul>
</li>
</ul>
<h5 id="数据副本"><a href="#数据副本" class="headerlink" title="数据副本"></a>数据副本</h5><blockquote>
<p>只有MergeTree系列里的表可支持副本：</p>
<ul>
<li>ReplicatedMergeTree</li>
<li>ReplicatedSummingMergeTree</li>
<li>ReplicatedReplacingMergeTree</li>
<li>ReplicatedAggregatingMergeTree</li>
<li>ReplicatedCollapsingMergeTree</li>
<li>ReplicatedVersionedCollapsingMergeTree</li>
<li>ReplicatedGraphiteMergeTree</li>
</ul>
<p>副本是表级别的，不是整个服务器级的。所以，服务器里可以同时有复制表和非复制表。副本不依赖分片。每个分片有它自己的独立副本。</p>
<p>对于 <code>INSERT</code> 和 <code>ALTER</code> 语句操作数据的会在压缩的情况下被复制,而 <code>CREATE</code>，<code>DROP</code>，<code>ATTACH</code>，<code>DETACH</code> 和 <code>RENAME</code> 语句只会在单个服务器上执行，不会被复制。</p>
<ul>
<li><code>CREATE TABLE</code> 在运行此语句的服务器上创建一个新的可复制表。如果此表已存在其他服务器上，则给该表添加新副本。</li>
<li><code>DROP TABLE</code> 删除运行此查询的服务器上的副本。</li>
<li><code>RENAME</code> 重命名一个副本。换句话说，可复制表不同的副本可以有不同的名称</li>
</ul>
<p><strong>如果配置文件中没有设置 ZooKeeper ，则无法创建复制表，并且任何现有的复制表都将变为只读。</strong></p>
<p><strong><code>SELECT</code> 查询并不需要借助 ZooKeeper ，副本并不影响 <code>SELECT</code> 的性能，查询复制表与非复制表速度是一样的。</strong></p>
</blockquote>
<p><strong>建表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table_name <span class="token punctuation">(</span>
    x UInt32
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> ReplicatedMergeTree
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> x<span class="token punctuation">;</span>
等价于
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table_name <span class="token punctuation">(</span>
    x UInt32
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> ReplicatedMergeTree<span class="token punctuation">(</span><span class="token string">'/clickhouse/tables/&#123;shard&#125;/&#123;database&#125;/table_name'</span><span class="token punctuation">,</span> <span class="token string">'&#123;replica&#125;'</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> x<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>zoo_path</code> — ZooKeeper 中该表的路径。</li>
<li><code>replica_name</code> — ZooKeeper 中的该表的副本名称。</li>
<li><code>other_parameters</code> — 关于引擎的一系列参数，这个引擎即是用来创建复制的引擎，例如，<code>ReplacingMergeTree</code> 。</li>
</ul>
<h5 id="SharedMergeTree"><a href="#SharedMergeTree" class="headerlink" title="SharedMergeTree"></a>SharedMergeTree</h5><blockquote>
<p>仅在ClickHouse Cloud（以及第一方合作伙伴云服务）中提供,SharedMergeTree表引擎系列是ReplicatedMergeTree引擎的云原生替代方案，经过优化，适用于共享对象存储（例如Amazon S3、Google Cloud Storage、MinIO、Azure Blob Storage）。每个特定的MergeTree引擎类型都有对应的SharedMergeTree引擎，例如ReplacingSharedMergeTree替代ReplacingReplicatedMergeTree。</p>
</blockquote>
<h5 id="SummingMergeTree"><a href="#SummingMergeTree" class="headerlink" title="SummingMergeTree"></a>SummingMergeTree</h5><blockquote>
<p>该引擎继承自 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree">MergeTree</a>。区别在于，当合并 <code>SummingMergeTree</code> 表的数据片段时，ClickHouse 会把所有具有相同主键的行合并为一行，该行包含了被合并的行中具有数值数据类型的列的汇总值。如果主键的组合方式使得单个键值对应于大量的行，则可以显著的减少存储空间并加快数据查询的速度。</p>
</blockquote>
<h4 id="日志引擎系列"><a href="#日志引擎系列" class="headerlink" title="日志引擎系列"></a>日志引擎系列</h4><blockquote>
<p>目的：为了需要写入许多小数据量（少于一百万行）的表的场景而开发的。</p>
<p>分类：</p>
<ul>
<li>StripeLog</li>
<li>Log</li>
<li>TinyLog</li>
</ul>
<p>共性：</p>
<ul>
<li>数据存储在磁盘上。</li>
<li>写入时将数据追加在文件末尾。</li>
<li>不支持<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/engines/table-engines/log-family#alter-mutations">突变</a>操作。</li>
<li>不支持索引。</li>
<li>非原子地写入数据。</li>
</ul>
<p>区别：</p>
<ul>
<li><p>并发访问数据的锁。</p>
</li>
<li><p>并行读取数据。</p>
</li>
</ul>
</blockquote>
<h5 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h5><blockquote>
<p><code>Log</code> 与 <code>TinyLog</code> 的不同之处在于，«标记» 的小文件与列文件存在一起。这些标记写在每个数据块上，并且包含偏移量，这些偏移量指示从哪里开始读取文件以便跳过指定的行数。这使得可以在多个线程中读取表数据。对于并发数据访问，可以同时执行读取操作，而写入操作则阻塞读取和其它写入。<code>Log</code>引擎不支持索引。同样，如果写入表失败，则该表将被破坏，并且从该表读取将返回错误。<code>Log</code>引擎适用于临时数据，write-once 表以及测试或演示目的。Log</p>
<p><code>Log</code> 与 <code>TinyLog</code> 的不同之处在于，«标记» 的小文件与列文件存在一起。这些标记写在每个数据块上，并且包含偏移量，这些偏移量指示从哪里开始读取文件以便跳过指定的行数。这使得可以在多个线程中读取表数据。对于并发数据访问，可以同时执行读取操作，而写入操作则阻塞读取和其它写入。<code>Log</code>引擎不支持索引。同样，如果写入表失败，则该表将被破坏，并且从该表读取将返回错误。<code>Log</code>引擎适用于临时数据，write-once 表以及测试或演示目的。</p>
</blockquote>
<h5 id="StripeLog"><a href="#StripeLog" class="headerlink" title="StripeLog"></a>StripeLog</h5><blockquote>
<p>在你需要写入许多小数据量（小于一百万行）的表的场景下使用这个引擎。</p>
</blockquote>
<p><strong>建表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
<span class="token punctuation">(</span>
    column1_name <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    column2_name <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> StripeLog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>写数据</strong></p>
<p><code>StripeLog</code> 引擎将所有列存储在一个文件中。对每一次 <code>Insert</code> 请求，ClickHouse 将数据块追加在表文件的末尾，逐列写入。</p>
<p>ClickHouse 为每张表写入以下文件：</p>
<ul>
<li><code>data.bin</code> — 数据文件。</li>
<li><code>index.mrk</code> — 带标记的文件。标记包含了已插入的每个数据块中每列的偏移量。</li>
</ul>
<p><code>StripeLog</code> 引擎不支持 <code>ALTER UPDATE</code> 和 <code>ALTER DELETE</code> 操作。</p>
<p><strong>读数据</strong></p>
<blockquote>
<p>带标记的文件使得 ClickHouse 可以并行的读取数据。这意味着 <code>SELECT</code> 请求返回行的顺序是不可预测的。使用 <code>ORDER BY</code> 子句对行进行排序。</p>
</blockquote>
<h5 id="TinyLog"><a href="#TinyLog" class="headerlink" title="TinyLog"></a>TinyLog</h5><blockquote>
<p>最简单的表引擎，用于将数据存储在磁盘上。每列都存储在单独的压缩文件中。写入时，数据将附加到文件末尾。<br>并发数据访问不受任何限制：<br>如果同时从表中读取并在不同的查询中写入，则读取操作将抛出异常<br>如果同时写入多个查询中的表，则数据将被破坏。<br>这种表引擎的典型用法是 write-once：首先只写入一次数据，然后根据需要多次读取。查询在单个流中执行。换句话说，此引擎适用于相对较小的表（建议最多1,000,000行）。如果您有许多小表，则使用此表引擎是适合的，因为它比Log引擎更简单（需要打开的文件更少）。当您拥有大量小表时，可能会导致性能低下，但在可能已经在其它 DBMS 时使用过，则您可能会发现切换使用 TinyLog 类型的表更容易。不支持索引。在 Yandex.Metrica 中，TinyLog 表用于小批量处理的中间数据。</p>
</blockquote>
<h4 id="集成的表引擎"><a href="#集成的表引擎" class="headerlink" title="集成的表引擎"></a>集成的表引擎</h4><blockquote>
<p>ClickHouse 提供了多种方式来与外部系统集成，包括表引擎。像所有其他的表引擎一样，使用<code>CREATE TABLE</code>或<code>ALTER TABLE</code>查询语句来完成配置。然后从用户的角度来看，配置的集成看起来像查询一个正常的表，但对它的查询是代理给外部系统的。这种透明的查询是这种方法相对于其他集成方法的主要优势之一，比如外部字典或表函数，它们需要在每次使用时使用自定义查询方法。</p>
</blockquote>
<p>支持集成的方式：</p>
<ul>
<li>JDBC</li>
<li>MYSQL</li>
<li>HDFS</li>
<li>KAFKA</li>
<li>RABBITMQ</li>
<li>HIVE</li>
<li>……</li>
</ul>
<h5 id="Mysql引擎"><a href="#Mysql引擎" class="headerlink" title="Mysql引擎"></a>Mysql引擎</h5><p>MySQL 引擎可以对存储在远程 MySQL 服务器上的数据执行 <code>SELECT</code> 查询。</p>
<p>调用格式：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">MySQL<span class="token punctuation">(</span><span class="token string">'host:port'</span><span class="token punctuation">,</span> <span class="token string">'database'</span><span class="token punctuation">,</span> <span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">[</span><span class="token punctuation">,</span> replace_query<span class="token punctuation">,</span> <span class="token string">'on_duplicate_clause'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>调用参数</strong></p>
<ul>
<li><code>host:port</code> — MySQL 服务器地址。</li>
<li><code>database</code> — 数据库的名称。</li>
<li><code>table</code> — 表名称。</li>
<li><code>user</code> — 数据库用户。</li>
<li><code>password</code> — 用户密码。</li>
<li><code>replace_query</code> — 将 <code>INSERT INTO</code> 查询是否替换为 <code>REPLACE INTO</code> 的标志。如果 <code>replace_query=1</code>，则替换查询</li>
<li><code>&#39;on_duplicate_clause&#39;</code> — 将 <code>ON DUPLICATE KEY UPDATE &#39;on_duplicate_clause&#39;</code> 表达式添加到 <code>INSERT</code> 查询语句中。例如：<code>impression = VALUES(impression) + impression</code>。如果需要指定 <code>&#39;on_duplicate_clause&#39;</code>，则需要设置 <code>replace_query=0</code>。如果同时设置 <code>replace_query = 1</code> 和 <code>&#39;on_duplicate_clause&#39;</code>，则会抛出异常。</li>
</ul>
<p>此时，简单的 <code>WHERE</code> 子句（例如 <code>=, !=, &gt;, &gt;=, &lt;, &lt;=</code>）是在 MySQL 服务器上执行。</p>
<p>其余条件以及 <code>LIMIT</code> 采样约束语句仅在对MySQL的查询完成后才在ClickHouse中执行。</p>
<p><code>MySQL</code> 引擎不支持可为空数据类型，因此，当从MySQL表中读取数据时，<code>NULL</code> 将转换为指定列类型的默认值（通常为0或空字符串）。</p>
<h5 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h5><p>允许CH通过 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Database_Connectivity">JDBC</a> 连接到外部数据库。</p>
<p>要实现JDBC连接，CH需要使用以后台进程运行的程序 <a target="_blank" rel="noopener" href="https://github.com/ClickHouse/clickhouse-jdbc-bridge">clickhouse-jdbc-bridge</a>。</p>
<p>该引擎支持 <a target="_blank" rel="noopener" href="https://clickhouse.com/docs/zh/sql-reference/data-types/nullable">Nullable</a> 数据类型。</p>
<p><strong>建表</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name
<span class="token punctuation">(</span>
    <span class="token keyword">columns</span> list<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> JDBC<span class="token punctuation">(</span>datasource_uri<span class="token punctuation">,</span> external_database<span class="token punctuation">,</span> external_table<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>引擎参数</strong></p>
<ul>
<li><p><code>datasource_uri</code> — 外部DBMS的URI或名字.</p>
<p>URI格式: <code>jdbc:&lt;driver_name&gt;://&lt;host_name&gt;:&lt;port&gt;/?user=&lt;username&gt;&amp;password=&lt;password&gt;</code>. MySQL示例: <code>jdbc:mysql://localhost:3306/?user=root&amp;password=root</code>.</p>
</li>
<li><p><code>external_database</code> — 外部DBMS的数据库名.</p>
</li>
<li><p><code>external_table</code> — <code>external_database</code>中的外部表名或类似<code>select * from table1 where column1=1</code>的查询语句.</p>
</li>
</ul>
<p><strong>用法示例</strong></p>
<p>通过mysql控制台客户端来创建表</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">mysql> CREATE TABLE `test`.`test` (
    ->   `int_id` INT NOT NULL AUTO_INCREMENT,
    ->   `int_nullable` INT NULL DEFAULT NULL,
    ->   `float` FLOAT NOT NULL,
    ->   `float_nullable` FLOAT NULL DEFAULT NULL,
    ->   PRIMARY KEY (`int_id`));
Query OK, 0 rows affected (0,09 sec)

mysql> insert into test (`int_id`, `float`) VALUES (1,2);
Query OK, 1 row affected (0,00 sec)

mysql> select * from test;
+------+----------+-----+----------+
| int_id | int_nullable | float | float_nullable |
+------+----------+-----+----------+
|      1 |         NULL |     2 |           NULL |
+------+----------+-----+----------+
1 row in set (0,00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在CH服务端创建表，并从中查询数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> jdbc_table
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>int_id<span class="token punctuation">`</span></span> Int32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>int_nullable<span class="token punctuation">`</span></span> Nullable<span class="token punctuation">(</span>Int32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>float<span class="token punctuation">`</span></span> Float32<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>float_nullable<span class="token punctuation">`</span></span> Nullable<span class="token punctuation">(</span>Float32<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> JDBC<span class="token punctuation">(</span><span class="token string">'jdbc:mysql://localhost:3306/?user=root&amp;password=root'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Special引擎"><a href="#Special引擎" class="headerlink" title="Special引擎"></a>Special引擎</h4><h4 id="物化视图MaterializedView"><a href="#物化视图MaterializedView" class="headerlink" title="物化视图MaterializedView"></a>物化视图MaterializedView</h4><blockquote>
<p>创建一个视图。它存在两种可选择的类型：普通视图与物化视图。</p>
<p>普通视图不存储任何数据，只是执行从另一个表中的读取。换句话说，普通视图只是保存了视图的查询，当从视图中查询时，此查询被作为子查询用于替换FROM子句。</p>
<p>SELECT a, b, c FROM view 等价于 SELECT a, b, c FROM (SELECT …)</p>
<p>物化视图存储的数据是由相应的SELECT查询转换得来的。在创建物化视图时，你还必须指定表的引擎 - 将会使用这个表引擎存储数据。目前物化视图的工作原理：当将数据写入到物化视图中SELECT子句所指定的表时，插入的数据会通过SELECT子句查询进行转换并将最终结果插入到视图中。</p>
<p>如果创建物化视图时指定了<strong>POPULATE子句</strong>，则在创建时将该表的数据插入到物化视图中。就像使用<code>CREATE TABLE ... AS SELECT ...</code>一样。否则，物化视图只会包含在物化视图创建后的新写入的数据。我们不推荐使用POPULATE，因为在视图创建期间写入的数据将不会写入其中。</p>
<p>当一个<code>SELECT</code>子句包含<code>DISTINCT</code>, <code>GROUP BY</code>, <code>ORDER BY</code>, <code>LIMIT</code>时，请注意，这些仅会在插入数据时在每个单独的数据块上执行。例如，如果你在其中包含了<code>GROUP BY</code>，则只会在查询期间进行聚合，但聚合范围仅限于单个批的写入数据。数据不会进一步被聚合。但是当你使用一些其他数据聚合引擎时这是例外的，如：<code>SummingMergeTree</code>。因此常用的引擎是<code>SummingMergeTree</code></p>
<p>目前对物化视图执行<code>ALTER</code>是不支持的，因此这可能是不方便的。如果物化视图是使用的<code>TO [db.]name</code>的方式进行构建的，你可以使用<code>DETACH</code>语句先将视图剥离，然后使用<code>ALTER</code>运行在目标表上，然后使用<code>ATTACH</code>将之前剥离的表重新加载进来。视图看起来和普通的表相同。例如，你可以通过<code>SHOW TABLES</code>查看到它们。没有单独的删除视图的语法。如果要删除视图，请使用<code>DROP TABLE</code>。</p>
</blockquote>
<p>简单来说：</p>
<p>视图保存的是一个select语句的查询结果</p>
<p>物化视图保存的是一个select语句的查询结果+数据</p>
<p><strong>物化视图注意事项</strong></p>
<p>1.创建物化视图的时候必须指定物化视图的engine 用于数据存储</p>
<p>2.POPULATE可以在创建视图的时候就开始导入数据，如果不加，只能在创建视图后添加数据。但是官方不推荐使用。</p>
<p>3.TO [db].[table]语法的时候，不得使用POPULATE。to一个目标表，可以将视图表原表信息根据视图规则将数据发送到目标表。<br>3.查询语句(select）可以包含下面的子句： DISTINCT, GROUP BY, ORDER BY, LIMIT…<br>4.物化视图的alter操作有些限制，操作起来不大方便。<br>5.物化视图是种特殊的数据表，可以用show tables 查看</p>
<p><strong>物化视图查询如此之快？</strong><br>空间换时间,因为物化视图这些规则已经全部写好并且条件所过滤后的数据已经存储在了本地表中，所以它比原数据查询快了很多，总的行数少了，因为都预计算好了。<br>缺点：它的本质是一个流式数据的使用场景，是累加式的技术，所以要用历史数据做去重、去核这样的分析，在物化视图里面是不太好用的。在某些场景的使用也是有限的。而且如果一张表加了好多物化视图，在写这张表的时候，就会消耗很多机器的资源，比如数据带宽占满、存储一下子增加了很多。</p>
<p><strong>示例：</strong></p>
<p>1.创建一个数据表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> order_detail 
<span class="token punctuation">(</span>
   id String<span class="token punctuation">,</span>
   sku_id  String<span class="token punctuation">,</span>
   pay_number Int32<span class="token punctuation">,</span>
   pay_amount Int32<span class="token punctuation">,</span> 
   order_date <span class="token keyword">Date</span> 
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> order_detail <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'001'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'2021-08-13'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'002'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'002'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.创建物化视图</p>
<blockquote>
<p>选用SummingMergeTree引擎，支持以主键分组，对数值型指标做自动累加。每当表的parts做后台merge的时候，主键相同记录合并成一行记录，节省空间。</p>
<p><strong>不指定POPULATE</strong></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> MATERIALIZED <span class="token keyword">VIEW</span> order_mv1
<span class="token keyword">ENGINE</span><span class="token operator">=</span>SummingMergeTree
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> toYYYYMMDD<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>order_date<span class="token punctuation">)</span>
<span class="token punctuation">[</span>是否指定 populate<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
id<span class="token punctuation">,</span>
order_date<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>pay_number<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>pay_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> amount
<span class="token keyword">FROM</span> order_detail
<span class="token keyword">WHERE</span> order_date <span class="token operator">></span> <span class="token string">'2021-08-14'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> id<span class="token punctuation">,</span>order_date<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4.查看表信息与视图信息</p>
<blockquote>
<p>查看当前表</p>
<p>show tables;</p>
<p>#视图表</p>
<p>order_mv1</p>
<p>#源表</p>
<p>order_detail</p>
<p>#持久化表</p>
<p>.join开头的表</p>
<p>我们查看视图并无表信息，这是因为我们并为只用populate导致，未指定populate时，只有当原表进行了数据的插入操作，视图才能监听到后续插入进表的数据，如果之前有数据，则无法监听到。</p>
</blockquote>
<p>5.再次插入数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> order_detail <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'003'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token string">'2021-08-12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'003'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'003'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'004'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'004'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">'2021-08-16'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'005'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">'2021-08-17'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'006'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token string">'2021-08-18'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>此时查看视图发现数据已经存在</p>
</blockquote>
<p>6.创建目标表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> order_des
<span class="token punctuation">(</span>
   id String<span class="token punctuation">,</span>
   sku_id  String<span class="token punctuation">,</span>
   pay_number Int32<span class="token punctuation">,</span>
   pay_amount Int32<span class="token punctuation">,</span> 
   order_date <span class="token keyword">Date</span> 
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>order_date<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>7.创建将数据传输到表中物化视图</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> MATERIALIZED <span class="token keyword">VIEW</span> order_mv3
<span class="token keyword">to</span> order_des
<span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
id<span class="token punctuation">,</span>
order_date<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>pay_number<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>pay_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> amount
<span class="token keyword">FROM</span> order_detail
<span class="token keyword">WHERE</span> order_date <span class="token operator">></span> <span class="token string">'2021-08-14'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> id<span class="token punctuation">,</span>order_date<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>1.下载1亿数据</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="https://datasets.clickhouse.com/hits/tsv/hits_100m_obfuscated_v1.tsv.xz">https://datasets.clickhouse.com/hits/tsv/hits_100m_obfuscated_v1.tsv.xz</a> | unxz –threads&#x3D;<code>nproc</code> &gt; hits_v1.tsv</p>
</blockquote>
<p>2.Validate the checksum</p>
<blockquote>
<p>md5sum hits_v1.tsv</p>
<p>Checksum should be equal to: f3631b6295bf06989c1437491f7592cb</p>
</blockquote>
<p>3.创建数据表</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clickhouse-client <span class="token parameter variable">--query</span><span class="token operator">=</span><span class="token string">"CREATE TABLE tutorial.hits_100m_obfuscated_all on cluster perftest_4shards_2replicas (WatchID UInt64, JavaEnable UInt8, Title String, GoodEvent Int16, EventTime DateTime, EventDate Date, CounterID UInt32, ClientIP UInt32, RegionID UInt32, UserID UInt64, CounterClass Int8, OS UInt8, UserAgent UInt8, URL String, Referer String, Refresh UInt8, RefererCategoryID UInt16, RefererRegionID UInt32, URLCategoryID UInt16, URLRegionID UInt32, ResolutionWidth UInt16, ResolutionHeight UInt16, ResolutionDepth UInt8, FlashMajor UInt8, FlashMinor UInt8, FlashMinor2 String, NetMajor UInt8, NetMinor UInt8, UserAgentMajor UInt16, UserAgentMinor FixedString(2), CookieEnable UInt8, JavascriptEnable UInt8, IsMobile UInt8, MobilePhone UInt8, MobilePhoneModel String, Params String, IPNetworkID UInt32, TraficSourceID Int8, SearchEngineID UInt16, SearchPhrase String, AdvEngineID UInt8, IsArtifical UInt8, WindowClientWidth UInt16, WindowClientHeight UInt16, ClientTimeZone Int16, ClientEventTime DateTime, SilverlightVersion1 UInt8, SilverlightVersion2 UInt8, SilverlightVersion3 UInt32, SilverlightVersion4 UInt16, PageCharset String, CodeVersion UInt32, IsLink UInt8, IsDownload UInt8, IsNotBounce UInt8, FUniqID UInt64, OriginalURL String, HID UInt32, IsOldCounter UInt8, IsEvent UInt8, IsParameter UInt8, DontCountHits UInt8, WithHash UInt8, HitColor FixedString(1), LocalEventTime DateTime, Age UInt8, Sex UInt8, Income UInt8, Interests UInt16, Robotness UInt8, RemoteIP UInt32, WindowName Int32, OpenerName Int32, HistoryLength Int16, BrowserLanguage FixedString(2), BrowserCountry FixedString(2), SocialNetwork String, SocialAction String, HTTPError UInt16, SendTiming UInt32, DNSTiming UInt32, ConnectTiming UInt32, ResponseStartTiming UInt32, ResponseEndTiming UInt32, FetchTiming UInt32, SocialSourceNetworkID UInt8, SocialSourcePage String, ParamPrice Int64, ParamOrderID String, ParamCurrency FixedString(3), ParamCurrencyID UInt16, OpenstatServiceName String, OpenstatCampaignID String, OpenstatAdID String, OpenstatSourceID String, UTMSource String, UTMMedium String, UTMCampaign String, UTMContent String, UTMTerm String, FromTag String, HasGCLID UInt8, RefererHash UInt64, URLHash UInt64, CLID UInt32) ENGINE = MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER  BY (CounterID, EventDate, intHash32(UserID)) SAMPLE BY intHash32(UserID) SETTINGS index_granularity = 8192"</span>

CREATE TABLE IF NOT EXISTS tutorial.hits_100m_obfuscated_all_dis on cluster perftest_4shards_2replicas AS tutorial.hits_100m_obfuscated_all ENGINE <span class="token operator">=</span> Distributed<span class="token punctuation">(</span>perftest_4shards_2replicas, tutorial, hits_100m_obfuscated_all, rand<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

clickhouse-client <span class="token parameter variable">--port</span> <span class="token number">8000</span> <span class="token parameter variable">--query</span> <span class="token string">"INSERT INTO tutorial.hits_100m_obfuscated_all_dis FORMAT TSV"</span> <span class="token parameter variable">--max_insert_block_size</span><span class="token operator">=</span><span class="token number">100000</span> <span class="token operator">&lt;</span> hits_100m_obfuscated_v1.tsv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="HA测试"><a href="#HA测试" class="headerlink" title="HA测试"></a>HA测试</h2><p>集群架构</p>
<p>2个shard2个Replica</p>
<ol>
<li><p>节点故障模拟查询：手动停止 ClickHouse 集群中的一个节点，能够正常查询出完整数据，保证了集群的高可用性和数据的完整性。</p>
</li>
<li><p>节点恢复测试：单节点宕机，执行插入语句，节点恢复后，将自动复制副本中的数据。</p>
</li>
<li><p>数据迁移：var&#x2F;lib&#x2F;clickhouse目录下将data和metadata迁移到新环境目录，启动服务即可</p>
</li>
</ol>
<p>面直接讲metadata的表结构拷贝过去的方法，有一个致命的BUG。如果表是分布式表，直接将表结构拷贝，虽然clickHouse中表已经创建成功，但是在ZK上的表的唯一地址并不会自动创建。所以所有需要与ZK交互的表都变成： Read Only模式,不能插入数据</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/Git%20Tutorial.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/Git%20Tutorial.html" itemprop="url">git tutorial</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-01-24T00:00:00+08:00">
                2024-01-24
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T16:48:53+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          学习如何使用Git
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/post/Git%20Tutorial.html">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/OrionPotter" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/imlzgg" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orion Potter</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
