<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="OrionPotter" />










<meta property="og:type" content="website">
<meta property="og:title" content="Orion Potter&#39;s 个人博客">
<meta property="og:url" content="https://blog.orionpotter.space/index.html">
<meta property="og:site_name" content="Orion Potter&#39;s 个人博客">
<meta property="og:locale">
<meta property="article:author" content="Orion Potter">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.orionpotter.space/"/>





  <title>Orion Potter's 个人博客</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Orion Potter's 个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-folder"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/1.html" itemprop="url">JWT认证实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:08:30+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:10:58+08:00">
                2025-04-04
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/authorization/" itemprop="url" rel="index">
                    <span itemprop="name">authorization</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="认证原理"><a href="#认证原理" class="headerlink" title="认证原理"></a>认证原理</h1><h2 id="跨域认证的问题"><a href="#跨域认证的问题" class="headerlink" title="跨域认证的问题"></a>跨域认证的问题</h2><p>互联网服务离不开用户认证。一般流程是下面这样。</p>
<blockquote>
<p>1、用户向服务器发送用户名和密码。</p>
<p>2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。</p>
<p>3、服务器向用户返回一个 session_id，写入用户的 Cookie。</p>
<p>4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。</p>
<p>5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</p>
</blockquote>
<p>这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。</p>
<p>举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？</p>
<p>一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</p>
<p>另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。</p>
<h2 id="JWT-JSON-Web-Token"><a href="#JWT-JSON-Web-Token" class="headerlink" title="JWT (JSON Web Token)"></a>JWT (JSON Web Token)</h2><p>JWT是一种用于在各方之间作为JSON对象安全传输信息的紧凑、URL安全的令牌。它由三部分组成：</p>
<ul>
<li><strong>Header</strong>：包含令牌类型（通常为JWT）和签名算法（例如HMAC SHA256）。</li>
<li><strong>Payload</strong>：包含声明（claims），即传输的数据。常见的声明包括：用户ID、用户名、过期时间等。</li>
<li><strong>Signature</strong>：用于验证令牌的真实性。它是由Header和Payload通过签名算法和密钥生成的。</li>
</ul>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript">Header<span class="token punctuation">.</span>Payload<span class="token punctuation">.</span>Signature<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</p>
<blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>上面代码中，<code>alg</code>属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；<code>typ</code>属性表示这个令牌（token）的类型（type），JWT 令牌统一写为<code>JWT</code>。</p>
<p>最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。</p>
<blockquote>
<ul>
<li>iss (issuer)：签发人</li>
<li>exp (expiration time)：过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号</li>
</ul>
</blockquote>
<p>除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。</p>
<blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"admin"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。</p>
<p>这个 JSON 对象也要使用 Base64URL 算法转成字符串。</p>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>Signature 部分是对前两部分的签名，防止数据篡改。</p>
<p>首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">HMACSHA256</span><span class="token punctuation">(</span>
  <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span>
  <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
  secret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用”点”（<code>.</code>）分隔，就可以返回给用户。</p>
<h2 id="JWT-的使用方式"><a href="#JWT-的使用方式" class="headerlink" title="JWT 的使用方式"></a>JWT 的使用方式</h2><p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</p>
<p>此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面。</p>
<blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">Authorization</span><span class="token operator">:</span> Bearer <span class="token operator">&lt;</span>token<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<p>另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h2><ol>
<li><strong>用户登录</strong>：用户提交用户名和密码。</li>
<li><strong>认证服务器验证</strong>：服务器验证用户信息，成功后生成JWT令牌。</li>
<li><strong>返回令牌</strong>：服务器将JWT令牌返回给客户端。</li>
<li><strong>客户端存储令牌</strong>：客户端存储令牌（通常在本地存储或Cookie中）。</li>
<li><strong>请求资源</strong>：客户端在每次请求资源时，将JWT令牌放入HTTP请求头中。</li>
<li><strong>服务器验证令牌</strong>：服务器验证JWT令牌的有效性，若有效则返回请求的资源。</li>
</ol>
<h1 id="编程步骤"><a href="#编程步骤" class="headerlink" title="编程步骤"></a>编程步骤</h1><h2 id="创建SpringBoot项目"><a href="#创建SpringBoot项目" class="headerlink" title="创建SpringBoot项目"></a>创建SpringBoot项目</h2><p>使用Spring Initializr创建一个Spring Boot项目，选择以下依赖：</p>
<ul>
<li>Spring Web</li>
<li>Spring Security</li>
<li>Spring Boot DevTools</li>
<li>JWT (可以通过Maven或Gradle添加依赖)</li>
</ul>
<h2 id="添加JWT依赖"><a href="#添加JWT依赖" class="headerlink" title="添加JWT依赖"></a>添加JWT依赖</h2><p>在<code>pom.xml</code>中添加JWT依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建用户注册类"><a href="#创建用户注册类" class="headerlink" title="创建用户注册类"></a>创建用户注册类</h2><p>前期准备，创建一个用户注册类来进行用户注册，后续采用jwt登录涉及加密处理，前期注册的时候采用加密存进数据库。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//控制器类</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        userService<span class="token punctuation">.</span><span class="token function">registerUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"User registered successfully"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//接口类</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//实现类</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMapper</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> encodedPassword <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将用户名和加密后的密码存储到数据库中</span>
        <span class="token class-name">User</span> passwdUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        passwdUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        passwdUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>passwdUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//实体类</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>  <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建Security配置类"><a href="#创建Security配置类" class="headerlink" title="创建Security配置类"></a>创建Security配置类</h2><p>创建一个配置类来配置Spring Security：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUserDetailsService</span> jwtUserDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//禁用CSRF保护（对于无状态的REST API来说，CSRF保护通常是多余的）。</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span> <span class="token comment">//配置会话管理策略为无状态（STATELESS）</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/auth/login"</span><span class="token punctuation">,</span> <span class="token string">"/auth/register"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 允许匿名访问登录和注册路径</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            	<span class="token comment">//注册JWT过滤器，确保在每次请求时验证JWT令牌</span>
                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtRequestFilter</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">,</span> userDetailsService<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>jwtUserDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	
    <span class="token comment">// 配置用户认证服务和密码编码器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建JWT工具类"><a href="#创建JWT工具类" class="headerlink" title="创建JWT工具类"></a>创建JWT工具类</h2><p>创建一个JWT工具类，用于生成和验证JWT令牌：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtils</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;jwt.secret&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;jwt.expiration&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> expiration<span class="token punctuation">;</span>


    <span class="token comment">// 生成JWT令牌</span>
    <span class="token annotation punctuation">@CacheResult</span><span class="token punctuation">(</span>cacheKey <span class="token operator">=</span> <span class="token string">"#this.getCacheKey(#username)"</span><span class="token punctuation">,</span>expireTime <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"token:"</span><span class="token operator">+</span>username<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 提取声明（claims）</span>
    <span class="token keyword">public</span> <span class="token class-name">Claims</span> <span class="token function">extractClaims</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Extracting claims from Token: &#123;&#125;"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出接收到的令牌</span>
            <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SignatureException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Invalid JWT signature: &#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error extracting claims: &#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 验证JWT令牌</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">extractClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">String</span> tokenUsername <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isTokenExpired <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isValid <span class="token operator">=</span> username<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tokenUsername<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTokenExpired<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Token validation failed. Username: &#123;&#125;, Token Username: &#123;&#125;, Is Token Expired: &#123;&#125;"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> tokenUsername<span class="token punctuation">,</span> isTokenExpired<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> isValid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建用户认证服务"><a href="#创建用户认证服务" class="headerlink" title="创建用户认证服务"></a>创建用户认证服务</h2><p>创建一个用户认证服务，用于加载用户信息：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">// 根据用户名加载用户</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> lambdaQueryWrapper
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"User not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtUserDetails</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// user是你自定义的UserDetails实现类</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建认证控制器"><a href="#创建认证控制器" class="headerlink" title="创建认证控制器"></a>创建认证控制器</h2><p>创建一个控制器来处理用户登录和生成JWT令牌：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUserDetailsService</span> jwtUserDetailsService<span class="token punctuation">;</span>

    <span class="token comment">// 处理用户登录请求</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> authRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 进行用户认证</span>
            <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authRequest<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Invalid username or password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 生成JWT令牌</span>
        <span class="token keyword">final</span> <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> jwtUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jwtUtils<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建JWT过滤器"><a href="#创建JWT过滤器" class="headerlink" title="创建JWT过滤器"></a>创建JWT过滤器</h2><p>创建一个JWT过滤器，用于在每次请求时验证JWT令牌：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtRequestFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUtils</span> jwtUtil<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JwtRequestFilter</span><span class="token punctuation">(</span><span class="token class-name">JwtUtils</span> jwtUtil<span class="token punctuation">,</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsService <span class="token operator">=</span> userDetailsService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtUtil <span class="token operator">=</span> jwtUtil<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">final</span> <span class="token class-name">String</span> authorizationHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jwt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 从请求头中获取JWT令牌</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorizationHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authorizationHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            jwt <span class="token operator">=</span> authorizationHeader<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            username <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">extractClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 验证令牌并设置认证信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jwtUtil<span class="token punctuation">.</span><span class="token function">validateToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">UsernamePasswordAuthenticationToken</span> usernamePasswordAuthenticationToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                        userDetails<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                usernamePasswordAuthenticationToken
                        <span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>usernamePasswordAuthenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h1><h2 id="注册阶段"><a href="#注册阶段" class="headerlink" title="注册阶段"></a>注册阶段</h2><ol>
<li><strong>用户发送注册请求</strong>：通过客户端（如浏览器或Postman）发送一个json格式的user对象的POST请求到<code>/regester</code>接口。</li>
<li><strong>调用UserService的注册方法</strong>：将需要注册的user对象传入registerUser方法中，将密码使用PasswordEncoder加密后和用户名存到数据库。</li>
</ol>
<h2 id="认证阶段"><a href="#认证阶段" class="headerlink" title="认证阶段"></a>认证阶段</h2><ol>
<li><strong>用户登录请求</strong>：通过客户端（如浏览器或Postman）发送一个json格式的user对象的POST请求到<code>/login</code>接口</li>
<li><strong>创建认证请求对象</strong>：使用 <code>UsernamePasswordAuthenticationToken</code> 创建一个包含用户名和密码的认证请求对象。</li>
<li><strong>调用 <code>AuthenticationManager</code> 的 <code>authenticate</code> 方法</strong>：<code>AuthenticationManager</code> 调用内部配置的 <code>AuthenticationProvider</code> 进行认证。</li>
<li><strong><code>DaoAuthenticationProvider</code> 进行用户认证</strong>：</li>
</ol>
<ul>
<li>使用 <code>UserDetailsService</code> 加载用户信息。</li>
<li>使用 <code>PasswordEncoder</code> 验证密码。</li>
</ul>
<ol start="5">
<li><strong>返回认证结果</strong>：</li>
</ol>
<ul>
<li>如果认证成功，返回一个填充了用户详细信息和权限的 <code>Authentication</code> 对象。</li>
<li>如果认证失败，抛出 <code>AuthenticationException</code>。</li>
</ul>
<h2 id="生成JWT令牌阶段"><a href="#生成JWT令牌阶段" class="headerlink" title="生成JWT令牌阶段"></a>生成JWT令牌阶段</h2><ol>
<li><strong>调用 <code>loadUserByUsername</code> 方法</strong>：</li>
</ol>
<ul>
<li><code>jwtUserDetailsService</code> 是一个实现了 <code>UserDetailsService</code> 接口的服务类。</li>
<li><code>loadUserByUsername</code> 方法用于根据用户名加载用户详细信息。</li>
</ul>
<ol start="2">
<li><p><strong>查询用户信息</strong>：在 <code>loadUserByUsername</code> 方法中，通常会查询数据库或其他存储系统，以获取用户信息。</p>
</li>
<li><p><strong>返回 <code>UserDetails</code> 对象</strong>：查询到用户信息后，创建并返回一个实现了 <code>UserDetails</code> 接口的对象，通常是一个自定义的用户详细信息类（例如 <code>JwtUserDetails</code>）</p>
</li>
<li><p><strong>调用 <code>generateToken</code> 方法</strong>：</p>
</li>
</ol>
<ul>
<li><code>jwtUtils</code> 是一个用于生成和验证 JWT 令牌的工具类。</li>
<li><code>generateToken</code> 方法用于生成一个包含用户名和其他信息的 JWT 令牌。</li>
</ul>
<ol start="5">
<li><strong>创建 JWT 令牌</strong>：</li>
</ol>
<ul>
<li>在 <code>generateToken</code> 方法中，使用 JWT 库（例如 <code>jjwt</code>）创建一个 JWT 令牌。</li>
<li>令牌中通常包含用户名、签发时间、过期时间等信息，并使用指定的密钥进行签名。</li>
</ul>
<ol start="6">
<li><strong>返回 JWT 令牌</strong>：生成的 JWT 令牌以字符串形式返回。</li>
</ol>
<h2 id="受保护的控制器类"><a href="#受保护的控制器类" class="headerlink" title="受保护的控制器类"></a>受保护的控制器类</h2><p>以testController为例，来看受保护的请求，如何进行JWT验证的执行流程</p>
<ol>
<li><strong>请求到达</strong> <code>DispatcherServlet</code>：所有请求首先到达 Spring 的 <code>DispatcherServlet</code>。</li>
<li><strong>进入过滤器链</strong>：请求通过 Spring Security 配置的过滤器链。</li>
<li><strong>通过每个过滤器</strong>：</li>
</ol>
<ul>
<li><code>SecurityContextPersistenceFilter</code>：从存储中加载 <code>SecurityContext</code> 并将其存储在 <code>SecurityContextHolder</code> 中，以便在请求处理过程中使用。</li>
<li><code>JwtRequestFilter</code>（自定义过滤器）：从请求头中提取 JWT 令牌，并验证其有效性。如果令牌有效，将认证信息存储到 <code>SecurityContextHolder</code> 中。</li>
<li><code>ExceptionTranslationFilter</code>：处理认证和授权过程中抛出的异常，将其转换为适当的 HTTP 响应。</li>
<li><code>FilterSecurityInterceptor</code>：进行访问控制决策，检查当前用户是否有权限访问请求的资源。</li>
</ul>
<ol start="4">
<li><strong>处理器映射</strong>：<code>DispatcherServlet</code> 使用 <code>HandlerMapping</code> 查找与请求路径对应的处理器方法。</li>
<li><strong>调用处理器方法</strong>：<code>DispatcherServlet</code> 调用找到的处理器方法。</li>
<li><strong>返回响应</strong>：处理器方法执行并返回响应，<code>DispatcherServlet</code> 将响应返回给客户端。</li>
</ol>
<h1 id="涉及类介绍"><a href="#涉及类介绍" class="headerlink" title="涉及类介绍"></a>涉及类介绍</h1><h2 id="UsernamePasswordAuthenticationToken"><a href="#UsernamePasswordAuthenticationToken" class="headerlink" title="UsernamePasswordAuthenticationToken"></a><code>UsernamePasswordAuthenticationToken</code></h2><p><strong>作用：</strong></p>
<ol>
<li><strong>存储用户认证信息</strong>：<ul>
<li><code>UsernamePasswordAuthenticationToken</code> 对象包含了用户的认证信息，例如用户名（principal）和密码（credentials）。</li>
</ul>
</li>
<li><strong>传递认证请求</strong>：<ul>
<li>在用户登录时，<code>UsernamePasswordAuthenticationToken</code> 对象通常用于创建认证请求对象，并传递给 <code>AuthenticationManager</code> 进行认证。</li>
</ul>
</li>
<li><strong>表示认证状态</strong>：<ul>
<li><code>UsernamePasswordAuthenticationToken</code> 对象还可以表示认证状态，通过 <code>setAuthenticated</code> 方法设置为已认证或未认证。</li>
</ul>
</li>
</ol>
<p><strong>构造函数：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用父类的构造函数，传入 null 表示没有权限信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span> <span class="token comment">// 设置用户主体,就是用户名</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span> <span class="token comment">// 设置用户凭据，就是密码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置认证状态为未认证</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a><code>SecurityContextPersistenceFilter</code></h2><p><strong>作用</strong>：</p>
<ul>
<li>从存储中加载 <code>SecurityContext</code> 并将其存储在 <code>SecurityContextHolder</code> 中，以便在请求处理过程中使用。</li>
<li>在请求结束时，将 <code>SecurityContext</code> 的状态保存到存储中。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>
    <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SecurityContext</span> contextAfterChainExecution <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        repo<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>contextAfterChainExecution<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ExceptionTranslationFilter"><a href="#ExceptionTranslationFilter" class="headerlink" title="ExceptionTranslationFilter"></a><code>ExceptionTranslationFilter</code></h2><p><strong>作用</strong>：</p>
<ul>
<li>处理认证和授权过程中抛出的异常，将其转换为适当的 HTTP 响应。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a><code>FilterSecurityInterceptor</code></h2><p><strong>作用</strong>：</p>
<ul>
<li>进行访问控制决策，检查当前用户是否有权限访问请求的资源。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">FilterInvocation</span> fi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InterceptorStatusToken</span> token <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeInvocation</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        fi<span class="token punctuation">.</span><span class="token function">getChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finallyInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E6%9C%89%E7%8A%B6%E6%80%81%E5%92%8C%E6%97%A0%E7%8A%B6%E6%80%81%E7%9A%84%E5%8C%BA%E5%88%AB.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E6%9C%89%E7%8A%B6%E6%80%81%E5%92%8C%E6%97%A0%E7%8A%B6%E6%80%81%E7%9A%84%E5%8C%BA%E5%88%AB.html" itemprop="url">有状态和无状态请求的区别</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是状态"><a href="#什么是状态" class="headerlink" title="什么是状态"></a>什么是状态</h1><p>“状态”是指系统用于处理请求的存储信息。随着用户与应用程序交互或系统事件发生，这些信息可能会随时间而变化。 </p>
<h1 id="有状态请求"><a href="#有状态请求" class="headerlink" title="有状态请求"></a>有状态请求</h1><p>有状态应用会存储用户 ID、会话信息、配置和偏好设置等数据，以帮助处理特定用户的请求。有状态设计允许应用为其用户提供个性化体验，同时无需在多个请求之间共享数据。 </p>
<blockquote>
<p>在有状态请求中，服务器会跟踪客户端的状态。这通常是通过会话或者cookie来实现的。每次客户端发送给服务器的请求，服务器都会参考之前的信息来处理这次请求。一个典型的例子就是登录到网站后，服务器会存储你的信息（比如用户名）。当你在网站内进行其他操作时，服务器会通过识别你的状态来确保你已经登录，这样你就可以访问需要登录才能打开的页面。</p>
</blockquote>
<h1 id="无状态的由来"><a href="#无状态的由来" class="headerlink" title="无状态的由来"></a>无状态的由来</h1><p>随着应用程序变得越来越复杂，流量也越来越大，有状态设计的局限性也越来越明显。管理和维护会话数据会给系统带来巨大的性能开销和复杂性。这种复杂性使得系统难以水平扩展，因为跨多个实例共享状态成为一项挑战。对可扩展性和效率的迫切需求推动了无状态设计的流行。请求包含处理请求所需的所有信息，而不是状态管理机制。系统能够处理高级别的请求，同时增加系统扩展的灵活性，使其更加节省资源。 </p>
<h1 id="无状态请求"><a href="#无状态请求" class="headerlink" title="无状态请求"></a>无状态请求</h1><blockquote>
<p>在无状态请求中，服务器并不记录任何关于客户端的状态信息。每个请求都是独立的，服务器不会关联不同的请求。这意味着每个请求都必须包含所有必要的信息，服务器不能依赖于过去的请求或会话来获取任何信息。无状态请求可以使服务器更容易扩展，因为它们并不需要保存任何关于客户端的状态信息。</p>
</blockquote>
<h1 id="有状态和无状态的区别"><a href="#有状态和无状态的区别" class="headerlink" title="有状态和无状态的区别"></a>有状态和无状态的区别</h1><blockquote>
<p>有状态请求和无状态请求主要的区别在于系统是否记住过去的信息,在实际应用中，根据使用场景的需要，既有无状态也有有状态的存在。例如，HTTP协议本身就是无状态的，但是我们可以通过在应用层面添加会话或者cookie等工具，以便让HTTP请求变成有状态的。</p>
</blockquote>
<h1 id="无状态应用场景"><a href="#无状态应用场景" class="headerlink" title="无状态应用场景"></a>无状态应用场景</h1><ol>
<li><p><code>微服务和无服务器计算</code> 它们体现了无状态，使服务和功能能够独立运行，从而提高可扩展性和资源效率。</p>
</li>
<li><p><code>RESTful API 和 CDN</code> 通过包含所有必要信息的每个 API 调用或请求，无状态设计简化了操作并提高了内容传递速度。</p>
</li>
</ol>
<h1 id="无状态的缺点"><a href="#无状态的缺点" class="headerlink" title="无状态的缺点"></a><strong>无状态的缺点</strong></h1><ol>
<li><p>更大的请求大小——需要在每个请求中包含完整的数据，这会导致数据传输增加，从而影响性能。 </p>
</li>
<li><p>传输效率低下——不断发送完整数据集的效率可能低于访问有状态设计中的集中式数据。 </p>
</li>
<li><p>并不总是理想的——在本质上需要状态的场景中，例如复杂的用户交互，无状态设计可能会增加更多复杂性，而不是简化流程。大多数应用程序根据每个组件的需求和限制选择有状态和无状态设计之间的混合方法。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" itemprop="url">设计模式</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基于jdbc的策略模式"><a href="#基于jdbc的策略模式" class="headerlink" title="基于jdbc的策略模式"></a>基于jdbc的策略模式</h1><blockquote>
<p>当进行数据库连接的时候，可能是mysql，可能是oracle,可能是pg,涉及到数据库的切换。为此采用策略模式进行多数据库切换，只需要选择不同数据库的对应的客户端就行</p>
<p>策略模式原理：</p>
<p>策略模式属于对象的行为模式。其用意是针对一组算法，将每一个算法封装到具有共同接口的独立的类中，从而使得它们可以相互替换。策略模式使得算法可以在不影响到客户端的情况下发生变化。</p>
<p>缺点：把每个具体的策略实现都单独封装成为类，如果备选的策略很多的话，那么对象的数目就会很可观。</p>
</blockquote>
<h2 id="创建策略接口"><a href="#创建策略接口" class="headerlink" title="创建策略接口"></a>创建策略接口</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 数据库连接策略接口
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StatgeDb</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Mysql策略实现类"><a href="#Mysql策略实现类" class="headerlink" title="Mysql策略实现类"></a>Mysql策略实现类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * Mysql策略实现类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlStatge</span> <span class="token keyword">implements</span> <span class="token class-name">StatgeDb</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 具体实现
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//1.加载驱动</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//2.获取连接</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/switchgame(lf526)?characterEncoding=utf8&amp;serverTimezone=UTC&amp;useSSL=false"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> throwables<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取连接失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            throwables<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获取连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Orcale策略实现类"><a href="#Orcale策略实现类" class="headerlink" title="Orcale策略实现类"></a>Orcale策略实现类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * Orcale策略实现类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrcaleStatge</span> <span class="token keyword">implements</span> <span class="token class-name">StatgeDb</span><span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OrcaleStatge连接成功，只做演示，不具体实现"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Pg策略实现类"><a href="#Pg策略实现类" class="headerlink" title="Pg策略实现类"></a>Pg策略实现类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * Pg策略实现类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PgStatge</span> <span class="token keyword">implements</span> <span class="token class-name">StatgeDb</span><span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"PgStatge连接成功，只做演示，不具体实现"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="策略模式实现类"><a href="#策略模式实现类" class="headerlink" title="策略模式实现类"></a>策略模式实现类</h2><blockquote>
<p>策略模式客户端，只需要创建客户端的时候，传入不同的策略对象，即可调用不同的数据库</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 策略模式实现类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatgeDbClient</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">StatgeDb</span> statgeDb<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">StatgeDbClient</span><span class="token punctuation">(</span><span class="token class-name">StatgeDb</span> statgeDb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statgeDb <span class="token operator">=</span> statgeDb<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> statgeDb<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="策略模式实现测试类"><a href="#策略模式实现测试类" class="headerlink" title="策略模式实现测试类"></a>策略模式实现测试类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 策略模式实现测试类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatgeDbTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//对mysql进行连接</span>
        <span class="token class-name">StatgeDbClient</span> statgeDbClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatgeDbClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MysqlStatge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> statgeDbClient<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对mysql进行连接</span>
        <span class="token class-name">StatgeDbClient</span> orcaleStatge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatgeDbClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrcaleStatge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection_orcale <span class="token operator">=</span> orcaleStatge<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对mysql进行连接</span>
        <span class="token class-name">StatgeDbClient</span> pgStatge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatgeDbClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PgStatge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection_pgStatge <span class="token operator">=</span> pgStatge<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h1><blockquote>
<p>执行sql的时候想看下执行的sql语句，此时可以使用代理模式，把需要打印的sql，调用一下打印方法就可以了</p>
<p>代理模式: 为一个对象提供一个替身，以控制对这个对象的访问。即通过代理对象访问目标对象.这样做的好处是:可以在目标对象实现的基础上,增强额外的功能操作,即扩展目标对象的功能。</p>
</blockquote>
<h2 id="创建代理模式接口"><a href="#创建代理模式接口" class="headerlink" title="创建代理模式接口"></a>创建代理模式接口</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 代理模式接口
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProxySql</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建真实实现类"><a href="#创建真实实现类" class="headerlink" title="创建真实实现类"></a>创建真实实现类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 代理真实类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealProxySqlImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ProxySql</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sql<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">RealProxySqlImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sql <span class="token operator">=</span> sql<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"execute sql "</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建代理实现类"><a href="#创建代理实现类" class="headerlink" title="创建代理实现类"></a>创建代理实现类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 代理实现类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxySqlImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ProxySql</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">RealProxySqlImpl</span> realProxySql<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sql<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ProxySqlImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sql <span class="token operator">=</span> sql<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>realProxySql <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            realProxySql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealProxySqlImpl</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        realProxySql<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<p>只需要需要打印sql的地方进行调用代理类，本方法打印sql实现比较简单，代理模式可以进行进行事务管理，sql注入的检测等其他高级功能</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//读取用户信息</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from user"</span><span class="token punctuation">;</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  sql <span class="token operator">=</span> sql <span class="token operator">+</span> <span class="token string">"where username like ?"</span><span class="token punctuation">;</span>
  <span class="token comment">//添加代理类</span>
  <span class="token class-name">ProxySql</span> proxySql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxySqlImpl</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  proxySql<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"%"</span><span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><blockquote>
<p>它提供了一种创建对象的最佳方式。</p>
<p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。</p>
</blockquote>
<blockquote>
<p>懒汉式和饿汉式区别:</p>
<p>实例化方面:懒汉式默认不会实例化，外部什么时候调用什么时候new。饿汉式在类加载的时候就实例化，并目创建单例对象。<br>线程安全方面:</p>
<p>1.饿汉式线程安全:在线程还没出现之前就已经实例化了，因此饿汉式线程一定是安全的。<br>2.懒汉式线程不安全:因为懒汉式加载是在使用时才会去new实例的，那么你去new的时候是一个动态的过程，是放到方法中实现的。</p>
</blockquote>
<h2 id="懒汉式实现方式"><a href="#懒汉式实现方式" class="headerlink" title="懒汉式实现方式"></a>懒汉式实现方式</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 单例模式类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 懒汉式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DBUtil</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">DBUtil</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="饿汉式实现方式"><a href="#饿汉式实现方式" class="headerlink" title="饿汉式实现方式"></a>饿汉式实现方式</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 单例模式类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 饿汉式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DBUtil</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DBUtil</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><blockquote>
<p>每次使用的时候不用每次new创建一个对象，直接去单例里面拿对象</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SoftTypeService</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//private DBUtil db = new DBUtil();</span>
	<span class="token keyword">private</span> <span class="token class-name">DBUtil</span> db <span class="token operator">=</span> <span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="模板方法"><a href="#模板方法" class="headerlink" title="模板方法"></a>模板方法</h1><blockquote>
<p>在模板模式（Template Pattern）中，一个抽象类公开定义了执行它的方法的方式&#x2F;模板。它的子类可以按需要重写方法实现，但调用将以抽象类中定义的方式进行。这种类型的设计模式属于行为型模式</p>
<p>Servlet就是一个很好的模板模式的类，只需要继承并且重写他的get、post方法就可以，因为它已经写好了这种模板</p>
</blockquote>
<h2 id="自定义一个servlet"><a href="#自定义一个servlet" class="headerlink" title="自定义一个servlet"></a>自定义一个servlet</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 自定义模板类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServletHttp</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServletHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO Auto-generated constructor stub</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//执行具体的业务逻辑</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token function">doGet</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="未自定义前我们的使用方式"><a href="#未自定义前我们的使用方式" class="headerlink" title="未自定义前我们的使用方式"></a>未自定义前我们的使用方式</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Logout</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
       
    <span class="token comment">/**
     * @see HttpServlet#HttpServlet()
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO Auto-generated constructor stub</span>
    <span class="token punctuation">&#125;</span>

	<span class="token comment">/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

		request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		<span class="token function">doGet</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用我们自定义的servlet模板"><a href="#使用我们自定义的servlet模板" class="headerlink" title="使用我们自定义的servlet模板"></a>使用我们自定义的servlet模板</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 模板模式类
 * &lt;/p>
 *
 */</span>
<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">"/logout2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModelLogout</span> <span class="token keyword">extends</span> <span class="token class-name">ServletHttp</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//执行具体的业务逻辑</span>
        request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="测试方式"><a href="#测试方式" class="headerlink" title="测试方式"></a>测试方式</h2><pre class="line-numbers language-jsp" data-language="jsp"><code class="language-jsp">&lt;%@ page pageEncoding&#x3D;&quot;utf-8&quot;%&gt;
&lt;h1 style&#x3D;&quot;color: red; text-align: center;&quot;&gt;&lt;&#x2F;h1&gt;
&lt;body style&#x3D;&quot;background:url(images&#x2F;b3.jpg);background-size:cover;text-align: center;&quot;&gt;
&lt;div align&#x3D;&quot;right&quot;&gt;
	&lt;a href&#x3D;&quot;list_user&quot;&gt;用户管理&lt;&#x2F;a&gt;&amp;nbsp;&amp;nbsp; 
	&lt;a href&#x3D;&quot;&quot;&gt;游戏软件管理&lt;&#x2F;a&gt;&amp;nbsp;&amp;nbsp; 
	&lt;a href&#x3D;&quot;type_list&quot;&gt;游戏分类管理&lt;&#x2F;a&gt;&amp;nbsp;&amp;nbsp; 
	&lt;a href&#x3D;&quot;logout&quot;&gt;退出系统&lt;&#x2F;a&gt;&amp;nbsp;&amp;nbsp; 换成&lt;a href&#x3D;&quot;logout2&quot;&gt;退出系统&lt;&#x2F;a&gt;&amp;nbsp;&amp;nbsp;
&lt;&#x2F;div&gt;
&lt;&#x2F;body&gt;
&lt;hr&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h1><blockquote>
<p>用一个已经创建的实例作为原型，通过复制该原型对象来创建一个和原型相同或相似的新对象。在这里，原型实例指定了要创建的对象的种类。</p>
</blockquote>
<h2 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h2><blockquote>
<ul>
<li>Java自带的原型模式基于内存二进制流的复制，在性能上比直接 new 一个对象更加优良。</li>
<li>可以使用深克隆方式保存对象的状态，使用原型模式将对象复制一份，并将其状态保存起来，简化了创建对象的过程，以便在需要的时候使用（例如恢复到历史某一状态），可辅助实现撤销操作。</li>
</ul>
</blockquote>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点:"></a>缺点:</h2><blockquote>
<ul>
<li>需要为每一个类都配置一个 clone 方法</li>
<li>clone 方法位于类的内部，当对已有类进行改造的时候，需要修改代码，违背了开闭原则。</li>
<li>当实现深克隆时，需要编写较为复杂的代码，而且当对象之间存在多重嵌套引用时，为了实现深克隆，每一层对象对应的类都必须支持深克隆，实现起来会比较麻烦。因此，深克隆、浅克隆需要运用得当。</li>
</ul>
</blockquote>
<h2 id="抽象原型类"><a href="#抽象原型类" class="headerlink" title="抽象原型类"></a>抽象原型类</h2><blockquote>
<p>Cloneable 接口</p>
</blockquote>
<h2 id="具体原型类"><a href="#具体原型类" class="headerlink" title="具体原型类"></a>具体原型类</h2><blockquote>
<p>实现抽象原型类的 clone() 方法，它是可被复制的对象。</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * user类
 * &lt;/p>
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>  <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token class-name">String</span> salt<span class="token punctuation">;</span>
    <span class="token class-name">String</span> ident<span class="token punctuation">;</span>
    <span class="token class-name">String</span> telephone<span class="token punctuation">;</span>
    <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token class-name">String</span> ident<span class="token punctuation">,</span> <span class="token class-name">String</span> telephone<span class="token punctuation">,</span> <span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>salt <span class="token operator">=</span> salt<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ident <span class="token operator">=</span> ident<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telephone <span class="token operator">=</span> telephone<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token class-name">String</span> ident<span class="token punctuation">,</span> <span class="token class-name">String</span> telephone<span class="token punctuation">,</span> <span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>salt <span class="token operator">=</span> salt<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ident <span class="token operator">=</span> ident<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telephone <span class="token operator">=</span> telephone<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> salt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSalt</span><span class="token punctuation">(</span><span class="token class-name">String</span> salt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>salt <span class="token operator">=</span> salt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getIdent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ident<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setIdent</span><span class="token punctuation">(</span><span class="token class-name">String</span> ident<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ident <span class="token operator">=</span> ident<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTelephone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> telephone<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTelephone</span><span class="token punctuation">(</span><span class="token class-name">String</span> telephone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>telephone <span class="token operator">=</span> telephone<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"User&#123;"</span> <span class="token operator">+</span>
                <span class="token string">"id="</span> <span class="token operator">+</span> id <span class="token operator">+</span>
                <span class="token string">", username='"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">", password='"</span> <span class="token operator">+</span> password <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">", salt='"</span> <span class="token operator">+</span> salt <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">", ident='"</span> <span class="token operator">+</span> ident <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">", telephone='"</span> <span class="token operator">+</span> telephone <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token string">", address='"</span> <span class="token operator">+</span> address <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'&#125;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体原型复制成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &lt;p>
 * 原型测试类
 * &lt;/p>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PrototypeTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> user<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj1==obj2?"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> user1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E7%BC%93%E5%AD%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E7%BC%93%E5%AD%98.html" itemprop="url">缓存</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="多级缓存架构"><a href="#多级缓存架构" class="headerlink" title="多级缓存架构"></a>多级缓存架构</h1><h2 id="什么是多级缓存架构"><a href="#什么是多级缓存架构" class="headerlink" title="什么是多级缓存架构"></a>什么是多级缓存架构</h2><p>多级缓存架构是一种缓存系统，它将缓存分为多个级别，每个级别都有其特定的作用和特点。这种架构的主要目的是提高缓存命中率和系统性能。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ol>
<li><strong>分布式缓存系统</strong>：在分布式系统中，多级缓存架构可以将缓存分配到不同的节点上，提高缓存的可用性和可扩展性。</li>
<li><strong>高性能计算</strong>：在高性能计算中，多级缓存架构可以将缓存分为不同的级别，例如 CPU 缓存、内存缓存和磁盘缓存，提高计算速度和性能。</li>
<li><strong>数据库缓存</strong>：在数据库缓存中，多级缓存架构可以将缓存分为不同的级别，例如一级缓存（内存）和二级缓存（磁盘），提高数据库查询速度和性能。</li>
</ol>
<h2 id="如何实现多级缓存架构"><a href="#如何实现多级缓存架构" class="headerlink" title="如何实现多级缓存架构"></a>如何实现多级缓存架构</h2><p>实现多级缓存架构需要考虑以下几个方面：</p>
<ol>
<li><strong>缓存分配</strong>：将缓存分配到不同的级别上，例如CPU缓存、内存缓存和磁盘缓存。</li>
<li><strong>缓存管理</strong>：管理缓存的生命周期，例如缓存的加载、更新和失效。</li>
<li><strong>缓存命中</strong>：实现缓存命中的机制，例如缓存的查找和替换。</li>
</ol>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>多级缓存架构的原理是将缓存分为不同的级别，每个级别都有其特定的作用和特点。例如：</p>
<ol>
<li><strong>CPU缓存</strong>：CPU 缓存是最快的缓存级别，用于存储常用的数据和指令。</li>
<li><strong>内存缓存</strong>：内存缓存是第二快的缓存级别，用于存储较大的数据和对象。</li>
<li><strong>磁盘缓存</strong>：磁盘缓存是最慢的缓存级别，用于存储大量的数据和文件。</li>
</ol>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p><strong>优点：</strong></p>
<ol>
<li>提高缓存的命中率。</li>
<li>在高性能计算和数据库缓存场景中，提高系统性能。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li><p>引入了多级缓存后，需要进行缓存管理和命中率高的缓存机制，增加了系统复杂性。</p>
</li>
<li><p>引入多级缓存后，需要更多的存储空间，本质上是空间换时间。</p>
</li>
</ol>
<h2 id="通用方案"><a href="#通用方案" class="headerlink" title="通用方案"></a>通用方案</h2><p>实际中不会使用cpu缓存，这是硬件缓存，一般常用的2级缓存的架构方案，一级缓存：本地缓存<code>guava</code>，二级缓存：分布式缓存<code>redis</code>。</p>
<h3 id="Guava-VS-Redis"><a href="#Guava-VS-Redis" class="headerlink" title="Guava VS Redis"></a>Guava VS Redis</h3><p><strong>1. Guava</strong></p>
<p>特点：</p>
<ul>
<li><p>内嵌缓存，数据存储在JVM中，适用于单机应用或者本地缓存。</p>
</li>
<li><p>数据存在JVM中，读取和写入时延低。</p>
</li>
</ul>
<p><strong>2. Redis</strong></p>
<p>特点：</p>
<ul>
<li>Redis是是一个独立的数据库，可以用作分布式缓存，适用于多个应用实例。</li>
<li>适用于分布式系统、多实例共享数据缓存、可以持久化的数据缓存。</li>
</ul>
<h3 id="为什么Redis稍慢"><a href="#为什么Redis稍慢" class="headerlink" title="为什么Redis稍慢"></a>为什么Redis稍慢</h3><p>Guava Cache存储在JVM内存中，所有操作都是本地内存访问，不涉及网络通信。Redis通常作为一个独立的服务运行，应用程序需要通过网络协议（如TCP）进行通信，增加了网络延迟。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>多级缓存架构，能在很多场景下显著提升性能。然而，这种架构也存在一些问题，需要通过特定的方法来解决。</p>
<h4 id="缓存一致性问题"><a href="#缓存一致性问题" class="headerlink" title="缓存一致性问题"></a>缓存一致性问题</h4><p>本地缓存和分布式缓存的数据可能不同步，导致缓存数据不一致。比如，当数据在分布式缓存中更新时，本地缓存可能仍然存储旧的数据。</p>
<p>解决方法：</p>
<ul>
<li><strong>缓存失效策略</strong>：在分布式缓存中更新数据时，立即使相关的本地缓存失效或删除。例如，通过发布&#x2F;订阅机制（如Redis的Pub&#x2F;Sub）通知所有应用实例清除或更新其本地缓存。</li>
<li><strong>缓存一致性协议</strong>：使用一致性协议（如基于Zookeeper的分布式一致性算法）来确保缓存一致性，但这种方式复杂度较高。</li>
</ul>
<h4 id="缓存雪崩问题"><a href="#缓存雪崩问题" class="headerlink" title="缓存雪崩问题"></a>缓存雪崩问题</h4><p>当缓存中的大量数据同时过期，或者缓存服务器宕机时，所有请求直接涌向数据库，可能导致数据库过载。</p>
<p>解决方法：</p>
<ul>
<li><p><strong>缓存预热</strong>：在缓存启动时预加载常用数据，避免大量请求直接打到数据库。</p>
</li>
<li><p><strong>分散过期时间</strong>：为不同的缓存键设置不同的过期时间，避免大量数据同时过期。</p>
</li>
<li><p><strong>降级策略</strong>：在缓存不可用时，采用降级方案，如返回默认值或部分数据。</p>
</li>
</ul>
<h4 id="缓存穿透问题"><a href="#缓存穿透问题" class="headerlink" title="缓存穿透问题"></a>缓存穿透问题</h4><p>恶意请求或查询结果不存在的数据直接打到数据库，绕过缓存，导致缓存失效。</p>
<p>解决方法：</p>
<ul>
<li><p><strong>缓存空结果</strong>：对于查询结果不存在的数据，也缓存一个空值，但要设置较短的过期时间。</p>
</li>
<li><p><strong>布隆过滤器</strong>：在缓存层之前引入布隆过滤器，快速判断请求的数据是否存在，从而减少对数据库的直接查询。</p>
</li>
</ul>
<h4 id="缓存击穿问题"><a href="#缓存击穿问题" class="headerlink" title="缓存击穿问题"></a>缓存击穿问题</h4><p>热点数据在缓存过期的一瞬间，大量请求同时打到数据库，导致数据库压力骤增。</p>
<p>解决方法：</p>
<ul>
<li><strong>互斥锁&#x2F;信号量</strong>：在缓存失效时，对同一个键的请求加锁，只有一个请求去加载数据，其余请求等待。</li>
<li><strong>预加载&#x2F;延迟更新</strong>：在缓存即将过期时，提前加载和更新缓存中的热点数据。</li>
</ul>
<h4 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h4><p>当缓存中的数据需要与数据库保持严格一致时，如何处理缓存与数据库的更新操作。</p>
<p>解决方法：</p>
<ul>
<li><strong>读写穿透</strong>：在更新数据库的同时更新缓存，确保缓存中的数据与数据库一致。</li>
<li><strong>异步更新</strong>：使用消息队列或事件驱动架构，在数据库更新后异步更新缓存。</li>
<li><strong>事务性缓存</strong>：使用分布式事务，确保数据库和缓存更新操作的原子性和一致性。</li>
</ul>
<h4 id="本地缓存过期问题"><a href="#本地缓存过期问题" class="headerlink" title="本地缓存过期问题"></a>本地缓存过期问题</h4><p>本地缓存没有及时更新，可能会存储旧数据。</p>
<p>解决方法：</p>
<ul>
<li><strong>定期刷新</strong>：定期刷新本地缓存，确保数据不过期。</li>
<li><strong>实时更新</strong>：通过事件驱动机制（如Kafka或Redis的Pub&#x2F;Sub），在分布式缓存更新时实时通知本地缓存进行更新。</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="示例应用架构"><a href="#示例应用架构" class="headerlink" title="示例应用架构"></a>示例应用架构</h3><ul>
<li><p><strong>本地缓存</strong>：Guava Cache，用于快速访问常用数据。</p>
</li>
<li><p><strong>分布式缓存</strong>：Redis，用于跨实例共享数据。</p>
</li>
<li><p><strong>数据库</strong>：用一个HashMap来模拟数据库。</p>
</li>
<li><p><strong>一致性维护</strong>：使用Redis的Pub&#x2F;Sub机制通知本地缓存失效。</p>
</li>
</ul>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>guava<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>guava<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">30.1</span><span class="token operator">-</span>jre<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="模拟数据库"><a href="#模拟数据库" class="headerlink" title="模拟数据库"></a>模拟数据库</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Database</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="缓存服务"><a href="#缓存服务" class="headerlink" title="缓存服务"></a>缓存服务</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheService</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> localCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Database</span> database <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisMessageListenerContainer</span> redisMessageListenerContainer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 初始化本地缓存</span>
        localCache <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置Redis的消息监听器，监听"cache:evict"频道</span>
        <span class="token class-name">MessageListenerAdapter</span> listenerAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageListenerAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"handleCacheEvict"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisMessageListenerContainer<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>listenerAdapter<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChannelTopic</span><span class="token punctuation">(</span><span class="token string">"cache:evict"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 尝试从本地缓存获取</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> localCache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 如果本地缓存有数据，但Redis缓存没有数据，将数据回填到Redis缓存</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"cache:"</span> <span class="token operator">+</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"cache:"</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 尝试从分布式缓存获取</span>
        value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"cache:"</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 将数据更新到本地缓存</span>
            localCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 最后从数据库获取</span>
        value <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            localCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"cache:"</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 更新数据库</span>
        database<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新缓存</span>
        localCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"cache:"</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通知其他实例的本地缓存失效</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"cache:evict"</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 处理缓存失效的通知</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleCacheEvict</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        localCache<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置Redis"><a href="#配置Redis" class="headerlink" title="配置Redis"></a>配置Redis</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheApplication</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CacheApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisMessageListenerContainer</span> <span class="token function">redisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RedisMessageListenerContainer</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        container<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> container<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="进行数据操作"><a href="#进行数据操作" class="headerlink" title="进行数据操作"></a>进行数据操作</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheRunner</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CacheService</span> cacheService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 设置值</span>
        cacheService<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"Value1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取值</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Get value for key 1: "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新值</span>
        cacheService<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"UpdatedValue1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 再次获取值，应该是更新后的值</span>
        value <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Get updated value for key 1: "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h4><p><strong>初始化本地缓存</strong>：</p>
<ul>
<li>使用Guava Cache构建一个本地缓存。</li>
<li><code>maximumSize</code>设置缓存最大条目数。</li>
<li><code>expireAfterWrite</code>设置缓存条目的过期时间。</li>
</ul>
<p><strong>消息监听器</strong>：</p>
<ul>
<li>使用Spring的<code>RedisMessageListenerContainer</code>监听Redis的Pub&#x2F;Sub频道<code>cache:evict</code>。</li>
<li>当有消息发布到<code>cache:evict</code>频道时，<code>handleCacheEvict</code>方法将被调用，失效本地缓存中的相应条目。</li>
</ul>
<p><strong>数据获取</strong>：</p>
<ul>
<li><code>getValue</code>方法首先尝试从本地缓存获取数据，如果本地缓存没有命中，再尝试从Redis缓存获取，如果redis命中了，做一个缓存回填，否则从数据库获取。</li>
<li>如果数据从数据库获取成功，会同时更新本地缓存和Redis缓存。</li>
</ul>
<p><strong>数据设置</strong>：</p>
<ul>
<li><code>setValue</code>方法更新模拟数据库的数据，同时更新本地缓存和Redis缓存。</li>
<li>通过<code>redisTemplate.convertAndSend</code>方法，将缓存失效通知发布到<code>cache:evict</code>频道，通知其他实例失效相应的本地缓存。</li>
</ul>
<p><strong>处理缓存失效通知</strong>：</p>
<ul>
<li><code>handleCacheEvict</code>方法负责处理从<code>cache:evict</code>频道接收到的消息，失效本地缓存中的相应条目。</li>
</ul>
<h1 id="缓存淘汰"><a href="#缓存淘汰" class="headerlink" title="缓存淘汰"></a>缓存淘汰</h1><h2 id="缓存替换策略有哪些"><a href="#缓存替换策略有哪些" class="headerlink" title="缓存替换策略有哪些"></a>缓存替换策略有哪些</h2><blockquote>
<p>缓存是常用的技术手段，它能够帮助我们更快地获取频繁使用的数据。不过当缓存满了以后，我们就需要选择某种策略来决定谁将从缓存中被优先移除。以下是一些常见的缓存替换策略及其实现。</p>
</blockquote>
<ol>
<li><strong>LRU (Least Recently Used)</strong></li>
</ol>
<p>LRU是最近最少使用的缓存策略，它以时间为依据，优先替换最长时间未访问的数据。这是基于这样一个理论：如果一个数据最近被访问过，那么它在未来被再次访问的可能性很高。我们可以通过维护一个所有缓存条目的链表来实现这个策略。当一个条目被访问时，我们将其移到链表的顶部。当需要逐出数据时，移除链表尾部的条目。</p>
<ol start="2">
<li><strong>MRU (Most Recently Used)</strong></li>
</ol>
<p>MRU是与LRU恰恰相反的策略，它优先替换最近访问的数据。MRU假设最近访问过的数据在未来最不可能被访问，这在很多场景都是合理的。其实现与LRU类似，但当条目被访问时，我们将其移到链表的底部，而非顶部。替换时，我们移除链表顶部的项。</p>
<ol start="3">
<li><strong>SLRU (Segmented LRU)</strong></li>
</ol>
<p>SLRU是LRU的进阶版，它将缓存分为两个部分：probation（试用）和protected（保护）。新来的数据先进入probation部分，如果再次被访问则会被推到protected部分。当需要替换数据时，首先替换probation部分的，如果probation部分为空，那么从protected部分挤出一部分数据。</p>
<ol start="4">
<li><strong>LFU (Least Frequently Used)</strong></li>
</ol>
<p>LFU策略会优先替换那些访问次数最少的数据。实现LFU需要我们追踪每个条目被访问的频率，这可以通过哈希表实现。每当条目被访问，其计数就增加，当缓存满时，只需将计数最小的条目移除即可。</p>
<ol start="5">
<li><strong>FIFO (First In, First Out)</strong></li>
</ol>
<p>FIFO的策略很简单：先进入缓存的数据首先被替换。实现FIFO可以通过队列实现，新的条目添加到队尾，替换时移除队首条目。</p>
<ol start="6">
<li><strong>TTL (Time To Live)</strong></li>
</ol>
<p>TTL是一个时间相关的策略。在TTL策略中，缓存条目有一个剩余生命期，当生命期到达就将其从缓存中移除。这就意味着所有的缓存条目都有一个过期时间。</p>
<ol start="7">
<li><strong>双层缓存</strong></li>
</ol>
<p>在某些情况下，我们可能需要两层缓存：一层是在CPU里面，另一层在内存中。CPU层的缓存很小但是非常快速，内存层的缓存则大很多但是速度慢一些。数据首先从CPU缓存中获取，如果没有再去内存缓存中获取。对于这种策略，我们可以为每层都使用适合的策略，比如LRU等。</p>
<ol start="8">
<li><strong>RR (Random Replacement)</strong></li>
</ol>
<p>RR是最简单的一种缓存替换策略，它随机选择一个条目进行替换。实现RR策略则只需要在所有的缓存条目中随机选一个移除即可。</p>
<h2 id="缓存替换策略实现算法"><a href="#缓存替换策略实现算法" class="headerlink" title="缓存替换策略实现算法"></a>缓存替换策略实现算法</h2><ol>
<li><p><strong>LRU (Least Recently Used)</strong></p>
<p>最简单的实现方式是使用一个队列和一个哈希表。队列用于保存元素的访问顺序，哈希表用于查找元素是否在队列中。每次使用某个元素时，将它添加到队列尾部或移动到队列尾部。当队列满时，队列头部的元素就是最长时间未被使用的元素，将其弹出。</p>
</li>
<li><p><strong>MRU (Most Recently Used)</strong></p>
<p>MRU的实现方式与LRU类似。区别是每次使用某个元素时，将它添加到队列头部或者移动到队列头部。当队列满时，移除队列尾部的元素。</p>
</li>
<li><p><strong>SLRU (Segmented LRU)</strong></p>
<p>SLRU具体实现可以借助两个队列：一个用于保护段（protected segment），一个用于试验段（probational segment）。新元素首先添加到试验段队列尾部。当元素再次被访问时，它被移到保护段队列尾部。如果试验段队列满，移除它的头部元素。如果保护段队列满，将头部元素移到试验段队列尾部。</p>
</li>
<li><p><strong>LFU (Least Frequently Used)</strong></p>
<p>LFU可以通过优先队列和哈希表来实现。哈希表用于查找元素，优先队列用于保存访问频率和元素的对应关系。每次访问元素，都会更新其在优先队列中的优先级。当需要替换元素时，移除优先队列顶部的元素。</p>
</li>
<li><p><strong>FIFO (First In, First Out)</strong></p>
<p>FIFO是最简单的策略，也是通过队列实现。新元素直接添加到队列尾部，需要替换时直接丢弃队列头部的元素。</p>
</li>
<li><p><strong>TTL (Time To Live)</strong></p>
<p>TTL可以通过每个元素添加一个时间戳来实现。每次访问队列时，检查队列头部的元素，如果它们的有效期已经过期，就将它们出队。</p>
</li>
<li><p><strong>双层缓存</strong></p>
<p>双层缓存的实现需要两个缓存，每个缓存都使用适当的替换策略，比如LRU或者FIFO。第一级缓存通常位于CPU中，非常小但速度很快。第二级缓存位于内存中，较大但速度较慢。</p>
</li>
<li><p><strong>RR (Random Replacement)</strong></p>
<p>RR可能是最简单的缓存替换策略，每次替换时，从缓存中随机选择一个元素丢弃。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E7%BD%91%E7%BB%9C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E7%BD%91%E7%BB%9C.html" itemprop="url">计算机网络</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a>OSI七层模型</h1><h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>通过物理媒介如光纤、电缆、无线传输比特流。</p>
<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><h4 id="Ethernet"><a href="#Ethernet" class="headerlink" title="Ethernet"></a>Ethernet</h4><p>提供了一种标准的物理连接方式，通常使用双绞线、光纤等介质将计算机和网络设备（如交换机、路由器）连接起来，从而加入到一个局域网（LAN）或广域网（WAN）中。</p>
<h4 id="Wi-Fi"><a href="#Wi-Fi" class="headerlink" title="Wi-Fi"></a>Wi-Fi</h4><p>提供无线连接和数据传输的能力，使设备可以通过无线方式连接到互联网或局域网，实现网络访问和数据交换。</p>
<h4 id="RS-232"><a href="#RS-232" class="headerlink" title="RS-232"></a>RS-232</h4><p>一种常用的串行通信接口标准，常被用于计算机和外部设备（如调制解调器、串口打印机、串口扫描仪等）之间进行数据传输。</p>
<h4 id="Bluetooth"><a href="#Bluetooth" class="headerlink" title="Bluetooth"></a>Bluetooth</h4><p>一种无线通信技术，通过无线方式将不同设备连接在一起，实现数据传输和通信。</p>
<h4 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h4><p>提供了一种通用的、高速、可靠的数据传输和设备连接方式，广泛应用于各类计算机和电子设备中。</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><h3 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h3><p>负责传输数据帧，提供对物理层传输错误的检测和纠正，控制发送端向接收端的传输数据帧的速率进行流量控制。</p>
<h3 id="协议-1"><a href="#协议-1" class="headerlink" title="协议"></a>协议</h3><h4 id="Ethernet-1"><a href="#Ethernet-1" class="headerlink" title="Ethernet"></a>Ethernet</h4><p>规定了计算机和网络设备之间的数据传输方式，如数据的编码和解码方法、数据帧的格式等，使得计算机可以通过有线网络连接，并能够在网络中传输数据。</p>
<h4 id="PPP"><a href="#PPP" class="headerlink" title="PPP"></a>PPP</h4><p>提供了一种点对点连接的通信机制，用于建立和管理点对点连接，并支持可靠的数据传输。</p>
<h4 id="ARP与RARP"><a href="#ARP与RARP" class="headerlink" title="ARP与RARP"></a>ARP与RARP</h4><ul>
<li><strong>ARP</strong>：将特定的IP地址解析为相应的MAC地址，以便在局域网中进行数据通信。通过广播ARP请求和相应的ARP响应来建立和维护IP地址和MAC地址之间的映射关系。</li>
<li><strong>RARP</strong>：将特定的MAC地址解析为相应的IP地址。通常需要搭建一个RARP服务器，在这个服务器上注册设备的MAC和IP，设备会请求RARP服务器返回IP地址。</li>
<li><strong>区别</strong>：ARP是已知IP地址求MAC地址，RARP是已知MAC地址求IP地址。</li>
</ul>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><h3 id="作用-2"><a href="#作用-2" class="headerlink" title="作用"></a>作用</h3><p>负责将数据包的传输，提供路由和转发功能。</p>
<h3 id="协议-2"><a href="#协议-2" class="headerlink" title="协议"></a>协议</h3><h4 id="IP协议"><a href="#IP协议" class="headerlink" title="IP协议"></a>IP协议</h4><p><strong>作用</strong>：通过IP地址进行主机标识与定位、实现数据包的路由和交换、支持网络间的通信以及提供灵活的寻址机制。</p>
<h5 id="IP基础"><a href="#IP基础" class="headerlink" title="IP基础"></a>IP基础</h5><ul>
<li><strong>IP与MAC的关系</strong>：IP用于网络间通信，MAC用于直连设备间通信。</li>
<li><strong>IP地址的定义</strong>：IP地址（IPv4）由32位正整数表示，计算机中用二进制处理，人们便于计算用十进制标记。</li>
<li><strong>IP地址的分类</strong>：IP地址由网络号+主机号组成，网络号定义范围，主机号定义个数，最大主机数为2的主机号的幂-2（255用于广播，0是网络地址）。</li>
<li><strong>无分类IP地址CIDR</strong>：32位IP地址分为网络号和主机号，格式为a.b.c.d&#x2F;x，x表示网络号位数（0~32）。</li>
<li><strong>公网IP与私网IP</strong>：A类、B类、C类都有部分私有IP地址。</li>
<li><strong>IP地址与路由控制</strong>：网络地址用于路由控制，路由表中的下一跳决定路径。</li>
<li><strong>IP分片和重组</strong>：链路的最大传输单元（MTU）决定分片，目标主机进行重组，TCP层引入MSS进行切片。</li>
</ul>
<h5 id="IPv6基本认识"><a href="#IPv6基本认识" class="headerlink" title="IPv6基本认识"></a>IPv6基本认识</h5><ul>
<li><strong>由来</strong>：IPv4地址（32位）已耗尽，IPv6地址（128位）提供更多地址。</li>
<li><strong>IPv6地址格式</strong>：128位地址，每16位一组，以冒号「:」隔开。</li>
<li>IPv4首部与IPv6首部的改进：<ul>
<li>取消选项字段：IPv6首部固定长度40字节，传输更快。</li>
<li>取消分片&#x2F;重组字段：分片与重组仅在源与目标主机进行，提高路由器转发速度。</li>
<li>取消首部校验和字段：数据链路层和传输层校验，IPv6取消IP校验。</li>
</ul>
</li>
</ul>
<h4 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h4><p>NAT（网络地址转换）用于将私网地址转换为公网地址，因IPv4地址资源短缺而产生。NAPT（网络地址与端口转换）是NAT的扩展，不仅转换私网地址，还转换私网端口号为公网端口号。其缺点包括外部无法主动与NAT内部服务器建立连接、转换表生成带来性能开销以及NAT路由器重启时所有TCP连接被重置。解决方案包括使用IPv6和采用NAT穿透技术。</p>
<h4 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h4><p>ICMP（互联网控制消息协议，Internet Control Message Protocol）主要用于报告错误和进行网络诊断。其报文类型分为查询报文和差错报文。查询报文用于诊断，包括回送请求（类型8）和回送应答（类型0）。差错报文用于通知错误原因，包括目标不可达（类型3）、重定向或改变路由（类型5）和超时（类型11）。</p>
<h4 id="OSPF"><a href="#OSPF" class="headerlink" title="OSPF"></a>OSPF</h4><p>OSPF协议用于在自治系统内部实现动态路由选择和路径计算。它通过计算最短路径、动态路由更新、负载均衡和管理网络拓扑等功能，提供了高效、可靠和灵活的路由方案。</p>
<h4 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h4><p>BGP协议使得不同自治系统之间能够交换路由信息，并根据应用策略和属性选择最佳路径。通过提供路由策略、容错性和弹性等功能，BGP协议实现了互联网中的自治系统之间的高效、灵活和可靠的路由选择。</p>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><h3 id="作用-3"><a href="#作用-3" class="headerlink" title="作用"></a>作用</h3><p>在源节点和目标节点之间建立端到端的通信连接。</p>
<h3 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h3><p><strong>作用</strong>：TCP通过可靠的数据传输、流量控制、拥塞控制、连接管理和数据分割组装等机制，确保数据的安全、完整和可靠传输，并提供了端到端的通信能力。</p>
<h4 id="TCP基本概念"><a href="#TCP基本概念" class="headerlink" title="TCP基本概念"></a>TCP基本概念</h4><ul>
<li>TCP头部格式：<ul>
<li><strong>序列号</strong>：用于解决网络包乱序的问题，通过SYN数据包发送，每次发送在上一次发送基础上+1。</li>
<li><strong>确认应答号</strong>：用于解决丢包问题，服务端发送确认应答号，客户端收到后确认之前的数据包已正常接收。</li>
<li><strong>控制位</strong>：包括ACK（确认应答有效）、RST（强制断开连接）、SYN（建立连接）、FIN（断开连接）。</li>
</ul>
</li>
<li><strong>TCP协议的必要性</strong>：IP层发送数据包不可靠，TCP工作在传输层，确保接收端接收的网络包是完整的、有序的。</li>
<li><strong>TCP连接</strong>：用于保证可靠性和流量控制的状态信息，包括Socket、序列号和窗口大小。TCP连接由四元组（源地址、源端口、目的地址、目的端口）唯一确定。</li>
<li><strong>TCP连接建立</strong>：通过三次握手建立连接，确保可靠传输序列号。三次握手比两次握手更可靠，比四次握手更高效。</li>
<li><strong>TCP分片传输</strong>：通过MTU和MSS进行数据包切片和重组，避免IP层分片带来的问题。</li>
<li><strong>SYN攻击</strong>：通过伪造大量虚假IP发送SYN请求，占满服务端半连接队列，导致请求被丢弃。可通过增大队列容量、开启tcp_syncookies等方式防御。</li>
</ul>
<h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><p>TCP三次握手是TCP协议在建立连接时使用的过程，用于确保双方都能正常通信并同步初始序列号。</p>
<pre class="line-numbers language-none"><code class="language-none">客户端（Client）                               服务端（Server）
(seq&#x3D;x)                                          (seq&#x3D;y)
    |                                               |
    |  -----------SYN, seq&#x3D;x------------&gt;           |  (第一次握手)
    |                                               |
    |  &lt;------SYN-ACK, seq&#x3D;y, ack&#x3D;x+1-------        |  (第二次握手)
    |                                               |
    |  -----------ACK, ack&#x3D;y+1------------&gt;         |  (第三次握手)
    |                                               |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>详细过程</strong></p>
<ol>
<li><strong>第一次握手（SYN, seq&#x3D;x）</strong>：<ul>
<li><strong>客户端</strong>：发送一个SYN报文段，序列号为x，表示希望建立连接。</li>
<li><strong>服务端</strong>：接收到SYN报文段后，进入SYN-RECEIVED状态。</li>
</ul>
</li>
<li><strong>第二次握手（SYN-ACK, seq&#x3D;y, ack&#x3D;x+1）</strong>：<ul>
<li><strong>服务端</strong>：发送一个SYN-ACK报文段，包含自己的初始序列号y和确认序列号x+1，表示确认收到客户端的SYN报文段。</li>
<li><strong>客户端</strong>：接收到SYN-ACK报文段后，进入ESTABLISHED状态。</li>
</ul>
</li>
<li><strong>第三次握手（ACK, ack&#x3D;y+1）</strong>：<ul>
<li><strong>客户端</strong>：发送一个ACK报文段，确认序列号为y+1，表示确认收到服务端的SYN-ACK报文段。</li>
<li><strong>服务端</strong>：接收到ACK报文段后，进入ESTABLISHED状态，连接建立完成。</li>
</ul>
</li>
</ol>
<h4 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h4><p>TCP四次挥手是TCP连接终止的过程，用于确保双方都能正常关闭连接。</p>
<pre class="line-numbers language-none"><code class="language-none">客户端（Client）                               服务端（Server）
(seq&#x3D;x)                                          (seq&#x3D;y)
    |                                               |
    |  -----------FIN, seq&#x3D;x------------&gt;           |  (第一次挥手)
    |                                               |
    |  &lt;----------ACK, ack&#x3D;x+1-----------           |  (第二次挥手)
    |                                               |
    |  &lt;-----------FIN, seq&#x3D;y------------           |  (第三次挥手)
    |                                               |
    |  -----------ACK, ack&#x3D;y+1------------&gt;         |  (第四次挥手)
    |                                               |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>详细过程：</strong></p>
<ol>
<li><strong>第一次挥手（FIN, seq&#x3D;x）</strong>：<ul>
<li><strong>客户端</strong>：发送一个FIN报文段，序列号为x，表示希望关闭连接，进入FIN-WAIT-1状态。</li>
<li><strong>服务端</strong>：接收到FIN报文段后，进入CLOSE-WAIT状态。</li>
</ul>
</li>
<li><strong>第二次挥手（ACK, ack&#x3D;x+1）</strong>：<ul>
<li><strong>服务端</strong>：发送一个ACK报文段，确认号为x+1，确认收到客户端的FIN报文段。</li>
<li><strong>客户端</strong>：接收到ACK报文段后，进入FIN-WAIT-2状态。</li>
</ul>
</li>
<li><strong>第三次挥手（FIN, seq&#x3D;y）</strong>：<ul>
<li><strong>服务端</strong>：在准备好关闭连接后，发送一个FIN报文段，序列号为y，表示希望关闭连接。</li>
<li><strong>客户端</strong>：接收到FIN报文段后，进入TIME-WAIT状态。</li>
</ul>
</li>
<li><strong>第四次挥手（ACK, ack&#x3D;y+1）</strong>：<ul>
<li><strong>客户端</strong>：发送一个ACK报文段，确认号为y+1，确认收到服务端的FIN报文段。</li>
<li><strong>服务端</strong>：接收到ACK报文段后，进入CLOSED状态，连接关闭完成。</li>
<li><strong>客户端</strong>：在TIME-WAIT状态等待一段时间（通常是2倍的最大报文段寿命，2MSL），然后进入CLOSED状态，连接关闭完成。</li>
</ul>
</li>
</ol>
<h4 id="TCP重传机制"><a href="#TCP重传机制" class="headerlink" title="TCP重传机制"></a>TCP重传机制</h4><p>TCP的重传机制用于确保数据包在传输过程中不会丢失。</p>
<ol>
<li><strong>超时重传（Timeout Retransmission）</strong>：<ul>
<li>每次发送数据包时，TCP会启动一个定时器。如果在定时器超时之前没有收到相应的确认（ACK）报文段，TCP会认为该数据包丢失，并重新发送该数据包。</li>
<li>超时时间（RTO, Retransmission Timeout）是动态计算的，通常基于往返时间（RTT, Round-Trip Time）的估计。</li>
</ul>
</li>
<li><strong>快速重传（Fast Retransmit）</strong>：<ul>
<li>当接收方收到一个乱序的数据包时，会立即发送一个重复的ACK报文段，告知发送方期望的下一个字节序号。</li>
<li>如果发送方连续收到三个重复的ACK报文段（即四个相同的ACK），会立即重传相应的数据包，而不必等待超时。</li>
</ul>
</li>
</ol>
<h4 id="TCP流量控制机制"><a href="#TCP流量控制机制" class="headerlink" title="TCP流量控制机制"></a>TCP流量控制机制</h4><p>TCP的流量控制机制用于防止发送方发送的数据超过接收方的处理能力。</p>
<ol>
<li><strong>滑动窗口（Sliding Window）</strong>：<ul>
<li>TCP使用滑动窗口机制来控制数据流量。滑动窗口的大小由接收方通过ACK报文段中的窗口大小字段（Window Size）来告知发送方。</li>
<li>发送方根据接收方的窗口大小来决定可以发送的数据量。如果窗口大小为0，发送方会停止发送数据，直到接收到一个非零的窗口大小。</li>
</ul>
</li>
<li><strong>拥塞控制（Congestion Control）</strong>：<ul>
<li>拥塞控制是为了防止网络拥塞而设计的机制，主要包括以下四个算法：<ul>
<li><strong>慢启动（Slow Start）</strong>：发送方在开始发送数据时，先将拥塞窗口（cwnd）设置为一个较小的值（通常为1个MSS，最大报文段大小），然后逐步增加发送速率。</li>
<li><strong>拥塞避免（Congestion Avoidance）</strong>：当拥塞窗口达到一个阈值（ssthresh）后，进入拥塞避免阶段，每次成功发送一个窗口的数据后，将拥塞窗口增加一个MSS。</li>
<li><strong>快速重传（Fast Retransmit）</strong>：如前所述，当发送方收到三个重复的ACK时，立即重传相应的数据包。</li>
<li><strong>快速恢复（Fast Recovery）</strong>：在快速重传后，不进入慢启动，而是将拥塞窗口设置为ssthresh的一半，然后进入拥塞避免阶段。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="UDP协议"><a href="#UDP协议" class="headerlink" title="UDP协议"></a>UDP协议</h3><p><strong>作用</strong>：UDP提供快速、无连接的传输，适用于实时音视频通信、游戏、传感器网络等延迟应用。</p>
<h4 id="UDP头部格式"><a href="#UDP头部格式" class="headerlink" title="UDP头部格式"></a>UDP头部格式</h4><ul>
<li><strong>目标和源端口</strong>：用于告诉UDP协议应该把报文发给哪个进程。</li>
<li><strong>包长度</strong>：保存了UDP首部的长度和数据的长度之和。</li>
<li><strong>校验和</strong>：提供可靠的UDP首部和数据，防止在网络传输中受损的UDP包。</li>
</ul>
<h4 id="TCP和UDP的区别"><a href="#TCP和UDP的区别" class="headerlink" title="TCP和UDP的区别"></a>TCP和UDP的区别</h4><ol>
<li>连接：<ul>
<li>TCP是面向连接的传输层协议，传输数据前需要建立连接。</li>
<li>UDP不需要连接，即刻传输数据。</li>
</ul>
</li>
<li>服务对象：<ul>
<li>TCP是一对一的两点服务，即一条连接只有两个端点。</li>
<li>UDP支持一对一、一对多、多对多的交互通信。</li>
</ul>
</li>
<li>可靠性：<ul>
<li>TCP是可靠交付数据的，数据可以无差错、不丢失、不重复、按序到达。</li>
<li>UDP尽最大努力交付，不保证可靠交付数据。</li>
</ul>
</li>
<li>拥塞控制和流量控制：<ul>
<li>TCP有拥塞控制和流量控制机制，保证数据传输的安全性。</li>
<li>UDP没有拥塞控制和流量控制机制，即使网络非常拥堵，也不会影响UDP的发送速率。</li>
</ul>
</li>
<li>首部开销：<ul>
<li>TCP首部长度较长，首部在没有使用「选项」字段时是20个字节，如果使用了「选项」字段则会变长。</li>
<li>UDP首部只有8个字节，并且是固定不变的，开销较小。</li>
</ul>
</li>
<li>传输方式：<ul>
<li>TCP是流式传输，没有边界，但保证顺序和可靠。</li>
<li>UDP是一个包一个包的发送，有边界，但可能会丢包和乱序。</li>
</ul>
</li>
<li>分片不同：<ul>
<li>TCP的数据大小如果大于MSS大小，会在传输层进行分片，目标主机收到后也在传输层组装TCP数据包，如果中途丢失了一个分片，只需要重传丢失的分片。</li>
<li>UDP的数据大小如果大于MTU大小，会在IP层进行分片，目标主机收到后在IP层组装完数据，再传给传输层。</li>
</ul>
</li>
<li>应用场景：<ul>
<li>TCP适用于需要高可靠性的数据传输，如网页浏览、文件传输、电子邮件等。</li>
<li>UDP适用于对实时性要求高但对可靠性要求低的应用，如视频流、音频流、在线游戏等。</li>
</ul>
</li>
</ol>
<h3 id="TCP和UDP可以使用同一个端口吗"><a href="#TCP和UDP可以使用同一个端口吗" class="headerlink" title="TCP和UDP可以使用同一个端口吗"></a>TCP和UDP可以使用同一个端口吗</h3><p>可以，当主机收到数据包后，可以在IP包头的「协议号」字段知道该数据包是TCP&#x2F;UDP，所以可以根据这个信息确定送给哪个模块（TCP&#x2F;UDP）处理，送给TCP&#x2F;UDP模块的报文根据「端口号」确定送给哪个应用程序处理。</p>
<h2 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h2><h3 id="作用-4"><a href="#作用-4" class="headerlink" title="作用"></a>作用</h3><p>负责建立、管理和终止会话（会话是指两个应用程序之间的通信过程），提供了会话管理和同步功能。</p>
<h3 id="协议-3"><a href="#协议-3" class="headerlink" title="协议"></a>协议</h3><h4 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h4><p>一种安全的远程登录和文件传输协议，它提供了数据加密、身份验证和安全传输的功能。通过SSH协议，用户可以远程登录到远程计算机或服务器上，并进行命令执行、文件传输和远程管理等操作，保证了远程操作过程中的安全性和可靠性。</p>
<h4 id="SIP"><a href="#SIP" class="headerlink" title="SIP"></a>SIP</h4><p>一种用于建立、修改和终止多媒体会话的通信协议。它提供多媒体会话的管理和控制功能，支持注册、定位、会话协商、呼叫控制和路由等功能，使得用户可以通过多种终端进行实时的多媒体通信。</p>
<h4 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h4><p>允许用户通过网络远程访问和控制远程计算机的桌面环境。它提供了远程控制、远程支持、虚拟化和远程桌面服务、数据安全和跨平台支持的功能。</p>
<h2 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h2><h3 id="作用-5"><a href="#作用-5" class="headerlink" title="作用"></a>作用</h3><p>负责数据的表示、编码和加密，确保数据能够在不同系统之间正确解释和理解。</p>
<h3 id="协议-4"><a href="#协议-4" class="headerlink" title="协议"></a>协议</h3><h4 id="JPEG"><a href="#JPEG" class="headerlink" title="JPEG"></a>JPEG</h4><p>提供了图像压缩、多媒体应用、压缩质量调节、颜色空间支持和逐行扫描等功能。</p>
<h4 id="MPEG"><a href="#MPEG" class="headerlink" title="MPEG"></a>MPEG</h4><p>主要应用于视频和音频的压缩、传输和存储。它提供了视频压缩、视频传输和存储、视频流媒体和互联网传输以及音频压缩和编码的功能。</p>
<h4 id="SSL-x2F-TLS"><a href="#SSL-x2F-TLS" class="headerlink" title="SSL&#x2F;TLS"></a>SSL&#x2F;TLS</h4><p>提供了数据传输加密、身份验证、服务器安全、统一资源定位和加密套件协商等功能。</p>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><h3 id="作用-6"><a href="#作用-6" class="headerlink" title="作用"></a>作用</h3><p>负责提供各种网络服务和应用，如电子邮件、文件传输、远程登录和网页浏览等。</p>
<h3 id="协议-5"><a href="#协议-5" class="headerlink" title="协议"></a>协议</h3><h4 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h4><p><strong>基本概念</strong>：</p>
<ul>
<li><strong>HTTP</strong>：超文本传输协议。</li>
<li>常见状态码：<ul>
<li><strong>1xx</strong>：协议的中间状态，较少见。</li>
<li><strong>2xx</strong>：成功响应，如200（成功）、204（无内容）、206（部分内容）。</li>
<li><strong>3xx</strong>：重定向，如301（永久重定向）、302（临时重定向）、304（未修改）。</li>
<li><strong>4xx</strong>：客户端错误，如400（请求错误）、403（禁止访问）、404（未找到）。</li>
<li><strong>5xx</strong>：服务器错误，如500（服务器错误）、501（未实现）、502（网关错误）、503（服务不可用）。</li>
</ul>
</li>
<li>常见字段：<ul>
<li><strong>客户端</strong>：Host（域名）、Connection（保持长连接）、Accept-Encoding（接收的压缩格式）、Accept（接收的数据格式）。</li>
<li><strong>服务端</strong>：Content-Length（数据长度）、Content-Type（数据格式）、Content-Encoding（压缩格式）。</li>
</ul>
</li>
</ul>
<p><strong>GET与POST</strong>：</p>
<ul>
<li><strong>区别</strong>：GET用于查询数据，POST用于修改和写入数据；GET请求较快，POST请求数据量更大。</li>
<li><strong>安全性和幂等性</strong>：GET是安全和幂等的，POST不是。</li>
</ul>
<p><strong>HTTP特性</strong>：</p>
<ul>
<li><strong>HTTP&#x2F;1.1优点</strong>：简单、灵活易扩展、应用广泛和跨平台。</li>
<li><strong>HTTP&#x2F;1.1缺点</strong>：无状态、明文传输。</li>
<li><strong>性能</strong>：基于TCP&#x2F;IP，使用长连接和管道网络传输，但存在队头阻塞问题。</li>
</ul>
<p><strong>HTTP缓存技术</strong>：</p>
<ul>
<li>强制缓存：浏览器判断缓存是否过期，直接从本地获取资源。<ul>
<li><strong>实现方式</strong>：Cache-Control、Expires。</li>
</ul>
</li>
<li>协商缓存：服务端告知客户端是否可以使用缓存。<ul>
<li><strong>实现方式</strong>：If-Modified-Since和Last-Modified（基于时间）、If-None-Match和ETag（基于唯一标识）。</li>
</ul>
</li>
</ul>
<p><strong>HTTP与HTTPS</strong>：</p>
<ul>
<li><strong>区别</strong>：HTTPS在TCP和HTTP之间增加了SSL&#x2F;TLS协议，进行加密传输，默认端口为443。</li>
<li><strong>解决问题</strong>：HTTPS解决了HTTP的窃听、篡改和冒充问题，通过信息加密、校验机制和数字证书保证安全。</li>
<li><strong>建立连接</strong>：通过SSL&#x2F;TLS协议握手，协商加密算法和生成对称密钥。</li>
</ul>
<p><strong>HTTP的演变</strong>：</p>
<ul>
<li><strong>HTTP&#x2F;1.1改进</strong>：使用长连接和管道网络传输。</li>
<li><strong>HTTP&#x2F;2优化</strong>：头部压缩、二进制格式、并发传输、服务器推送。</li>
<li><strong>HTTP&#x2F;3优化</strong>：解决HTTP&#x2F;2队头阻塞问题，基于UDP的QUIC协议实现可靠传输。</li>
</ul>
<h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><p>HTTPS（HyperText Transfer Protocol Secure）是HTTP的安全版本，通过SSL&#x2F;TLS（安全套接字层&#x2F;传输层安全协议）来加密数据传输，确保数据在客户端和服务器之间传输时的安全性。</p>
<pre class="line-numbers language-none"><code class="language-none">客户端（Client）                               		服务器（Server）
    |                                                    |
    |  ---1. 发起HTTPS请求（ClientHello）---&gt;              |
    |                                                    |
    |  &lt;------2. 发送证书（ServerHello）-------            |
    |                                                    |
    |  ---3. 验证证书并生成对称密钥（ClientKeyExchange）---&gt; |
    |                                                    |
    |  &lt;-----------4. 解密对称密钥----------------         |
    |                                                    |
    |  ---5. 建立加密通道（Finished）---------&gt;             |
    |                                                    |
    |  &lt;-----------加密数据传输---------------------       |
    |                                                    |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>客户端发起HTTPS请求</li>
</ol>
<p>客户端（通常是浏览器）向服务器发起HTTPS请求。这个请求类似于HTTP请求，但使用的是HTTPS协议。</p>
<ol start="2">
<li>服务器发送证书</li>
</ol>
<p>服务器收到HTTPS请求后，会发送一个包含公钥的数字证书给客户端。这个证书由受信任的证书颁发机构（CA）签发，包含服务器的公钥、服务器的域名、证书的有效期等信息。</p>
<ol start="3">
<li>客户端验证证书</li>
</ol>
<p>客户端收到服务器的证书后，会验证证书的有效性。验证过程包括：</p>
<ul>
<li>检查证书是否由受信任的CA签发。</li>
<li>检查证书是否在有效期内。</li>
<li>检查证书中的域名是否与服务器的域名匹配。</li>
</ul>
<p>如果证书验证失败，客户端会显示警告信息，提示用户连接不安全。如果验证成功，客户端会生成一个随机的对称密钥。</p>
<ol start="4">
<li>生成会话密钥</li>
</ol>
<p>客户端使用服务器的公钥加密生成的对称密钥，并将加密后的对称密钥发送给服务器。由于只有服务器拥有对应的私钥，只有服务器能够解密这个对称密钥。</p>
<ol start="5">
<li>建立加密通道</li>
</ol>
<p>服务器使用私钥解密出客户端发送的对称密钥。此时，客户端和服务器都拥有了相同的对称密钥。接下来，客户端和服务器使用这个对称密钥进行加密通信。</p>
<ol start="6">
<li>加密数据传输</li>
</ol>
<p>客户端和服务器之间的所有数据传输都使用对称密钥进行加密和解密，确保数据在传输过程中不会被窃取或篡改。</p>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p><strong>功能</strong>：域名解析、IP地址转换、负载均衡、高可用性和故障恢复、域名管理。</p>
<p><strong>解析流程</strong>：</p>
<ol>
<li>浏览器寻找本地缓存。</li>
<li>本地操作系统的DNS解析器。</li>
<li>根域寻找顶级域名。</li>
<li>顶级根域寻找权威域名。</li>
<li>权威域名返回该域名的IP。</li>
<li>本地操作系统缓存IP并返回给浏览器。</li>
<li>浏览器与目标服务器建立连接，渲染响应。</li>
</ol>
<h4 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h4><p><strong>功能</strong>：文件传输、文件访问和管理、目录操作、匿名访问、安全传输、虚拟主机和共享服务器。</p>
<h4 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h4><p><strong>功能</strong>：IP地址分配、网络配置、IP地址管理、简化网络管理、提供灵活性和可移植性。</p>
<p><strong>端口号</strong>：客户端68，服务端67。</p>
<p><strong>通信方式</strong>：UDP广播通信。</p>
<p><strong>协商流程</strong>：</p>
<ol>
<li><strong>DHCP DISCOVER</strong>：客户端发送UDP广播找到DHCP服务器。</li>
<li><strong>DHCP OFFER</strong>：服务器提供可租约的IP地址、子网掩码、默认网关、DNS服务器和IP地址租用期。</li>
<li><strong>DHCP REQUEST</strong>：客户端选择一个服务器并发送请求报文响应。</li>
<li><strong>DHCP ACK</strong>：服务器应答请求报文，确认参数。</li>
</ol>
<h4 id="IMAP"><a href="#IMAP" class="headerlink" title="IMAP"></a>IMAP</h4><p><strong>功能</strong>：邮件存储和管理、邮件同步、分段和增量下载、搜索和过滤、支持多客户端访问。</p>
<h4 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h4><p><strong>功能</strong>：邮件传输、邮件路由、邮件队列管理、邮件身份验证、错误处理和通知。</p>
<h1 id="TCP-x2F-IP-四层模型"><a href="#TCP-x2F-IP-四层模型" class="headerlink" title="TCP&#x2F;IP 四层模型"></a>TCP&#x2F;IP 四层模型</h1><h2 id="网络接口层"><a href="#网络接口层" class="headerlink" title="网络接口层"></a>网络接口层</h2><h3 id="作用-7"><a href="#作用-7" class="headerlink" title="作用"></a>作用</h3><p>负责处理与物理网络接口相关的所有功能，包括数据帧的发送和接收、物理地址的解析和硬件驱动程序的管理。</p>
<h3 id="协议-6"><a href="#协议-6" class="headerlink" title="协议"></a>协议</h3><ul>
<li><strong>Ethernet</strong>：用于局域网中的数据帧传输。</li>
<li><strong>PPP</strong>：用于点对点连接。</li>
<li><strong>ARP</strong>：用于将IP地址解析为MAC地址。</li>
</ul>
<h2 id="网络层-1"><a href="#网络层-1" class="headerlink" title="网络层"></a>网络层</h2><h3 id="作用-8"><a href="#作用-8" class="headerlink" title="作用"></a>作用</h3><p>负责数据包的传输和路由选择，确保数据包能够从源地址到达目的地址。</p>
<h3 id="协议-7"><a href="#协议-7" class="headerlink" title="协议"></a>协议</h3><ul>
<li><strong>IP</strong>：提供不可靠的、无连接的数据包传输服务。</li>
<li><strong>ICMP</strong>：用于报告错误和进行网络诊断。</li>
<li><strong>OSPF</strong>：用于自治系统内部的路由选择。</li>
<li><strong>BGP</strong>：用于自治系统之间的路由选择。</li>
</ul>
<h2 id="传输层-1"><a href="#传输层-1" class="headerlink" title="传输层"></a>传输层</h2><h3 id="作用-9"><a href="#作用-9" class="headerlink" title="作用"></a>作用</h3><p>提供端到端的通信服务，确保数据的可靠传输和正确排序。</p>
<h3 id="协议-8"><a href="#协议-8" class="headerlink" title="协议"></a>协议</h3><ul>
<li><strong>TCP</strong>：提供可靠的、面向连接的传输服务。</li>
<li><strong>UDP</strong>：提供不可靠的、无连接的传输服务。</li>
</ul>
<h2 id="应用层-1"><a href="#应用层-1" class="headerlink" title="应用层"></a>应用层</h2><h3 id="作用-10"><a href="#作用-10" class="headerlink" title="作用"></a>作用</h3><p>提供各种网络服务和应用，如电子邮件、文件传输、远程登录和网页浏览等。</p>
<h3 id="协议-9"><a href="#协议-9" class="headerlink" title="协议"></a>协议</h3><ul>
<li><strong>HTTP</strong>：用于网页浏览。</li>
<li><strong>DNS</strong>：用于域名解析。</li>
<li><strong>FTP</strong>：用于文件传输。</li>
<li><strong>DHCP</strong>：用于动态分配IP地址。</li>
<li><strong>IMAP</strong>：用于邮件存储和管理。</li>
<li><strong>SMTP</strong>：用于邮件传输。</li>
</ul>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="键入网址到网页显示发生了什么"><a href="#键入网址到网页显示发生了什么" class="headerlink" title="键入网址到网页显示发生了什么"></a>键入网址到网页显示发生了什么</h2><ol>
<li>DNS解析：<ul>
<li>浏览器检查缓存，查找域名对应的IP地址。</li>
<li>如果缓存中没有，操作系统的DNS解析器会向DNS服务器查询。</li>
<li>DNS服务器返回IP地址。</li>
</ul>
</li>
<li>TCP连接：<ul>
<li>浏览器与服务器通过三次握手建立TCP连接。</li>
</ul>
</li>
<li>发送HTTP请求：<ul>
<li>浏览器向服务器发送HTTP请求报文，包括请求行、请求头和请求体。</li>
</ul>
</li>
<li>服务器处理请求：<ul>
<li>服务器接收到请求后，处理请求并生成响应报文。</li>
</ul>
</li>
<li>返回HTTP响应：<ul>
<li>服务器将响应报文通过TCP连接返回给浏览器，包括状态行、响应头和响应体。</li>
</ul>
</li>
<li>渲染网页：<ul>
<li>浏览器接收到响应报文后，解析HTML、CSS和JavaScript，渲染网页。</li>
</ul>
</li>
<li>关闭连接：<ul>
<li>浏览器与服务器通过四次挥手断开TCP连接。</li>
</ul>
</li>
</ol>
<h2 id="Cookie和Session"><a href="#Cookie和Session" class="headerlink" title="Cookie和Session"></a>Cookie和Session</h2><p><strong>Cookie</strong>：</p>
<ul>
<li><strong>定义</strong>：存储在客户端的小数据文件，用于在客户端和服务器之间传递信息。</li>
<li>特点：<ul>
<li>存储在客户端（浏览器）。</li>
<li>每次请求都会自动发送到服务器。</li>
<li>可以设置过期时间。</li>
<li>安全性较低，容易被篡改。</li>
</ul>
</li>
<li>用途：<ul>
<li>记录用户登录状态。</li>
<li>存储用户偏好设置。</li>
<li>跟踪用户行为。</li>
</ul>
</li>
</ul>
<p><strong>Session</strong>：</p>
<ul>
<li><strong>定义</strong>：存储在服务器端的会话数据，用于跟踪用户的会话状态。</li>
<li>特点：<ul>
<li>存储在服务器端。</li>
<li>通过Session ID在客户端和服务器之间传递。</li>
<li>通常在用户关闭浏览器或会话超时时失效。</li>
<li>安全性较高，不容易被篡改。</li>
</ul>
</li>
<li>用途：<ul>
<li>记录用户登录状态。</li>
<li>存储用户临时数据。</li>
<li>跟踪用户会话。</li>
</ul>
</li>
</ul>
<h2 id="进制之间的转换"><a href="#进制之间的转换" class="headerlink" title="进制之间的转换"></a>进制之间的转换</h2><p><strong>二进制（Binary）</strong>：以2为基数，使用0和1表示。</p>
<p><strong>八进制（Octal）</strong>：以8为基数，使用0-7表示。</p>
<p><strong>十进制（Decimal）</strong>：以10为基数，使用0-9表示。</p>
<p><strong>十六进制（Hexadecimal）</strong>：以16为基数，使用0-9和A-F表示。</p>
<p><strong>转换方法</strong>：</p>
<ol>
<li><p>二进制转十进制：</p>
<ul>
<li>从右到左，每位乘以2的对应次幂，然后求和。</li>
<li>例子：1011（二进制） &#x3D; 1 * 2^3 + 0 * 2^2 + 1 * 2^1 + 1 * 2^0 &#x3D; 11（十进制）。</li>
</ul>
</li>
<li><p>十进制转二进制：</p>
<ul>
<li>除以2，记录余数，直到商为0，逆序排列余数。</li>
<li>例子：11（十进制） &#x3D; 1011（二进制）。</li>
</ul>
</li>
<li><p>二进制转八进制：</p>
<ul>
<li>每三位二进制数转换为一位八进制数。</li>
<li>例子：1011（二进制） &#x3D; 001 011 &#x3D; 13（八进制）。</li>
</ul>
</li>
<li><p>八进制转二进制：</p>
<ul>
<li>每位八进制数转换为三位二进制数。</li>
<li>例子：13（八进制） &#x3D; 001 011 &#x3D; 1011（二进制）。</li>
</ul>
</li>
<li><p>二进制转十六进制：</p>
<ul>
<li>每四位二进制数转换为一位十六进制数。</li>
<li>例子：1011（二进制） &#x3D; 0001 0110 &#x3D; 16（十六进制）。</li>
</ul>
</li>
<li><p>十六进制转二进制：</p>
<ul>
<li>每位十六进制数转换为四位二进制数。</li>
<li>例子：16（十六进制） &#x3D; 0001 0110 &#x3D; 1011（二进制）。</li>
</ul>
</li>
<li><p>十进制转八进制：</p>
<ul>
<li>除以8，记录余数，直到商为0，逆序排列余数。</li>
<li>例子：11（十进制） &#x3D; 13（八进制）。</li>
</ul>
</li>
<li><p>八进制转十进制：</p>
<ul>
<li>从右到左，每位乘以8的对应次幂，然后求和。</li>
<li>例子：13（八进制） &#x3D; 1<em>8^1 + 3</em>8^0 &#x3D; 11（十进制）。</li>
</ul>
</li>
<li><p>十进制转十六进制：</p>
<ul>
<li>除以16，记录余数，直到商为0，逆序排列余数。</li>
<li>例子：11（十进制） &#x3D; B（十六进制）。</li>
</ul>
</li>
<li><p>十六进制转十进制：</p>
<ul>
<li>从右到左，每位乘以16的对应次幂，然后求和。</li>
<li>例子：B（十六进制） &#x3D; 11（十进制）。</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E6%95%B0%E4%BB%93%E5%88%86%E5%B1%82.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E6%95%B0%E4%BB%93%E5%88%86%E5%B1%82.html" itemprop="url">数仓分层</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数仓分层"><a href="#数仓分层" class="headerlink" title="数仓分层"></a>数仓分层</h1><h2 id="数仓概念"><a href="#数仓概念" class="headerlink" title="数仓概念"></a>数仓概念</h2><h3 id="什么是数据仓库"><a href="#什么是数据仓库" class="headerlink" title="什么是数据仓库"></a>什么是数据仓库</h3><blockquote>
<p>数据仓库，英文名称为<code>Data Warehouse</code>，可简写为<code>DW</code>或<code>DWH</code>,是为企业所有级别的决策制定过程，提供所有类型数据支持的战略集合。<strong>它出于分析性报告和决策支持目的而创建</strong>。</p>
</blockquote>
<h3 id="数据仓库作用"><a href="#数据仓库作用" class="headerlink" title="数据仓库作用"></a>数据仓库作用</h3><blockquote>
<p>构建面向分析的集成化数据环境，提供指导业务流程改进、监视时间、成本、质量以及控制。数据仓库本身并不 “生产” 任何数据，同时自身也不需要 “消费” 任何的数据，数据来源于外部，并且开放给外部应用，这也是为什么叫 “仓库” ，而不叫 “工厂” 的原因。</p>
</blockquote>
<h3 id="数据仓库的特点"><a href="#数据仓库的特点" class="headerlink" title="数据仓库的特点"></a>数据仓库的特点</h3><h4 id="面向主题"><a href="#面向主题" class="headerlink" title="面向主题"></a>面向主题</h4><blockquote>
<p>操作型数据库的数据组织面向事务处理任务，各个业务系统之间各自分离，而数据仓库中的数据是按照一定的主题域进行组织。主题是一个抽象的概念，是指用户使用数据仓库进行决策时所关心的重点方面，一个主题通常包含多个操作型信息系统。</p>
</blockquote>
<h4 id="集成"><a href="#集成" class="headerlink" title="集成"></a>集成</h4><blockquote>
<p>面向事务处理的操作型数据库通常与某些特定的应用相关，数据库之间相互独立，并且往往是异构的。而数据仓库中的数据是在对原有分散的数据库数据抽取、清理的基础上经过系统加工、汇总和整理得到的，必须消除元数据中的不一致性，以保证数据仓库内的信息关于整个企业的一致的全局信息。</p>
</blockquote>
<h4 id="不可更新"><a href="#不可更新" class="headerlink" title="不可更新"></a>不可更新</h4><blockquote>
<p>操作型数据库中的数据通常实时更新，数据根据需要及时发生变化。数据仓库的数据主要供企业决策分析之用，所涉及的数据操作主要是数据查询，一旦某个数据进入数据很残酷以后，一般情况下将被长期保留，也就是数据仓库中一般有大量的查询操作，但修改和删除操作很少，通常只需要定期的加载、刷新。</p>
</blockquote>
<h4 id="时变性"><a href="#时变性" class="headerlink" title="时变性"></a>时变性</h4><blockquote>
<p>操作型数据库主要关心当前某一个时间段内的数据，而数据仓库中的数据通常包含历史信息，系统记录了企业从过去某一个时点（如开始应用数据仓库的时点）到目前的各个阶段的信息，通过这些信息，可以对企业的发展历程和未来趋势做出定量分析和预测。</p>
</blockquote>
<h4 id="数据仓库中的数据"><a href="#数据仓库中的数据" class="headerlink" title="数据仓库中的数据"></a>数据仓库中的数据</h4><blockquote>
<p>包括元数据，粒度数据、当前详细数据，历史数据、档案数据。</p>
</blockquote>
<p>1.4.1 元数据</p>
<blockquote>
<p>最重要的部分，关于数据的数据。也成为数据仓库的结构，是所有数据集成体现。仓库开发者使用元素来管理和控制仓库的建立和维护。</p>
</blockquote>
<p>1.4.2 粒度数据</p>
<blockquote>
<p>定义为呼叫仓库所保存的信息的概要程度。不同粒度表示为不同级别的汇总数据。汇总数据是信息仓库的特点，所有的企业数据分类（按部门、地区、功能等）需要的信息都不同，同时有效的信息仓库是未不同风格提供的，轻量级汇总数据是企业自行的主要依据，它来自根据企业组成部分的轻量级汇总数据或来自当前详细数据。这一层的数据容量比其他任何一个都少，代表一个折衷的积累，用来支撑广泛的各式的需要和兴趣。通过高度汇总，执行者能够使用“钻取”到达逐步增加的详细层。</p>
</blockquote>
<p>1.4.3 当前详细数据</p>
<blockquote>
<p>是信息仓库的核心，存放大量数据。数据来自业务操作数据库，通过主题来组织，不是代表特定应用，而是代表整个企业。在仓库中数据粒度最低，当数据精确化时，其中的每一个数据实体都是一个块照、一个时刻，表示一个瞬间。一旦需要经常支持企业需求，数据随即进行更新。</p>
</blockquote>
<p>1.4.4 历史数据</p>
<blockquote>
<p>以前的有意义数据（一般两年以上），给企业带来延续的利益和价值。包含巨大的数据量，可以用来预测和趋势分析。包括：旧数据（原始或汇总形式）、描述旧数据特征的元数据。</p>
</blockquote>
<h4 id="1-5-数据仓库的基本架构"><a href="#1-5-数据仓库的基本架构" class="headerlink" title="1.5 数据仓库的基本架构"></a>1.5 数据仓库的基本架构</h4><blockquote>
<p>数据仓库的目的是构建面向分析的继承化数据环境，为企业提供决策支持（Decision Support）。其实数据仓库本身并不“生产”然后数据，同时自身也不需要“消费”任何数据，数据来源于外部，并且开放给外部应用，这也是为什么叫“仓库”，而不叫“工厂”的原因。因此数据仓库的基本架构主要包含的数据流入流出的过程，可以分为三层</p>
<p>–原始层（元数据）</p>
<p>–仓库层（数据仓库）</p>
<p>–应用层（数据应用）</p>
</blockquote>
<img src="https://pic4.zhimg.com/80/v2-91d6a6ca901449e1e3dc96851f408453_1440w.webp" alt="img" style="zoom: 50%;">

<img src="/post/Users\Administrator\AppData\Local\Temp\WeChat Files\1bcb8ac1f3fd27d4452992905efd093.jpg" alt="1bcb8ac1f3fd27d4452992905efd093" style="zoom: 50%;">





<h4 id="1-6-数据库和数据仓库的区别"><a href="#1-6-数据库和数据仓库的区别" class="headerlink" title="1.6 数据库和数据仓库的区别"></a>1.6 数据库和数据仓库的区别</h4><img src="https://pic1.zhimg.com/80/v2-ce707b3e18e8fa5bb6adc377acedcf78_1440w.webp" alt="img" style="zoom:50%;">

<p>数据仓库是在传统数据库的基础之上发展起来的，但它并不是对传统数据库的彻底抛弃，而是旨在弥补传统数据库在数据分析能力方面的不足，以提供良好的大规模数据分析能力为己任，力图为决策提供有效的技术支持。和传统数据库相比，数据仓库在总体特征、面向用户、存储内容等方面，都有着重大的差异（如下表）。</p>
<img src="https://pic2.zhimg.com/80/v2-a0874931c5b236e904ff335547bf88ad_1440w.webp" alt="img" style="zoom: 33%;">

<h3 id="原始数据层"><a href="#原始数据层" class="headerlink" title="原始数据层"></a>原始数据层</h3><blockquote>
<p>ODS(Operational Data Store)</p>
<ol>
<li>保持数据原貌，不做任何修改</li>
<li>压缩采用 LZO，压缩比是 100g 数据压缩完 10g 左右。</li>
<li>创建分区表</li>
</ol>
</blockquote>
<h3 id="明细数据层"><a href="#明细数据层" class="headerlink" title="明细数据层"></a>明细数据层</h3><blockquote>
<p>DWD</p>
<p>1.数据清洗<br>（1）空值去除<br>（2）过滤核心字段无意义的数据，比如订单表中订单 id 为 null，支付表中支付 id 为空<br>（3）将用户行为宽表和业务表进行数据一致性处理</p>
<p>2.清洗的手段<br>Sql、mr、rdd、kettle、Python等等</p>
<p>3.清洗掉多少数据算合理<br>1 万条数据清洗掉 1 条。</p>
<p>4.脱敏<br>对手机号、身份证号等敏感数据脱敏</p>
<p>5.维度退化<br>对业务数据传过来的表进行维度退化和降维。（商品一级二级三级、省市县、年月日）</p>
<p>6.LZO压缩</p>
<p>7.列式存储 parquet</p>
</blockquote>
<h3 id="服务数据层"><a href="#服务数据层" class="headerlink" title="服务数据层"></a>服务数据层</h3><blockquote>
<p>DWS</p>
<ol>
<li><p>DWS 层有 3-5 张宽表（处理 100-200 个指标 70%以上的需求）</p>
<p>  具体宽表名称：用户行为宽表，用户购买商品明细行为宽表，商品宽表，购物车宽表，物流宽表、登录注册、售后等。</p>
</li>
<li><p>哪个宽表最宽？大概有多少个字段？<br>最宽的是用户行为宽表。大概有 60-100 个字段</p>
</li>
<li><p>具体用户行为宽表字段名称<br>评论、打赏、收藏、关注–商品、关注–人、点赞、分享、好价爆料、文章发布、活跃、签到、补签卡、幸运屋、礼品、金币、电商点击、gmv</p>
</li>
</ol>
</blockquote>
<h3 id="主题数据层"><a href="#主题数据层" class="headerlink" title="主题数据层"></a>主题数据层</h3><blockquote>
<p>DWT</p>
<p>分析过的指标<br>日活、月活、周活、留存、留存率、新增（日、周、年）、转化率、流失、回流、七天内连续 3 天登录（点赞、收藏、评价、购买、加购、下单、活动）、连续 3 周（月）登录、GMV、复购率、复购率排行、点赞、评论、收藏、领优惠价人数、使用优惠价、沉默、值不值得买、退款人数、退款率 topn 热门商品</p>
<p>留转 G 复活指标<br>（1）活跃<br>日活：100 万 ；月活：是日活的 2-3 倍 300 万<br>总注册的用户多少？1000 万-3000 万之间<br>（2）GMV<br>GMV：每天 10 万订单 （50 – 100 元） 500 万-1000 万<br>10%-20% 100 万-200 万<br>（3）复购率<br>某日常商品复购；（手纸、面膜、牙膏）10%-20%<br>电脑、显示器、手表 1%<br>（4）转化率<br>商品详情 &#x3D;》 加购物车 &#x3D;》下单 &#x3D;》 支付<br>5%-10% 60-70% 90%-95%<br>（5）留存率<br>1&#x2F;2&#x2F;3、周留存、月留存<br>搞活动： 10-20%</p>
</blockquote>
<h3 id="应用数据层"><a href="#应用数据层" class="headerlink" title="应用数据层"></a>应用数据层</h3><blockquote>
<ol>
<li><p>如何分析用户活跃？<br> 在启动日志中统计不同设备 id 出现次数。</p>
</li>
<li><p>如何分析用户新增?<br> 用活跃用户表 left join 用户新增表，用户新增表中 mid 为空的即为用户新增。</p>
</li>
<li><p>如何分析用户 1 天留存？<br> 留存用户&#x3D;前一天新增 join 今天活跃<br> 用户留存率&#x3D;留存用户&#x2F;前一天新增</p>
</li>
<li><p>如何分析沉默用户？<br> (登录时间为 7 天前,且只出现过一次)<br> 按照设备 id 对日活表分组，登录次数为 1，且是在一周前登录。</p>
</li>
<li><p>如何分析本周回流用户？<br> 本周活跃 left join 本周新增 left join 上周活跃，且本周新增 id 和上周活跃 id 都为 null。</p>
</li>
<li><p>如何分析流失用户？<br> (登录时间为 7 天前)<br> 按照设备 id 对日活表分组，且七天内没有登录过。</p>
</li>
<li><p>如何分析最近连续 3 周活跃用户数？<br> 按照设备 id 对周活进行分组，统计次数大于 3 次。</p>
</li>
<li><p>如何分析最近七天内连续三天活跃用户数？<br> 1）查询出最近 7 天的活跃用户，并对用户活跃日期进行排名<br> 2）计算用户活跃日期及排名之间的差值<br> 3）对同用户及差值分组，统计差值个数<br> 4）将差值相同个数大于等于 3 的数据取出，然后去重，即为连续 3 天及以上活跃的用户<br> 7天连续收藏、点赞、购买、加购、付款、浏览、商品点击、退货、1 个月连续 7 天、连续两周</p>
</li>
</ol>
</blockquote>
<h1 id="数仓建模"><a href="#数仓建模" class="headerlink" title="数仓建模"></a>数仓建模</h1><h2 id="常用建模工具"><a href="#常用建模工具" class="headerlink" title="常用建模工具"></a>常用建模工具</h2><blockquote>
<p>PowerDesigner&#x2F;SQLYog&#x2F;EZDML</p>
</blockquote>
<h2 id="ODS层"><a href="#ODS层" class="headerlink" title="ODS层"></a>ODS层</h2><blockquote>
<ol>
<li>保持数据原貌不做任何修改，起到备份数据的作用。</li>
<li>数据采用压缩，减少磁盘存储空间（例如：原始数据 100G，可以压缩到 10G 左右）</li>
<li>创建分区表，防止后续的全表扫描</li>
</ol>
</blockquote>
<h2 id="DWD层"><a href="#DWD层" class="headerlink" title="DWD层"></a>DWD层</h2><blockquote>
<p>DWD 层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。维度建模一般按照以下四个步骤：</p>
<p>选择业务过程→声明粒度→确认维度→确认事实</p>
<p>（1）选择业务过程</p>
<p>在业务系统中，如果业务表过多，挑选我们感兴趣的业务线，比如下单业务，支付业务，退款业务，物流业务，一条业务线对应一张事实表。如果小公司业务表比较少，建议选择所有业务线。</p>
<p>（2）声明粒度</p>
<p>数据粒度指数据仓库的数据中保存数据的细化程度或综合程度的级别。<br>声明粒度意味着精确定义事实表中的一行数据表示什么，应该尽可能选择最小粒度，以此来应各种各样的需求。<br>典型的粒度声明如下：</p>
<p>订单当中的每个商品项作为下单事实表中的一行，粒度为每次<br>每周的订单次数作为一行，粒度为每周。<br>每月的订单次数作为一行，粒度为每月。<br>注意：如果在 DWD 层粒度就是每周或者每月，那么后续就没有办法统计细粒度的指标了。所有建议采用最小粒度。<br>（3）确定维度</p>
<p>维度的主要作用是描述业务是事实，主要表示的是“谁，何处，何时”等信息。例如：<br>时间维度、用户维度、地区维度等常见维度。</p>
<p>（4）确定事实</p>
<p>此处的“事实”一词，指的是业务中的度量值，例如订单金额、下单次数等。<br>在 DWD 层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建最细粒度的明细层事实表。事实表可做适当的宽表化处理。</p>
<p>根据维度建模中的星型模型思想，将维度进行退化。例如：地区表和省份表退化为地区维度表，商品表、品类表、spu 表、商品三级分类、商品二级分类、商品一级分类表退化为商品维度表，活动信息表和活动规则表退化为活动维度表。至此，数仓的维度建模已经完毕，DWS、DWT 和 ADS 和维度建模已经没有关系了。DWS 和 DWT 都是建宽表，宽表都是按照主题去建。主题相当于观察问题的角度，对应着维度表。</p>
</blockquote>
<h2 id="DWS层"><a href="#DWS层" class="headerlink" title="DWS层"></a>DWS层</h2><blockquote>
<p>DWS 层统计各个主题对象的当天行为，服务于 DWT 层的主题宽表。DWS层的宽表字段，是站在不同维度的视角去看事实表，重点关注事实表的度量值，通过与之关联的事实表，获得不同的事实表的度量值。</p>
</blockquote>
<h2 id="DWT层"><a href="#DWT层" class="headerlink" title="DWT层"></a>DWT层</h2><blockquote>
<p>以分析的主题对象为建模驱动，基于上层的应用和产品的指标需求，构建主题对象的全量宽表。<br>DWT 层主题宽表都记录什么字段？<br>每个维度关联的不同事实表度量值以及首次、末次时间、累积至今的度量值、累积某个时间段的度量值。</p>
</blockquote>
<h2 id="ADS层"><a href="#ADS层" class="headerlink" title="ADS层"></a>ADS层</h2><blockquote>
<p>分别对设备主题、会员主题、商品主题和营销主题进行指标分析，其中营销主题是用户主题和商品主题的跨主题分析案例</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" itemprop="url">操作系统</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="操作系统概述"><a href="#操作系统概述" class="headerlink" title="操作系统概述"></a>操作系统概述</h1><p>操作系统（Operating System，简称OS）是计算机系统中的核心软件，负责管理硬件资源、提供用户接口、执行应用程序等。操作系统的主要功能包括进程管理、内存管理、文件系统管理、设备管理和用户接口。</p>
<h2 id="操作系统的主要功能"><a href="#操作系统的主要功能" class="headerlink" title="操作系统的主要功能"></a>操作系统的主要功能</h2><h3 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h3><p>进程管理是操作系统的核心功能之一，负责创建、调度、终止进程，并提供进程间通信和同步机制。</p>
<ul>
<li><strong>进程</strong>：进程是程序在执行中的实例，包括程序代码、数据和执行状态。</li>
<li><strong>线程</strong>：线程是进程中的一个执行单元，一个进程可以包含多个线程。</li>
<li><strong>调度算法</strong>：操作系统使用调度算法决定进程的执行顺序，常见的调度算法包括先来先服务（FCFS）、短作业优先（SJF）、优先级调度和时间片轮转（RR）。</li>
<li><strong>进程间通信（IPC）</strong>：操作系统提供多种进程间通信机制，包括管道、消息队列、共享内存和信号量。</li>
<li><strong>进程同步</strong>：操作系统提供同步机制，如互斥锁、信号量和条件变量，确保多个进程或线程在访问共享资源时不会发生冲突。</li>
</ul>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>内存管理是操作系统的另一项重要功能，负责分配和回收内存空间，确保各进程能够正常运行。</p>
<ul>
<li><strong>内存分配</strong>：操作系统使用内存分配算法将内存分配给进程，常见的分配算法包括首次适配（First Fit）、最佳适配（Best Fit）和最坏适配（Worst Fit）。</li>
<li><strong>虚拟内存</strong>：虚拟内存技术允许进程使用比实际物理内存更大的地址空间，通过页表将虚拟地址映射到物理地址。</li>
<li><strong>分页和分段</strong>：分页和分段是两种常见的内存管理技术，分页将内存划分为固定大小的页，分段将内存划分为不同大小的段。</li>
<li><strong>内存保护</strong>：操作系统通过内存保护机制防止进程非法访问其他进程的内存空间。</li>
</ul>
<h3 id="文件系统管理"><a href="#文件系统管理" class="headerlink" title="文件系统管理"></a>文件系统管理</h3><p>文件系统管理是操作系统的基本功能之一，负责组织和管理存储设备上的文件和目录。</p>
<ul>
<li><strong>文件</strong>：文件是存储在磁盘上的数据集合，具有文件名和文件属性。</li>
<li><strong>目录</strong>：目录是文件的集合，用于组织和管理文件。</li>
<li><strong>文件系统</strong>：文件系统是操作系统用于管理文件和目录的结构和方法，常见的文件系统包括FAT、NTFS、EXT和HFS。</li>
<li><strong>文件操作</strong>：操作系统提供文件操作接口，包括创建、删除、读写和重命名文件。</li>
</ul>
<h3 id="设备管理"><a href="#设备管理" class="headerlink" title="设备管理"></a>设备管理</h3><p>设备管理是操作系统的重要功能，负责管理和控制计算机的硬件设备，包括输入输出设备、存储设备和网络设备。</p>
<ul>
<li><strong>设备驱动程序</strong>：设备驱动程序是操作系统与硬件设备之间的接口，负责控制和操作硬件设备。</li>
<li><strong>设备调度</strong>：操作系统使用设备调度算法管理设备的访问和使用，确保设备的高效利用。</li>
<li><strong>设备接口</strong>：操作系统提供设备接口，允许应用程序访问和操作硬件设备。</li>
</ul>
<h2 id="用户接口"><a href="#用户接口" class="headerlink" title="用户接口"></a>用户接口</h2><p>用户接口是操作系统与用户之间的交互界面，提供命令行界面（CLI）和图形用户界面（GUI）。</p>
<ul>
<li><strong>命令行界面（CLI）</strong>：CLI是基于文本的用户界面，用户通过输入命令与操作系统交互。</li>
<li><strong>图形用户界面（GUI）</strong>：GUI是基于图形的用户界面，用户通过图标、窗口和菜单与操作系统交互。</li>
</ul>
<h2 id="操作系统的类型"><a href="#操作系统的类型" class="headerlink" title="操作系统的类型"></a>操作系统的类型</h2><h3 id="单用户单任务操作系统"><a href="#单用户单任务操作系统" class="headerlink" title="单用户单任务操作系统"></a>单用户单任务操作系统</h3><p>单用户单任务操作系统只能同时支持一个用户和一个任务的执行，适用于简单的计算机系统。</p>
<ul>
<li><strong>例子</strong>：MS-DOS</li>
</ul>
<h3 id="单用户多任务操作系统"><a href="#单用户多任务操作系统" class="headerlink" title="单用户多任务操作系统"></a>单用户多任务操作系统</h3><p>单用户多任务操作系统支持一个用户同时执行多个任务，适用于个人计算机。</p>
<ul>
<li><strong>例子</strong>：Windows、macOS</li>
</ul>
<h3 id="多用户多任务操作系统"><a href="#多用户多任务操作系统" class="headerlink" title="多用户多任务操作系统"></a>多用户多任务操作系统</h3><p>多用户多任务操作系统支持多个用户同时执行多个任务，适用于服务器和大型计算机系统。</p>
<ul>
<li><strong>例子</strong>：Unix、Linux</li>
</ul>
<h3 id="实时操作系统"><a href="#实时操作系统" class="headerlink" title="实时操作系统"></a>实时操作系统</h3><p>实时操作系统用于对时间要求严格的应用场景，能够在规定时间内完成任务。</p>
<ul>
<li><strong>例子</strong>：RTOS、VxWorks</li>
</ul>
<h2 id="操作系统的常见问题"><a href="#操作系统的常见问题" class="headerlink" title="操作系统的常见问题"></a>操作系统的常见问题</h2><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>死锁是指两个或多个进程在等待对方释放资源，导致所有进程都无法继续执行的情况。</p>
<ul>
<li><strong>预防</strong>：资源分配图、银行家算法。</li>
<li><strong>检测</strong>：死锁检测算法。</li>
<li><strong>恢复</strong>：终止进程、回收资源。</li>
</ul>
<h3 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h3><p>内存泄漏是指程序在运行过程中未能释放已分配的内存，导致内存资源逐渐耗尽的问题。</p>
<ul>
<li><strong>预防</strong>：及时释放内存、使用智能指针。</li>
<li><strong>检测</strong>：内存泄漏检测工具。</li>
</ul>
<h3 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h3><p>缓冲区溢出是指程序在写入数据时超过了缓冲区的边界，导致数据覆盖其他内存区域的问题。</p>
<ul>
<li><strong>预防</strong>：边界检查、使用安全函数。</li>
<li><strong>检测</strong>：缓冲区溢出检测工具。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1.html" itemprop="url">9中数据通信/流动模式</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          该篇博客描述点对点、API 网关、发布-订阅、请求-响应、事件溯源、ETL、批处理、流处理、编排的工作原理
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/post/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1.html">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E6%96%B0%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E6%96%B0%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF.html" itemprop="url">新学习路线</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%E5%9B%BE.drawio.svg"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.orionpotter.space/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orion Potter's 个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1.html" itemprop="url">微服务</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-04-04T14:06:41+08:00">
                2025-04-04
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="微服务基础概念"><a href="#微服务基础概念" class="headerlink" title="微服务基础概念"></a>微服务基础概念</h1><h2 id="微服务架构定义"><a href="#微服务架构定义" class="headerlink" title="微服务架构定义"></a>微服务架构定义</h2><p>微服务架构是一种软件设计方法，将一个应用程序拆分为一组小型、独立部署的服务。每个服务都专注于特定的业务功能，可以独立开发、测试、部署和扩展，并通过轻量级的通信协议（如HTTP&#x2F;REST或消息队列）与其他服务进行交互。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ol>
<li><strong>模块化</strong>：每个微服务都是一个独立的模块，专注于实现特定的业务功能。</li>
<li><strong>灵活性</strong>：每个微服务可以独立开发、测试、部署减少对整个系统的影响。</li>
<li><strong>技术多样性</strong>：不同微服务可以采用不同的技术栈和数据存储。</li>
<li><strong>轻量级通信</strong>：微服务之间通过轻量级协议进行通信，如HTTP&#x2F;REST、gRPC或消息队列。</li>
<li><strong>故障隔离</strong>：单个服务的故障不会导致整个系统崩溃，提高系统的可靠性。</li>
</ol>
<h2 id="与单体架构对比"><a href="#与单体架构对比" class="headerlink" title="与单体架构对比"></a>与单体架构对比</h2><blockquote>
<p>Microservices（微服务）和Monolithic Applications（单体应用）代表了两种架构风格,在<strong>单体架构</strong>的情况下，整个应用程序被打包并部署在一起，而在<strong>微服务架构</strong>的情况下，应用程序被分解为一组小型、独立的服务，这些服务通过网络（主要是通过 HTTP）相互通信，每个服务负责特定的业务能力，并且可以独立开发、部署和扩展。对应用程序进行更改变得更加弹性，不会影响系统的其他部分。</p>
</blockquote>
<img src="/images/单体和微服务的区别.drawio.svg" style="zoom:67%;">

<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ol>
<li><strong>部署:</strong> 单体应用通常作为一个整体进行部署，微服务允许每个服务单独部署和管理。</li>
<li><strong>扩展性:</strong> 单体应用缩放涉及整个应用的复制，可能浪费资源，微服务可以单独缩放最需要资源的服务。</li>
<li><strong>开发工作流:</strong> 单体应用通常由一个开发团队统一管理，微服务可以由不同团队针对各自服务独立开发。</li>
<li><strong>技术栈局限性:</strong> 单体架构倾向于限制在单一的技术栈，微服务架构可以使用不同的技术栈开发不同服务。</li>
<li><strong>容错能力与隔离性:</strong> 单体应用的一个组件故障可能会导致整个应用宕机，微服务的设计使得故障服务不会直接影响到其他服务。</li>
</ol>
<h2 id="领域驱动设计-DDD"><a href="#领域驱动设计-DDD" class="headerlink" title="领域驱动设计 (DDD)"></a>领域驱动设计 (DDD)</h2><p>领域驱动设计（Domain-Driven Design，DDD）是一种软件开发方法，旨在通过对复杂业务领域的深入理解来构建软件系统。DDD强调业务领域的概念和语言，帮助开发人员和业务专家更好地沟通和合作。</p>
<ol>
<li><strong>实体类（领域对象）的设计</strong>：在传统方法和DDD方法中，实体类（或者称为领域对象）的设计并没有太大的区别，都是用来表示业务领域中的概念和数据结构的类。这些类包含属性和可能的方法，用于表示业务对象的状态和行为。</li>
<li><strong>服务类的区别</strong>：<ul>
<li><strong>传统方法中的服务类</strong>：通常用于实现基本的增删改查操作，它们主要负责数据的存储和检索，以及简单的数据操作。</li>
<li><strong>DDD方法中的服务类</strong>：在DDD中，服务类可能会更加关注领域业务逻辑的实现，而不仅仅局限于简单的CRUD操作。</li>
</ul>
</li>
</ol>
<h1 id="服务间通信"><a href="#服务间通信" class="headerlink" title="服务间通信"></a>服务间通信</h1><h2 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h2><p>REST（Representational State Transfer）API 是一种基于HTTP协议的通信方式，常使用JSON格式进行数据传输。RESTful服务通常具有以下特点：</p>
<ul>
<li>无状态性：每个请求都是独立的，服务器不会保存客户端的状态。</li>
<li>可缓存性：响应数据可以被客户端缓存。</li>
<li>层次系统：允许在客户端和服务器之间通过中间层进行通信。</li>
<li>统一接口：所有的操作都通过标准的HTTP方法（GET、POST、PUT、DELETE等）来进行。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/orders"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderRepository</span> orderRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span> <span class="token function">getAllOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> orderRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> orderRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrderById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ResourceNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Order not found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> orderDetails<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ResourceNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Order not found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>orderDetails<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ResourceNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Order not found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>RPC（Remote Procedure Call）是一种通过网络进行远程服务调用的协议，常见的技术选型有gRpc、Dubbo,gRPC 是一种高性能的开源RPC框架，使用Protobuf（Protocol Buffers）作为数据序列化格式，提供语言无关、平台无关的通信方式，基于HTTP&#x2F;2协议，通过定义服务和消息类型的Protobuf文件进行通信。</p>
<h3 id="RPC调用原理"><a href="#RPC调用原理" class="headerlink" title="RPC调用原理"></a>RPC调用原理</h3><p><strong>OrderService.proto</strong></p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token keyword">option</span> java_package <span class="token operator">=</span> <span class="token string">"com.example.grpc"</span><span class="token punctuation">;</span>
<span class="token keyword">option</span> java_outer_classname <span class="token operator">=</span> <span class="token string">"OrderServiceProto"</span><span class="token punctuation">;</span>

<span class="token keyword">service</span> <span class="token class-name">OrderService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">rpc</span> <span class="token function">CreateOrder</span> <span class="token punctuation">(</span><span class="token class-name">OrderRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">OrderResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">rpc</span> <span class="token function">GetOrder</span> <span class="token punctuation">(</span><span class="token class-name">OrderIdRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">OrderResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">OrderRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> description <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">OrderResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">string</span> description <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">OrderIdRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>GrpcServer.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrpcServer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token class-name">ServerBuilder</span><span class="token punctuation">.</span><span class="token function">forPort</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server started on port 9090"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>GrpcClient.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrpcClient</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建 gRPC Channel，连接到服务端</span>
        <span class="token class-name">ManagedChannel</span> channel <span class="token operator">=</span> <span class="token class-name">ManagedChannelBuilder</span><span class="token punctuation">.</span><span class="token function">forAddress</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9090</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">usePlaintext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 在示例中使用非加密的通信</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建 OrderService 的 gRPC 客户端存根</span>
        <span class="token class-name">OrderServiceGrpc<span class="token punctuation">.</span>OrderServiceBlockingStub</span> stub <span class="token operator">=</span> <span class="token class-name">OrderServiceGrpc</span><span class="token punctuation">.</span><span class="token function">newBlockingStub</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 准备调用 CreateOrder 方法</span>
        <span class="token class-name">OrderRequest</span> request <span class="token operator">=</span> <span class="token class-name">OrderRequest</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string">"New order request"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用远程服务的 CreateOrder 方法</span>
        <span class="token class-name">OrderResponse</span> response <span class="token operator">=</span> stub<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印返回的订单 ID 和描述</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Order created with ID: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Description: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 关闭 Channel</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            channel<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Dubbo调用原理"><a href="#Dubbo调用原理" class="headerlink" title="Dubbo调用原理"></a>Dubbo调用原理</h3><ol>
<li><p><strong>定义服务接口</strong>：</p>
<p>有一个服务接口 <code>UserService</code>，包含方法 <code>getUserInfo(int userId)</code>，用于获取用户信息。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><strong>Provider 实现服务接口</strong>：</p>
<p>Provider 实现 <code>UserService</code> 接口，并通过 Dubbo 暴露服务。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 实现具体的业务逻辑，根据 userId 查询用户信息</span>
        <span class="token keyword">return</span> <span class="token string">"User "</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" Info"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 Spring 配置文件中暴露服务：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userService<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.UserServiceImpl<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.UserService<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p><strong>Consumer 调用服务</strong>：</p>
<p>Consumer 通过 Dubbo 引用 Provider 提供的服务，并调用其方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserClient</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ClassPathXmlApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"consumer.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"userService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userInfo <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User Info: "</span> <span class="token operator">+</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 Spring 配置文件中引用服务：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userService<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.UserService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><strong>Registry 注册中心配置</strong>：</p>
<p>Dubbo 配置文件中配置注册中心地址：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>registry</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zookeeper://localhost:2181<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p>消息队列是一种用于异步通信的机制。RabbitMQ是一个常用的消息队列中间件，支持多种消息传递协议，能够实现发布&#x2F;订阅、点对点、延迟队列等多种消息模式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSender</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"orderQueue"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><p>OpenFeign是Spring Cloud中的一个声明式HTTP客户端，能够通过注解方式定义HTTP请求接口，从而提高代码的可读性和维护性。</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="启用Feign客户端"><a href="#启用Feign客户端" class="headerlink" title="启用Feign客户端"></a>启用Feign客户端</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MicroserviceOneApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MicroserviceOneApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="定义Feign客户端接口"><a href="#定义Feign客户端接口" class="headerlink" title="定义Feign客户端接口"></a>定义Feign客户端接口</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// name属性指定在注册中心的微服务的名称</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"microservice-three"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HelloService</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//指定调用的方法</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/three/hello"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="在服务中使用Feign客户端"><a href="#在服务中使用Feign客户端" class="headerlink" title="在服务中使用Feign客户端"></a>在服务中使用Feign客户端</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">HelloService</span> helloService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/one/open"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> hello <span class="token operator">=</span> helloService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"i am open!"</span> <span class="token operator">+</span> hello<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h1><h2 id="服务注册中心"><a href="#服务注册中心" class="headerlink" title="服务注册中心"></a>服务注册中心</h2><p>服务注册中心是一种机制，用于管理和发现分布式系统中的服务实例。服务注册中心记录了所有可用的服务实例信息，并允许客户端通过查询注册中心来找到所需的服务。常用的服务注册中心包括 Eureka、Consul 和 Nacos。</p>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Eureka</strong></td>
<td>- 服务注册与发现 - 健康检查 - 自我保护机制</td>
<td>- Netflix开源项目 - 适用于Spring Cloud生态</td>
<td>仍在主流使用，但Spring Cloud官方推荐使用Spring Cloud Kubernetes或Spring Cloud Consul</td>
</tr>
<tr>
<td><strong>Consul</strong></td>
<td>- 服务注册与发现 - 健康检查 - Key&#x2F;Value存储 - 多数据中心支持</td>
<td>- HashiCorp开源项目 - 支持多数据中心和分布式一致性</td>
<td>主流使用，尤其在需要多数据中心支持的场景</td>
</tr>
<tr>
<td><strong>Etcd</strong></td>
<td>- 服务注册与发现 - 分布式键值存储 - 强一致性</td>
<td>- CoreOS开源项目 - 轻量级 - 高性能</td>
<td>主流使用，特别是在Kubernetes中作为数据存储</td>
</tr>
<tr>
<td><strong>Kubernetes Service</strong></td>
<td>- 服务注册与发现 - 自动负载均衡 - 健康检查</td>
<td>- Kubernetes原生支持 - 无需额外组件</td>
<td>主流使用，特别是在Kubernetes生态中</td>
</tr>
<tr>
<td><strong>Nacos</strong></td>
<td>- 服务注册与发现 - 配置管理 - 动态DNS服务</td>
<td>- 阿里巴巴开源项目 - 支持AP和CP模式切换</td>
<td>主流使用，尤其在中国和阿里云生态中</td>
</tr>
</tbody></table>
<h2 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h2><ol>
<li><strong>服务注册</strong>：服务实例在启动时向注册中心注册自己的信息（例如，IP地址、端口、服务名称等）。</li>
<li><strong>服务心跳</strong>：服务实例定期向注册中心发送心跳信号，表示自己仍然可用。</li>
<li><strong>服务发现</strong>：客户端查询注册中心，获取可用服务实例的信息。</li>
<li><strong>服务下线</strong>：服务实例在关闭时向注册中心发送注销请求；如果实例因故障未能发送注销请求，注册中心会在心跳超时后将其标记为不可用。</li>
</ol>
<h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><h4 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h4><p><strong>1.导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.启用 Eureka Server</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.配置文件</strong></p>
<p>在 <code>application.yml</code> 文件中配置 Eureka Server：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h4><p><strong>1.导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.启用 Eureka Client</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClientApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaClientApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.配置文件</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8761/eureka/

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>client<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>4.测试</strong></p>
<p>通过<a href="http://localhost:8761查看客户端是否注册成功">http://localhost:8761查看客户端是否注册成功</a></p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><p>在微服务架构中，负载均衡是一个重要的机制，它确保请求均匀地分布到多个服务实例上，以提高系统的可用性和性能。</p>
<h2 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h2><ol>
<li><strong>轮询（Round）</strong>： 每个请求依次分配给不同的服务器，循环进行。</li>
<li><strong>随机（Random）</strong>： 每个请求随机分配给一台服务器。</li>
<li><strong>权重（Weighted）</strong>： 根据服务器的权重分配请求，权重高的服务器分配的请求更多。</li>
</ol>
<h2 id="客户端负载均衡"><a href="#客户端负载均衡" class="headerlink" title="客户端负载均衡"></a>客户端负载均衡</h2><p><strong>客户端负载均衡</strong>是指在客户端选择服务器来处理请求。Spring Cloud loadbalancer是一个客户端负载均衡器。</p>
<h2 id="服务端负载均衡"><a href="#服务端负载均衡" class="headerlink" title="服务端负载均衡"></a>服务端负载均衡</h2><p><strong>服务端负载均衡</strong>是指在服务器端选择具体的服务器来处理请求。Nginx 是一个常用的服务端负载均衡器。</p>
<h2 id="技术选型-1"><a href="#技术选型-1" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Nginx</strong></td>
<td>- HTTP&#x2F;HTTPS负载均衡 - 反向代理 - 健康检查 - 高可用性</td>
<td>- 开源项目 - 配置灵活，支持多种负载均衡算法</td>
<td>主流使用，广泛应用于各种场景</td>
</tr>
<tr>
<td><strong>HAProxy</strong></td>
<td>- TCP&#x2F;HTTP负载均衡 - 反向代理 - 健康检查 - 高性能</td>
<td>- 开源项目 - 高性能，适用于高并发场景</td>
<td>主流使用，特别是在高性能需求场景</td>
</tr>
<tr>
<td><strong>Envoy</strong></td>
<td>- L4&#x2F;L7负载均衡 - 服务网格 - 动态配置 - 健康检查</td>
<td>- CNCF开源项目 - 原生支持服务网格</td>
<td>主流使用，特别是在服务网格架构中</td>
</tr>
<tr>
<td><strong>Traefik</strong></td>
<td>- HTTP&#x2F;HTTPS负载均衡 - 动态配置 - 支持多种后端 - 健康检查</td>
<td>- 开源项目 - 原生支持Docker和Kubernetes</td>
<td>主流使用，特别是在容器化环境中</td>
</tr>
<tr>
<td><strong>Ribbon</strong></td>
<td>- 客户端负载均衡 - 支持多种负载均衡算法 - 与Eureka集成</td>
<td>- Netflix开源项目 - 适用于Spring Cloud生态</td>
<td>主流使用，但Spring Cloud官方推荐使用Spring Cloud LoadBalancer作为替代</td>
</tr>
<tr>
<td><strong>LoadBalancer</strong></td>
<td>- 泛指负载均衡器 - 分配流量 - 提高可用性和性能</td>
<td>- 包含多种实现，如Nginx、HAProxy、Envoy等</td>
<td>主流使用，具体实现视场景而定</td>
</tr>
</tbody></table>
<h2 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h2><p>负载均衡通过将请求分发到多个服务器来提升系统性能和可靠性。负载均衡器（无论是客户端还是服务端）都需要管理服务器列表并根据特定算法选择服务器处理请求。</p>
<h2 id="实例代码-1"><a href="#实例代码-1" class="headerlink" title="实例代码"></a>实例代码</h2><h3 id="使用Spring-Cloud-loadbalancer实现客户端负载均衡"><a href="#使用Spring-Cloud-loadbalancer实现客户端负载均衡" class="headerlink" title="使用Spring Cloud loadbalancer实现客户端负载均衡"></a>使用Spring Cloud loadbalancer实现客户端负载均衡</h3><p><strong>1.导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.配置文件</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># application.yaml</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">import</span><span class="token punctuation">:</span> <span class="token string">"configserver:"</span>  <span class="token comment"># 从配置中心获取配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 启用基于服务发现的配置中心查找</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> CONFIG<span class="token punctuation">-</span>SERVER   <span class="token comment"># 配置中心服务在服务注册中心中的名称</span>
<span class="token comment"># microservice-one.yml</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
<span class="token key atrule">message</span><span class="token punctuation">:</span> hihi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.主类</strong></p>
<p>在主类中添加<code>@EnableEurekaClient</code>注解：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MicroserviceOneApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MicroserviceOneApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>4.配置负载均衡</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadbalanceConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>5.使用restTemplate进行请求</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://eureka-client/hello"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="使用Nginx实现服务端负载均衡"><a href="#使用Nginx实现服务端负载均衡" class="headerlink" title="使用Nginx实现服务端负载均衡"></a>使用Nginx实现服务端负载均衡</h4><ol>
<li><strong>安装Nginx</strong></li>
</ol>
<p>根据操作系统的不同，使用包管理工具安装Nginx。例如，在Ubuntu上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol>
<li><strong>配置Nginx</strong></li>
</ol>
<p>编辑<code>/etc/nginx/nginx.conf</code>或<code>/etc/nginx/conf.d/default.conf</code>文件，添加负载均衡配置：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083 weight=1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><strong>重启Nginx</strong></li>
</ol>
<p>保存配置文件后，重启Nginx：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="API网关"><a href="#API网关" class="headerlink" title="API网关"></a>API网关</h1><p>API网关（API Gateway）是一个核心组件，它充当了前端和后端微服务之间的入口，负责处理客户端请求，并提供了路由、安全、监控、负载均衡、缓存功能。</p>
<h2 id="API网关功能"><a href="#API网关功能" class="headerlink" title="API网关功能"></a>API网关功能</h2><ol>
<li><strong>路由</strong>：API网关接收客户端请求并将其路由到适当的微服务。</li>
<li><strong>负载均衡</strong>：API网关可以将请求分发到多台服务器，提供负载均衡功能。</li>
<li><strong>安全</strong>：API网关可以集中管理认证和授权，确保请求的安全性。</li>
<li><strong>监控</strong>：API网关可以监控请求的流量、延迟、错误等信息，帮助进行系统的监控和管理。</li>
</ol>
<h2 id="常用网关技术"><a href="#常用网关技术" class="headerlink" title="常用网关技术"></a>常用网关技术</h2><ol>
<li><strong>Zuul</strong>：Netflix开源的API网关解决方案，提供动态路由、监控、弹性、安全等功能。</li>
<li><strong>Spring Cloud Gateway</strong>：Spring官方推出的API网关解决方案，基于Spring 5、Spring Boot 2和Project Reactor，具有高效的异步非阻塞处理能力。</li>
</ol>
<h2 id="技术选型-2"><a href="#技术选型-2" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Zuul</strong></td>
<td>- 路由 - 过滤器 - 负载均衡 - 安全性</td>
<td>- Netflix开源项目 - 适用于Spring Cloud生态</td>
<td>主流使用，但Spring Cloud官方推荐使用Spring Cloud Gateway作为替代</td>
</tr>
<tr>
<td><strong>Spring Cloud Gateway</strong></td>
<td>- 路由 - 过滤器 - 负载均衡 - 安全性</td>
<td>- Spring Cloud官方项目 - 与Spring生态深度集成</td>
<td>主流使用，特别是在Spring Cloud生态中</td>
</tr>
<tr>
<td><strong>Kong</strong></td>
<td>- 路由 - 插件架构 - 负载均衡 - API管理</td>
<td>- 开源项目 - 基于Nginx和OpenResty</td>
<td>主流使用，特别是在API管理和扩展性需求高的场景</td>
</tr>
<tr>
<td><strong>Traefik</strong></td>
<td>- 路由 - 动态配置 - 负载均衡 - 支持多种后端</td>
<td>- 开源项目 - 原生支持Docker和Kubernetes</td>
<td>主流使用，特别是在容器化环境中</td>
</tr>
<tr>
<td><strong>Envoy</strong></td>
<td>- 路由 - 负载均衡 - 服务网格 - 动态配置</td>
<td>- CNCF开源项目 - 原生支持服务网格</td>
<td>主流使用，特别是在服务网格架构中</td>
</tr>
</tbody></table>
<h2 id="什么是服务限流？"><a href="#什么是服务限流？" class="headerlink" title="什么是服务限流？"></a>什么是服务限流？</h2><p>服务限流是一种控制系统中请求流量的方法，旨在保护服务免受突发流量的影响，防止系统过载和崩溃。限流通常在微服务架构中用于保障服务的稳定性和可靠性。</p>
<h3 id="服务限流的概念"><a href="#服务限流的概念" class="headerlink" title="服务限流的概念"></a>服务限流的概念</h3><p>Spring Cloud Gateway通过<code>RequestRateLimiter</code>过滤器支持基于Redis的令牌桶限流。</p>
<ol>
<li><strong>限流策略</strong>：<ul>
<li><strong>固定窗口计数</strong>（Fixed Window Counter）：在固定时间窗口内限制请求数量。</li>
<li><strong>滑动窗口计数</strong>（Sliding Window Counter）：将固定窗口划分为多个小窗口，通过滑动计算请求数量。</li>
<li><strong>令牌桶</strong>（Token Bucket）：令牌按照固定速率生成，请求需要消耗令牌才能通过。</li>
<li><strong>漏桶</strong>（Leaky Bucket）：请求以恒定速率处理，多余请求排队或被丢弃。</li>
</ul>
</li>
<li><strong>限流层次</strong>：<ul>
<li><strong>应用层限流</strong>：在应用内部实现限流，保护特定服务或资源。</li>
<li><strong>API网关限流</strong>：在API网关层面实现限流，保护整个服务集群。</li>
<li><strong>客户端限流</strong>：在客户端实现限流，避免客户端过多请求对服务造成压力。</li>
</ul>
</li>
</ol>
<h2 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h2><p>API网关作为系统的入口，统一管理和路由客户端的请求，并提供额外的功能如负载均衡、安全、监控等。API网关可以简化客户端与微服务的交互，减少客户端的复杂性。</p>
<h2 id="实例代码-2"><a href="#实例代码-2" class="headerlink" title="实例代码"></a>实例代码</h2><h3 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.ben-manes.caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>service

  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>one
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//MICROSERVICE<span class="token punctuation">-</span>ONE
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/one/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>three
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//MICROSERVICE<span class="token punctuation">-</span>THREE
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/three/<span class="token important">**</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> RewritePath=/service/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">></span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">&#123;</span>segment<span class="token punctuation">&#125;</span>

    <span class="token key atrule">eureka</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
          <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8761/eureka/
      <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
   <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> caffeine

<span class="token key atrule">caffeine</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span> maximumSize=500<span class="token punctuation">,</span>expireAfterAccess=600s     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="主类"><a href="#主类" class="headerlink" title="主类"></a>主类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayServiceApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建一个配置类来启用缓存和配置负载均衡</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> <span class="token function">loadBalancedWebClientBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">WebClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CaffeineCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CaffeineCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cacheManager<span class="token punctuation">.</span><span class="token function">setCaffeine</span><span class="token punctuation">(</span><span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expireAfterAccess</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h1><h2 id="集中化配置管理"><a href="#集中化配置管理" class="headerlink" title="集中化配置管理"></a>集中化配置管理</h2><p>集中化配置管理是指将应用程序的所有配置统一管理和存储，通常在一个中心化的配置服务器中。这样可以方便地管理、修改和分发配置文件。</p>
<h2 id="动态配置更新"><a href="#动态配置更新" class="headerlink" title="动态配置更新"></a>动态配置更新</h2><p>动态配置更新是指当配置文件发生变化时，应用程序可以实时获取新的配置并应用，无需重启服务。Spring Cloud Config 提供了这一功能，结合 Spring Cloud Bus 可以实现配置的实时更新。</p>
<h2 id="技术选型-3"><a href="#技术选型-3" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Spring Cloud Config</strong></td>
<td>- 集中配置管理 - 动态更新 - 加密&#x2F;解密支持</td>
<td>- Spring Cloud官方项目 - 与Spring生态深度集成</td>
<td>主流使用，特别是在Spring Cloud生态中</td>
</tr>
<tr>
<td><strong>Consul</strong></td>
<td>- 配置管理 - 服务注册与发现 - 健康检查</td>
<td>- HashiCorp开源项目 - 支持多数据中心和分布式一致性</td>
<td>主流使用，尤其在需要多数据中心支持的场景</td>
</tr>
<tr>
<td><strong>Etcd</strong></td>
<td>- 分布式键值存储 - 配置管理 - 强一致性</td>
<td>- CoreOS开源项目 - 轻量级 - 高性能</td>
<td>主流使用，特别是在Kubernetes中作为数据存储</td>
</tr>
<tr>
<td><strong>Nacos</strong></td>
<td>- 配置管理 - 服务注册与发现 - 动态DNS服务</td>
<td>- 阿里巴巴开源项目 - 支持AP和CP模式切换</td>
<td>主流使用，尤其在中国和阿里云生态中</td>
</tr>
<tr>
<td><strong>Zookeeper</strong></td>
<td>- 配置管理 - 服务注册与发现 - 分布式锁</td>
<td>- Apache开源项目 - 强一致性保证 - 高可用性</td>
<td>仍在使用，但由于其复杂性和运维成本，有些场景下被Consul和Etcd替代</td>
</tr>
</tbody></table>
<h2 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h2><p>Spring Cloud Config 提供了服务器端和客户端组件，用于集中化配置管理和动态配置更新。</p>
<ol>
<li><strong>Spring Cloud Config Server</strong>：提供配置管理服务，集中存储配置文件，支持从多种存储介质读取配置，如 Git、SVN、本地文件等。</li>
<li><strong>Spring Cloud Config Client</strong>：用于从 Config Server 获取配置，并在应用中使用。</li>
<li><strong>Spring Cloud Bus</strong>：基于消息代理（如 RabbitMQ、Kafka），实现配置的动态刷新。</li>
</ol>
<h2 id="实例代码-3"><a href="#实例代码-3" class="headerlink" title="实例代码"></a>实例代码</h2><p>下面是使用 Spring Cloud Config Server 和 Config Client 实现配置管理的示例代码。</p>
<h3 id="Spring-Cloud-Config-Server"><a href="#Spring-Cloud-Config-Server" class="headerlink" title="Spring Cloud Config Server"></a>Spring Cloud Config Server</h3><p><strong>1.1 导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>1.2 配置文件</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/your<span class="token punctuation">-</span>repo/config<span class="token punctuation">-</span>repo
          <span class="token key atrule">clone-on-start</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>1.3 主类</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigServerApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Spring-Cloud-Config-Client"><a href="#Spring-Cloud-Config-Client" class="headerlink" title="Spring Cloud Config Client"></a>Spring Cloud Config Client</h3><p><strong>2.1 导入依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.2 配置文件</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.3 主类</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2.4 控制器</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;message:Default Hello&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/message"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="动态配置更新-1"><a href="#动态配置更新-1" class="headerlink" title="动态配置更新"></a>动态配置更新</h3><p><strong>3.1 添加 Spring Cloud Bus 依赖</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.2 配置 RabbitMQ</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.3 启用 Spring Cloud Bus</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.4 配置文件刷新</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;message:Default Hello&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/message"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3.5 手动触发刷新</strong></p>
<p>通过 POST 请求触发刷新：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:8080/actuator/refresh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="服务容错"><a href="#服务容错" class="headerlink" title="服务容错"></a>服务容错</h1><p>服务容错（Fault Tolerance）是指系统在部分组件发生故障时仍然能够继续运行并提供服务的能力。服务容错包括多种策略和模式，如断路器模式、重试机制、回退机制、限流、负载均衡、健康检查，断路器模式在服务容错中非常重要，因为它能够有效防止级联故障（即一个服务的故障导致其他服务也发生故障），通过快速失败和自动恢复机制，断路器模式可以显著提高系统的稳定性和可用性。</p>
<h2 id="服务容错机制"><a href="#服务容错机制" class="headerlink" title="服务容错机制"></a>服务容错机制</h2><ol>
<li><strong>断路器模式（Circuit Breaker）</strong><ul>
<li><strong>主要功能</strong>：防止故障扩散，快速失败，自动恢复。</li>
<li><strong>工作原理</strong>：断路器在检测到服务故障时会打开断路器，阻止请求发送到该服务，从而防止系统过载和故障扩散。断路器有三种状态：关闭（正常）、打开和半开（尝试恢复）。</li>
<li><strong>应用场景</strong>：适用于需要防止级联故障的场景，如微服务之间的调用。</li>
</ul>
</li>
<li><strong>重试机制（Retry）</strong><ul>
<li><strong>主要功能</strong>：在请求失败时自动重试，以增加成功的机会。</li>
<li><strong>工作原理</strong>：在请求失败时，系统会按照预定义的策略（如重试次数和间隔时间）重新发送请求。</li>
<li><strong>应用场景</strong>：适用于临时性故障或网络不稳定的场景。</li>
</ul>
</li>
<li><strong>回退机制（Fallback）</strong><ul>
<li><strong>主要功能</strong>：在服务不可用时提供备用方案或默认响应。</li>
<li><strong>工作原理</strong>：当服务调用失败时，系统会返回预定义的回退响应或调用备用服务。</li>
<li><strong>应用场景</strong>：适用于需要保证服务可用性的场景，即使部分功能降级。</li>
</ul>
</li>
<li><strong>限流（Rate Limiting）</strong><ul>
<li><strong>主要功能</strong>：控制请求的速率，以防止服务过载。</li>
<li><strong>工作原理</strong>：系统会限制单位时间内的请求数量，超过限制的请求会被拒绝或延迟处理。</li>
<li><strong>应用场景</strong>：适用于防止突发流量导致服务过载的场景。</li>
</ul>
</li>
<li><strong>负载均衡（Load Balancing）</strong><ul>
<li><strong>主要功能</strong>：将请求分配到多个服务实例，以提高可用性和性能。</li>
<li><strong>工作原理</strong>：通过不同的负载均衡算法（如轮询、随机、最小连接数等）将请求分配到不同的服务实例。</li>
<li><strong>应用场景</strong>：适用于需要高可用性和高性能的场景。</li>
</ul>
</li>
<li><strong>健康检查（Health Check）</strong><ul>
<li><strong>主要功能</strong>：定期检查服务的健康状态，确保只有健康的服务实例接收请求。</li>
<li><strong>工作原理</strong>：系统会定期发送健康检查请求到服务实例，如果实例不健康则将其从负载均衡池中移除。</li>
<li><strong>应用场景</strong>：适用于需要动态调整服务实例的场景。</li>
</ul>
</li>
</ol>
<h2 id="什么是服务容错、熔断、降级"><a href="#什么是服务容错、熔断、降级" class="headerlink" title="什么是服务容错、熔断、降级"></a>什么是服务容错、熔断、降级</h2><h3 id="服务熔断（Circuit-Breaking）"><a href="#服务熔断（Circuit-Breaking）" class="headerlink" title="服务熔断（Circuit Breaking）"></a>服务熔断（Circuit Breaking）</h3><p><strong>定义</strong>：<br>服务熔断是一种保护机制，用于防止一个服务的故障蔓延到整个系统。它通过监控服务调用的失败率，当失败率超过一定阈值时，熔断器会打开，阻止进一步的调用请求。(Hystrix通过断路器模式实现服务熔断)</p>
<p><strong>如何检测故障：</strong></p>
<ol>
<li><strong>超时机制</strong>：断路器通常会为每个服务调用设置一个超时时间。如果服务调用在预定的超时时间内没有返回结果，断路器将视为服务调用失败。</li>
<li><strong>错误率</strong>：断路器会监控服务调用的错误率。如果服务调用的错误率超过预设的阈值，断路器会打开（Open），停止向服务发起新的请求，防止继续访问出现故障的服务。</li>
<li><strong>健康检查</strong>：有些断路器会定期向服务发起健康检查请求，检查服务是否仍然可用。如果健康检查失败，断路器也会将服务标记为不可用，进入开放状态。</li>
<li><strong>半开状态</strong>：在断路器打开一段时间后，有些实现会尝试进入半开状态，允许部分请求通过，以便验证服务的恢复情况。如果这些请求成功，则断路器会恢复关闭状态；如果失败，则继续保持打开状态。</li>
</ol>
<p><strong>主要功能</strong>：</p>
<ul>
<li><strong>故障隔离</strong>：防止故障扩散到其他服务。</li>
<li><strong>快速失败</strong>：在熔断器打开时，立即返回错误响应，而不是等待超时。</li>
<li><strong>自动恢复</strong>：熔断器会定期尝试恢复连接，如果服务恢复正常，则重新允许请求通过。</li>
</ul>
<p><strong>工作原理</strong>：<br>熔断器通常有三种状态：</p>
<ul>
<li><strong>关闭（Closed）</strong>：服务正常，所有请求都通过。</li>
<li><strong>打开（Open）</strong>：服务故障，所有请求都立即失败。</li>
<li><strong>半开（Half-Open）</strong>：熔断器定期尝试恢复连接，允许部分请求通过以检测服务是否恢复。</li>
</ul>
<h3 id="服务降级（Fallback）"><a href="#服务降级（Fallback）" class="headerlink" title="服务降级（Fallback）"></a>服务降级（Fallback）</h3><p><strong>定义</strong>：<br>服务降级是指在服务不可用或响应时间过长时，提供一个备用的响应或执行备用逻辑，以保证系统的基本功能可用。(Hystrix通过Fallback机制实现服务降级)</p>
<p><strong>主要功能</strong>：</p>
<ul>
<li><strong>提供备用方案</strong>：在服务不可用时，返回预定义的备用响应或调用备用服务。</li>
<li><strong>提高系统可用性</strong>：即使部分功能不可用，系统仍能提供基本服务。</li>
</ul>
<p><strong>工作原理</strong>：<br>当服务调用失败或超时时，系统会调用预定义的降级逻辑，例如返回默认值、调用备用服务或执行其他替代操作。</p>
<h3 id="两者者之间的关系"><a href="#两者者之间的关系" class="headerlink" title="两者者之间的关系"></a>两者者之间的关系</h3><ul>
<li>服务熔断和服务降级通常结合使用。当服务熔断器检测到服务故障并打开时，系统会触发服务降级逻辑，返回备用响应或调用备用服务。</li>
<li>服务熔断是防止故障扩散的机制，而服务降级是保证系统在故障情况下仍能提供基本服务的策略。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>服务熔断</strong>：防止故障扩散，快速失败，自动恢复。</li>
<li><strong>服务降级</strong>：在服务不可用时提供备用方案，提高系统可用性。</li>
<li><strong>服务容错</strong>：通过多种机制和策略确保系统在故障情况下仍能运行，包括服务熔断和服务降级。</li>
</ul>
<h2 id="技术选型-4"><a href="#技术选型-4" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Hystrix</strong></td>
<td>- 断路器模式 - 线程隔离 - 限流 - 回退机制</td>
<td>- Netflix开源项目 - 适用于Spring Cloud生态</td>
<td>逐渐被淘汰，Spring Cloud官方推荐使用Resilience4j作为替代</td>
</tr>
<tr>
<td><strong>Resilience4j</strong></td>
<td>- 断路器模式 - 限流 - 重试 - 缓存 - 线程隔离</td>
<td>- 轻量级库 - 与Spring Boot和Spring Cloud深度集成</td>
<td>主流使用，特别是在Spring Cloud生态中</td>
</tr>
<tr>
<td><strong>Sentinel</strong></td>
<td>- 流量控制 - 熔断降级 - 系统负载保护 - 热点参数限流</td>
<td>- 阿里巴巴开源项目 - 支持多种流量控制策略</td>
<td>主流使用，尤其在中国和阿里云生态中</td>
</tr>
<tr>
<td><strong>Istio</strong></td>
<td>- 服务网格 - 断路器 - 重试 - 超时 - 流量控制</td>
<td>- CNCF开源项目 - 原生支持服务网格</td>
<td>主流使用，特别是在服务网格架构中</td>
</tr>
<tr>
<td><strong>Spring Retry</strong></td>
<td>- 重试机制 - 回退机制 - 统计和监控</td>
<td>- Spring项目 - 与Spring生态深度集成</td>
<td>主流使用，特别是在Spring生态中</td>
</tr>
</tbody></table>
<h2 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h2><p>断路器模式、重试机制和超时控制都是通过一系列策略和配置来实现容错和故障处理。</p>
<ol>
<li><strong>断路器模式</strong>：断路器模式用于防止服务之间的故障传播和级联失败。当对某个服务的调用失败次数达到阈值时，断路器会打开，直接返回失败响应，避免继续调用失败的服务。</li>
<li><strong>重试机制</strong>：重试机制用于在请求失败时自动重试，以增加成功的可能性，它可以处理网络波动或临时故障，提升系统的健壮性和可靠性，重试策略可以基于最大重试次数、重试间隔等来配置，避免频繁重试造成系统负担。</li>
<li><strong>超时控制</strong>：设置请求的最大响应时间，在超过预设时间后，系统会终止请求并返回适当的响应或执行后续处理。这可以防止资源被长时间占用，提高系统的响应性和用户体验。</li>
</ol>
<h2 id="实例代码-4"><a href="#实例代码-4" class="headerlink" title="实例代码"></a>实例代码</h2><p>下面是使用 Resilience4j 实现断路器、重试和超时控制的示例代码。</p>
<ol>
<li>添加 Resilience4j 依赖</li>
</ol>
<p>在项目的 <code>pom.xml</code> 文件中添加 Resilience4j 的依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-circuitbreaker-resilience4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.github.resilience4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>resilience4j-spring-boot2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>配置断路器、重试和超时控制</li>
</ol>
<p>在 <code>application.yml</code> 文件中配置 Resilience4j：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">3</span>
        <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 5s
        <span class="token key atrule">slowCallRateThreshold</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">slowCallDurationThreshold</span><span class="token punctuation">:</span> 2s
  <span class="token key atrule">retry</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxRetryAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
        <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> 500ms
  <span class="token key atrule">time-limiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 1s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>使用断路器、重试和超时控制</li>
</ol>
<p>在服务中使用 Resilience4j 的注解来应用断路器、重试和超时控制：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@CircuitBreaker</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Retry</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TimeLimiter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 调用远程服务或执行可能失败的操作</span>
        <span class="token keyword">return</span> <span class="token string">"Processed successfully"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>启用 Resilience4j</li>
</ol>
<p>在 Spring Boot 应用的主类上添加 <code>@EnableCircuitBreaker</code> 和 <code>@EnableRetry</code> 注解，启用 Resilience4j 功能：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>
<span class="token annotation punctuation">@EnableRetry</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="服务监控与追踪"><a href="#服务监控与追踪" class="headerlink" title="服务监控与追踪"></a>服务监控与追踪</h1><h2 id="分布式日志"><a href="#分布式日志" class="headerlink" title="分布式日志"></a>分布式日志</h2><p>分布式日志指的是多个服务实例产生的日志被集中存储和管理的过程，通常用于故障排查、性能优化和安全审计等目的。</p>
<h2 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h2><p>链路追踪是一种技术，用于监控和诊断分布式系统中请求的调用路径和性能数据。它能够跟踪服务间的调用关系，帮助定位延迟和故障根因。</p>
<h2 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h2><p>性能监控是指收集、分析和展示系统的运行时数据，帮助识别性能瓶颈和优化机会。</p>
<h2 id="技术选型-5"><a href="#技术选型-5" class="headerlink" title="技术选型"></a>技术选型</h2><table>
<thead>
<tr>
<th>技术选型</th>
<th>主要能力</th>
<th>区别</th>
<th>当前使用情况</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Prometheus</strong></td>
<td>- 时间序列数据存储 - 多维数据模型 - 强大的查询语言 - 可视化与告警</td>
<td>- CNCF开源项目 - 与Kubernetes深度集成</td>
<td>主流使用，特别是在Kubernetes生态中</td>
</tr>
<tr>
<td><strong>Grafana</strong></td>
<td>- 数据可视化 - 支持多种数据源 - 灵活的仪表盘 - 告警管理</td>
<td>- 开源项目 - 通常与Prometheus结合使用</td>
<td>主流使用，广泛应用于各种场景</td>
</tr>
<tr>
<td><strong>Elasticsearch, Logstash, Kibana (ELK Stack)</strong></td>
<td>- 日志收集与分析 - 数据存储与检索 - 数据可视化 - 实时监控</td>
<td>- 开源项目 - 灵活性高，适用于大规模日志分析</td>
<td>主流使用，特别是在日志管理和分析场景</td>
</tr>
<tr>
<td><strong>Jaeger</strong></td>
<td>- 分布式追踪 - 上下文传播 - 性能监控 - 根因分析</td>
<td>- CNCF开源项目 - 与OpenTracing标准兼容</td>
<td>主流使用，特别是在微服务架构中</td>
</tr>
<tr>
<td><strong>Zipkin</strong></td>
<td>- 分布式追踪 - 上下文传播 - 性能监控 - 根因分析</td>
<td>- 开源项目 - 与Spring Cloud Sleuth深度集成</td>
<td>主流使用，特别是在Spring Cloud生态中</td>
</tr>
</tbody></table>
<h2 id="技术原理-5"><a href="#技术原理-5" class="headerlink" title="技术原理"></a>技术原理</h2><p>这些技术主要通过在应用程序中添加代理、中间件或库来实现监控和追踪，例如通过注入特定的组件或配置来收集和传输相关数据。</p>
<h3 id="分布式日志和链路追踪的原理"><a href="#分布式日志和链路追踪的原理" class="headerlink" title="分布式日志和链路追踪的原理"></a>分布式日志和链路追踪的原理</h3><ol>
<li><strong>分布式日志</strong>：通过在应用程序中使用适当的日志框架（如Logback、Log4j等）配置，将日志发送到中心化的日志存储或分析平台（如ELK Stack、Splunk等），从而实现集中化日志管理和分析。</li>
<li><strong>链路追踪</strong>：使用特定的链路追踪工具（如Spring Cloud Sleuth、Zipkin、Jaeger等），在服务调用链路中注入唯一的标识（如Trace ID和Span ID），并将调用信息发送到链路追踪服务器或平台。这些工具可以帮助跟踪服务之间的调用关系、计算延迟，并可视化调用链路和性能数据。</li>
</ol>
<h3 id="性能监控的原理"><a href="#性能监控的原理" class="headerlink" title="性能监控的原理"></a>性能监控的原理</h3><ol>
<li><strong>Prometheus</strong>：Prometheus 是一种开源的监控和警报工具包，通过在应用程序中添加 Prometheus 的客户端库（如Spring Boot Actuator的集成），可以暴露应用程序的指标（metrics），如内存使用、CPU 使用、请求处理时间等。Prometheus 定期拉取这些指标，并存储在时间序列数据库中，支持灵活的查询和图形化展示。</li>
<li><strong>Grafana</strong>：Grafana 是一个开源的数据可视化工具，与 Prometheus 配合使用可以实现强大的监控和可视化功能。Grafana 可以连接多种数据源，包括 Prometheus，提供丰富的仪表盘和图表，帮助用户实时监控系统的性能指标和运行状态。</li>
</ol>
<h2 id="实例代码-5"><a href="#实例代码-5" class="headerlink" title="实例代码"></a>实例代码</h2><h3 id="ELK收集可视化日志"><a href="#ELK收集可视化日志" class="headerlink" title="ELK收集可视化日志"></a>ELK收集可视化日志</h3><h4 id="导入依赖-1"><a href="#导入依赖-1" class="headerlink" title="导入依赖"></a>导入依赖</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>net.logstash.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>logstash-logback-encoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置-Logback"><a href="#配置-Logback" class="headerlink" title="配置 Logback"></a>配置 Logback</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- src/main/resources/logback-spring.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org/springframework/boot/logging/logback/base.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logstash<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>net.logstash.logback.appender.LogstashTcpSocketAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>destination</span><span class="token punctuation">></span></span>localhost:5044<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>destination</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>net.logstash.logback.encoder.LogstashEncoder<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logstash<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置-Logstash"><a href="#配置-Logstash" class="headerlink" title="配置 Logstash"></a>配置 Logstash</h4><pre class="line-numbers language-none"><code class="language-none">input &#123;
  tcp &#123;
    port &#x3D;&gt; 5044
    codec &#x3D;&gt; json
  &#125;
&#125;

output &#123;
  elasticsearch &#123;
    hosts &#x3D;&gt; [&quot;http:&#x2F;&#x2F;localhost:9200&quot;]
    index &#x3D;&gt; &quot;microservices-logs-%&#123;+YYYY.MM.dd&#125;&quot;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="启动-Logstash"><a href="#启动-Logstash" class="headerlink" title="启动 Logstash"></a>启动 Logstash</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">logstash <span class="token parameter variable">-f</span> logstash.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="配置-Elasticsearch-和-Kibana"><a href="#配置-Elasticsearch-和-Kibana" class="headerlink" title="配置 Elasticsearch 和 Kibana"></a>配置 Elasticsearch 和 Kibana</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> elasticsearch <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> elasticsearch:7.10.0
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token parameter variable">--link</span> elasticsearch:elasticsearch kibana:7.10.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="使用-Spring-Cloud-Sleuth-和-Zipkin-实现链路追踪"><a href="#使用-Spring-Cloud-Sleuth-和-Zipkin-实现链路追踪" class="headerlink" title="使用 Spring Cloud Sleuth 和 Zipkin 实现链路追踪"></a>使用 Spring Cloud Sleuth 和 Zipkin 实现链路追踪</h3><h4 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在 Spring Boot 项目的 <code>pom.xml</code> 文件中添加依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><p>在 <code>application.yml</code> 文件中配置 Zipkin 服务器地址：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="启用-Sleuth"><a href="#启用-Sleuth" class="headerlink" title="启用 Sleuth"></a>启用 Sleuth</h4><p>在主类中添加 <code>@EnableZipkinServer</code> 注解启用 Sleuth 和 Zipkin：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableZipkinServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZipkinServerApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ZipkinServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用-Prometheus-和-Grafana-进行性能监控"><a href="#使用-Prometheus-和-Grafana-进行性能监控" class="headerlink" title="使用 Prometheus 和 Grafana 进行性能监控"></a>使用 Prometheus 和 Grafana 进行性能监控</h3><h4 id="添加依赖-2"><a href="#添加依赖-2" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在 Spring Boot 项目的 <code>pom.xml</code> 文件中添加 Prometheus 的依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.micrometer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>micrometer-registry-prometheus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置-Prometheus"><a href="#配置-Prometheus" class="headerlink" title="配置 Prometheus"></a>配置 Prometheus</h4><p>在 <code>application.yml</code> 文件中添加 Prometheus 监控端点的配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置-Grafana"><a href="#配置-Grafana" class="headerlink" title="配置 Grafana"></a>配置 Grafana</h4><p>下载并安装 Grafana，连接 Prometheus 数据源，并导入相应的仪表盘（dashboard）进行监控和可视化。</p>
<h1 id="微服务安全"><a href="#微服务安全" class="headerlink" title="微服务安全"></a>微服务安全</h1><h2 id="认证与授权"><a href="#认证与授权" class="headerlink" title="认证与授权"></a>认证与授权</h2><p>认证与授权是保障系统安全的重要组成部分，其中认证是验证用户身份的过程，授权是确定用户是否有权限执行特定操作的过程。</p>
<h2 id="API安全"><a href="#API安全" class="headerlink" title="API安全"></a>API安全</h2><p>API安全涉及保护API免受未经授权访问、恶意攻击或数据泄露等威胁。</p>
<h2 id="技术原理-6"><a href="#技术原理-6" class="headerlink" title="技术原理"></a>技术原理</h2><p>认证与授权通常使用以下技术实现：</p>
<ul>
<li><strong>OAuth2</strong>：OAuth2 是一个开放标准，允许用户授权第三方应用访问他们存储在服务提供者上的资源，而不需要分享他们的凭证（如用户名和密码）。</li>
<li>**JWT (JSON Web Token)**：JWT 是一种紧凑且独立的方式，用于在各方之间安全地传输信息作为 JSON 对象。JWT 可以使用 HMAC 算法或使用 RSA&#x2F;ECDSA 的公钥&#x2F;私钥对进行签名，确保传输过程中的数据完整性和安全性。</li>
</ul>
<h2 id="实例代码-6"><a href="#实例代码-6" class="headerlink" title="实例代码"></a>实例代码</h2><h3 id="使用-Spring-Security-和-OAuth2-实现认证与授权"><a href="#使用-Spring-Security-和-OAuth2-实现认证与授权" class="headerlink" title="使用 Spring Security 和 OAuth2 实现认证与授权"></a>使用 Spring Security 和 OAuth2 实现认证与授权</h3><p>下面是使用 Spring Security 和 OAuth2 的简单示例，实现基本的认证与授权功能。</p>
<ol>
<li>添加依赖</li>
</ol>
<p>在 Spring Boot 项目的 <code>pom.xml</code> 文件中添加 Spring Security 和 OAuth2 的依赖：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security.oauth.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-oauth2-autoconfigure<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>配置 Spring Security 和 OAuth2</li>
</ol>
<p>在 <code>application.yml</code> 文件中配置 Spring Security 和 OAuth2 的相关信息：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token key atrule">custom</span><span class="token punctuation">:</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>client<span class="token punctuation">-</span>id
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>client<span class="token punctuation">-</span>secret
            <span class="token key atrule">scope</span><span class="token punctuation">:</span> read<span class="token punctuation">,</span>write
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> <span class="token string">"&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;"</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token key atrule">custom</span><span class="token punctuation">:</span>
            <span class="token key atrule">token-uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//oauth.provider.com/oauth/token
            <span class="token key atrule">authorization-uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//oauth.provider.com/oauth/authorize<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>配置认证和授权服务</li>
</ol>
<p>创建一个配置类来配置认证服务器和资源服务器：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableOAuth2Client</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 配置具体的认证与授权规则</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>编写控制器和服务</li>
</ol>
<p>创建一个简单的控制器来测试 OAuth2 认证和授权：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, OAuth2!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>启动应用程序</li>
</ol>
<p>运行 Spring Boot 应用程序，并访问 <code>/hello</code> 路径，应该会跳转到 OAuth2 认证页面进行登录授权。</p>
<h1 id="微服务设计模式"><a href="#微服务设计模式" class="headerlink" title="微服务设计模式"></a>微服务设计模式</h1><h2 id="服务拆分策略"><a href="#服务拆分策略" class="headerlink" title="服务拆分策略"></a>服务拆分策略</h2><p>服务拆分是设计微服务架构的关键步骤，合理的拆分策略可以提高系统的可维护性、可扩展性和可靠性。</p>
<ol>
<li><strong>业务功能拆分</strong>：<ul>
<li><strong>单一职责原则</strong>：每个微服务应只负责一个特定的业务功能。例如，用户服务、订单服务和支付服务等。</li>
<li><strong>业务能力划分</strong>：识别核心业务能力，将其作为独立的微服务。例如，在电商平台中，可以有库存管理、购物车、结算等独立的业务能力。</li>
</ul>
</li>
<li><strong>团队自治</strong>：<ul>
<li><strong>团队结构</strong>：将团队组织结构与微服务架构对齐，每个团队负责一个或多个微服务。这有助于独立开发、测试和部署。</li>
<li><strong>DevOps 文化</strong>：鼓励团队对其服务的全生命周期负责，从开发到生产运维，提升团队的责任感和服务质量。</li>
</ul>
</li>
<li><strong>数据隔离</strong>：<ul>
<li><strong>独立数据库</strong>：每个微服务应拥有自己的数据库，避免跨服务的数据耦合。这减少了数据库层面的依赖性和冲突。</li>
<li><strong>数据复制和同步</strong>：使用事件驱动架构和消息队列实现数据的异步复制和同步，确保数据在不同服务之间的一致性。</li>
</ul>
</li>
</ol>
<h2 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h2><p>在分布式系统中，数据一致性是一个关键问题，需要根据业务需求在一致性、可用性和分区容忍性之间进行权衡。</p>
<ol>
<li><strong>CAP 理论</strong>：<ul>
<li><strong>一致性（Consistency）</strong>：所有节点在同一时间看到的数据是相同的。</li>
<li><strong>可用性（Availability）</strong>：每个请求都能在合理的时间内获得响应，但不保证数据一致性。</li>
<li><strong>分区容忍性（Partition Tolerance）</strong>：系统在遇到网络分区故障时仍能继续运作，但可能会牺牲一致性或可用性中的一个。</li>
</ul>
</li>
<li><strong>最终一致性</strong>：<ul>
<li><strong>定义</strong>：系统允许在一段时间内存在数据不一致的状态，但最终所有节点的数据会达到一致。</li>
<li><strong>实现方法</strong>：使用事件驱动架构、消息队列和异步处理机制来保证数据的最终一致性。</li>
<li><strong>场景</strong>：适用于读写操作不强依赖实时一致性的场景，例如社交媒体的点赞和评论。</li>
</ul>
</li>
</ol>
<h2 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h2><p>分布式事务管理旨在保证跨多个服务的事务一致性。常用的分布式事务管理模式包括：</p>
<ol>
<li><strong>两阶段提交（2PC）</strong>：<ul>
<li><strong>原理</strong>：包括准备阶段和提交阶段。所有参与者先在准备阶段锁定资源，如果所有参与者都准备好了，则进入提交阶段，否则回滚事务。</li>
<li><strong>缺点</strong>：复杂性高，性能低，容易产生锁竞争和死锁问题。</li>
</ul>
</li>
<li><strong>Saga 模式</strong>：<ul>
<li><strong>定义</strong>：Saga 是一种将长事务拆分为一系列短事务，通过每个短事务的可补偿操作来保证最终一致性的模式。</li>
<li>实现方式：<ul>
<li><strong>协调者（Orchestrator）模式</strong>：一个协调者服务负责管理和执行 Saga 事务的各个步骤，处理成功和失败的情况。</li>
<li><strong>编排者（Choreography）模式</strong>：没有单一的协调者，每个微服务通过事件驱动来触发下一个事务步骤。</li>
</ul>
</li>
<li>步骤：<ol>
<li><strong>事务步骤</strong>：将长事务拆分为多个短事务，每个短事务都有一个对应的补偿操作。</li>
<li><strong>补偿操作</strong>：每个事务步骤如果失败，需要执行对应的补偿操作来回滚已完成的步骤。</li>
<li><strong>事务状态管理</strong>：使用数据库或消息队列来记录事务的状态，确保事务步骤的顺序执行和状态一致性。</li>
</ol>
</li>
<li><strong>优势</strong>：Saga 模式避免了全局锁和单点故障，提高了系统的可扩展性和可靠性。</li>
<li><strong>示例</strong>：在电商交易中，一个订单处理流程可以分为创建订单、扣减库存、扣款和确认订单，每个步骤失败时执行相应的补偿操作。</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/yourname" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/yourname" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orion Potter</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
